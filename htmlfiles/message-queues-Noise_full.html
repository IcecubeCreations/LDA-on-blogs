<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 7) & !(IE 8)]><!-->
<html lang="en-US">
<!--<![endif]-->
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>message queues | Noise</title>
<link rel="profile" href="https://gmpg.org/xfn/11">
<!--[if lt IE 9]>
	<script src="https://noise.getoto.net/wp-content/themes/z/js/html5.js"></script>
	<![endif]-->
<meta name='robots' content='max-image-preview:large' />
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Noise &raquo; Feed" href="https://noise.getoto.net/feed/" />
<link rel="alternate" type="application/rss+xml" title="Noise &raquo; Comments Feed" href="https://noise.getoto.net/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Noise &raquo; message queues Tag Feed" href="https://noise.getoto.net/tag/message-queues/feed/" />

<script src="//www.googletagmanager.com/gtag/js?id=UA-1237038-1" data-cfasync="false" data-wpfc-render="false" type="text/javascript" async></script>
<script data-cfasync="false" data-wpfc-render="false" type="text/javascript">
				var mi_version = '8.5.3';
				var mi_track_user = true;
				var mi_no_track_reason = '';
				
								var disableStrs = [
															'ga-disable-UA-1237038-1',
									];

				/* Function to detect opted out users */
				function __gtagTrackerIsOptedOut() {
					for ( var index = 0; index < disableStrs.length; index++ ) {
						if ( document.cookie.indexOf( disableStrs[ index ] + '=true' ) > -1 ) {
							return true;
						}
					}

					return false;
				}

				/* Disable tracking if the opt-out cookie exists. */
				if ( __gtagTrackerIsOptedOut() ) {
					for ( var index = 0; index < disableStrs.length; index++ ) {
						window[ disableStrs[ index ] ] = true;
					}
				}

				/* Opt-out function */
				function __gtagTrackerOptout() {
					for ( var index = 0; index < disableStrs.length; index++ ) {
						document.cookie = disableStrs[ index ] + '=true; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/';
						window[ disableStrs[ index ] ] = true;
					}
				}

				if ( 'undefined' === typeof gaOptout ) {
					function gaOptout() {
						__gtagTrackerOptout();
					}
				}
								window.dataLayer = window.dataLayer || [];

				window.MonsterInsightsDualTracker = {
					helpers: {},
					trackers: {},
				};
				if ( mi_track_user ) {
					function __gtagDataLayer() {
						dataLayer.push( arguments );
					}

					function __gtagTracker( type, name, parameters ) {
						if (!parameters) {
							parameters = {};
						}

						if (parameters.send_to) {
							__gtagDataLayer.apply( null, arguments );
							return;
						}

						if ( type === 'event' ) {
							
															parameters.send_to = monsterinsights_frontend.ua;
								__gtagDataLayer( type, name, parameters );
													} else {
							__gtagDataLayer.apply( null, arguments );
						}
					}
					__gtagTracker( 'js', new Date() );
					__gtagTracker( 'set', {
						'developer_id.dZGIzZG' : true,
											} );
															__gtagTracker( 'config', 'UA-1237038-1', {"forceSSL":"true","link_attribution":"true"} );
										window.gtag = __gtagTracker;											(function () {
							/* https://developers.google.com/analytics/devguides/collection/analyticsjs/ */
							/* ga and __gaTracker compatibility shim. */
							var noopfn = function () {
								return null;
							};
							var newtracker = function () {
								return new Tracker();
							};
							var Tracker = function () {
								return null;
							};
							var p = Tracker.prototype;
							p.get = noopfn;
							p.set = noopfn;
							p.send = function (){
								var args = Array.prototype.slice.call(arguments);
								args.unshift( 'send' );
								__gaTracker.apply(null, args);
							};
							var __gaTracker = function () {
								var len = arguments.length;
								if ( len === 0 ) {
									return;
								}
								var f = arguments[len - 1];
								if ( typeof f !== 'object' || f === null || typeof f.hitCallback !== 'function' ) {
									if ( 'send' === arguments[0] ) {
										var hitConverted, hitObject = false, action;
										if ( 'event' === arguments[1] ) {
											if ( 'undefined' !== typeof arguments[3] ) {
												hitObject = {
													'eventAction': arguments[3],
													'eventCategory': arguments[2],
													'eventLabel': arguments[4],
													'value': arguments[5] ? arguments[5] : 1,
												}
											}
										}
										if ( 'pageview' === arguments[1] ) {
											if ( 'undefined' !== typeof arguments[2] ) {
												hitObject = {
													'eventAction': 'page_view',
													'page_path' : arguments[2],
												}
											}
										}
										if ( typeof arguments[2] === 'object' ) {
											hitObject = arguments[2];
										}
										if ( typeof arguments[5] === 'object' ) {
											Object.assign( hitObject, arguments[5] );
										}
										if ( 'undefined' !== typeof arguments[1].hitType ) {
											hitObject = arguments[1];
											if ( 'pageview' === hitObject.hitType ) {
												hitObject.eventAction = 'page_view';
											}
										}
										if ( hitObject ) {
											action = 'timing' === arguments[1].hitType ? 'timing_complete' : hitObject.eventAction;
											hitConverted = mapArgs( hitObject );
											__gtagTracker( 'event', action, hitConverted );
										}
									}
									return;
								}

								function mapArgs( args ) {
									var arg, hit = {};
									var gaMap = {
										'eventCategory': 'event_category',
										'eventAction': 'event_action',
										'eventLabel': 'event_label',
										'eventValue': 'event_value',
										'nonInteraction': 'non_interaction',
										'timingCategory': 'event_category',
										'timingVar': 'name',
										'timingValue': 'value',
										'timingLabel': 'event_label',
										'page' : 'page_path',
										'location' : 'page_location',
										'title' : 'page_title',
									};
									for ( arg in args ) {
																				if ( ! ( ! args.hasOwnProperty(arg) || ! gaMap.hasOwnProperty(arg) ) ) {
											hit[gaMap[arg]] = args[arg];
										} else {
											hit[arg] = args[arg];
										}
									}
									return hit;
								}

								try {
									f.hitCallback();
								} catch ( ex ) {
								}
							};
							__gaTracker.create = newtracker;
							__gaTracker.getByName = newtracker;
							__gaTracker.getAll = function () {
								return [];
							};
							__gaTracker.remove = noopfn;
							__gaTracker.loaded = true;
							window['__gaTracker'] = __gaTracker;
						})();
									} else {
										console.log( "" );
					( function () {
							function __gtagTracker() {
								return null;
							}
							window['__gtagTracker'] = __gtagTracker;
							window['gtag'] = __gtagTracker;
					} )();
									}
			</script>

<link rel='stylesheet' id='wp-block-library-css' href='https://noise.getoto.net/wp-includes/css/dist/block-library/style.min.css?ver=5.8.4' type='text/css' media='all' />
<link rel='stylesheet' id='twentyfourteen-lato-css' href='https://fonts.googleapis.com/css?family=Lato%3A300%2C400%2C700%2C900%2C300italic%2C400italic%2C700italic&#038;subset=latin%2Clatin-ext' type='text/css' media='all' />
<link rel='stylesheet' id='genericons-css' href='https://noise.getoto.net/wp-content/themes/z/genericons/genericons.css?ver=3.0.3' type='text/css' media='all' />
<link rel='stylesheet' id='twentyfourteen-style-css' href='https://noise.getoto.net/wp-content/themes/z/style.css?ver=5.8.4' type='text/css' media='all' />
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentyfourteen-ie-css'  href='https://noise.getoto.net/wp-content/themes/z/css/ie.css?ver=20131205' type='text/css' media='all' />
<![endif]-->
<script type="5ced1ade86d8531617648efa-text/javascript" src='https://noise.getoto.net/wp-content/plugins/google-analytics-for-wordpress/assets/js/frontend-gtag.min.js?ver=8.5.3' id='monsterinsights-frontend-script-js'></script>
<script data-cfasync="false" data-wpfc-render="false" type="text/javascript" id='monsterinsights-frontend-script-js-extra'>/* <![CDATA[ */
var monsterinsights_frontend = {"js_events_tracking":"true","download_extensions":"doc,pdf,ppt,zip,xls,docx,pptx,xlsx","inbound_paths":"[]","home_url":"https:\/\/noise.getoto.net","hash_tracking":"false","ua":"UA-1237038-1","v4_id":""};/* ]]> */
</script>
<script type="5ced1ade86d8531617648efa-text/javascript" src='https://noise.getoto.net/wp-includes/js/jquery/jquery.min.js?ver=3.6.0' id='jquery-core-js'></script>
<script type="5ced1ade86d8531617648efa-text/javascript" src='https://noise.getoto.net/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2' id='jquery-migrate-js'></script>
<style type="text/css" id="wp-custom-css">
			.crap {color: black}		</style>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" type="5ced1ade86d8531617648efa-text/javascript"></script>
<script type="5ced1ade86d8531617648efa-text/javascript">
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-6472219848970595",
          enable_page_level_ads: true
     });
</script><script async src='/cdn-cgi/challenge-platform/h/b/scripts/invisible.js?ts=1653573600'></script></head>
<body class="archive tag tag-message-queues tag-7033 group-blog masthead-fixed list-view full-width">
<div id="page" class="hfeed site">
<header id="masthead" class="site-header" role="banner">
<div class="header-main">
<h1 class="site-title"><a href="https://noise.getoto.net/" rel="home">Noise</a></h1>
<div class="search-toggle">
<a href="#search-container" class="screen-reader-text" aria-expanded="false" aria-controls="search-container">Search</a>
</div>
<nav id="primary-navigation" class="site-navigation primary-navigation" role="navigation">
<button class="menu-toggle">Primary Menu</button>
<a class="screen-reader-text skip-link" href="#content">Skip to content</a>
<div class="menu-small-container"><ul id="primary-menu" class="nav-menu"><li id="menu-item-208616" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-208616"><a href="https://noise.getoto.net/">Home</a></li>
<li id="menu-item-208614" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-208614"><a href="https://noise.getoto.net/about/">About</a></li>
</ul></div> </nav>
</div>
<div id="search-container" class="search-box-wrapper hide">
<div class="search-box">
<form role="search" method="get" class="search-form" action="https://noise.getoto.net/">
<label>
<span class="screen-reader-text">Search for:</span>
<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" />
</label>
<input type="submit" class="search-submit" value="Search" />
</form> </div>
</div>
</header>
<div id="main" class="site-main">
<section id="primary" class="content-area">
<div id="content" class="site-content" role="main">
<header class="archive-header">
<h1 class="archive-title">Tag Archives: message queues</h1>
</header>
<article id="post-822751" class="post-822751 post type-post status-publish format-standard hentry tag-amazon-simple-notification-service-sns tag-amazon-simple-queue-service-sqs tag-message-queues tag-message-topics tag-messaging tag-microservices">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2019/11/22/application-integration-patterns-for-microservices-fan-out-strategies/" rel="bookmark">Application integration patterns for microservices: Fan-out strategies</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2019/11/22/application-integration-patterns-for-microservices-fan-out-strategies/" rel="bookmark"><time class="entry-date" datetime="2019-11-22T21:20:38+02:00">2019-11-22</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/rachel-richardson/" rel="author">Rachel Richardson</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Rachel Richardson">Rachel Richardson</a> original <a href="https://aws.amazon.com/blogs/compute/application-integration-patterns-for-microservices-fan-out-strategies/">https://aws.amazon.com/blogs/compute/application-integration-patterns-for-microservices-fan-out-strategies/</a></p>
<p><em>This post is courtesy of Dirk Fr&ouml;hner</em></p>
<p>The <a href="https://aws.amazon.com/blogs/compute/understanding-asynchronous-messaging-for-microservices/">first blog in this series</a> introduced asynchronous messaging for building loosely coupled systems that can scale, operate, and evolve individually.&nbsp;It considered messaging as a communications model for microservices architectures.&nbsp;This post covers concrete architectural considerations, focusing on the messaging architecture.</p>
<h2>Wild Rydes</h2>
<p>Wild Rydes is a fictional technology start-up. You may have heard of it – it disrupts individual transportation by replacing traditional taxis with unicorns.&nbsp;We use the&nbsp;Wild Rydes storyline in several hands-on AWS workshops. It illustrates concepts such as serverless development, event-driven design, API management, and messaging in microservices.</p>
<p>This blog post explores the decision-making process in building the Wild Rydes workshop, with a goal of helping you apply these concepts to your applications.</p>
<p>In the workshop, a customer requests a ‘unicorn’ ride using the Wild Rydes customer application.&nbsp;Registered unicorn drivers can use the application to manage their rides.&nbsp;Unicorn drivers submit a ride completion message after they have successfully delivered a customer to their destination.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic1.jpg"><img loading="lazy" class="alignnone size-large wp-image-7764" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic1-1024x598.jpg" alt="Wild Rydes app image" width="1024" height="598" /></a></p>
<h2>Submit a ride completion</h2>
<h3>API exposed by the unicorn management service</h3>
<p>At Wild Rydes, end-user clients are implemented as mobile applications and communicate via REST APIs (also known as hypermedia APIs) with the backend services.</p>
<p>For this use case, the application interacts with the API exposed by the unicorn management service.&nbsp;It uses the&nbsp;<code>submit-ride-completion</code>&nbsp;resource that it discovered from the API’s home document to send the relevant details of a ride to the backend.&nbsp;In response, the backend persists these details, creates a new&nbsp;<code>completed-ride&nbsp;resource</code>. This returns the respective status code, the location, and a representation of the new resource to the client.&nbsp;The API details are shown below.</p>
<p>Request from client to submit the details of a completed ride:</p>
<pre><code class="lang-http">POST /&lt;submit-ride-completion-resource-path&gt; HTTP/1.1
Content-Type: application/json;charset=UTF-8
...

{
    &quot;from&quot;: &quot;...&quot;,
    &quot;to&quot;: &quot;...&quot;,
    &quot;duration&quot;: &quot;...&quot;,
    &quot;distance&quot;: &quot;...&quot;,
    &quot;customer&quot;: &quot;...&quot;,
    &quot;fare&quot;: &quot;...&quot;
}</code></pre>
<p>Response from the unicorn management service:</p>
<pre><code class="lang-http">HTTP/1.1 201 Created
Date: Sat, 31 Aug 2019 12:00:00 GMT
Location: &lt;url-of-newly-created-completed-ride-resource&gt;
Content-Location: &lt;url-of-newly-created-completed-ride-resource&gt;
Content-Type: application/json;charset=UTF-8
...

{
    &quot;links&quot;: {
        &quot;self&quot;: {
            &quot;href&quot;: &quot;https://...&quot;
        }
    },
    &lt;completed-ride-resource-representation-properties&gt;
}</code></pre>
<h3>Schematic architecture for the use case</h3>
<p>The schematic architecture for the use case is shown in diagram 1 below:</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic2.jpg"><img loading="lazy" class="alignnone size-large wp-image-7766" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic2-1024x418.jpg" alt="Diagram 1: Mutliple microservices need information about ride completion" width="1024" height="418" /></a></p>
<p><em>Diagram 1: Multiple microservices need information about ride completion</em></p>
<p>There are other microservices in Wild Rydes that are also interested in a new completed ride. The examples from the diagram are:</p>
<ul>
<li>Customer notification service: customers should receive a notification in the app about their latest completed ride.</li>
<li>Customer accounting service: After all, Wild Rydes is a business, so this service is responsible for collecting the fare from the customer.</li>
<li>Customer loyalty service: Everybody wants to collect&nbsp;miles&nbsp;and would like to receive benefits for being a loyal customer.</li>
<li>Data lake ingestion service: Wild Rydes is a data-driven company and they want to ingest all data generated from any process into their data lake for arbitrary analytics.</li>
<li>Extraordinary rides service: This special service is interested in rides with fares or distances above certain thresholds for preparing insights for business managers.</li>
</ul>
<p>Based on this scenario, let’s review the integration options.</p>
<h2>Integration options</h2>
<h3>Integration via database</h3>
<p>The unicorn management service stores the details of a completed ride in a database. It could share the database with the other services directly, but that creates tight coupling. Sharing the database&nbsp;also restricts your flexibility&nbsp;to scale and evolve your services.</p>
<h3>Integration via REST APIs</h3>
<p>What about using REST APIs for the integration?&nbsp;The HTTP-based implementation of the REST architectural style uses the distributed architecture concepts of the web.&nbsp;However, what does this mean for the implementation?</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic3.jpg"><img loading="lazy" class="alignnone size-large wp-image-7767" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic3-1024x417.jpg" alt="Diagram 2: Using REST APIs to communicate to microservices" width="1024" height="417" /></a></p>
<p><em>Diagram 2: Using REST APIs to communicate to microservices</em></p>
<p>As shown in diagram 2 above:</p>
<ul>
<li>Effectively, all interested services on the right-hand side would have to expose an API resource. These would be called by the unicorn management service for each newly completed ride.</li>
<li>To enable elasticity behind a single resource URL, you may need a load balancer in front of each interested service.</li>
<li>The unicorn management service would have to know about all these interested services and their respective APIs. Hopefully, each service uses a streamlined API resource.</li>
<li>Lastly, the&nbsp;unicorn management service must store, retry, and track all request attempts in case an interested service is not available. This ensures durability so we don’t lose any of these notifications.</li>
</ul>
<p>One approach is to manage a recipient list in the unicorn management service. This adds additional complexity to the unicorn management service and coupling on both sides. Although there are self-registration and discovery approaches, managing a recipient list is not the core use case of the unicorn management service.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic4.jpg"><img loading="lazy" class="alignnone size-large wp-image-7768" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic4-1024x416.jpg" alt="Diagram 3: Using a separate service to manage the fan-out to other services" width="1024" height="416" /></a></p>
<p><em>Diagram 3: Using a separate service to manage the fan-out to other services</em></p>
<p>A better approach would be to externalize the recipient list into a separate Request Distribution Service, as diagram 3 shows.&nbsp;This decouples both sides, but binds each side to the new service.&nbsp;Still, the unicorn management service is still responsible for the delivery of the ride data to all the recipients.&nbsp;Again, this heavy lifting is not the main task of this service.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic5.jpg"><img loading="lazy" class="alignnone size-large wp-image-7769" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic5-1024x417.jpg" alt="Diagram 4: Filtering information for extraordinary rides" width="1024" height="417" /></a></p>
<p><em>Diagram 4: Filtering information for extraordinary rides</em></p>
<p>In diagram 4, the information filtering for the <em>Extraordinary Rides Service</em> is self-managed.&nbsp;This means that there is code on one side to either not send or to discard irrelevant ride data.</p>
<p>For this use case, integration via REST APIs potentially adds coupling to the services. And it adds heavy lifting to the services that is beyond their actual domain.</p>
<h3>Integration via messaging</h3>
<p>A third option could use messaging for the integration.</p>
<p><strong>Publish-subscribe pattern</strong></p>
<p>Both Amazon SNS and Amazon EventBridge can be used to implement the publish-subscribe pattern.&nbsp; In this use case, we recommend Amazon SNS, which scales to support high throughput and fan-out applications.&nbsp;Amazon EventBridge includes direct integrations with&nbsp;software as a service (SaaS) applications and other AWS services. It’s ideal for publish-subscribe use cases involving these types of integrations.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic6.jpg"><img loading="lazy" class="alignnone size-large wp-image-7770" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic6-1024x420.jpg" alt="Diagram 5: Using Amazon SNS to implement a publish-subscribe pattern" width="1024" height="420" /></a></p>
<p><em>Diagram 5: Using Amazon SNS to implement a publish-subscribe pattern</em></p>
<p>Diagram 5 shows an SNS topic called <em>Ride Completion Topic</em>.&nbsp;The unicorn management service can now send the details about a completed ride into that topic. All interested services on the right-hand side can subscribe to this topic.</p>
<p>Using a message topic to publish the details of a completed ride frees us from managing the recipient list, as well as making ensuring reliable delivery of the messages.&nbsp;It also decouples both sides as much as possible.&nbsp;Services on the right-hand side can autonomously subscribe to the topic. The <em>Unicorn Management Service</em> does not know anything about the topic’s subscribers.</p>
<p><strong>Message filter pattern</strong></p>
<p>Looking at the <em>Extraordinary Rides Service</em>, the message filter functionality of Amazon SNS can autonomously and individually discard irrelevant messages.&nbsp;The <em>Extraordinary Rides Service </em>can specify the threshold values for the fare and distance.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic7.jpg"><img loading="lazy" class="alignnone size-large wp-image-7771" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic7-1024x418.jpg" alt="Diagram 6: Filtering extraordinary rides using Amazon SNS" width="1024" height="418" /></a></p>
<p><em>Diagram 6: Filtering extraordinary rides using Amazon SNS</em></p>
<p><strong>Topic-queue-chaining pattern</strong></p>
<p>Consider the publish-subscribe channel between the <em>Unicorn Management Service</em>, and the subscribing services on the right-hand side.</p>
<p>One of the consuming services may go offline for maintenance.&nbsp;Or the code that processes messages from the ride completion topic could run into an exception.&nbsp;These are two examples where a subscriber service could potentially miss topic messages.</p>
<p>A good pattern to apply here is topic-queue-chaining.&nbsp;That means that you add a queue, in our case an SQS queue, between the ride completion topic and each of the subscriber services.&nbsp;As messages are buffered persistently in an SQS queue, it prevents lost messages if a subscriber process run into problems for many hours or days.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic8.jpg"><img loading="lazy" class="alignnone size-large wp-image-7772" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/Pic8-1024x418.jpg" alt="Diagram 7: Chaining topics and queues to buffer messages persistently" width="1024" height="418" /></a></p>
<p><em>Diagram 7: Chaining topics and queues to buffer messages persistently</em></p>
<p><strong>Queues as buffering load balancers</strong></p>
<p>An SQS queue in front of each subscriber service also acts as a buffering load balancer.</p>
<p>Since every message is delivered to one of potentially many consumer processes, you can scale out the subscriber services, and the message load is distributed over the available consumer processes.</p>
<p>As messages are buffered in the queue, they are preserved during a scaling event, such as when you must wait until an additional consumer process becomes operational.</p>
<p>Lastly, these queue characteristics help flatten peak loads for your consumer processes, buffering messages until consumers are available. This allows you to process messages at a pace decoupled from the message source.</p>
<h2>Conclusion</h2>
<p>The Wild Rydes example shows how&nbsp;messaging can provide decoupling and greater flexibility for your microservices landscape.</p>
<p>In contrast to REST APIs, a messaging system takes care of message delivery outside of your service code.&nbsp;Using a publish-subscribe channel provides simple fan-out capability.&nbsp;And message filters allow for selective message reception without the effort of implementing that logic into your code.</p>
<p>With topic-queue-chaining pattern, you can add queue characteristics to a fan-out scenario so that you can easily scale out on the consumer side, and flatten peak loads.</p>
<p>For a deeper dive into queues and topics and how to use them in your microservices architecture, please use the following resources:</p>
<ol>
<li>AWS whitepaper:&nbsp;<a href="https://docs.aws.amazon.com/whitepapers/latest/microservices-on-aws/introduction.html?icmpid=link_from_whitepapers_page">Implementing Microservices on AWS</a></li>
<li>AWS blog:&nbsp;<a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-point-to-point-channels/">Implementing enterprise integration patterns with AWS messaging services: point-to-point channels</a></li>
<li>AWS blog:&nbsp;<a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-publish-subscribe-channels/">Implementing enterprise integration patterns with AWS messaging services: publish-subscribe channels</a></li>
<li>AWS blog: <a href="https://aws.amazon.com/blogs/compute/building-scalable-applications-and-microservices-adding-messaging-to-your-toolbox/">Building Scalable Applications and Microservices: Adding Messaging to Your Toolbox</a></li>
</ol>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/amazon-simple-notification-service-sns/" rel="tag">Amazon Simple Notification Service (SNS)</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service-sqs/" rel="tag">Amazon Simple Queue Service (SQS)</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/message-topics/" rel="tag">message topics</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a><a href="https://noise.getoto.net/tag/microservices/" rel="tag">microservices</a></span></footer></article>
<article id="post-822753" class="post-822753 post type-post status-publish format-standard hentry tag-amazon-mq tag-amazon-simple-notification-service-sns tag-amazon-simple-queue-service-sqs tag-message-queues tag-message-topics tag-messaging tag-microservices">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2019/11/22/understanding-asynchronous-messaging-for-microservices/" rel="bookmark">Understanding asynchronous messaging for microservices</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2019/11/22/understanding-asynchronous-messaging-for-microservices/" rel="bookmark"><time class="entry-date" datetime="2019-11-22T21:19:28+02:00">2019-11-22</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/rachel-richardson/" rel="author">Rachel Richardson</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Rachel Richardson">Rachel Richardson</a> original <a href="https://aws.amazon.com/blogs/compute/understanding-asynchronous-messaging-for-microservices/">https://aws.amazon.com/blogs/compute/understanding-asynchronous-messaging-for-microservices/</a></p>
<p><em>This post is courtesy of Dirk Fr&ouml;hner</em></p>
<p>One of the implications of applying the microservices architectural style is that much communication between components happens over the network. After all, your microservices landscape is a distributed system.&nbsp;To achieve the promises of&nbsp;microservices, such as being able to individually scale, operate, and evolve each service, this communication must happen in a&nbsp;loosely coupled&nbsp;and reliable manner.</p>
<p>A common way to loosely couple services is to expose an API following the REST architectural style.&nbsp;REST APIs are based on the architecture of the web and provide loose coupling between communicating parties.&nbsp;REST APIs offer a great way to decouple interfaces from concrete implementations, and to advise clients about what they can do next, by the use of links and link relations.</p>
<p>While REST APIs are common and useful in microservices design, REST APIs tend to be designed with synchronous communications, where a response is required.&nbsp;A request coming from an end-user client can trigger a complex communications path within your services landscape, which can effectively add coupling between the services at runtime. After all, this is why there are mitigation patterns like circuit-breaker in the first place.&nbsp;REST APIs can also add some heavy lifting to your infrastructure that we will discuss further below.</p>
<h3>Asynchronous messaging</h3>
<p>If loose-coupling is important, especially in a system that requires high resilience and has unpredictable scale, another option is asynchronous messaging.</p>
<p>Asynchronous messaging is a fundamental approach for integrating independent systems, or building up a set of loosely coupled systems that can operate, scale, and evolve independently and flexibly.&nbsp;As our colleague Tim Bray said, “<em>If your application is cloud-native, or large-scale, or distributed, and doesn’t include a messaging component, that’s probably a bug.</em>”&nbsp;In this blog post, we will outline some fundamental benefits of asynchronous messaging for the communications between microservices.</p>
<p>For a refresher on the fundamental messaging patterns and their implementations with Amazon SQS, Amazon SNS, and Amazon MQ, please read our previous blog posts</p>
<ul>
<li><a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-point-to-point-channels/">Implementing enterprise integration patterns with AWS messaging services: point-to-point channels</a></li>
<li><a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-publish-subscribe-channels/">Implementing enterprise integration patterns with AWS messaging services: publish-subscribe channels</a></li>
<li><a href="https://aws.amazon.com/blogs/compute/building-scalable-applications-and-microservices-adding-messaging-to-your-toolbox/">Building Scalable Applications and Microservices: Adding Messaging to Your Toolbox</a></li>
</ul>
<p>For a summary of the semantics of queues and topics:</p>
<ul>
<li>A queue is like a buffer. You can put messages into a queue, and you can retrieve messages from a queue. Message queues operate so that any given message is only consumed by one receiver, although multiple receivers can be connected to the queue.</li>
<li>A topic is like a broadcasting station. You can publish messages to a topic, and anyone interested in these messages can subscribe to the topic.&nbsp;In this model, any message published to a topic is immediately received by all of the subscribers of the topic (unless you have applied the message filter pattern).</li>
</ul>
<h3>Use-case</h3>
<p>Consider a typical scenario illustrated in the diagram below. An end-user client (EUC) addresses an API resource of one of our services, through Amazon API Gateway in this example.&nbsp;From there, the request can potentially follow a path across the microservices landscape to get completely processed.</p>
<p>To provide the final result, there will be potentially cascading subsequent requests sent between other microservices. This example illustrates the complexity involved in processing a single end user request.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/pic1.png"><img loading="lazy" class="alignnone size-large wp-image-7761" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/11/21/pic1-1024x575.png" alt="End User Client accessing a service using an API" width="1024" height="575" /></a></p>
<p><em>Diagram 1: End-User Client accessing a service using an API</em></p>
<p>End-user clients (EUCs) often communicate with services via REST APIs in a synchronous manner.&nbsp;However, the communication can also be designed using an asynchronous approach.&nbsp;For instance, if an EUC submits a request that takes some time to process, the respective API resource can respond with HTTP status&nbsp;202 Accepted, and a link to a resource that provides the current processing status.&nbsp;Downstream, the communication between the service that receives that request, and other services that are involved in processing the request, can happen asynchronously using messaging services.</p>
<p>There are situations where a communications model using asynchronous messaging can make your life easier than using REST APIs.</p>
<h3>Infrastructure complexity</h3>
<p>Start with looking at the infrastructure complexity for the backends of your services.&nbsp;Depending on your implementation paradigm,&nbsp;you have to include different components in your infrastructure&nbsp;that you don’t have to deal with when using messaging.</p>
<p>Imagine your services each expose a REST API.&nbsp;Typically, this means you add a load balancer in front of your compute layer, and your backend implementation includes an HTTP server. It is usually a good idea to decouple your services APIs from their concrete implementations, so you could also consider adding Amazon API Gateway in front of your load balancer.</p>
<p>For a serverless approach, you don’t need to worry about load balancing and scaling out infrastructure. Amazon API Gateway with AWS Lambda integration provides a fully managed solution for removing complexities around infrastructure management.</p>
<p>Using Amazon SQS as a cloud-native messaging service for queues, you don’t employ any of the above mentioned components.&nbsp;As <a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-point-to-point-channels/">described in a prior post</a>, an SQS queue can act as a load balancer in itself. The consumers, or target services, don’t need an HTTP server, but simply ask a queue for available messages.&nbsp;If you use AWS Lambda for your consumers, this process is even simpler, as the Lambda functions are automatically invoked when messages appear in an SQS queue. See <a href="https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html">Using AWS Lambda with Amazon SQS</a> to learn more.</p>
<p>The same applies to Serverless architectures implementing a publish/subscribe pattern. Lambda function executions can be directly triggered by SNS messages.&nbsp;Without AWS Lambda, you need load balancers and web servers in your backend implementations to receive SNS notifications, as those are injected via web hooks into your services.&nbsp;SNS also provides the fan-out functionality that you would otherwise have to build using an intermediary component to implement a recipient list of subscribers.</p>
<h3>Reliability, resilience</h3>
<p>For synchronous systems, if a service crashes&nbsp;while it processes the payload of an API request, the information is lost.&nbsp;A good way&nbsp;to prevent this on a microservice is to explicitly persist an incoming request immediately after receiving it. Then process and&nbsp;reprocess, until the request is finally marked as resolved.</p>
<p>This approach requires additional work, and it requires the microservice to not crash while persisting an incoming API request.&nbsp;The microservice sending a request must also resend if the target service doesn’t acknowledge receipt. For example, it doesn’t respond with a successful HTTP status code, or the connection drops.</p>
<p>When sending messages to a queue, this additional work is addressed by the messaging infrastructure. A message will remain in a queue&nbsp;unless a consumer explicitly states that processing is finished by acknowledging the message reception.&nbsp;As long as message reception is not acknowledged by a consumer, it will stay in the queue.&nbsp;Messages can be retained in an SQS queue for a maximum of 14 days.</p>
<h3>Scale out latency</h3>
<p>Under increased load, your services must scale out to process the requests. You must then consider scale-out latency, which may be managed for you with serverless implementations.&nbsp;It takes a few moments from when an Auto Scaling group triggers the launch of additional instances until these are ready to operate.&nbsp;Also launching new container tasks takes time.&nbsp;When your scaling threshold is not optimal and the scaling event occurs late, your available resources may be unable to serve all incoming requests. These requests may be lost or answered with HTTP status code <em>5xx</em>.</p>
<p>Using message queues that buffer messages during a scaling event help prevent this.&nbsp;Even in use cases where the EUC is waiting for an immediate response, this is the more reliable architecture.&nbsp;If your infrastructure needs time to scale out and you are not able to process all requests in time, the requests are persisted.</p>
<h3>When messaging is your only choice</h3>
<p>What happens when your services must respond to peak loads at scale?</p>
<p>For many applications, the scale-out latency, including load balancer pre-warming, will eventually become too large to handle steeply ascending loads fast enough.&nbsp;With a serverless architecture, exposing your Lambda functions with API Gateway can handle steeply ascending loads. But you must still consider downstream systems, which may be easily overwhelmed.</p>
<p>In these scenarios, where rapid scaling without overwhelming downstream systems is important, messaging may be your best choice.&nbsp;Message queues help protect your downstream services by buffering incoming payloads for consumption at the pace of the consuming service.&nbsp;This&nbsp;helps not only for the communications between microservices, but also when peak loads flood your client-facing API.&nbsp;Often, the most important goal is to accept an incoming request, while the actual processing of that request can happen later.&nbsp;You decouple these steps from each other by using queues.</p>
<p>Serverless messaging systems like Amazon SQS and Amazon SNS can respond quickly to support&nbsp;high scale. These are often the best solution when scale is unpredictable.&nbsp; While the instance-based messaging system, Amazon MQ, provides compatibility with open standards, it requires manual scaling for large workloads, unlike serverless messaging services.</p>
<h3>Conclusion</h3>
<p>We hope you got some inspiration to also employ asynchronous messaging for your microservices communications architecture. In blog XYZ we provide concrete examples of these patterns. For more information, feel free to consume the following resources:</p>
<ol>
<li>AWS whitepaper:&nbsp;<a href="https://docs.aws.amazon.com/whitepapers/latest/microservices-on-aws/introduction.html?icmpid=link_from_whitepapers_page">Implementing Microservices on AWS</a></li>
<li>AWS blog:&nbsp;<a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-point-to-point-channels/">Implementing enterprise integration patterns with AWS messaging services: point-to-point channels</a></li>
<li>AWS blog:&nbsp;<a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-publish-subscribe-channels/">Implementing enterprise integration patterns with AWS messaging services: publish-subscribe channels</a></li>
<li>AWS blog: <a href="https://aws.amazon.com/blogs/compute/building-scalable-applications-and-microservices-adding-messaging-to-your-toolbox/">Building Scalable Applications and Microservices: Adding Messaging to Your Toolbox</a></li>
</ol>
<p>Read the next blog in the series,&nbsp; <a href="https://aws.amazon.com/blogs/compute/application-integration-patterns-for-microservices-fan-out-strategies/">Application Integration Patterns for Microservices: Fan-out Strategies</a>.</p>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/amazon-mq/" rel="tag">Amazon MQ*</a><a href="https://noise.getoto.net/tag/amazon-simple-notification-service-sns/" rel="tag">Amazon Simple Notification Service (SNS)</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service-sqs/" rel="tag">Amazon Simple Queue Service (SQS)</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/message-topics/" rel="tag">message topics</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a><a href="https://noise.getoto.net/tag/microservices/" rel="tag">microservices</a></span></footer></article>
<article id="post-764910" class="post-764910 post type-post status-publish format-standard hentry tag-advanced-300 tag-amazon-mq tag-amazon-route-53 tag-message-queues tag-messaging">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2019/09/11/creating-static-custom-domain-endpoints-with-amazon-mq-to-simplify-broker-modification-and-scaling/" rel="bookmark">Creating static custom domain endpoints with Amazon MQ to simplify broker modification and scaling</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2019/09/11/creating-static-custom-domain-endpoints-with-amazon-mq-to-simplify-broker-modification-and-scaling/" rel="bookmark"><time class="entry-date" datetime="2019-09-11T08:05:41+03:00">2019-09-11</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/rachel-richardson/" rel="author">Rachel Richardson</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Rachel Richardson">Rachel Richardson</a> original <a href="https://aws.amazon.com/blogs/compute/creating-static-custom-domain-endpoints-with-amazon-mq/">https://aws.amazon.com/blogs/compute/creating-static-custom-domain-endpoints-with-amazon-mq/</a></p>
<p><em>This post is courtesy of&nbsp;Wallace Printz, Senior Solutions Architect, AWS, and&nbsp;Christian Mueller, Senior Solutions Architect, AWS.</em></p>
<p>Many cloud-native application architectures take advantage of the point-to-point and publish-subscribe (“pub-sub”) model of message-based communication between application components. This architecture is generally more resilient to failure because of the loose coupling and because message processing failures can be retried. It’s also more efficient because individual application components can independently scale up or down to maintain message-processing SLAs, compared to monolithic application architectures. Synchronous (REST-based) systems are tightly coupled. A problem in a synchronous downstream dependency has an immediate impact on the upstream callers.</p>
<p>Retries from upstream callers can all too easily fan out and amplify problems. <a href="https://aws.amazon.com/sqs/">Amazon SQS</a> and <a href="https://aws.amazon.com/sns/">Amazon SNS</a> are fully managed message queuing services, but are not necessarily the right tool for the job in some cases. For applications requiring messaging protocols including JMS, NMS, AMQP, STOMP, MQTT, and WebSocket, Amazon provides <a href="https://aws.amazon.com/amazon-mq/">Amazon MQ</a>. Amazon MQ is a managed message broker service for Apache ActiveMQ that makes it easy to set up and operate message brokers in the cloud.</p>
<p>Amazon MQ provides two managed broker deployment connection options: public brokers and private brokers. Public brokers receive internet-accessible IP addresses, while private brokers receive only private IP addresses from the corresponding CIDR range in their VPC subnet.</p>
<p>In some cases, for security purposes, you may prefer to place brokers in a private subnet. You can also allow access to the brokers through a persistent public endpoint, such as a subdomain of their corporate domain like <em>mq.example.com</em>.</p>
<p>In this post, we explain how to provision private Amazon MQ brokers behind a secure public load balancer endpoint using an example subdomain.</p>
<h2>Architecture overview</h2>
<p>There are several reasons one might want to deploy this architecture beyond the security aspects.</p>
<p>First, human-readable URLs are easier for people to parse when reviewing operations and troubleshooting, such as deploying updates to <em>mq-dev.example.com</em> before <em>mq-prod.example.com</em>.</p>
<p>Second, maintaining static URLs for your brokers helps reduce the necessity of modifying client code when performing maintenance on the brokers.</p>
<p>Third, this pattern allows you to vertically scale your brokers without changing the client code or even notifying the clients that changes have been made.</p>
<p>Finally, the same architecture described here works for a <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/network-of-brokers.html">network of brokers</a> configuration as well, whereby you could horizontally scale your brokers without impacting the client code.</p>
<h2>Prerequisites</h2>
<p>This blog post assumes some familiarity with AWS networking fundamentals, such as VPCs, subnets, load balancers, and <a href="https://aws.amazon.com/route53/">Amazon Route 53</a>.</p>
<p>When you are finished, the architecture should be set up as shown in the following diagram. For ease of visualization, we demonstrate with a pair of brokers using the active-standby option.</p>
<h2>Solution Overview</h2>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/Solution-overview.png"><img loading="lazy" class="alignnone size-full wp-image-7106" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/Solution-overview.png" alt="Amazon MQ solution overview" width="978" height="994" /></a></p>
<p>The client to broker traffic flow is as follows.</p>
<ul>
<li>First, the client service tries to connect with a failover URL to the domain endpoint setup in Route 53. If a client loses the connection, using the failover URL allows the client to automatically try to reconnect to the broker.</li>
<li>The client looks up the domain name from Route 53, and Route 53 returns the IP address of the Network Load Balancer.</li>
<li>The client creates a secure socket layer (SSL) connection to the Network Load Balancer with an SSL certificate provided from <a href="https://aws.amazon.com/certificate-manager/">AWS Certificate Manager</a> (ACM). The Network Load Balancer selects from the healthy brokers in its target group and creates a separate SSL connection between the Network Load Balancer and the broker. This provides secure, end-to-end SSL encrypted messaging between client and brokers.</li>
</ul>
<p>In this diagram, the healthy broker connection is shown in the solid line. The standby broker, which does not reply to connection requests and is therefore marked as unhealthy in the target group, is shown in the dashed line.</p>
<h2>Solution walkthrough</h2>
<p>To build this architecture, build the network segmentation first, then the Amazon MQ brokers, and finally the network routing.</p>
<h3>Setup</h3>
<p>First, you need the following resources:</p>
<ul>
<li>A VPC</li>
<li>One private subnet per Availability Zone</li>
<li>One public subnet for your bastion host (if desired)</li>
</ul>
<p>This demonstration VPC uses the 20.0.0.0/16 CIDR range.</p>
<p>Additionally, you must create a custom security group for your brokers. Set up this security group to allow traffic from your Network Load Balancer and, if using a network of brokers, among the brokers as well.</p>
<p>This VPC is not being used for any other workloads. This demonstration allows all incoming traffic originating within the VPC, including the Network Load Balancer, through to the brokers on the following ports:</p>
<ul>
<li>OpenWire communication port of 61617</li>
<li>Apache ActiveMQ console port of 8162</li>
</ul>
<p>If you are using a different protocol, adjust the port numbers accordingly.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot1.png"><img loading="lazy" class="alignnone wp-image-7099 size-large" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot1-1024x433.png" alt="Create an amazon mq security group" width="1024" height="433" /></a></p>
<h3>Building the Amazon MQ brokers</h3>
<p>Now that you have the network segmentation set up, build the Amazon MQ brokers. As mentioned previously, this demonstration uses the active-standby pair of private brokers option.</p>
<p>Configure the broker settings by selecting a broker name, instance type, ActiveMQ console user, and password first.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot2.png"><img loading="lazy" class="alignnone wp-image-7100 size-large" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot2-1024x565.png" alt="Configure Amazon MQ broker settings" width="1024" height="565" /></a></p>
<p>In the <strong>Additional Settings</strong> area, place the brokers in your previously selected VPC and the associated private subnets.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot3.png"><img loading="lazy" class="alignnone wp-image-7101 size-large" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot3-1024x570.png" alt="Configure Amazon MQ additional settings" width="1024" height="570" /></a></p>
<p>Finally, select the existing <strong>Security Group</strong> previously discussed, and make sure that the <strong>Public Accessibility</strong> option is set to <strong>No</strong>.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot4.png"><img loading="lazy" class="alignnone wp-image-7102 size-large" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot4-1024x564.png" alt="Set Amazon MQ security group settings" width="1024" height="564" /></a></p>
<p>That’s it for the brokers. When it is done provisioning, the Amazon MQ dashboard should look like the one shown in the following screenshot. Note the IP addresses of the brokers and the ActiveMQ web console URLs for later.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot5.png"><img loading="lazy" class="alignnone wp-image-7103 size-large" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot5-1024x562.png" alt="Amazon MQ dashboard" width="1024" height="562" /></a></p>
<h3>Configuring a Load Balancer Target Group</h3>
<p>The next step in the build process is to configure the load balancer’s target group. This demonstration uses the private IP addresses of the brokers as targets for the Network Load Balancer.</p>
<p>Create and name a target group, select the <strong>IP</strong> option under <strong>Target type</strong>, and make sure to select <strong>TLS</strong> under <strong>Protocol</strong> and <strong>61617</strong> under <strong>Port</strong>, as well as the VPC in which your brokers reside. It is important to configure the health check settings so traffic is only routed to active brokers by selecting the TCP protocol and overriding the health check port to 8162, the Apache ActiveMQ console port.</p>
<p>Do not use the OpenWire port as the target group health check port. Because the Network Load Balancer may not be able to recognize the host as healthy on that port, it is better to use the ActiveMQ web console port.</p>
<p>Next, add the brokers’ IP addresses as targets. You can find the broker IP addresses in the Amazon MQ console page after they complete provisioning. Make sure to add both the active and the standby broker to the target group so that when reboots occur, the Network Load Balancer routes traffic to whichever broker is active.</p>
<p>You may be pursuing a more dynamic environment for scaling brokers up and down to handle the demands of a variable message load. In that case, as you scale to add more brokers, make sure that you also add them to the target group.</p>
<p><strong><a href="https://docs.aws.amazon.com/lambda/">AWS Lambda</a></strong> would be a great way to programmatically handle adding or removing the broker’s IP addresses to this target group automatically.</p>
<h3>Creating a Network Load Balancer</h3>
<p>Next, create a Network Load Balancer. This demo uses an internet-facing load balancer with TLS listeners on port 61617, and routes traffic to brokers’ VPC and private subnets.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot.png"><img loading="lazy" class="alignnone wp-image-7098 size-large" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot-1024x997.png" alt="Configure a network load balancer" width="1024" height="997" /></a></p>
<p>Clients must securely connect to the Network Load Balancer, so this demo uses an ACM certificate for the subdomain registered in Route 53, such as <em>mq.example.com</em>. For simplicity, ACM certificate provisioning is not shown. For more information, see <a href="https://docs.aws.amazon.com/acm/latest/userguide/gs-acm-request-public.html">Request a Public Certificate</a>.</p>
<p>Make sure that the ACM certificate is provisioned in the same Region as your Network Load Balancer, or the certificate is not displayed in the selection menu.</p>
<p>Next, select the target group that you just created, and select <strong>TLS</strong> for the connection between the Network Load Balancer and the brokers. Similarly, select the health checks on TCP port 8162.</p>
<p>If all went well, you see the list of brokers’ IP addresses listed as targets. From here, review your settings and confirm you’d like to deploy the Network Load Balancer.</p>
<h3>Configuring Route 53</h3>
<p>The last step in this build is to configure Route 53 to serve traffic at the subdomain of your choice to your Network Load Balancer.</p>
<p>Go to your Route 53 Hosted Zone, and create a new subdomain record set, such as <em>mq.example.com</em>, that matches the ACM certificate that you previously created. In the <strong>Type</strong> field, select <strong>A – IPv4 address</strong>, then select <strong>Yes</strong> for <strong>Alias</strong>. This allows you to select the Network Load Balancer as the alias target. Select the Network Load Balancer that you just created from the <strong>Alias Target</strong> menu and save the record set.</p>
<h2>Testing broker connectivity</h2>
<p>And that’s it!</p>
<p>There’s an important advantage to this architecture. When you create Amazon MQ active-standby brokers, the Amazon MQ service provides two endpoints. Only one broker host is active at a time, and when configuration changes or other reboot events occur, the standby broker becomes active and the active broker goes to standby. The typical connection string when there is an option to connect to multiple brokers is something similar to the following string</p>
<p><code>&quot;failover:(ssl://b-ce452fbe-2581-4003-8ce2-4185b1377b43-1.mq.us-west-2.amazonaws.com:61617,ssl://b-ce452fbe-2581-4003-8ce2-4185b1377b43-2.mq.us-west-2.amazonaws.com:61617)&quot;<br /> </code></p>
<p>In this architecture, you use only a single connection URL, but you still want to use the failover protocol to force re-connection if the connection is dropped for any reason.</p>
<p>For ease of use, this solution relies on the <a href="https://github.com/aws-samples/amazon-mq-workshop">Amazon MQ workshop</a> client application code from re:Invent 2018. To test this solution setting the connection URL to the following:</p>
<p><code>&quot;failover:(ssl://mq.example.com:61617</code></p>
<p>Run the producer and consumer clients in separate terminal windows.</p>
<p>The messages are sent and received successfully across the internet, while the brokers are hidden behind the Network Load Balancer.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot7.png"><img loading="lazy" class="alignnone size-full wp-image-7104" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot7.png" alt="" width="809" height="737" /></a></p>
<h3>Logging into the broker’s ActiveMQ console</h3>
<p>But what if we want to log in to the broker’s ActiveMQ web console?</p>
<p>There are three options. Due to the security group rules, only traffic originating from inside the VPC is allowed to the brokers.</p>
<ul>
<li>Use a VPN connection from the corporate network to the VPC. Most customers likely use this option, but for rapid testing, there is a simple and cost-effective method.</li>
<li>Connect to the brokers’ web console through a Route 53 subdomain, which requires creating a separate port 8162 Listener on the existing Network Load Balancer and creating a separate TLS target group on port 8162 for the brokers.</li>
<li>Use a bastion host to proxy traffic to the web console.</li>
</ul>
<p>To use a bastion host, create a small Linux EC2 instance in your public subnet, and make sure that:</p>
<ul>
<li>The EC2 instance has a public IP address.</li>
<li>You have access to the SSH key pair.</li>
<li>It is placed in a security group that allows SSH port 22 traffic from your location.</li>
</ul>
<p>For simplicity, this step is not shown, but this demonstration uses a t3.micro Amazon Linux 2 host with all default options as the bastion.</p>
<h3>Creating a forwarding tunnel</h3>
<p>Next, create a forwarding tunnel through an SSH connection to the bastion host. Below is an example command in the terminal window. This keeps a persistent SSH connection forwarding port 8162 through the bastion host at the public IP address 54.244.188.53.</p>
<p>For example, the command could be:</p>
<p><code>ssh -D 8162 -C -q -N -I &lt;my-key-pair-name&gt;.pem <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="5a3f3968772f293f281a">[email&#160;protected]</a>&lt;ec2-ip-address&gt;</code></p>
<p>You can also configure a browser to tunnel traffic through your proxy.</p>
<p>We have chosen to demonstrate in Firefox. Configure the network settings to use a manual proxy on localhost on the Apache ActiveMQ console port of 8162.&nbsp; This can be done by opening the Firefox <strong>Connection Settings.&nbsp; </strong>In the <strong>Configure Proxy Access to the Internet</strong> section, select <strong>Manual proxy configuration</strong>, then set the <strong>SOCKS Host</strong> to <strong>localhost</strong> and <strong>Port</strong> to <strong>8162</strong>, leaving other fields empty.</p>
<p>Finally, use the Apache ActiveMQ console URL provided in the Amazon MQ web console details page to connect to the broker through the proxy.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot8.png"><img loading="lazy" class="alignnone size-large wp-image-7105" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/09/10/screenshot8-1024x570.png" alt="ActiveMQ screenshot" width="1024" height="570" /></a></p>
<h2>Conclusion</h2>
<p>Congratulations! You’ve successfully built a highly available Amazon MQ broker pair in a private subnet. You’ve layered your security defense by putting the brokers behind a highly scalable Network Load Balancer, and you’ve configured routing from a single custom subdomain URL to multiple brokers with health check built in.</p>
<p>To learn more about Amazon MQ and scalable broker communication patterns, we highly recommend the following resources:</p>
<ul>
<li><a href="https://youtu.be/Z5CvI5yKA-E">Migration &amp; Messaging for Mission Critical Apps with S&amp;P Global Ratings</a></li>
<li><a href="https://aws.amazon.com/blogs/compute/tag/amazon-mq/">Amazon MQ at the AWS Compute Blog</a></li>
<li><a href="https://github.com/aws-samples/amazon-mq-workshop">Amazon MQ workshop</a></li>
</ul>
<p>Keep on building!</p>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/advanced-300/" rel="tag">Advanced (300)</a><a href="https://noise.getoto.net/tag/amazon-mq/" rel="tag">Amazon MQ*</a><a href="https://noise.getoto.net/tag/amazon-route-53/" rel="tag">Amazon Route 53</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a></span></footer></article>
<article id="post-723674" class="post-723674 post type-post status-publish format-standard hentry tag-advanced-300 tag-amazon-simple-queue-service-sqs tag-amazon-sqs tag-message-queues tag-messaging tag-serverless">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2019/07/25/simple-two-way-messaging-using-the-amazon-sqs-temporary-queue-client/" rel="bookmark">Simple Two-way Messaging using the Amazon SQS Temporary Queue Client</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2019/07/25/simple-two-way-messaging-using-the-amazon-sqs-temporary-queue-client/" rel="bookmark"><time class="entry-date" datetime="2019-07-25T21:09:56+03:00">2019-07-25</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/rachel-richardson/" rel="author">Rachel Richardson</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Rachel Richardson">Rachel Richardson</a> original <a href="https://aws.amazon.com/blogs/compute/simple-two-way-messaging-using-the-amazon-sqs-temporary-queue-client/">https://aws.amazon.com/blogs/compute/simple-two-way-messaging-using-the-amazon-sqs-temporary-queue-client/</a></p>
<p><em>This post is contributed by Robin Salkeld,&nbsp;<span class="optional-wrapper">Sr. Software Development Engineer</span></em></p>
<p><a href="https://aws.amazon.com/sqs/">Amazon SQS</a> is a fully managed message queuing service that makes it easy to decouple and scale microservices, distributed systems, and serverless applications. Asynchronous workflows have always been the primary use case for SQS. Using queues ensures one component can keep running smoothly without losing data when another component is unavailable or slow.</p>
<p>We were surprised, then, to discover that many customers use SQS in synchronous workflows. For example, many applications use queues to communicate between frontends and backends when processing a login request from a user.</p>
<p>Why would anyone use SQS for this? The service stores messages for up to 14 days with high durability, but messages in a synchronous workflow often must be processed within a few minutes, or even seconds. Why not just set up an HTTPS endpoint?</p>
<p>The more we talked to customers, the more we understood. Here’s what we learned:</p>
<ul>
<li>Creating a queue is often easier and faster than creating an HTTPS endpoint and the infrastructure necessary to ensure the endpoint’s scalability.</li>
<li>Queues are safe by default because they are locked down to the AWS account that created them. In addition, any DDoS attempt on your service is absorbed by SQS instead of loading down your own servers.</li>
<li>There is generally no need to create firewall rules for the communication between microservices if they use queues.</li>
<li>Although SQS provides durable storage (which isn’t necessary for short-lived messages), it is still a cost-effective solution for this use case. This is especially true when you consider all the messaging broker maintenance that is done for you.</li>
</ul>
<p>However, setting up efficient two-way communication through one-way queues requires some non-trivial client-side code. In our previous two-part post series on implementing enterprise integration patterns with AWS messaging services, <a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-point-to-point-channels/">Point-to-point channels</a> and <a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-publish-subscribe-channels/">Publish-subscribe channels</a>, we discussed the <a href="https://www.enterpriseintegrationpatterns.com/patterns/messaging/ReturnAddress.html">Request-Response Messaging Pattern</a>. In this pattern, each requester creates a <em>temporary destination</em> to receive each response message.</p>
<p>The simplest approach is to create a new queue for each response, but this is like building a road just so a single car can drive on it before tearing it down. Technically, this can work (and SQS can create and delete queues quickly), but we can definitely make it faster and cheaper.</p>
<p>To better support short-lived, lightweight messaging destinations, we are pleased to present the <a href="https://github.com/awslabs/amazon-sqs-java-temporary-queues-client">Amazon SQS Temporary Queue Client</a>. This client makes it easy to create and delete many temporary messaging destinations without inflating your AWS bill.</p>
<h1>Virtual queues</h1>
<p>The key concept behind the client is the <em>virtual queue</em>. Virtual queues let you multiplex many low-traffic queues onto a single SQS queue. Creating a virtual queue only instantiates a local buffer to hold messages for consumers as they arrive; there is no API call to SQS and no costs associated with creating a virtual queue.</p>
<p>The Temporary Queue Client includes the AmazonSQSVirtualQueuesClient class for creating and managing virtual queues. This class implements the AmazonSQS interface and adds support for attributes related to virtual queues. You can create a virtual queue using this client by calling the CreateQueue API action and including the HostQueueURL queue attribute. This attribute specifies the existing SQS queue on which to host the virtual queue. The queue URL for a virtual queue is in the form &lt;host queue URL&gt;#&lt;virtual queue name&gt;. For example:</p>
<p><code>https://sqs.us-east-2.amazonaws.com/123456789012/MyQueue#MyVirtualQueueName</code></p>
<p>When you call the SendMessage or SendMessageBatch API actions on AmazonSQSVirtualQueuesClient with a virtual queue URL, the client first extracts the virtual queue name. It then attaches this name as an additional message attribute to each message, and sends the messages to the host queue. When you call the ReceiveMessage API action on a virtual queue, the calling thread waits for messages to appear in the in-memory buffer for the virtual queue. Meanwhile, a background thread polls the host queue and dispatches messages to these buffers according to the additional message attribute.</p>
<p>This mechanism is similar to how the <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-client-side-buffering-request-batching.html">AmazonSQSBufferedAsyncClient</a> prefetches messages, and the benefits are similar. A single call to SQS can provide messages for up to 10 virtual queues, reducing the API calls that you pay for by up to a factor of ten. Deleting a virtual queue simply removes the client-side resources used to implement them, again without making API calls to SQS.</p>
<p>The diagram below illustrates the end-to-end process for sending messages through virtual queues:</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/07/24/pic1.png"><img loading="lazy" class="alignnone size-large wp-image-6809" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2019/07/24/pic1-1024x644.png" alt="Sending messages through virtual queues" width="1024" height="644" /></a></p>
<p>Virtual queues are similar to virtual machines. Just as a virtual machine provides the same experience as a physical machine, a virtual queue divides the resources of a single SQS queue into smaller logical queues. This is ideal for temporary queues, since they frequently only receive a handful of messages in their lifetime. Virtual queues are currently implemented entirely within the Temporary Queue Client, but additional support and optimizations might be added to SQS itself in the future.</p>
<p>In most cases, you don’t have to manage virtual queues yourself. The library also includes the AmazonSQSTemporaryQueuesClient class. This class automatically creates virtual queues when the CreateQueue API action is called and creates host queues on demand for all queues with the same queue attributes. To optimize existing application code that creates and deletes queues, you can use this class as a drop-in replacement implementation of the AmazonSQS interface.</p>
<p>The client also includes the AmazonSQSRequester and AmazonSQSResponder interfaces, which enable two-way communication through SQS queues. The following is an example of an RPC implementation for a web application’s login process.</p>
<pre><code class="lang-java">/**
 * This class handles a user's login request on the client side.
 */
public class LoginClient {

    // The SQS queue to send the requests to.
    private final String requestQueueUrl;

    // The AmazonSQSRequester creates a temporary queue for each response.
    private final AmazonSQSRequester sqsRequester = AmazonSQSRequesterClientBuilder.defaultClient();

    private final LoginClient(String requestQueueUrl) {
        this.requestQueueUrl = requestQueueUrl;
    }

    /**
     * Send a login request to the server.
     */
    public String login(String body) throws TimeoutException {
        SendMessageRequest request = new SendMessageRequest()
                .withMessageBody(body)
                .withQueueUrl(requestQueueUrl);

        // This:
        //  - creates a temporary queue
        //  - attaches its URL as an attribute on the message
        //  - sends the message
        //  - receives the response from the temporary queue
        //  - deletes the temporary queue
        //  - returns the response
        //
        // If something goes wrong and the server's response never shows up, this method throws a
        // TimeoutException.
        Message response = sqsRequester.sendMessageAndGetResponse(request, 20, TimeUnit.SECONDS);
        
        return response.getBody();
    }
}

/**
 * This class processes users' login requests on the server side.
 */
public class LoginServer {

    // The SQS queue to poll for login requests.
    // Assume that on construction a thread is created to poll this queue and call
    // handleLoginRequest() below for each message.
    private final String requestQueueUrl;

    // The AmazonSQSResponder sends responses to the correct response destination.
    private final AmazonSQSResponder sqsResponder = AmazonSQSResponderClientBuilder.defaultClient();

    private final AmazonSQS(String requestQueueUrl) {
        this.requestQueueUrl = requestQueueUrl;
    }

    /**
     * Handle a login request sent from the client above.
     */
    public void handleLoginRequest(Message message) {
        // Assume doLogin does the actual work, and returns a serialized result
        String response = doLogin(message.getBody());

        // This extracts the URL of the temporary queue from the message attribute and sends the
        // response to that queue.
        sqsResponder.sendResponseMessage(MessageContent.fromMessage(message), new MessageContent(response));  
    }
}</code></pre>
<h2>Cleaning up</h2>
<p>As with any other AWS SDK client, your code should call the shutdown() method when the temporary queue client is no longer needed. The AmazonSQSRequester interface also provides a shutdown() method, which shuts down its internal temporary queue client. This ensures that the in-memory resources needed for any virtual queues are reclaimed, and that the host queue that the client automatically created is also deleted automatically.</p>
<p>However, in the world of distributed systems things are a little more complex. Processes can run out of memory and crash, and hosts can reboot suddenly and unexpectedly. There are even cases where you don’t have the opportunity to run custom code on shutdown.</p>
<p>The Temporary Queue Client client addresses this issue as well. For each host queue with recent API calls, the client periodically uses the TagQueue API action to attach a fresh tag value that indicates the queue is still being used. The tagging process serves as a heartbeat to keep the queue alive. According to a configurable time period (by default, 5 minutes), a background thread uses the ListQueues API action to obtain the URLs of all queues with the configured prefix. Then, it deletes each queue that has not been tagged recently. The mechanism is similar to how the <a href="https://aws.amazon.com/blogs/database/building-distributed-locks-with-the-dynamodb-lock-client/">Amazon DynamoDB Lock Client</a> expires stale lock leases.</p>
<p>If you use the AmazonSQSTemporaryQueuesClient directly, you can customize how long queues must be idle before they is deleted by configuring the IdleQueueRetentionPeriodSeconds queue attribute. The client supports setting this attribute on both host queues and virtual queues. For virtual queues, setting this attribute ensures that the in-memory resources do not become a memory leak in the presence of application bugs.</p>
<p>Any API call to a queue marks it as non-idle, including ReceiveMessage calls that don’t return any messages. The only reason to increase the retention period attribute is to give the client more time when it can’t send heartbeats—for example, due to garbage collection pauses or networking issues.</p>
<p>But what if you want to use this client in a fleet of a thousand EC2 instances? Won’t every client spend a lot of time checking every queue for idleness? Doesn’t that imply duplicate work that increases as the fleet is scaled up?</p>
<p>We thought of this too. The Temporary Queue Client creates a shared queue for all clients using the same queue prefix, and uses this queue as a work queue for the distributed task. Instead of every client calling the ListQueues API action every five minutes, a new <em>seed message</em> (which triggers the sweeping process) is sent to this queue every five minutes.</p>
<p>When one of the clients receives this message, it calls the ListQueues API action and sends each queue URL in the result as another kind of message to the same shared work queue. The work of actually checking each queue for idleness is distributed roughly evenly to the active clients, ensuring scalability. There is even a mechanism that works around the fact that the ListQueues API action currently only returns no more than 1,000 queue URLs at time.</p>
<h2>Summary</h2>
<p>We are excited about how the new <a href="https://github.com/awslabs/amazon-sqs-java-temporary-queues-client">Amazon SQS Temporary Queue Client</a> makes more messaging patterns easier and cheaper for you. Download the code from GitHub, have a look at <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-temporary-queues.html">Temporary Queues</a> in the <em>Amazon SQS Developer Guide</em>, try out the client, and let us know what you think!</p>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/advanced-300/" rel="tag">Advanced (300)</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service-sqs/" rel="tag">Amazon Simple Queue Service (SQS)</a><a href="https://noise.getoto.net/tag/amazon-sqs/" rel="tag">Amazon SQS</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a><a href="https://noise.getoto.net/tag/serverless/" rel="tag">serverless</a></span></footer></article>
<article id="post-492697" class="post-492697 post type-post status-publish format-standard hentry tag-amazon-mq tag-amazon-simple-notification-service-sns tag-amazon-simple-queue-service-sqs tag-amazon-sns tag-amazon-sqs tag-application-integration tag-enterprise-strategy tag-message-queues tag-message-topics tag-messaging">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2018/11/22/implementing-enterprise-integration-patterns-with-aws-messaging-services-point-to-point-channels/" rel="bookmark">Implementing enterprise integration patterns with AWS messaging services: point-to-point channels</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2018/11/22/implementing-enterprise-integration-patterns-with-aws-messaging-services-point-to-point-channels/" rel="bookmark"><time class="entry-date" datetime="2018-11-22T22:07:34+02:00">2018-11-22</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/rachel-richardson/" rel="author">Rachel Richardson</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Rachel Richardson">Rachel Richardson</a> original <a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-point-to-point-channels/">https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-point-to-point-channels/</a></p>
<p><em>This post is courtesy of&nbsp;Christian Mueller, Sr. Solutions Architect, AWS and&nbsp;Dirk Fr&ouml;hner, S<span class="optional-wrapper">r. Solutions Architect,&nbsp;</span><span class="optional-wrapper">AWS</span></em></p>
<p>At <a href="https://aws.amazon.com/">AWS</a>, we see our customers increasingly moving toward managed services to reduce the time and money that they spend managing infrastructure. This also applies to the messaging domain, where AWS provides a collection of managed services.</p>
<p>Asynchronous messaging is a fundamental approach for integrating independent systems or building up a set of loosely coupled systems that can scale and evolve independently and flexibly. The well-known collection of <a href="http://www.enterpriseintegrationpatterns.com/">enterprise integration patterns</a> (EIPs) provides a “technology-independent vocabulary” to “design and document integration solutions.” This blog is the first of two that describes how you can implement the core EIPs using AWS messaging services. Let’s first look at the relevant <a href="https://aws.amazon.com/messaging/">AWS messaging services</a>.</p>
<p>When organizations migrate their traditional messaging and existing applications to the cloud gradually, they usually want to do it without rewriting their code. <a href="https://aws.amazon.com/amazon-mq/">Amazon MQ</a> is a managed message broker service for <a href="http://activemq.apache.org/">Apache ActiveMQ</a> that makes it easy to set up and operate message brokers in the cloud. It supports industry-standard APIs and protocols such as JMS, AMQP, and MQTT, so you can switch from any standards-based message broker to Amazon MQ without rewriting the messaging code in your applications. Amazon MQ is recommended if you’re using messaging with existing applications and want to move your messaging to the cloud without rewriting existing code.</p>
<p>However, if you build new applications for the cloud, we recommend that you consider using cloud-native messaging services such as <a href="https://aws.amazon.com/sqs/">Amazon SQS</a> and <a href="https://aws.amazon.com/sns/">Amazon SNS</a>. These serverless, fully managed message queue and topic services scale to meet your demands and provide simple, easy-to-use APIs. You can use Amazon SQS and Amazon SNS to decouple and scale microservices, distributed systems, and serverless applications and improve overall reliability.</p>
<p>This blog looks at the first part of some fundamental integration patterns. We describe the patterns and apply them to these AWS messaging services. This will help you apply the right pattern to your use case and architect for scale in a secure and cost-efficient manner. For all variants, we employ both traditional and cloud-native messaging services: Amazon MQ for the former and Amazon SQS and Amazon SNS for the latter.</p>
<h2>Integration Patterns</h2>
<p>Let’s start with some fundamental integration patterns.</p>
<h3>Message exchange patterns</h3>
<p>First, we inspect the two major message exchange patterns: one-way and request-response.</p>
<h4>One-way messaging</h4>
<p>Applying one-way messaging, a message producer (sender) sends out a message to a messaging channel and doesn’t expect or want a response from whatever process (receiver) consumed the message. Examples of one-way messaging include a data transfer and a notification about an event that happened.</p>
<h4>Request-response messaging</h4>
<p>With request-response messaging, a message producer (requester) sends out a message: for example, a command to instruct the responder to execute something. The requester expects a response from each message consumer (responder) who received that message, likely to know what the result of all executions was. To know where to send the response message to, the request message contains a return address that the responder uses. To make sure that the requester can assign an incoming response to a request, the requester adds a correlation identifier to the request, which the responders echo in their responses.</p>
<h3>Messaging channels: point-to-point</h3>
<p>Next, we look at the point-to-point messaging channel, one of the most important patterns for messaging channels. We will continue our consideration with <a href="https://aws.amazon.com/pub-sub-messaging/">publish-subscribe</a> in our <a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-publish-subscribe-channels/">second post</a>.</p>
<p>A point-to-point channel is usually implemented by message queues. Message queues operate so that any given message is only consumed by one receiver, although multiple receivers can be connected to the queue. The queue ensures once-only consumption. Messages are usually buffered in queues so that they’re available for consumption for a certain amount of time, even if no receiver is currently connected.</p>
<p>Point-to-point channels are often used for loosely coupled message transmission, though there are two other common uses. First, it can support horizontal scaling of message processing on the receiver side. Depending on the message load in the channel, the number of receiver processes can be elastically adjusted to cope with the load as needed. The queue acts as a buffering load balancer. Second, it can flatten peak loads of messages and prevent your receivers from being flooded when you can’t scale out fast enough or you don’t want additional scaling.</p>
<h2>Integration scenarios</h2>
<p>In this section, we apply these fundamental patterns to AWS messaging services. The code examples are written in Java, but only by author preference. You can implement the same integration scenarios in C++, .NET, Node.js, Python, Ruby, Go, and other programming languages that <a href="https://aws.amazon.com/tools/#sdk">AWS provides an SDK</a> and an <a href="http://activemq.apache.org/cross-language-clients.html">Apache Active MQ client library</a> is available for.</p>
<h3>Point-to-point channels: one-way messaging</h3>
<p>The diagrams in the following subsections show the principle of one-way messaging for point-to-point channels, using Amazon MQ queues and Amazon SQS queues. The sender produces a message and sends it into a queue, and the receiver consumes the message from the queue for processing. For traditional messaging (that is, Amazon MQ), the senders and consumers can use protocols such as JMS or AMQP. For cloud-native messaging, they can use the Amazon SQS API.</p>
<h4>Traditional messaging</h4>
<p>To follow this example, open the <a href="https://console.aws.amazon.com/amazon-mq/home">Amazon MQ console</a> and <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-creating-configuring-broker.html">create a broker</a>.&nbsp;In the following diagram we see the above explained components for the traditional messaging scenario: A sender sends messages into an Amazon MQ queue, a receiver consumes messages from that queue.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Point-to-point-traditional-messaging.jpg"><img loading="lazy" class="alignnone size-large wp-image-5593" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Point-to-point-traditional-messaging-1024x380.jpg" alt="Point to point traditional messaging" width="1024" height="380" /></a></p>
<p>In the following code example, sender and receiver are using the Apache Active MQ client library and the standard Java messaging service (JMS) API to send and receive messages to and from an Amazon MQ queue. You can run the code on every Amazon compute service, your on-premises data center, or your personal computer. For simplicity, the code launches sender and receiver in the same Java virtual machine (JVM).</p>
<pre><code class="lang-java">public class PointToPointOneWayTraditional {

    public static void main(String... args) throws Exception {
        ActiveMQSslConnectionFactory connFact = new ActiveMQSslConnectionFactory(&quot;failover:(ssl://&lt;broker-1&gt;.amazonaws.com:61617,ssl://&lt;broker-2&gt;.amazonaws.com:61617)&quot;);
        connFact.setConnectResponseTimeout(10000);
        Connection conn = connFact.createConnection(&quot;user&quot;, &quot;password&quot;);
        conn.setClientID(&quot;PointToPointOneWayTraditional&quot;);
        conn.start();

        new Thread(new Receiver(conn.createSession(false, Session.CLIENT_ACKNOWLEDGE), &quot;Queue.PointToPoint.OneWay.Traditional&quot;)).start();
        new Thread(new Sender(conn.createSession(false, Session.CLIENT_ACKNOWLEDGE), &quot;Queue.PointToPoint.OneWay.Traditional&quot;)).start();
    }

    public static class Sender implements Runnable {

        private Session session;
        private String destination;

        public Sender(Session session, String destination) {
            this.session = session;
            this.destination = destination;
        }

        public void run() {
            try {
                MessageProducer messageProducer = session.createProducer(session.createQueue(destination));
                long counter = 0;

                while (true) {
                    TextMessage message = session.createTextMessage(&quot;Message &quot; + ++counter);
                    message.setJMSMessageID(UUID.randomUUID().toString());
                    messageProducer.send(message);
                }
            } catch (JMSException e) {
                throw new RuntimeException(e);
            }
        }
    }

    public static class Receiver implements Runnable, MessageListener {

        private Session session;
        private String destination;

        public Receiver(Session session, String destination) {
            this.session = session;
            this.destination = destination;
        }

        public void run() {
            try {
                MessageConsumer consumer = session.createConsumer(session.createQueue(destination));
                consumer.setMessageListener(this);
            } catch (JMSException e) {
                throw new RuntimeException(e);
            }
        }

        public void onMessage(Message message) {
            try {
                System.out.println(String.format(&quot;received message '%s' with message id '%s'&quot;, ((TextMessage) message).getText(), message.getJMSMessageID()));
                message.acknowledge();
            } catch (JMSException e) {
                throw new RuntimeException(e);
            }
        }
    }
}</code></pre>
<h4>Cloud-native messaging</h4>
<p>To follow this example, open the <a href="https://console.aws.amazon.com/sqs/home">Amazon SQS console</a>&nbsp;and <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-create-queue.html">create a standard SQS queue</a>, using the queue name P2POneWayCloudNative. &nbsp;In the following diagram we see the above explained components for the cloud-native messaging scenario: A sender sends messages into an Amazon SQS queue, a receiver consumes messages from that queue.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Point-to-point-cloud-native-messaging.jpg"><img loading="lazy" class="alignnone size-large wp-image-5594" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Point-to-point-cloud-native-messaging-1024x371.jpg" alt="Point to point cloud-native messaging" width="1024" height="371" /></a></p>
<p>&nbsp;</p>
<p>In the sample code below, the example sender is using the AWS SDK for Java to send messages to an Amazon SQS queue, running in an endless loop. You can run the code on every Amazon compute service, your on-premises data center, or your personal computer.</p>
<pre><code class="lang-java">public class PointToPointOneWayCloudNative {

    public static void main(String... args) throws Exception {
        final AmazonSQS sqs = AmazonSQSClientBuilder.standard().build();

        new Thread(new Sender(sqs, &quot;https://sqs.&lt;region&gt;.amazonaws.com/&lt;account-number&gt;/P2POneWayCloudNative&quot;)).start();
    }

    public static class Sender implements Runnable {

        private AmazonSQS sqs;
        private String destination;

        public Sender(AmazonSQS sqs, String destination) {
            this.sqs = sqs;
            this.destination = destination;
        }

        public void run() {
            long counter = 0;

            while (true) {
                sqs.sendMessage(
                    new SendMessageRequest()
                        .withQueueUrl(destination)
                        .withMessageBody(&quot;Message &quot; + ++counter)
                        .addMessageAttributesEntry(&quot;MessageID&quot;, new MessageAttributeValue().withDataType(&quot;String&quot;).withStringValue(UUID.randomUUID().toString())));
            }
        }
    }
}</code></pre>
<p>We implement the receiver below in a serverless manner as an <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> function, using Amazon SQS as the event source. The name of the SQS queue is configured outside the function’s code, which is why it doesn’t appear in this code example.</p>
<pre><code class="lang-java">public class Receiver implements RequestHandler&lt;SQSEvent, Void&gt; {

    @Override
    public Void handleRequest(SQSEvent request, Context context) {
        for (SQSEvent.SQSMessage message: request.getRecords()) {
            System.out.println(String.format(&quot;received message '%s' with message id '%s'&quot;, message.getBody(), message.getMessageAttributes().get(&quot;MessageID&quot;).getStringValue()));
        }

        return null;
    }
}</code></pre>
<p>If this approach is new to you, you can find more details in <a href="https://aws.amazon.com/blogs/aws/aws-lambda-adds-amazon-simple-queue-service-to-supported-event-sources/">AWS Lambda Adds Amazon Simple Queue Service to Supported Event Sources</a>. Using Lambda comes with a number of benefits. For example, you don’t have to manage the compute environment for the receiver, and you can use an event (or push) model instead of having to poll for new messages.</p>
<h3>Point-to-point channels: request-response messaging</h3>
<p>In addition to the one-way scenario, we have a return channel option. We would now call the involved processes rather than the requester and responder. The requester sends a message into the request queue, and the responder sends the response into the response queue. Remember that the requester enriches the message with a return address (the name of the response queue) so that the responder knows where to send the response to. The requester also sends a correlation ID that the responder copies into the response message so that the requester can match the incoming response with a request.</p>
<h4>Traditional messaging</h4>
<p>In this example, we reuse the Amazon MQ broker that we set up earlier. In the following diagram we see the above explained components for the traditional messaging scenario, using an Amazon MQ queue each for the request messages and for the response messages.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Point-to-point-request-response-traditional-messaging.jpg"><img loading="lazy" class="alignnone size-large wp-image-5595" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Point-to-point-request-response-traditional-messaging-1024x380.jpg" alt="Point to point request response traditional messaging" width="1024" height="380" /></a></p>
<p>Using Amazon MQ, we don’t have to create queues explicitly because they’re implicitly created as needed when we start sending messages to them. This example is similar to the point-to-point one-way traditional example.</p>
<pre><code class="lang-java">public class PointToPointRequestResponseTraditional {

    public static void main(String... args) throws Exception {
        ActiveMQSslConnectionFactory connFact = new ActiveMQSslConnectionFactory(&quot;failover:(ssl://&lt;broker-1&gt;.amazonaws.com:61617,ssl://&lt;broker-2&gt;.amazonaws.com:61617)&quot;);
        connFact.setConnectResponseTimeout(10000);
        Connection conn = connFact.createConnection(&quot;user&quot;, &quot;password&quot;);
        conn.setClientID(&quot;PointToPointRequestResponseTraditional&quot;);
        conn.start();

        new Thread(new Responder(conn.createSession(false, Session.CLIENT_ACKNOWLEDGE), &quot;Queue.PointToPoint.RequestResponse.Traditional&quot;)).start();
        new Thread(new Requester(conn.createSession(false, Session.CLIENT_ACKNOWLEDGE), &quot;Queue.PointToPoint.RequestResponse.Traditional&quot;)).start();
    }

    public static class Requester implements Runnable {

        private Session session;
        private String destination;

        public Requester(Session session, String destination) {
            this.session = session;
            this.destination = destination;
        }

        public void run() {
            MessageProducer messageProducer = null;
            try {
                messageProducer = session.createProducer(session.createQueue(destination));
                long counter = 0;

                while (true) {
                    TemporaryQueue replyTo = session.createTemporaryQueue();
                    String correlationId = UUID.randomUUID().toString();
                    TextMessage message = session.createTextMessage(&quot;Message &quot; + ++counter);
                    message.setJMSMessageID(UUID.randomUUID().toString());
                    message.setJMSCorrelationID(correlationId);
                    message.setJMSReplyTo(replyTo);
                    messageProducer.send(message);

                    MessageConsumer consumer = session.createConsumer(replyTo, &quot;JMSCorrelationID='&quot; + correlationId + &quot;'&quot;);
                    try {
                        Message receivedMessage = consumer.receive(5000);
                        System.out.println(String.format(&quot;received message '%s' with message id '%s'&quot;, ((TextMessage) receivedMessage).getText(), receivedMessage.getJMSMessageID()));
                        receivedMessage.acknowledge();
                    } finally {
                        if (consumer != null) {
                            consumer.close();
                        }
                    }
                }
            } catch (JMSException e) {
                throw new RuntimeException(e);
            }
        }
    }

    public static class Responder implements Runnable, MessageListener {

        private Session session;
        private String destination;

        public Responder(Session session, String destination) {
            this.session = session;
            this.destination = destination;
        }

        public void run() {
            try {
                MessageConsumer consumer = session.createConsumer(session.createQueue(destination));
                consumer.setMessageListener(this);
            } catch (JMSException e) {
                throw new RuntimeException(e);
            }
        }

        public void onMessage(Message message) {
            try {
                String correlationId = message.getJMSCorrelationID();
                Destination replyTo = message.getJMSReplyTo();

                TextMessage responseMessage = session.createTextMessage(((TextMessage) message).getText() + &quot; with CorrelationID &quot; + correlationId);
                responseMessage.setJMSMessageID(UUID.randomUUID().toString());
                responseMessage.setJMSCorrelationID(correlationId);

                MessageProducer messageProducer = session.createProducer(replyTo);
                try {
                    messageProducer.send(responseMessage);

                    message.acknowledge();
                } finally {
                    if (messageProducer != null) {
                        messageProducer.close();
                    }
                }
            } catch (JMSException e) {
                throw new RuntimeException(e);
            }
        }
    }
}</code></pre>
<h4>Cloud-native messaging</h4>
<p>Open the <a href="https://console.aws.amazon.com/sqs/home">Amazon SQS console</a> and create two standard SQS queues using the queue names P2PReqRespCloudNative and P2PReqRespCloudNative-Resp. In the following diagram we see the above explained components for the cloud-native scenario, using an Amazon SQS queue each for the request messages and for the response messages.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Point-to-point-request-response-cloud-native-messaging.jpg"><img loading="lazy" class="alignnone size-large wp-image-5596" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Point-to-point-request-response-cloud-native-messaging-1024x405.jpg" alt="Point to point request response cloud native messaging" width="1024" height="405" /></a></p>
<p>The following example requester is almost identical to the point-to-point one-way cloud-native example sender. It also provides a reply-to address and a correlation ID.</p>
<pre><code class="lang-java">public class PointToPointRequestResponseCloudNative {

    public static void main(String... args) throws Exception {
        final AmazonSQS sqs = AmazonSQSClientBuilder.standard().build();

        new Thread(new Requester(sqs, &quot;https://sqs.&lt;region&gt;.amazonaws.com/&lt;account-number&gt;/P2PReqRespCloudNative&quot;, &quot;https://sqs.&lt;region&gt;.amazonaws.com/&lt;account-number&gt;/P2PReqRespCloudNative-Resp&quot;)).start();
    }

    public static class Requester implements Runnable {

        private AmazonSQS sqs;
        private String destination;
        private String replyDestination;
        private Map&lt;String, SendMessageRequest&gt; inflightMessages = new ConcurrentHashMap&lt;&gt;();

        public Requester(AmazonSQS sqs, String destination, String replyDestination) {
            this.sqs = sqs;
            this.destination = destination;
            this.replyDestination = replyDestination;
        }

        public void run() {
            long counter = 0;

            while (true) {
                String correlationId = UUID.randomUUID().toString();
                SendMessageRequest request = new SendMessageRequest()
                    .withQueueUrl(destination)
                    .withMessageBody(&quot;Message &quot; + ++counter)
                    .addMessageAttributesEntry(&quot;CorrelationID&quot;, new MessageAttributeValue().withDataType(&quot;String&quot;).withStringValue(correlationId))
                    .addMessageAttributesEntry(&quot;ReplyTo&quot;, new MessageAttributeValue().withDataType(&quot;String&quot;).withStringValue(replyDestination));
                sqs.sendMessage(request);

                inflightMessages.put(correlationId, request);

                ReceiveMessageResult receiveMessageResult = sqs.receiveMessage(
                    new ReceiveMessageRequest()
                        .withQueueUrl(replyDestination)
                        .withMessageAttributeNames(&quot;CorrelationID&quot;)
                        .withMaxNumberOfMessages(5)
                        .withWaitTimeSeconds(2));

                for (Message receivedMessage : receiveMessageResult.getMessages()) {
                    System.out.println(String.format(&quot;received message '%s' with message id '%s'&quot;, receivedMessage.getBody(), receivedMessage.getMessageId()));

                    String receivedCorrelationId = receivedMessage.getMessageAttributes().get(&quot;CorrelationID&quot;).getStringValue();
                    SendMessageRequest originalRequest = inflightMessages.remove(receivedCorrelationId);
                    System.out.println(String.format(&quot;Corresponding request message '%s'&quot;, originalRequest.getMessageBody()));

                    sqs.deleteMessage(
                        new DeleteMessageRequest()
                            .withQueueUrl(replyDestination)
                            .withReceiptHandle(receivedMessage.getReceiptHandle()));
                }
            }
        }
    }
}</code></pre>
<p>The following example responder is almost identical to the point-to-point one-way cloud-native example receiver. It also creates a message and sends it back to the reply-to address provided in the received message.</p>
<pre><code class="lang-java">public class Responder implements RequestHandler&lt;SQSEvent, Void&gt; {

    private final AmazonSQS sqs = AmazonSQSClientBuilder.standard().build();

    @Override
    public Void handleRequest(SQSEvent request, Context context) {
        for (SQSEvent.SQSMessage message: request.getRecords()) {
            System.out.println(String.format(&quot;received message '%s' with message id '%s'&quot;, message.getBody(), message.getMessageId()));
            String correlationId = message.getMessageAttributes().get(&quot;CorrelationID&quot;).getStringValue();
            String replyTo = message.getMessageAttributes().get(&quot;ReplyTo&quot;).getStringValue();

            System.out.println(String.format(&quot;sending message with correlation id '%s' to '%s'&quot;, correlationId, replyTo));
            sqs.sendMessage(
                new SendMessageRequest()
                    .withQueueUrl(replyTo)
                    .withMessageBody(message.getBody() + &quot; with CorrelationID &quot; + correlationId)
                    .addMessageAttributesEntry(&quot;CorrelationID&quot;, new MessageAttributeValue().withDataType(&quot;String&quot;).withStringValue(correlationId)));
        }

        return null;
    }
}</code></pre>
<h2>Go build!</h2>
<p>We look forward to hearing about what you build and will continue innovating our services on your behalf.</p>
<h3>Additional resources</h3>
<ul>
<li><a href="https://aws.amazon.com/blogs/aws/amazon-mq-managed-message-broker-service-for-activemq/">Amazon MQ – Managed Message Broker Service for ActiveMQ</a></li>
<li><a href="https://aws.amazon.com/blogs/compute/running-activemq-in-a-hybrid-cloud-environment-with-amazon-mq/">Running ActiveMQ in a Hybrid Cloud Environment with Amazon MQ</a></li>
<li><a href="https://github.com/aws-samples/amazon-mq-workshop/blob/master/README.md">Amazon MQ Workshop</a> on the GitHub website</li>
<li><a href="https://aws.amazon.com/blogs/compute/invoking-aws-lambda-from-amazon-mq/">Invoking AWS Lambda from Amazon MQ</a></li>
<li><a href="https://aws.amazon.com/blogs/aws/aws-lambda-adds-amazon-simple-queue-service-to-supported-event-sources/">AWS Lambda Adds Amazon Simple Queue Service to Supported Event Sources</a></li>
</ul>
<h3>What’s next?</h3>
<p>We have introduced the first fundamental EIPs and shown how you can apply them to the AWS messaging services. If you are keen to dive deeper, continue reading with the second part of this series, where we will cover publish-subscribe messaging.</p>
<h4><a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-publish-subscribe-channels/">Read Part 2: Publish-Subscribe Messaging</a></h4>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/amazon-mq/" rel="tag">Amazon MQ*</a><a href="https://noise.getoto.net/tag/amazon-simple-notification-service-sns/" rel="tag">Amazon Simple Notification Service (SNS)</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service-sqs/" rel="tag">Amazon Simple Queue Service (SQS)</a><a href="https://noise.getoto.net/tag/amazon-sns/" rel="tag">Amazon SNS</a><a href="https://noise.getoto.net/tag/amazon-sqs/" rel="tag">Amazon SQS</a><a href="https://noise.getoto.net/tag/application-integration/" rel="tag">Application Integration</a><a href="https://noise.getoto.net/tag/enterprise-strategy/" rel="tag">Enterprise Strategy*</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/message-topics/" rel="tag">message topics</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a></span></footer></article>
<article id="post-492699" class="post-492699 post type-post status-publish format-standard hentry tag-amazon-mq tag-amazon-simple-notification-service-sns tag-amazon-simple-queue-service-sqs tag-amazon-sns tag-amazon-sqs tag-enterprise-strategy tag-message-queues tag-message-topics tag-messaging">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2018/11/22/implementing-enterprise-integration-patterns-with-aws-messaging-services-publish-subscribe-channels/" rel="bookmark">Implementing enterprise integration patterns with AWS messaging services: publish-subscribe channels</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2018/11/22/implementing-enterprise-integration-patterns-with-aws-messaging-services-publish-subscribe-channels/" rel="bookmark"><time class="entry-date" datetime="2018-11-22T22:07:17+02:00">2018-11-22</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/rachel-richardson/" rel="author">Rachel Richardson</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Rachel Richardson">Rachel Richardson</a> original <a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-publish-subscribe-channels/">https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-publish-subscribe-channels/</a></p>
<p><em>This post is courtesy of&nbsp;Christian Mueller, Sr. Solutions Architect, AWS and&nbsp;Dirk Fr&ouml;hner, Sr. Solutions Architect,&nbsp;AWS</em></p>
<p>In this blog, we look at the second part of some fundamental <a href="http://www.enterpriseintegrationpatterns.com/">enterprise integration patterns</a> and how you can implement them with <a href="https://aws.amazon.com/messaging/">AWS messaging services</a>. If you missed the first part, we encourage you to start there.</p>
<p><strong><a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-point-to-point-channels/">Read Part 1: Point-to-Point Messaging</a></strong></p>
<h2>Integration patterns</h2>
<h3>Messaging channels: publish-subscribe</h3>
<p>As mentioned in the <a href="https://aws.amazon.com/blogs/compute/implementing-enterprise-integration-patterns-with-aws-messaging-services-point-to-point-channels/">first blog</a>, we continue with the second major messaging channel pattern: publish-subscribe.</p>
<p>A publish-subscribe channel is usually implemented using message topics. In this model, any message published to a topic is immediately received by all of the subscribers of the topic (unless you have applied the message filter pattern). However, if there is no subscriber, messages are usually discarded. The durable subscriber pattern describes an exception where messages are kept for a while in case the subscriber is offline. Publish-subscribe is used when multiple parties are interested in certain messages. Sometimes, this pattern is also referred to as fan-out.</p>
<p>Let’s apply this pattern to the different AWS messaging services and get our hands dirty. To follow our examples, sign in to your AWS account (or create an account as described in <a href="https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/">How do I create and activate a new Amazon Web Services account?</a>).</p>
<h2>Integration scenarios</h2>
<h3>Publish-subscribe channels: one-way messaging</h3>
<p>Publish-subscribe one-way patterns are often involved in notification style use cases, where the publisher sends out an event and doesn’t care who is interested in this event. For example, <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html">Amazon CloudWatch Events</a> publishes state changes in the environment, and you can subscribe and act accordingly.</p>
<p>The diagrams in the following subsections show the principles of one-way messaging for publish-subscribe channels, using both <a href="https://aws.amazon.com/amazon-mq/">Amazon MQ</a> and <a href="https://aws.amazon.com/sns/">Amazon SNS</a> topics. A publisher produces a message and sends it into a topic, and subscribers consume the message from the topic for processing.</p>
<p>For traditional messaging, senders and consumers can use API protocols such JMS or AMQP. For cloud-native messaging, they can use the Amazon SNS API.</p>
<h4>Traditional messaging</h4>
<p>In this example, we reuse the Amazon MQ broker we set up in part one of this blog. As we can see in the following diagram, messages as published into an Amazon MQ topic and multiple subscribers can consume messages from it.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Publish-Subscribe-One-Way-Traditional-Messaging.jpg"><img loading="lazy" class="alignnone size-large wp-image-5604" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Publish-Subscribe-One-Way-Traditional-Messaging-1024x363.jpg" alt="Publish Subscribe One Way Traditional Messaging" width="1024" height="363" /></a></p>
<p>This example is similar to the point-to-point one-way traditional example using the <a href="http://activemq.apache.org/cross-language-clients.html">Apache Active MQ client library</a>, but we use topics instead of queues, as shown in the following code.</p>
<pre><code class="lang-java">public class PublishSubscribeOneWayTraditional {

    public static void main(String... args) throws Exception {
        ActiveMQSslConnectionFactory connFact = new ActiveMQSslConnectionFactory(&quot;failover:(ssl://&lt;broker-1&gt;.amazonaws.com:61617,ssl://&lt;broker-2&gt;.amazonaws.com:61617)&quot;);
        connFact.setConnectResponseTimeout(10000);
        Connection conn = connFact.createConnection(&quot;user&quot;, &quot;password&quot;);
        conn.setClientID(&quot;PubSubOneWayTraditional&quot;);
        conn.start();

        new Thread(new Subscriber(conn.createSession(false, Session.CLIENT_ACKNOWLEDGE), &quot;Topic.PubSub.OneWay.Traditional&quot;)).start();
        new Thread(new Publisher(conn.createSession(false, Session.CLIENT_ACKNOWLEDGE), &quot;Topic.PubSub.OneWay.Traditional&quot;)).start();
    }

    public static class Publisher implements Runnable {

        private Session session;
        private String destination;

        public Sender(Session session, String destination) {
            this.session = session;
            this.destination = destination;
        }

        public void run() {
            try {
                MessageProducer messageProducer = session.createProducer(session.createTopic(destination));
                long counter = 0;

                while (true) {
                    TextMessage message = session.createTextMessage(&quot;Message &quot; + ++counter);
                    message.setJMSMessageID(UUID.randomUUID().toString());
                    messageProducer.send(message);
                }
            } catch (JMSException e) {
                throw new RuntimeException(e);
            }
        }
    }

    public static class Subscriber implements Runnable, MessageListener {

        private Session session;
        private String destination;

        public Receiver(Session session, String destination) {
            this.session = session;
            this.destination = destination;
        }

        public void run() {
            try {
                MessageConsumer consumer = session.createDurableSubscriber(session.createTopic(destination), &quot;subscriber-1&quot;);
                consumer.setMessageListener(this);
            } catch (JMSException e) {
                throw new RuntimeException(e);
            }
        }

        public void onMessage(Message message) {
            try {
                System.out.println(String.format(&quot;received message '%s' with message id '%s'&quot;, ((TextMessage) message).getText(), message.getJMSMessageID()));
                message.acknowledge();
            } catch (JMSException e) {
                throw new RuntimeException(e);
            }
        }
    }
}</code></pre>
<h4>Cloud-native messaging</h4>
<p>To follow a similar example using Amazon SNS, open the <a href="https://console.aws.amazon.com/sns/home">Amazon SNS console</a> and <a href="https://docs.aws.amazon.com/sns/latest/dg/sns-getting-started.html#CreateTopic">create an Amazon SNS topic</a> named PubSubOneWayCloudNative. The below diagram illustrates that a publisher sends messages into an Amazon SNS topic which are consumed by subscribers of this topic.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Publish-Subscribe-One-Way-Cloud-Native-Messaging.jpg"><img loading="lazy" class="alignnone size-large wp-image-5605" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Publish-Subscribe-One-Way-Cloud-Native-Messaging-1024x355.jpg" alt="Publish Subscribe One Way Cloud Native Messaging" width="1024" height="355" /></a></p>
<p>We use the <a href="https://aws.amazon.com/sdk-for-java/">AWS SDK for Java</a> to send messages to our Amazon SNS topic, running in an endless loop. You can run the following code on every Amazon compute service, your on-premises data center, or your personal computer.</p>
<pre><code class="lang-java">public class PublishSubscribeOneWayCloudNative {

    public static void main(String... args) throws Exception {
        final AmazonSNS sns = AmazonSNSClientBuilder.standard().build();

        new Thread(new Publisher(sns, &quot;arn:aws:sns:&lt;region&gt;:&lt;account-number&gt;:PubSubOneWayCloudNative&quot;)).start();
    }

    public static class Publisher implements Runnable {

        private AmazonSNS sns;
        private String destination;

        public Sender(AmazonSNS sns, String destination) {
            this.sns = sns;
            this.destination = destination;
        }

        public void run() {
            long counter = 0;

            while (true) {
                sns.publish(
                    new PublishRequest()
                        .withTargetArn(destination)
                        .withSubject(&quot;PubSubOneWayCloudNative sample&quot;)
                        .withMessage(&quot;Message &quot; + ++counter)
                        .addMessageAttributesEntry(&quot;MessageID&quot;, new MessageAttributeValue().withDataType(&quot;String&quot;).withStringValue(UUID.randomUUID().toString())));
            }
        }
    }
}</code></pre>
<p>The subscriber is implemented as an <a href="https://aws.amazon.com/lambda">AWS Lambda</a> function, using Amazon SNS as the event source. For more information on how to set this up, see <a href="https://docs.aws.amazon.com/sns/latest/dg/sns-lambda.html">Using Amazon SNS for System-to-System Messaging with a Lambda Function as a Subscriber</a>.</p>
<pre><code class="lang-java">public class Subscriber implements RequestHandler&lt;SNSEvent, Void&gt; {

    @Override
    public Void handleRequest(SNSEvent request, Context context) {
        for (SNSEvent.SNSRecord record: request.getRecords()) {
            SNS sns = record.getSNS();

            System.out.println(String.format(&quot;received message '%s' with message id '%s'&quot;, sns.getMessage(), sns.getMessageAttributes().get(&quot;MessageID&quot;).getValue()));
        }

        return null;
    }
}</code></pre>
<h3>Publish-subscribe channels: request-response messaging</h3>
<p>Publish-subscribe request-response patterns are beneficial in use cases where it’s important to communicate with multiple services that do their work in parallel, but all their responses need to be aggregated afterward. One example is an order service, which needs to enrich the order message with data from multiple backend services.</p>
<p>The diagrams in the following subsections show the principles of request-response messaging for publish-subscribe channels, using both Amazon MQ and Amazon SNS topics. A publisher produces a message and sends it into a topic, and subscribers consume the message from the topic for processing.</p>
<p>Although we use a publish-subscribe channel for the request messages, we would usually use a point-to-point channel for the response messages. This assumes that the requester application or at least a dedicated application is the one entity that works on processing all the responses.</p>
<h4>Traditional messaging</h4>
<p>As we can see in the following diagram, a Amazon MQ topic is used to send out all the request messages, while all the response messages are sent into an Amazon MQ queue.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Publish-Subscribe-Request-Response-Traditional-Messaging.jpg"><img loading="lazy" class="alignnone size-large wp-image-5606" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Publish-Subscribe-Request-Response-Traditional-Messaging-1024x363.jpg" alt="Publish Subscribe Request Response Traditional Messaging" width="1024" height="363" /></a></p>
<p>In our code sample below, we use two responders.</p>
<pre><code class="lang-java">public class PublishSubscribeRequestResponseTraditional {

    public static void main(String... args) throws Exception {
        ActiveMQSslConnectionFactory connFact = new ActiveMQSslConnectionFactory(&quot;failover:(ssl://&lt;broker-1&gt;.amazonaws.com:61617,ssl://&lt;broker-2&gt;.amazonaws.com:61617)&quot;);
        connFact.setConnectResponseTimeout(10000);
        Connection conn = connFact.createConnection(&quot;user&quot;, &quot;password&quot;);
        conn.setClientID(&quot;PubSubReqRespTraditional&quot;);
        conn.start();

        new Thread(new Responder(conn.createSession(false, Session.CLIENT_ACKNOWLEDGE), &quot;Topic.PubSub.ReqResp.Traditional&quot;, &quot;subscriber-1&quot;)).start();
        new Thread(new Responder(conn.createSession(false, Session.CLIENT_ACKNOWLEDGE), &quot;Topic.PubSub.ReqResp.Traditional&quot;, &quot;subscriber-2&quot;)).start();
        new Thread(new Requester(conn.createSession(false, Session.CLIENT_ACKNOWLEDGE), &quot;Topic.PubSub.ReqResp.Traditional&quot;)).start();
    }

    public static class Requester implements Runnable {

        private Session session;
        private String destination;

        public Requester(Session session, String destination) {
            this.session = session;
            this.destination = destination;
        }

        public void run() {
            MessageProducer messageProducer = null;
            try {
                messageProducer = session.createProducer(session.createTopic(destination));
                long counter = 0;

                while (true) {
                    TemporaryQueue replyTo = session.createTemporaryQueue();
                    String correlationId = UUID.randomUUID().toString();
                    TextMessage message = session.createTextMessage(&quot;Message &quot; + ++counter);
                    message.setJMSMessageID(UUID.randomUUID().toString());
                    message.setJMSCorrelationID(correlationId);
                    message.setJMSReplyTo(replyTo);
                    messageProducer.send(message);

                    MessageConsumer consumer = session.createConsumer(replyTo, &quot;JMSCorrelationID='&quot; + correlationId + &quot;'&quot;);
                    try {
                        Message receivedMessage1 = consumer.receive(5000);
                        Message receivedMessage2 = consumer.receive(5000);
                        System.out.println(String.format(&quot;received 2 messages '%s' and '%s'&quot;, ((TextMessage) receivedMessage1).getText(), ((TextMessage) receivedMessage2).getText()));
                        receivedMessage2.acknowledge();
                    } finally {
                        if (consumer != null) {
                            consumer.close();
                        }
                    }
                }
            } catch (JMSException e) {
                throw new RuntimeException(e);
            }
        }
    }

    public static class Responder implements Runnable, MessageListener {

        private Session session;
        private String destination;
        private String name;

        public Responder(Session session, String destination, String name) {
            this.session = session;
            this.destination = destination;
            this.name = name;
        }

        public void run() {
            try {
                MessageConsumer consumer = session.createDurableSubscriber(session.createTopic(destination), name);
                consumer.setMessageListener(this);
            } catch (JMSException e) {
                throw new RuntimeException(e);
            }
        }

        public void onMessage(Message message) {
            try {
                String correlationId = message.getJMSCorrelationID();
                Destination replyTo = message.getJMSReplyTo();

                TextMessage responseMessage = session.createTextMessage(((TextMessage) message).getText() + &quot; from responder &quot; + name);
                responseMessage.setJMSMessageID(UUID.randomUUID().toString());
                responseMessage.setJMSCorrelationID(correlationId);

                MessageProducer messageProducer = session.createProducer(replyTo);
                try {
                    messageProducer.send(responseMessage);

                    message.acknowledge();
                } finally {
                    if (messageProducer != null) {
                        messageProducer.close();
                    }
                }
            } catch (JMSException e) {
                throw new RuntimeException(e);
            }
        }
    }
}</code></pre>
<h4>Cloud-native messaging</h4>
<p>To implement a similar pattern with Amazon SNS, open the <a href="https://console.aws.amazon.com/sns/home">Amazon SNS console</a> and create a new SNS topic named PubSubReqRespCloudNative. Then open the <a href="https://console.aws.amazon.com/sqs/home">Amazon SQS console</a> and create a standard SQS queue named PubSubReqRespCloudNative-Resp. The following diagram illustrates that we now use an Amazon SNS topic for request messages and an Amazon SQS queue for response messages.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Publish-Subscribe-Request-Response-Cloud-Native-Messaging.jpg"><img loading="lazy" class="alignnone size-large wp-image-5607" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/11/19/Publish-Subscribe-Request-Response-Cloud-Native-Messaging-1024x350.jpg" alt="Publish Subscribe Request Response Cloud Native Messaging" width="1024" height="350" /></a></p>
<p>This example requester is almost identical to the publish-subscribe one-way cloud-native example sender. The requester also specifies a reply-to address and a correlation ID as message attributes. This way, responders know where to send the responses to, and the receiver of the responses can assign them accordingly.</p>
<pre><code class="lang-java">public class PublishSubscribeReqRespCloudNative {

    public static void main(String... args) throws Exception {
        final AmazonSNS sns = AmazonSNSClientBuilder.standard().build();
        final AmazonSQS sqs = AmazonSQSClientBuilder.standard().build();

        new Thread(new Requester(sns, sqs, &quot;arn:aws:sns:&lt;region&gt;:&lt;account-number&gt;:PubSubReqRespCloudNative&quot;, &quot;https://sqs.&lt;region&gt;.amazonaws.com/&lt;account-number&gt;/PubSubReqRespCloudNative-Resp&quot;)).start();
    }

    public static class Requester implements Runnable {

        private AmazonSNS sns;
        private AmazonSQS sqs;
        private String destination;
        private String replyDestination;
        private Map&lt;String, PublishRequest&gt; inflightMessages = new ConcurrentHashMap&lt;&gt;();

        public Requester(AmazonSNS sns, AmazonSQS sqs, String destination, String replyDestination) {
            this.sns = sns;
            this.sqs = sqs;
            this.destination = destination;
            this.replyDestination = replyDestination;
        }

        public void run() {
            long counter = 0;

            while (true) {
                String correlationId = UUID.randomUUID().toString();
                PublishRequest request = new PublishRequest()
                    .withTopicArn(destination)
                    .withMessage(&quot;Message &quot; + ++counter)
                    .addMessageAttributesEntry(&quot;CorrelationID&quot;, new MessageAttributeValue().withDataType(&quot;String&quot;).withStringValue(correlationId))
                    .addMessageAttributesEntry(&quot;ReplyTo&quot;, new MessageAttributeValue().withDataType(&quot;String&quot;).withStringValue(replyDestination));
                sns.publish(request);

                inflightMessages.put(correlationId, request);

                ReceiveMessageResult receiveMessageResult = sqs.receiveMessage(
                    new ReceiveMessageRequest()
                        .withQueueUrl(replyDestination)
                        .withMessageAttributeNames(&quot;CorrelationID&quot;)
                        .withMaxNumberOfMessages(5)
                        .withWaitTimeSeconds(2));

                for (Message receivedMessage : receiveMessageResult.getMessages()) {
                    System.out.println(String.format(&quot;received message '%s' with message id '%s'&quot;, receivedMessage.getBody(), receivedMessage.getMessageId()));

                    String receivedCorrelationId = receivedMessage.getMessageAttributes().get(&quot;CorrelationID&quot;).getStringValue();
                    PublishRequest originalRequest = inflightMessages.remove(receivedCorrelationId);
                    System.out.println(String.format(&quot;Corresponding request message '%s'&quot;, originalRequest.getMessage()));

                    sqs.deleteMessage(
                        new DeleteMessageRequest()
                            .withQueueUrl(replyDestination)
                            .withReceiptHandle(receivedMessage.getReceiptHandle()));
                }
            }
        }
    }
}</code></pre>
<p>This example responder is almost identical to the publish-subscribe one-way cloud-native example receiver. It also creates a message, enriches it with the correlation ID, and sends it back to the reply-to address provided in the received message.</p>
<pre><code class="lang-java">public class Responder implements RequestHandler&lt;SNSEvent, Void&gt; {

    private final AmazonSQS sqs = AmazonSQSClientBuilder.standard().build();

    @Override
    public Void handleRequest(SNSEvent request, Context context) {
        for (SNSEvent.SNSRecord record: request.getRecords()) {
            System.out.println(String.format(&quot;received record '%s' with message id '%s'&quot;, record.getSNS().getMessage(), record.getSNS().getMessageId()));
            String correlationId = record.getSNS().getMessageAttributes().get(&quot;CorrelationID&quot;).getValue();
            String replyTo = record.getSNS().getMessageAttributes().get(&quot;ReplyTo&quot;).getValue();

            System.out.println(String.format(&quot;sending message with correlation id '%s' to '%s'&quot;, correlationId, replyTo));
            sqs.sendMessage(
                new SendMessageRequest()
                    .withQueueUrl(replyTo)
                    .withMessageBody(record.getSNS().getMessage() + &quot; with CorrelationID &quot; + correlationId)
                    .addMessageAttributesEntry(&quot;CorrelationID&quot;, new MessageAttributeValue().withDataType(&quot;String&quot;).withStringValue(correlationId)));
        }

        return null;
    }
}</code></pre>
<h2>Go Build!</h2>
<p>We look forward to hearing about what you build and will continue innovating our services on your behalf.</p>
<h3>Additional Resources</h3>
<ul>
<li><a href="https://aws.amazon.com/blogs/mobile/invoking-aws-lambda-functions-via-amazon-sns/">Invoking AWS Lambda functions via Amazon SNS</a></li>
<li><a href="https://aws.amazon.com/blogs/compute/messaging-fanout-pattern-for-serverless-architectures-using-amazon-sns/">Messaging Fanout Pattern for Serverless Architectures Using Amazon SNS</a></li>
</ul>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/amazon-mq/" rel="tag">Amazon MQ*</a><a href="https://noise.getoto.net/tag/amazon-simple-notification-service-sns/" rel="tag">Amazon Simple Notification Service (SNS)</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service-sqs/" rel="tag">Amazon Simple Queue Service (SQS)</a><a href="https://noise.getoto.net/tag/amazon-sns/" rel="tag">Amazon SNS</a><a href="https://noise.getoto.net/tag/amazon-sqs/" rel="tag">Amazon SQS</a><a href="https://noise.getoto.net/tag/enterprise-strategy/" rel="tag">Enterprise Strategy*</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/message-topics/" rel="tag">message topics</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a></span></footer></article>
<article id="post-399135" class="post-399135 post type-post status-publish format-standard hentry tag-activemq tag-amazon-mq tag-message-queues tag-message-topics tag-messaging tag-migration">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2018/06/26/migrating-from-rabbitmq-to-amazon-mq/" rel="bookmark">Migrating from RabbitMQ to Amazon MQ</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2018/06/26/migrating-from-rabbitmq-to-amazon-mq/" rel="bookmark"><time class="entry-date" datetime="2018-06-26T20:09:28+03:00">2018-06-26</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/rachel-richardson/" rel="author">Rachel Richardson</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Rachel Richardson">Rachel Richardson</a> original <a href="https://aws.amazon.com/blogs/compute/migrating-from-rabbitmq-to-amazon-mq/">https://aws.amazon.com/blogs/compute/migrating-from-rabbitmq-to-amazon-mq/</a></p>
<p><em>This post is courtesy of Sam Dengler, AWS Solutions Architect.</em></p>
<p>Message brokers can be used to solve a number of needs in enterprise architectures, including managing workload queues and broadcasting messages to a number of subscribers. Some AWS customers are using RabbitMQ today and would like to migrate to a managed service to reduce the overhead of operating their own message broker.</p>
<p><a href="https://aws.amazon.com/amazon-mq/">Amazon MQ</a> is a managed message broker service for <a href="http://activemq.apache.org/">Apache ActiveMQ</a> that makes it easier to operate and scale message brokers in the cloud. Amazon MQ provides compatibility with your existing workloads that use standard&nbsp;protocols such as OpenWire, AMQP, MQTT, and Stomp (all enabled with SSL). Amazon MQ automatically provisions&nbsp;infrastructure configured as a single-instance broker or as an active/standby broker for high availability.</p>
<p>In this post, I describe how to launch a new Amazon MQ instance. I review example Java code to migrate from a&nbsp;<a href="https://www.rabbitmq.com/">RabbitMQ</a> to Amazon MQ message broker using clients for ActiveMQ, <a href="https://qpid.apache.org/components/jms/index.html">Apache Qpid JMS</a>,&nbsp;and <a href="https://spring.io/guides/gs/messaging-jms/">Spring JmsTemplates</a>. I also review best practices for Amazon MQ and changes from RabbitMQ to Amazon MQ to support Publish/Subscribe message patterns.</p>
<h2>Getting started with Amazon MQ</h2>
<p>To start, open the <a href="https://console.aws.amazon.com/amazon-mq">Amazon MQ console</a>. Enter a broker name and choose&nbsp;<strong>Next step</strong>.</p>
<p>Launch a new Amazon MQ instance, choosing the <strong>mq.t2.micro</strong> instance type and <strong>Single-instance broker</strong> deployment mode, creating a user name and password, and choosing <strong>Create broker</strong>.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/06/11/Migrating-from-Rabbit-MQ-to-AMQ-1.jpg"><img loading="lazy" class="alignnone size-full wp-image-4493" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/06/11/Migrating-from-Rabbit-MQ-to-AMQ-1.jpg" alt="" width="701" height="1042" /></a></p>
<p>After several minutes, your instance changes status from <strong>Creation in progress</strong> to <strong>Running</strong>. &nbsp;You can visit the <strong>Details</strong> page of your broker to retrieve connection information, including a link to the ActiveMQ web console where you can monitor the status of your instance queues, etc. In the following code examples, you use the OpenWire and AMQP endpoints.</p>
<p>To be able to access your broker, you must configure one of your security groups to allow inbound traffic. For more information, see the link to&nbsp;<strong>Detailed instructions</strong>&nbsp;in the blue box in the <strong>Connections</strong> section.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/06/11/Migrating-from-Rabbit-MQ-to-AMQ-2.jpg"><img loading="lazy" class="alignnone size-large wp-image-4494" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/06/11/Migrating-from-Rabbit-MQ-to-AMQ-2-596x1024.jpg" alt="" width="596" height="1024" /></a></p>
<p>Now that your Amazon MQ broker is running, let’s look at some code!</p>
<h3>Dependencies</h3>
<p>The following code examples have dependencies across a range of libraries in order to demonstrate RabbitMQ, ActiveMQ, Qpid, Spring JMS templates, and connection pooling. I’ve listed all the dependencies in a single Maven pom.xml:</p>
<pre><code class="lang-java">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;MyGroup&lt;/groupId&gt;
    &lt;artifactId&gt;MyArtifact&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;dependencies&gt;
    
        &lt;!-- RabbitMQ --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.rabbitmq&lt;/groupId&gt;
            &lt;artifactId&gt;amqp-client&lt;/artifactId&gt;
            &lt;version&gt;5.1.2&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Apache Connection Pooling --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
            &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;
            &lt;version&gt;2.2&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;
            &lt;artifactId&gt;activemq-pool&lt;/artifactId&gt;
            &lt;version&gt;5.15.0&lt;/version&gt;
        &lt;/dependency&gt;
        
        &lt;!-- Apache ActiveMQ --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;
            &lt;artifactId&gt;activemq-client&lt;/artifactId&gt;
            &lt;version&gt;5.15.0&lt;/version&gt;
        &lt;/dependency&gt;
        
        &lt;!-- Apache QPid --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.qpid&lt;/groupId&gt;
            &lt;artifactId&gt;qpid-client&lt;/artifactId&gt;
            &lt;version&gt;6.3.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.qpid&lt;/groupId&gt;
            &lt;artifactId&gt;qpid-jms-client&lt;/artifactId&gt;
            &lt;version&gt;0.29.0&lt;/version&gt;
        &lt;/dependency&gt;
                
        &lt;!-- Spring JmsTemplate --&gt;
         &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-jms&lt;/artifactId&gt;
            &lt;version&gt;5.0.3.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;
        
        &lt;!-- Logging --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
            &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
            &lt;version&gt;1.7.25&lt;/version&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;
&lt;/project&gt;</code></pre>
<h2>RabbitMQ</h2>
<p>Here’s an example using RabbitMQ to send and receive a message via queue. The installation and configuration of RabbitMQ is out of scope for this post. For instructions for downloading and installing RabbitMQ, see&nbsp;<a href="https://www.rabbitmq.com/download.html">Downloading and Installing RabbitMQ</a>.</p>
<p>RabbitMQ uses the AMQP&nbsp;0-9-1 protocol by default, with support for AMQP 1.0 via a <a href="https://www.rabbitmq.com/plugins.html">plugin</a>. The RabbitMQ examples in this post use the AMQP 0-9</p>
<h3>RabbitMQ queue example</h3>
<p>To start, here’s some sample code to send and receive a message in RabbitMQ using a queue.</p>
<pre><code class="lang-java">import java.io.IOException;
import java.net.URISyntaxException;
import java.security.KeyManagementException;
import java.security.NoSuchAlgorithmException;
import java.util.concurrent.TimeoutException;

import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import com.rabbitmq.client.GetResponse;

public class RabbitMQExample {

    private static final boolean ACKNOWLEDGE_MODE = true;

    // The Endpoint, Username, Password, and Queue should be externalized and
    // configured through environment variables or dependency injection.
    private static final String ENDPOINT;
    private static final String USERNAME;
    private static final String PASSWORD;
    private static final String QUEUE = &quot;MyQueue&quot;;

    public static void main(String[] args) throws KeyManagementException, NoSuchAlgorithmException, URISyntaxException, IOException, TimeoutException {
        // Create a connection factory.
        ConnectionFactory connectionFactory = new ConnectionFactory();
        connectionFactory.setUri(ENDPOINT);

        // Specify the username and password.
        connectionFactory.setUsername(USERNAME);
        connectionFactory.setPassword(PASSWORD);

        // Establish a connection for the producer.
        Connection producerConnection = connectionFactory.newConnection();

        // Create a channel for the producer.
        Channel producerChannel = producerConnection.createChannel();

        // Create a queue named &quot;MyQueue&quot;.
        producerChannel.queueDeclare(QUEUE, false, false, false, null);

        // Create a message.
        String text = &quot;Hello from RabbitMQ!&quot;;

        // Send the message.
        producerChannel.basicPublish(&quot;&quot;, QUEUE, null, text.getBytes());
        System.out.println(&quot;Message sent: &quot; + text);

        // Clean up the producer.
        producerChannel.close();
        producerConnection.close();

        // Establish a connection for the consumer.
        Connection consumerConnection = connectionFactory.newConnection();

        // Create a channel for the consumer.
        Channel consumerChannel = consumerConnection.createChannel();

        // Create a queue named &quot;MyQueue&quot;.
        consumerChannel.queueDeclare(QUEUE, false, false, false, null);

        // Receive the message.
        GetResponse response = consumerChannel.basicGet(QUEUE, ACKNOWLEDGE_MODE);
        String message = new String(response.getBody(), &quot;UTF-8&quot;);
        System.out.println(&quot;Message received: &quot; + message);

        // Clean up the consumer.
        consumerChannel.close();
        consumerConnection.close();
    }
}</code></pre>
<p><code class="lang-xml"></code></p>
<p>In this example, you need to specify the&nbsp;<strong>ENDPOINT</strong>, <strong>USERNAME</strong>, and <strong>PASSWORD</strong>&nbsp;for your RabbitMQ message broker using environment variables or dependency injection.</p>
<p>This example uses the RabbitMQ client library to establish connectivity to the message broker and a channel for communication. In RabbitMQ, messages are sent over the channel to a named queue, which stores messages in a buffer, and from which consumers can receive and process messages. In this example, you publish a message using the&nbsp;<a href="https://www.rabbitmq.com/releases/rabbitmq-java-client/v3.6.5/rabbitmq-java-client-javadoc-3.6.5/com/rabbitmq/client/Channel.html#basicPublish(java.lang.String,%20java.lang.String,%20com.rabbitmq.client.AMQP.BasicProperties,%20byte%5B%5D)">Channel.basicPublish</a>&nbsp;method, using the default exchange, identified by an empty string (“”).</p>
<p>To receive and process the messages in the queue, create a second connection, channel, and&nbsp;queue. Queue declaration is an idempotent operation, so there is no harm in declaring it twice. In this example, you receive the message using the&nbsp;<a href="https://www.rabbitmq.com/releases/rabbitmq-java-client/v3.6.5/rabbitmq-java-client-javadoc-3.6.5/com/rabbitmq/client/Channel.html#basicGet(java.lang.String,%20boolean)">Channel.basicGet</a>&nbsp;method, automatically acknowledging message receipt to the broker.</p>
<p>This example demonstrates the basics of sending and receiving a message of one type. However, what if you wanted to publish messages of different types such that various consumers could subscribe only to pertinent message types (that is, pub/sub)? &nbsp;Here’s a RabbitMQ example using topic exchanges to route messages to different queues.</p>
<h3>RabbitMQ topic example</h3>
<p>This example is similar to the one earlier. To enable topic publishing, specify two additional properties:&nbsp;<strong>EXCHANGE</strong> and <strong>ROUTING_KEY</strong>. RabbitMQ uses the exchange and routing key properties for routing messaging. Look at how these properties change the code to publish a message.</p>
<pre><code class="lang-java">import java.io.IOException;
import java.net.URISyntaxException;
import java.security.KeyManagementException;
import java.security.NoSuchAlgorithmException;
import java.util.concurrent.TimeoutException;

import com.rabbitmq.client.BuiltinExchangeType;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;
import com.rabbitmq.client.GetResponse;

public class RabbitMQExample {

    private static final boolean ACKNOWLEDGE_MODE = true;

    // The Endpoint, Username, Password, Queue, Exhange, and Routing Key should
    // be externalized and configured through environment variables or
    // dependency injection.
    private static final String ENDPOINT; // &quot;amqp://localhost:5672&quot;
    private static final String USERNAME;
    private static final String PASSWORD;
    private static final String QUEUE = &quot;MyQueue&quot;;
    private static final String EXCHANGE = &quot;MyExchange&quot;;
    private static final String ROUTING_KEY = &quot;MyRoutingKey&quot;;
    
    public static void main(String[] args) throws KeyManagementException, NoSuchAlgorithmException, URISyntaxException, IOException, TimeoutException {
        // Create a connection factory.
        ConnectionFactory connectionFactory = new ConnectionFactory();
        connectionFactory.setUri(ENDPOINT);

        // Specify the username and password.
        connectionFactory.setUsername(USERNAME);
        connectionFactory.setPassword(PASSWORD);

        // Establish a connection for the producer.
        Connection producerConnection = connectionFactory.newConnection();

        // Create a channel for the producer.
        Channel producerChannel = producerConnection.createChannel();

        // Create a queue named &quot;MyQueue&quot;.
        producerChannel.queueDeclare(QUEUE, false, false, false, null);

        // Create an exchange named &quot;MyExchange&quot;.
        producerChannel.exchangeDeclare(EXCHANGE, BuiltinExchangeType.TOPIC);

        // Bind &quot;MyQueue&quot; to &quot;MyExchange&quot;, using routing key &quot;MyRoutingKey&quot;.
        producerChannel.queueBind(QUEUE, EXCHANGE, ROUTING_KEY);

        // Create a message.
        String text = &quot;Hello from RabbitMQ!&quot;;

        // Send the message.
        producerChannel.basicPublish(EXCHANGE, ROUTING_KEY, null, text.getBytes());
        System.out.println(&quot;Message sent: &quot; + text);

        // Clean up the producer.
        producerChannel.close();
        producerConnection.close();
        
        ...</code></pre>
<p><code class="lang-xml"><br /> </code></p>
<p>As before, you establish a connection to the RabbitMQ message broker, a channel for communication, and a queue to buffer messages for consumption. In addition to these components, you declare an explicit exchange of type&nbsp;<strong>BuiltinExchangeType.TOPIC</strong>&nbsp;and bind the queue to the exchange using the&nbsp;<strong>ROUTING_KEY</strong>&nbsp;that filters messages to send to the queue.</p>
<p>Again, publish a message using the&nbsp;<a href="https://www.rabbitmq.com/releases/rabbitmq-java-client/current-javadoc/com/rabbitmq/client/Channel.html#basicPublish-java.lang.String-java.lang.String-com.rabbitmq.client.AMQP.BasicProperties-byte:A-">Channel.basicPublish</a>&nbsp;method. This time, instead of publishing the message to a queue, specify the EXCHANGE and ROUTING_KEY values for the message. RabbitMQ uses these properties to route the message to the appropriate queue, from which a consumer receives the message using the same code from the first example.</p>
<h2>JMS API</h2>
<p>Now that you’ve seen examples for queue and topic publishing in RabbitMQ, look at code changes to support Amazon MQ, starting with the ActiveMQ client. But first, a quick review of the <a href="https://en.wikipedia.org/wiki/Java_Message_Service">Java Messaging Service (JMS) API</a>.</p>
<p>The remainder of the examples in this post use the&nbsp;JMS API, which abstracts messaging methods from underlying protocol and client implementations. The <a href="https://docs.oracle.com/javaee/6/tutorial/doc/bnceh.html">JMS API programming model</a>&nbsp;uses a combination of connection factories,&nbsp;connections, sessions, destinations,&nbsp;message producers,&nbsp;and message consumers to send and receive messages. The following image (from <a href="https://docs.oracle.com/javaee/6/tutorial/doc/bnceh.html">The Java EE 6 Tutorial</a>) shows the relationship between these components:</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/06/11/Migrating-from-Rabbit-MQ-to-AMQ-3.jpg"><img loading="lazy" class="alignnone size-full wp-image-4495" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/06/11/Migrating-from-Rabbit-MQ-to-AMQ-3.jpg" alt="" width="445" height="369" /></a></p>
<h3>ActiveMQ OpenWire connectivity to Amazon MQ</h3>
<p>Here’s how JMS is used with ActiveMQ to send and receive messages on a queue.</p>
<p>The ActiveMQ client uses the OpenWire protocol, supported by Amazon MQ. The OpenWire protocol can be found in your Amazon MQ broker’s endpoint list (screenshot). It requires that the security group for the Amazon MQ be open for the ActiveMQ OpenWire protocol endpoint port,&nbsp;<strong>61617</strong>.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/06/11/Migrating-from-Rabbit-MQ-to-AMQ-4.jpg"><img loading="lazy" class="alignnone size-full wp-image-4496" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/06/11/Migrating-from-Rabbit-MQ-to-AMQ-4.jpg" alt="" width="895" height="474" /></a></p>
<h3>ActiveMQ queue example</h3>
<p>Next, here’s an example to send and receive messages to Amazon MQ using the ActiveMQ client. This example should look familiar, as it follows the same flow to send and receive messages via a queue. I’ve included the example in full and then highlighted the differences to consider when migrating from RabbitMQ.</p>
<pre><code class="lang-java">import javax.jms.Connection;
import javax.jms.DeliveryMode;
import javax.jms.Destination;
import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.MessageConsumer;
import javax.jms.MessageProducer;
import javax.jms.Session;
import javax.jms.TextMessage;

import org.apache.activemq.ActiveMQConnectionFactory;
import org.apache.activemq.jms.pool.PooledConnectionFactory;

public class ActiveMQClientExample {

    private static final int DELIVERY_MODE = DeliveryMode.NON_PERSISTENT;
    private static final int ACKNOWLEDGE_MODE = Session.AUTO_ACKNOWLEDGE;

    // The Endpoint, Username, Password, and Queue should be externalized and
    // configured through environment variables or dependency injection.
    private static final String ENDPOINT; // &quot;ssl://x-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx-x.mq.us-east-1.amazonaws.com:61617&quot;
    private static final String USERNAME;
    private static final String PASSWORD;
    private static final String QUEUE = &quot;MyQueue&quot;;
    
    public static void main(String[] args) throws JMSException {
        // Create a connection factory.
        ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(ENDPOINT);

        // Specify the username and password.
        connectionFactory.setUserName(USERNAME);
        connectionFactory.setPassword(PASSWORD);

        // Create a pooled connection factory.
        PooledConnectionFactory pooledConnectionFactory = new PooledConnectionFactory();
        pooledConnectionFactory.setConnectionFactory(connectionFactory);
        pooledConnectionFactory.setMaxConnections(10);

        // Establish a connection for the producer.
        Connection producerConnection = pooledConnectionFactory.createConnection();
        producerConnection.start();

        // Create a session.
        Session producerSession = producerConnection.createSession(false, ACKNOWLEDGE_MODE);

        // Create a queue named &quot;MyQueue&quot;.
        Destination producerDestination = producerSession.createQueue(QUEUE);

        // Create a producer from the session to the queue.
        MessageProducer producer = producerSession.createProducer(producerDestination);
        producer.setDeliveryMode(DELIVERY_MODE);

        // Create a message.
        String text = &quot;Hello from Amazon MQ!&quot;;
        TextMessage producerMessage = producerSession.createTextMessage(text);

        // Send the message.
        producer.send(producerMessage);
        System.out.println(&quot;Message sent.&quot;);

        // Clean up the producer.
        producer.close();
        producerSession.close();
        producerConnection.close();

        // Establish a connection for the consumer.
        // Note: Consumers should not use PooledConnectionFactory.
        Connection consumerConnection = connectionFactory.createConnection();
        consumerConnection.start();

        // Create a session.
        Session consumerSession = consumerConnection.createSession(false, ACKNOWLEDGE_MODE);

        // Create a queue named &quot;MyQueue&quot;.
        Destination consumerDestination = consumerSession.createQueue(QUEUE);

        // Create a message consumer from the session to the queue.
        MessageConsumer consumer = consumerSession.createConsumer(consumerDestination);

        // Begin to wait for messages.
        Message consumerMessage = consumer.receive(1000);

        // Receive the message when it arrives.
        TextMessage consumerTextMessage = (TextMessage) consumerMessage;
        System.out.println(&quot;Message received: &quot; + consumerTextMessage.getText());

        // Clean up the consumer.
        consumer.close();
        consumerSession.close();
        consumerConnection.close();
        pooledConnectionFactory.stop();
    }
}</code></pre>
<p><code class="lang-xml"></code></p>
<p>In this example, you use the ActiveMQ client to establish connectivity to AmazonMQ using the OpenWire protocol with the&nbsp;<a href="http://activemq.apache.org/maven/apidocs/org/apache/activemq/ActiveMQConnectionFactory.html">ActiveMQConnectionFactory</a>&nbsp;class to specify the endpoint and user credentials. For this example, use the master user name and password chosen when creating the Amazon MQ broker earlier. However, it’s a best practice to <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-listing-managing-users.html">create additional Amazon MQ users</a>&nbsp;for brokers in non-sandbox environments.</p>
<p>You could use the&nbsp;ActiveMQConnectionFactory to establish connectivity to the Amazon MQ broker. However, it is a&nbsp;<a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-best-practices.html">best practice in Amazon MQ</a>&nbsp;to group multiple producer requests using the ActiveMQ <a href="http://activemq.apache.org/maven/apidocs/org/apache/activemq/jms/pool/PooledConnectionFactory.html">PooledConnectionFactory</a>&nbsp;to wrap the&nbsp;ActiveMQConnectionFactory.</p>
<p>Using the PooledConnectionFactory, you can create a&nbsp;<a href="https://docs.oracle.com/javaee/7/api/javax/jms/Connection.html">connection</a>&nbsp;to Amazon MQ and establish a&nbsp;<a href="https://docs.oracle.com/javaee/7/api/javax/jms/Session.html">session</a>&nbsp;to send a message. Like the RabbitMQ queue example, create a message <a href="https://docs.oracle.com/javaee/7/api/javax/jms/Destination.html">queue&nbsp;destination</a>&nbsp;using the<a href="https://docs.oracle.com/javaee/7/api/javax/jms/Session.html#createQueue-java.lang.String-"> Session.createQueue</a> method, and a&nbsp;<a href="https://docs.oracle.com/javaee/7/api/javax/jms/MessageProducer.html">message producer</a>&nbsp;to send the message to the queue.</p>
<p>For the consumer, use the ActiveMQConnectionFactory, NOT the PooledConnectionFactory, to create a connection, session, queue destination, and&nbsp;<a href="https://docs.oracle.com/javaee/7/api/javax/jms/MessageConsumer.html">message consumer</a>&nbsp;to receive the message&nbsp;because pooling of consumers is not considered a best practice. For more information, see the <a href="http://activemq.apache.org/spring-support.html">ActiveMQ Spring Support</a> page.</p>
<h3>ActiveMQ virtual destinations on Amazon MQ</h3>
<p>Here’s how topic publishing differs from RabbitMQ to Amazon MQ.</p>
<p>If you remember from the&nbsp;RabbitMQ topic example, you bound a queue to an exchange using a routing key to control queue destinations when sending messages using a key attribute.</p>
<p>You run into a problem if you try to implement topic subscription using the message consumer in the preceding&nbsp;ActiveMQ queue example. The following is an excerpt from&nbsp;<a href="http://activemq.apache.org/virtual-destinations.html">Virtual Destinations</a>, which provides more detail on this subject:</p>
<blockquote>
<p><em>A JMS durable subscriber MessageConsumer is created with a unique JMS clientID and durable subscriber name. To be JMS-compliant, only one JMS connection can be active at any point in time for one JMS clientID, and only one consumer can be active for a clientID and subscriber name. That is, only one thread can be actively consuming from a given logical topic subscriber.</em></p>
</blockquote>
<p>To solve this, ActiveMQ supports the concept of a virtual destination, which provides a logical topic subscription access to a physical queue for consumption without breaking JMS compliance. To do so, ActiveMQ uses a simple convention for specifying the topic and queue names to configure message routing.</p>
<ul>
<li>Topic names must use the “<strong>VirtualTopic</strong>.” prefix, followed by the topic name. For example,&nbsp;<strong>VirtualTopic.MyTopic</strong>.</li>
<li>Consumer names must use the&nbsp;“Consumer.” prefix, followed by the consumer name, followed by the topic name. For example, <strong>Consumer.MyConsumer.VirtualTopic.MyTopic</strong>.</li>
</ul>
<h3>ActiveMQ topic example</h3>
<p>Next, here’s an example for the ActiveMQ client that demonstrates publishing messaging to topics. This example is similar to the&nbsp;ActiveMQ Queue Example. In this one, create a&nbsp;<a href="https://docs.oracle.com/javaee/7/api/javax/jms/Topic.html">Topic</a>&nbsp;destination instead of a queue destination.</p>
<pre><code class="lang-java">import javax.jms.Connection;
import javax.jms.DeliveryMode;
import javax.jms.Destination;
import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.MessageConsumer;
import javax.jms.MessageProducer;
import javax.jms.Session;
import javax.jms.TextMessage;

import org.apache.activemq.ActiveMQConnectionFactory;
import org.apache.activemq.jms.pool.PooledConnectionFactory;

public class ActiveMQClientExample {

    private static final int DELIVERY_MODE = DeliveryMode.NON_PERSISTENT;
    private static final int ACKNOWLEDGE_MODE = Session.AUTO_ACKNOWLEDGE;

    // The Endpoint, Username, Password, Producer Topic, and Consumer Topic
    // should be externalized and configured through environment variables or
    // dependency injection.
    private static final String ENDPOINT; // &quot;ssl://x-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx-x.mq.us-east-1.amazonaws.com:61617&quot;
    private static final String USERNAME;
    private static final String PASSWORD;
    private static final String PRODUCER_TOPIC = &quot;VirtualTopic.MyTopic&quot;;
    private static final String CONSUMER1_TOPIC = &quot;Consumer.Consumer1.&quot; + PRODUCER_TOPIC;
    
    public static void main(String[] args) throws JMSException {
        // Create a connection factory.
        ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(ENDPOINT);

        // Specify the username and password.
        connectionFactory.setUserName(USERNAME);
        connectionFactory.setPassword(PASSWORD);

        // Create a pooled connection factory.
        PooledConnectionFactory pooledConnectionFactory = new PooledConnectionFactory();
        pooledConnectionFactory.setConnectionFactory(connectionFactory);
        pooledConnectionFactory.setMaxConnections(10);

        // Establish a connection for the producer.
        Connection producerConnection = pooledConnectionFactory.createConnection();
        producerConnection.start();

        // Create a session.
        Session producerSession = producerConnection.createSession(false, ACKNOWLEDGE_MODE);

        // Create a topic named &quot;VirtualTopic.MyTopic&quot;.
        Destination producerDestination = producerSession.createTopic(PRODUCER_TOPIC);

        // Create a producer from the session to the topic.
        MessageProducer producer = producerSession.createProducer(producerDestination);
        producer.setDeliveryMode(DELIVERY_MODE);

        // Create a message.
        String text = &quot;Hello from Amazon MQ!&quot;;
        TextMessage producerMessage = producerSession.createTextMessage(text);

        // Send the message.
        producer.send(producerMessage);
        System.out.println(&quot;Message sent.&quot;);

        // Clean up the producer.
        producer.close();
        producerSession.close();
        producerConnection.close();

        // Establish a connection for the consumer.
        // Note: Consumers should not use PooledConnectionFactory.
        Connection consumerConnection = connectionFactory.createConnection();
        consumerConnection.start();

        // Create a session.
        Session consumerSession = consumerConnection.createSession(false, ACKNOWLEDGE_MODE);

        // Create a queue called &quot;Consumer.Consumer1.VirtualTopic.MyTopic&quot;.
        Destination consumerDestination = consumerSession.createQueue(CONSUMER1_TOPIC);

        // Create a message consumer from the session to the queue.
        MessageConsumer consumer = consumerSession.createConsumer(consumerDestination);

        // Begin to wait for messages.
        Message consumerMessage = consumer.receive(1000);

        // Receive the message when it arrives.
        TextMessage consumerTextMessage = (TextMessage) consumerMessage;
        System.out.println(&quot;Message received: &quot; + consumerTextMessage.getText());

        // Clean up the consumer.
        consumer.close();
        consumerSession.close();
        consumerConnection.close();
        pooledConnectionFactory.stop();
    }
}</code></pre>
<p>In this example, the message producer uses the&nbsp;<a href="https://docs.oracle.com/javaee/7/api/javax/jms/Session.html#createTopic-java.lang.String-">Session.createTopic</a>&nbsp;method with the topic name,&nbsp;<strong>VirtualTopic.MyTopic</strong>, as the publishing destination. The message consumer code does not change, but the queue destination uses the virtual destination convention,&nbsp;<strong>Consumer.Consumer1.VirtualTopic.MyTopic</strong>. ActiveMQ uses these names for the topic and queue to route messages accordingly.</p>
<h2>AMQP connectivity to Amazon MQ</h2>
<p>Now that you’ve explored some examples using an ActiveMQ client, look at examples using the&nbsp;<a href="https://qpid.apache.org/components/jms/index.html">Qpid JMS</a>&nbsp;client to connect to the Amazon MQ broker over the AMQP 1.0 protocol and see how they differ.</p>
<p>The Qpid client uses the Advanced Message Queuing Protocol (AMQP) 1.0 protocol, supported by Amazon MQ. The AMQP 1.0 protocol can be found in your Amazon MQ broker’s endpoint list (screenshot). It uses port&nbsp;5671, which <a href="https://console.aws.amazon.com/amazon-mq/home?region=us-east-1">must be opened in the Security Group associated with the Amazon MQ broker</a>.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/06/11/Migrating-from-Rabbit-MQ-to-AMQ-5.jpg"><img loading="lazy" class="alignnone size-full wp-image-4497" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/06/11/Migrating-from-Rabbit-MQ-to-AMQ-5.jpg" alt="" width="895" height="474" /></a></p>
<p>The AMQP endpoint specifies a transport, <strong>amqp+ssl</strong>. For encrypted connections, Qpid expects the protocol name to be <strong>amqps</strong>, instead of amqp+ssl, however the rest of the connection address remains the same.</p>
<h3>Qpid JMS queue example</h3>
<p>Next, here’s an example to send and receive messages to Amazon MQ using the Qpid client. The Qpid JMS client is built using <a href="https://qpid.apache.org/proton/index.html">Apache Qpid Proton</a>, an AMQP messaging toolkit.</p>
<pre><code class="lang-java">import java.util.Hashtable;

import javax.jms.Connection;
import javax.jms.ConnectionFactory;
import javax.jms.DeliveryMode;
import javax.jms.Destination;
import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.MessageConsumer;
import javax.jms.MessageProducer;
import javax.jms.Session;
import javax.jms.TextMessage;
import javax.naming.Context;
import javax.naming.NamingException;

import org.apache.activemq.jms.pool.PooledConnectionFactory;

public class QpidClientExample {

    private static final int DELIVERY_MODE = DeliveryMode.NON_PERSISTENT;
    private static final int ACKNOWLEDGE_MODE = Session.AUTO_ACKNOWLEDGE;

    // The Endpoint, Username, Password, and Queue should be externalized and
    // configured through environment variables or dependency injection.
    private static final String ENDPOINT; // &quot;amqps://x-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx-x.mq.us-east-1.amazonaws.com:5671&quot;
    private static final String USERNAME;
    private static final String PASSWORD;
    private static final String QUEUE = &quot;MyQueue&quot;;

    public static void main(String[] args) throws JMSException, NamingException {
        // Use JNDI to specify the AMQP endpoint
        Hashtable&lt;Object, Object&gt; env = new Hashtable&lt;Object, Object&gt;();
        env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;org.apache.qpid.jms.jndi.JmsInitialContextFactory&quot;);
        env.put(&quot;connectionfactory.factoryLookup&quot;, ENDPOINT);
        javax.naming.Context context = new javax.naming.InitialContext(env);

        // Create a connection factory.
        ConnectionFactory connectionFactory = (ConnectionFactory) context.lookup(&quot;factoryLookup&quot;);

        // Create a pooled connection factory.
        PooledConnectionFactory pooledConnectionFactory = new PooledConnectionFactory();
        pooledConnectionFactory.setConnectionFactory(connectionFactory);
        pooledConnectionFactory.setMaxConnections(10);

        // Establish a connection for the producer.
        Connection producerConnection = pooledConnectionFactory.createConnection(USERNAME, PASSWORD);
        producerConnection.start();

        // Create a session.
        Session producerSession = producerConnection.createSession(false, ACKNOWLEDGE_MODE);

        // Create a queue named &quot;MyQueue&quot;.
        Destination producerDestination = producerSession.createQueue(QUEUE);

        // Create a producer from the session to the queue.
        MessageProducer producer = producerSession.createProducer(producerDestination);
        producer.setDeliveryMode(DELIVERY_MODE);

        // Create a message.
        String text = &quot;Hello from Qpid Amazon MQ!&quot;;
        TextMessage producerMessage = producerSession.createTextMessage(text);

        // Send the message.
        producer.send(producerMessage);
        System.out.println(&quot;Message sent.&quot;);

        // Clean up the producer.
        producer.close();
        producerSession.close();
        producerConnection.close();

        // Establish a connection for the consumer.
        // Note: Consumers should not use PooledConnectionFactory.
        Connection consumerConnection = connectionFactory.createConnection(USERNAME, PASSWORD);
        consumerConnection.start();

        // Create a session.
        Session consumerSession = consumerConnection.createSession(false, ACKNOWLEDGE_MODE);

        // Create a queue named &quot;MyQueue&quot;.
        Destination consumerDestination = consumerSession.createQueue(QUEUE);

        // Create a message consumer from the session to the queue.
        MessageConsumer consumer = consumerSession.createConsumer(consumerDestination);

        // Begin to wait for messages.
        Message consumerMessage = consumer.receive(1000);

        // Receive the message when it arrives.
        TextMessage consumerTextMessage = (TextMessage) consumerMessage;
        System.out.println(&quot;Message received: &quot; + consumerTextMessage.getText());

        // Clean up the consumer.
        consumer.close();
        consumerSession.close();
        consumerConnection.close();
        pooledConnectionFactory.stop();
    }
}</code></pre>
<p>The Qpid queue example is similar to the&nbsp;ActiveMQ Queue Example. They both use the JMS API model to send and receive messages, but the difference is in how the ConnectionFactory and AMQP endpoint is specified. According to the <a href="https://qpid.apache.org/releases/qpid-jms-0.29.0/docs/index.html">Qpid client configuration documentation</a>, the ConnectionFactory is specified using a JNDI InitialContext to look up JMS objects. The JNDI configuration is popularly specified in a file named jndi.properties&nbsp;on the Java Classpath. In this example, do it programmatically using a HashTable for simplicity.</p>
<p><strong>NOTE:</strong> Although the Qpid client and Qpid JMS client are used to establish connectivity to Amazon MQ using the AMQP 1.0 protocol, the producer should still use the ActiveMQ&nbsp;<a href="http://activemq.apache.org/maven/apidocs/org/apache/activemq/jms/pool/PooledConnectionFactory.html">PooledConnectionFactory</a>&nbsp;to wrap the Qpid ConnectionFactory. This can be confusing because <a href="https://qpid.apache.org/releases/qpid-java-6.1.5/jms-client-0-8/book/JMS-Client-0-8-Appendix-PooledConnecytionFactory.html">Qpid client provides a PooledConnectionFactory</a>&nbsp;that should NOT be used for AMQP 1.0.</p>
<p>The Qpid topic example is identical to the earlier&nbsp;ActiveMQ topic example&nbsp;with the same substitution, which establishes the ConnectionFactory to the AMQP 1.0 endpoint via JNDI.</p>
<h3>Spring JMS template queue example</h3>
<p>Finally, here are examples using the Spring JmsTemplate to send and receive messages.</p>
<p>This example established connectivity to Amazon MQ using the same protocol and client library used in the&nbsp;ActiveMQ queue example. That example requires that the security group for the Amazon MQ be open for the ActiveMQ OpenWire protocol endpoint port, 61617.</p>
<p>The <a href="https://docs.spring.io/spring/docs/3.0.x/spring-framework-reference/html/jms.html#jms-jmstemplate">Spring JmsTemplate</a>&nbsp;provides a higher-level abstraction on top of JMS. Code using the&nbsp;<a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jms/core/JmsTemplate.html">JmsTemplate</a>&nbsp;class only needs to implement handlers to process messages, while the management of connections, sessions, message producers, and message consumers is delegated to Spring. Look at the following code:</p>
<pre><code class="lang-java">import javax.jms.DeliveryMode;
import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.Session;
import javax.jms.TextMessage;

import org.apache.activemq.ActiveMQConnectionFactory;
import org.apache.activemq.command.ActiveMQQueue;
import org.apache.activemq.jms.pool.PooledConnectionFactory;
import org.springframework.jms.core.JmsTemplate;
import org.springframework.jms.core.MessageCreator;

public class ActiveMQSpringExample {

    private static final int DELIVERY_MODE = DeliveryMode.NON_PERSISTENT;
    private static final int ACKNOWLEDGE_MODE = Session.AUTO_ACKNOWLEDGE;

    // The Endpoint, Username, Password, and Queue should be externalized and
    // configured through environment variables or dependency injection.
    private static final String ENDPOINT; // ssl://x-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx-x.mq.us-east-1.amazonaws.com:61617&quot;
    private static final String USERNAME;
    private static final String PASSWORD;
    private static final String QUEUE = &quot;MyQueue&quot;;

    public static void main(String[] args) throws JMSException {
        // Create a connection factory.
        ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(ENDPOINT);

        // Specify the username and password.
        connectionFactory.setUserName(USERNAME);
        connectionFactory.setPassword(PASSWORD);

        // Create a pooled connection factory.
        PooledConnectionFactory pooledConnectionFactory = new PooledConnectionFactory();
        pooledConnectionFactory.setConnectionFactory(connectionFactory);
        pooledConnectionFactory.setMaxConnections(10);

        // Create a JmsTemplate for the producer.
        JmsTemplate producerJmsTemplate = new JmsTemplate();
        producerJmsTemplate.setConnectionFactory(pooledConnectionFactory);
        producerJmsTemplate.setDefaultDestination(new ActiveMQQueue(QUEUE));
        producerJmsTemplate.setSessionAcknowledgeMode(ACKNOWLEDGE_MODE);
        producerJmsTemplate.setDeliveryMode(DELIVERY_MODE);
        
        // Create a message creator.
        MessageCreator messageCreator = new MessageCreator() {
            public Message createMessage(Session session) throws JMSException {
                return session.createTextMessage(&quot;Hello from Spring Amazon MQ!&quot;);
            }
        };

        // Send the message.
        producerJmsTemplate.send(messageCreator);
        System.out.println(&quot;Message sent.&quot;);

        // Clean up the producer.
        // producer JmsTemplate will close underlying sessions and connections.

        // Create a JmsTemplate for the consumer.
        // Note: Consumers should not use PooledConnectionFactory.
        JmsTemplate consumerJmsTemplate = new JmsTemplate();
        consumerJmsTemplate.setConnectionFactory(connectionFactory);
        consumerJmsTemplate.setDefaultDestination(new ActiveMQQueue(QUEUE));
        consumerJmsTemplate.setSessionAcknowledgeMode(ACKNOWLEDGE_MODE);
        consumerJmsTemplate.setReceiveTimeout(1000);
        
        // Begin to wait for messages.
        Message consumerMessage = consumerJmsTemplate.receive();

        // Receive the message when it arrives.
        TextMessage consumerTextMessage = (TextMessage) consumerMessage;
        System.out.println(&quot;Message received: &quot; + consumerTextMessage.getText());

        // Clean up the consumer.
        // consumer JmsTemplate will close underlying sessions and connections.
        pooledConnectionFactory.stop();
    }
}</code></pre>
<pre></pre>
<p>Although Spring manages connections, sessions,&nbsp;and message producers, the grouping of producer connections is still a best practice. The ActiveMQ&nbsp;<a href="http://activemq.apache.org/maven/apidocs/org/apache/activemq/jms/pool/PooledConnectionFactory.html">PooledConnectionFactory</a>&nbsp;class is used in this example. However, the Spring&nbsp;<a href="https://docs.spring.io/spring/docs/3.0.x/spring-framework-reference/html/jms.html#d0e37061">CachingConnectionFactory</a> object is another option.</p>
<p>Following the PooledConnectionFactory creation, a JmsTemplate is created for the producer and an&nbsp;<a href="https://activemq.apache.org/maven/apidocs/org/apache/activemq/command/ActiveMQQueue.html">ActiveMQQueue</a>&nbsp;is created as the message destination. To use JmsTemplate to&nbsp;<a href="https://docs.spring.io/spring/docs/3.0.x/spring-framework-reference/html/jms.html#jms-sending">send a message</a>, a <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jms/core/MessageCreator.html">MessageCreator</a>&nbsp;callback is defined that generates a text message via the JmsTemplate.</p>
<p>A second JmsTemplate with an ActiveMQQueue is created for the consumer. In this example, a single message is received synchronously, however,&nbsp;<a href="https://docs.spring.io/spring/docs/3.0.x/spring-framework-reference/html/jms.html#jms-asynchronousMessageReception">asynchronous message reception</a> is a popular alternative when using message-driven POJOs.</p>
<p>Unlike the ActiveMQ examples, the Spring JMS template example does not require the explicit cleanup of the connection, session, message producer, or message consumer resources, as that is managed by Spring. Make sure to call the&nbsp;<a href="https://activemq.apache.org/maven/apidocs/org/apache/activemq/Service.html#stop--">PooledConnectionFactory.stop</a> method to cleanly exit the main method.</p>
<p>Finally, here’s an example using a Spring JmsTemplate for topic publishing.</p>
<h3>Spring JmsTemplate topic example</h3>
<p>This example combines the&nbsp;Spring JmsTemplate queue example&nbsp;with the virtual destinations approach from the&nbsp;ActiveMQ topic example. Look at the following code.</p>
<pre><code class="lang-java">import javax.jms.DeliveryMode;
import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.Session;
import javax.jms.TextMessage;

import org.apache.activemq.ActiveMQConnectionFactory;
import org.apache.activemq.command.ActiveMQQueue;
import org.apache.activemq.command.ActiveMQTopic;
import org.apache.activemq.jms.pool.PooledConnectionFactory;
import org.springframework.jms.core.JmsTemplate;
import org.springframework.jms.core.MessageCreator;

public class ActiveMQSpringExample {

    private static final int DELIVERY_MODE = DeliveryMode.NON_PERSISTENT;
    private static final int ACKNOWLEDGE_MODE = Session.AUTO_ACKNOWLEDGE;

    // The Endpoint, Username, Password, Producer Topic, and Consumer Topic
    // should be externalized and configured through environment variables or
    // dependency injection.
    private static final String ENDPOINT; // &quot;ssl://x-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx-x.mq.us-east-1.amazonaws.com:61617&quot;
    private static final String USERNAME;
    private static final String PASSWORD;
    private static final String PRODUCER_TOPIC = &quot;VirtualTopic.MyTopic&quot;;
    private static final String CONSUMER1_TOPIC = &quot;Consumer.Consumer1.&quot; + PRODUCER_TOPIC;
    
    public static void main(String[] args) throws JMSException {
        // Create a connection factory.
        ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(ENDPOINT);

        // Specify the username and password.
        connectionFactory.setUserName(USERNAME);
        connectionFactory.setPassword(PASSWORD);

        // Create a pooled connection factory.
        PooledConnectionFactory pooledConnectionFactory = new PooledConnectionFactory();
        pooledConnectionFactory.setConnectionFactory(connectionFactory);
        pooledConnectionFactory.setMaxConnections(10);

        // Create a JmsTemplate for the producer.
        JmsTemplate producerJmsTemplate = new JmsTemplate();
        producerJmsTemplate.setConnectionFactory(pooledConnectionFactory);
        producerJmsTemplate.setDefaultDestination(new ActiveMQTopic(PRODUCER_TOPIC));
        producerJmsTemplate.setSessionAcknowledgeMode(ACKNOWLEDGE_MODE);
        producerJmsTemplate.setDeliveryMode(DELIVERY_MODE);

        // Create a message creator.
        MessageCreator messageCreator = new MessageCreator() {
            public Message createMessage(Session session) throws JMSException {
                return session.createTextMessage(&quot;Hello from Spring Amazon MQ!&quot;);
            }
        };

        // Send the message.
        producerJmsTemplate.send(messageCreator);
        System.out.println(&quot;Message sent.&quot;);

        // Clean up the producer.
        // producer JmsTemplate will close underlying sessions and connections.

        // Create a JmsTemplate for the consumer.
        // Note: Consumers should not use PooledConnectionFactory.
        JmsTemplate consumerJmsTemplate = new JmsTemplate();
        consumerJmsTemplate.setConnectionFactory(connectionFactory);
        consumerJmsTemplate.setDefaultDestination(new ActiveMQQueue(CONSUMER1_TOPIC));
        consumerJmsTemplate.setSessionAcknowledgeMode(ACKNOWLEDGE_MODE);
        consumerJmsTemplate.setReceiveTimeout(1000);
        
        // Begin to wait for messages.
        Message consumerMessage = consumerJmsTemplate.receive();

        // Receive the message when it arrives.
        TextMessage consumerTextMessage = (TextMessage) consumerMessage;
        System.out.println(&quot;Message received: &quot; + consumerTextMessage.getText());

        // Clean up the consumer.
        // consumer JmsTemplate will close underlying sessions and connections.
        pooledConnectionFactory.stop();
    }
}</code></pre>
<pre>In this example, follow the ActiveMQ virtual destination naming convention for topics and queues:</pre>
<ul>
<li>When creating the producer JMS template, specify an&nbsp;<a href="https://activemq.apache.org/maven/apidocs/org/apache/activemq/command/ActiveMQTopic.html">ActiveMQTopic</a>&nbsp;as the destination using the name&nbsp;<strong>VirtualTopic.MyTopic</strong>.</li>
<li>When creating the consumer JMS template, specify an&nbsp;<a href="https://activemq.apache.org/maven/apidocs/org/apache/activemq/command/ActiveMQQueue.html">ActiveMQQueu</a>e&nbsp;as the destination using the name&nbsp;<strong>Consumer.Consumer1.VirtualTopic.MyTopic</strong>.</li>
</ul>
<p>ActiveMQ automatically handles routing messages from topic to queue.</p>
<h2>Conclusion</h2>
<p>In this post, I reviewed how to get started with an Amazon MQ broker and walked you through several code examples that explored the differences between RabbitMQ and Apache ActiveMQ client integrations. If you are considering migrating to Amazon MQ, these examples should help you understand the changes that might be required.</p>
<p>If you’re&nbsp;thinking about integrating your existing apps with new serverless apps, see the related post,&nbsp;<a href="https://aws.amazon.com/blogs/compute/invoking-aws-lambda-from-amazon-mq/">Invoking AWS Lambda from Amazon MQ</a>.</p>
<p>To learn more, see the <a href="https://aws.amazon.com/amazon-mq/">Amazon MQ</a> website and <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/welcome.html">Developer Guide</a>. You can try <a href="https://console.aws.amazon.com/amazon-mq/home">Amazon MQ for free</a> with the <a href="https://aws.amazon.com/free/">AWS Free Tier</a>, which includes up to 750 hours of a single-instance mq.t2.micro broker and up to 1 GB of storage per month for one year for new AWS accounts.</p>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/activemq/" rel="tag">ActiveMQ</a><a href="https://noise.getoto.net/tag/amazon-mq/" rel="tag">Amazon MQ*</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/message-topics/" rel="tag">message topics</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a><a href="https://noise.getoto.net/tag/migration/" rel="tag">Migration</a></span></footer></article>
<article id="post-374084" class="post-374084 post type-post status-publish format-standard hentry tag-6929 tag-ace tag-actions tag-activemq tag-ad tag-adi tag-ads tag-ai tag-all tag-als tag-amazon tag-amazon-cloudwatch tag-amazon-dynamodb tag-amazon-kinesis tag-amazon-kinesis-streams tag-amazon-mq tag-amazon-s3 tag-amazon-sns tag-amazon-sqs tag-amazon-web-services tag-apache tag-apis tag-app tag-application-integration tag-application-services tag-applications tag-apt tag-architecture tag-aria tag-arin tag-art tag-artifact tag-asia tag-asia-pacific tag-ati tag-ats tag-auth tag-availability tag-aws tag-aws-account tag-aws-cloud tag-aws-config tag-aws-direct-connect tag-aws-elastic-beanstalk tag-aws-lambda tag-aws-solutions tag-bean tag-bec tag-ble tag-book tag-bsi tag-c tag-cam tag-car tag-cas tag-case tag-cassandra tag-cd tag-choice tag-ci tag-cia tag-cli tag-cloud tag-cloud-services tag-cloudwatch tag-code tag-commercial tag-communications tag-console tag-container tag-context tag-control tag-conversion tag-core tag-court tag-credentials tag-curity tag-data tag-dbc tag-ddr tag-dea tag-dependencies tag-det tag-dp tag-dress tag-dyn tag-dynamodb tag-east tag-ebook tag-ebs tag-ebuild tag-ec tag-ec2 tag-eclipse tag-ecr tag-ed tag-edge tag-elastic-beanstalk tag-ens tag-enterprise tag-enterprise-strategy tag-environment tag-et tag-eu tag-facebook tag-fact tag-fail tag-failover tag-fine tag-fir tag-form tag-fun tag-gateway tag-general tag-git tag-github tag-go tag-got tag-guide tag-hat tag-header tag-html tag-http tag-ice tag-ide tag-inside tag-install tag-intel tag-internet tag-ip tag-ip-address tag-ips tag-ireland tag-irs tag-iss tag-iste tag-java tag-java-sdk tag-kinesis tag-lambda tag-laptop tag-launch tag-law tag-laws tag-led tag-lfi tag-logging tag-lte tag-mac tag-make tag-mali tag-mana tag-maven tag-message-queues tag-message-topics tag-messaging tag-migration tag-monitor tag-monitoring tag-mqtt tag-nab tag-ncr tag-nec tag-nes tag-network tag-nsa tag-on-premises tag-oregon tag-org tag-oss tag-other tag-ous tag-pa tag-password tag-pc tag-plex tag-plugin tag-power tag-ppl tag-present tag-project tag-protocols tag-ps tag-pth tag-qt tag-r tag-rat tag-rate tag-registry tag-rest tag-roles tag-router tag-routing tag-rov tag-rti tag-running tag-s tag-s3 tag-s3-bucket tag-sam tag-schema tag-sdk tag-secrets tag-security tag-security-group tag-ses tag-slack tag-sns tag-spark tag-spring tag-sqs tag-sse tag-ssl tag-star tag-storage tag-support tag-tag tag-talk tag-tech tag-technology tag-ted tag-terminal tag-test tag-testing tag-the tag-tic tag-time tag-tor tag-ui tag-un tag-us tag-variables tag-virgin tag-visual-studio tag-vpc tag-vpn tag-war tag-watch tag-web tag-web-services tag-website tag-win tag-windows tag-work tag-writing tag-xml">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2018/04/23/integrating-amazon-mq-with-other-aws-services-via-apache-camel/" rel="bookmark">Integrating Amazon MQ with other AWS services via Apache Camel</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2018/04/23/integrating-amazon-mq-with-other-aws-services-via-apache-camel/" rel="bookmark"><time class="entry-date" datetime="2018-04-23T18:56:40+03:00">2018-04-23</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/tara-van-unen/" rel="author">Tara Van Unen</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Tara Van Unen">Tara Van Unen</a> original <a href="https://aws.amazon.com/blogs/compute/integrating-amazon-mq-with-other-aws-services-via-apache-camel/">https://aws.amazon.com/blogs/compute/integrating-amazon-mq-with-other-aws-services-via-apache-camel/</a></p>
<h4>This post courtesy of Massimiliano Angelino, AWS Solutions Architect</h4>
<p>Different enterprise systems—ERP, CRM, BI, HR, etc.—need to exchange information but normally cannot do that natively because they are from different vendors. Enterprises have tried multiple ways to integrate heterogeneous systems, generally referred to as enterprise application integration (EAI).</p>
<p>Modern EAI systems are based on a message-oriented middleware (MoM), also known as enterprise service bus (ESB).&nbsp;An ESB provides data communication via a message bus, on top of which it also provides components to orchestrate, route, translate, and monitor the data exchange. Communication with the ESB is done via adapters or connectors provided by the ESB. In this way, the different applications do not have to have specific knowledge of the technology used to provide the integration.</p>
<p><a href="https://aws.amazon.com/amazon-mq/">Amazon&nbsp;MQ</a> used with Apache Camel is an open-source alternative to commercial ESBs. With the launch of Amazon&nbsp;MQ, integration between on-premises applications and cloud services becomes much simpler.&nbsp;Amazon&nbsp;MQ provides a managed message broker service currently supporting ApacheMQ 5.15.0.</p>
<p>In this post, I show how a simple integration between Amazon&nbsp;MQ and other AWS services can be achieved by using Apache Camel.</p>
<p>Apache Camel provides built-in connectors for integration with a wide variety of AWS services such as Amazon MQ, Amazon SQS, Amazon SNS, Amazon SWF, Amazon S3, AWS Lambda, Amazon DynamoDB, AWS Elastic Beanstalk, and Amazon Kinesis Streams. It also provides a <a href="https://camel.apache.org/components.html">broad range of other connectors</a> including Cassandra, JDBC, Spark, and even Facebook and Slack.</p>
<h2>EAI system architecture</h2>
<p>Different applications use different data formats, hence the need for a translation/transformation service. Such services can be provided to or from a common&nbsp;“normalized” format, or specifically between two applications.</p>
<p>The use of normalized formats simplifies the integration process when multiple applications need to share the same data, as the number of conversions to be realized is N (number of applications). This is at the cost of a more complex adaptation to a common format, which is required to cover all needs from the different applications, current and future.</p>
<p>Another characteristic of an EAI system is the support of distributed transactions to ensure data consistency across multiple applications.</p>
<p>EAI system architecture is normally composed of the following components:</p>
<ul>
<li>A centralized broker that handles security, access control, and data communications. Amazon&nbsp;MQ provides these features through the support of multiple transport protocols (AMQP, Openwire, MQTT, WebSocket), security (all communications are encrypted via SSL), and per destination granular access control.</li>
<li>An independent data model, also known as the canonical data model. XML is the de facto&nbsp;standard for the data representation.</li>
<li>Connectors/agents that allow the applications to communicate with the broker.</li>
<li>A system model to allow a standardized way for all components to interface with the EAI. Java Message Service (JMS) and Windows Communication Foundation (WCF) are standard APIs to interact with constructs such as queues and topics to implement the different messaging patterns.</li>
</ul>
<h2>Walkthrough</h2>
<p>This solution walks you through the following steps:</p>
<ul>
<li>Creating the broker</li>
<li>Writing a simple application</li>
<li>Adding the dependencies</li>
<li>Triaging files into S3</li>
<li>Writing the Camel route</li>
<li>Sending files to the AMQP queue</li>
<li>Setting up AMQP</li>
<li>Testing the code</li>
</ul>
<h3>Creating the broker</h3>
<p>To create a new broker, log in to your AWS account and choose Amazon&nbsp;MQ. Amazon&nbsp;MQ is currently available in six AWS Regions:</p>
<ul>
<li>US East (N. Virginia)</li>
<li>US East (Ohio)</li>
<li>US West (Oregon)</li>
<li>EU (Ireland)</li>
<li>EU (Frankfurt)</li>
<li>Asia Pacific (Sydney) regions.</li>
</ul>
<p>Make sure that you have selected one of these Regions.</p>
<p>The master user name and password are used to access the monitoring console of the broker and can be also used to authenticate when connecting the clients to the broker. I recommend creating separate users, without console access, to authenticate the clients to the broker, after the broker has been created.</p>
<p>For this example, create a single broker without failover. If your application requires a higher availability level, check the <strong>Create standby in a different zone</strong>&nbsp;check box. In case the principal broker instance would fail, the standby takes over in seconds. To make the client aware of the standby, use the failover:// protocol in the connection configuration pointing to both broker endpoints.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/Broker-Details.png"><img loading="lazy" class="alignnone size-large wp-image-4119" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/Broker-Details-1024x600.png" alt="" width="1024" height="600" /></a></p>
<p>Leave the other settings as is. The broker takes few minutes to be created. After it’s done, you can see the list of endpoints available for the different protocols.</p>
<p>After the broker has been created, modify the security group to add the allowed ports and sources for access.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/Details-Security-Group.png"><img loading="lazy" class="alignnone size-large wp-image-4120" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/Details-Security-Group-1024x547.png" alt="" width="1024" height="547" /></a></p>
<p>For this example, you need access to the ActiveMQ admin page and to AMQP. Open up ports 8162 and 5671 to the public address of your laptop.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/Security-Settings.png"><img loading="lazy" class="alignnone size-large wp-image-4121" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/Security-Settings-1024x555.png" alt="" width="1024" height="555" /></a></p>
<p>You can also create a new user for programmatic access to the broker. In the <strong>Users</strong> section, choose <strong>Create User</strong> and add a new user named <strong>sdk</strong>.</p>
<h3>Writing a simple application</h3>
<p>The complete code for this walkthrough is available from the&nbsp;<a href="https://github.com/aws-samples/aws-amazonmq-apachecamel-sample">aws-amazonmq-apachecamel-sample</a> GitHub repo. Clone the repository on your local machine to have the fully functional example. The rest of this post offers step-by-step instructions to build this solution.</p>
<p>To write the application, use Apache Maven and the Camel archetypes provided by Maven. If you do not have Apache Maven installed on your machine, you can follow the instructions at <a href="https://maven.apache.org/install.html">Installing Apache Maven</a>.</p>
<p>From a terminal, run the following command:</p>
<pre><code class="lang-bash">mvn archetype:generate</code></pre>
<p>You get a list of archetypes. Type camel&nbsp;to get only the one related to camel. In this case, use the java8 example and type the following:</p>
<pre><code class="lang-bash">90 + ENTER</code></pre>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/archetypes-1.png"><img loading="lazy" class="alignnone size-large wp-image-4124" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/archetypes-1-1024x248.png" alt="" width="1024" height="248" /></a></p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/archetypes-2.png"><img loading="lazy" class="alignnone size-large wp-image-4123" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/archetypes-2-1024x147.png" alt="" width="1024" height="147" /></a></p>
<p>Then, select a Camel version (pick the most recent) and fill in other properties for the project, such as <strong>groupId</strong>, <strong>artifactId</strong>,&nbsp;and <strong>version</strong>.&nbsp; For more information, see <a href="https://maven.apache.org/guides/mini/guide-naming-conventions.html">Guide to naming conventions on groupId, artifactId and version</a>.</p>
<p>For this example, use the following values:</p>
<ul>
<li><strong>groupId:</strong><em> com.angmas</em></li>
<li><strong>artifactId:</strong><em> camel-aws-simple</em></li>
<li><strong>version:</strong><em> 1.0-SNAPSHOT</em></li>
</ul>
<p>Maven now generates the skeleton code in a folder named as the<strong> artifactId</strong>. In this case:</p>
<p><code class="lang-bash">camel-aws-simple</code></p>
<p>Next, test that the environment is configured correctly to run Camel. At the prompt, run the following commands:</p>
<pre><code class="lang-bash">cd camel-aws-simple
mvn install
mvn exec:java</code></pre>
<p>You should see a log appearing in the console, printing&nbsp;the following:</p>
<pre><code class="lang-bash">[INFO] --- exec-maven-plugin:1.6.0:java (default-cli) @ camel-aws-test ---
[     com.angmas.MainApp.main()] DefaultCamelContext            INFO  Apache Camel 2.20.1 (CamelContext: camel-1) is starting
[     com.angmas.MainApp.main()] ManagedManagementStrategy      INFO  JMX is enabled
[     com.angmas.MainApp.main()] DefaultTypeConverter           INFO  Type converters loaded (core: 192, classpath: 0)
[     com.angmas.MainApp.main()] DefaultCamelContext            INFO  StreamCaching is not in use. If using streams then its recommended to enable stream caching. See more details at http://camel.apache.org/stream-caching.html
[     com.angmas.MainApp.main()] DefaultCamelContext            INFO  Route: route1 started and consuming from: timer://simple?period=1000
[     com.angmas.MainApp.main()] DefaultCamelContext            INFO  Total 1 routes, of which 1 are started
[     com.angmas.MainApp.main()] DefaultCamelContext            INFO  Apache Camel 2.20.1 (CamelContext: camel-1) started in 0.419 seconds
[-1) thread #2 - timer://simple] route1                         INFO  Got a String body
[-1) thread #2 - timer://simple] route1                         INFO  Got an Integer body
[-1) thread #2 - timer://simple] route1                         INFO  Got a Double body
[-1) thread #2 - timer://simple] route1                         INFO  Got a String body
[-1) thread #2 - timer://simple] route1                         INFO  Got an Integer body
[-1) thread #2 - timer://simple] route1                         INFO  Got a Double body
[-1) thread #2 - timer://simple] route1                         INFO  Got a String body
[-1) thread #2 - timer://simple] route1                         INFO  Got an Integer body
[-1) thread #2 - timer://simple] route1                         INFO  Got a Double body</code></pre>
<h3>Adding the dependencies</h3>
<p>Now that you have verified that the sample works, modify it to add the dependencies to interface to Amazon&nbsp;MQ/ActiveMQ and AWS.</p>
<p>For the following steps, you can use a normal text editor, such as vi, Sublime Text, or Visual Studio Code. Or, open the maven project in an IDE such as Eclipse or IntelliJ IDEA.</p>
<p>Open&nbsp;<code class="lang-xml">pom.xml</code> and add the following lines inside the <code class="lang-xml">&lt;dependencies&gt;</code> tag:</p>
<pre><code class="lang-xml">&lt;dependency&gt;
  &lt;groupId&gt;org.apache.camel&lt;/groupId&gt;
  &lt;artifactId&gt;camel-amqp&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.apache.camel&lt;/groupId&gt;
  &lt;artifactId&gt;camel-aws&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
<p>The&nbsp;<code class="lang-xml">camel-aws</code> component is taking care of the interface with the supported AWS services without requiring any in-depth knowledge of the AWS Java SDK. For more information, see <a href="https://camel.apache.org/aws.html">Camel Components for Amazon Web Services</a>.</p>
<h3>Triaging files into S3</h3>
<p>Write a Camel component that receives files as a payload to messages in a queue and write them to an S3 bucket with different prefixes depending on the extension.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/camel_reference_architecture.png"><img loading="lazy" class="alignnone size-large wp-image-4206" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/camel_reference_architecture-1024x495.png" alt="" width="1024" height="495" /></a></p>
<p>Because the broker that you created is exposed via a public IP address, you can execute the code from anywhere that there is an internet connection that allows communication on the specific ports. In this example, run the code from your own laptop. A broker can also be created without public IP address, in which case it is only accessible from inside the VPC in which it has been created, or by any peered VPC or network connected via a virtual gateway (VPN or AWS Direct Connect).</p>
<p>First, look at the code created by Maven. The archetype chosen created a standalone Camel context run via the helper&nbsp;<code class="lang-apacheconf">org.apache.camel.main.Main</code> class. This provides an easy way to run Camel routes from an IDE or the command line without needing to deploy it inside a container. &nbsp;Apache Camel can be also run as an OSGi module, or Spring and SpringBoot bean.</p>
<pre><code class="lang-java">package com.angmas;
import org.apache.camel.main.Main;
/**
 * A Camel Application
 */
public class MainApp {
    /**
     * A main() so you can easily run these routing rules in your IDE
     */
    public static void main(String... args) throws Exception {
        Main main = new Main();
        main.addRouteBuilder(new MyRouteBuilder());
        main.run(args);
    }
}
</code></pre>
<p>The main method instantiates the Camel Main helper class and the routes, and runs the Camel application. The MyRouteBuilder class creates a route using Java DSL. It is also possible to define routes in Spring XML and load them dynamically in the code.</p>
<pre><code class="lang-java">public void configure() {
        // this sample sets a random body then performs content-based
        // routing on the message using method references
        from(&quot;timer:simple?period=1000&quot;)
            .process()
                .message(m -&gt; m.setHeader(&quot;index&quot;, index++ % 3))
            .transform()
                .message(this::randomBody)
            .choice()
                .when()
                    .body(String.class::isInstance)
                    .log(&quot;Got a String body&quot;)
                .when()
                    .body(Integer.class::isInstance)
                    .log(&quot;Got an Integer body&quot;)
                .when()
                    .body(Double.class::isInstance)
                    .log(&quot;Got a Double body&quot;)
                .otherwise()
                    .log(&quot;Other type message&quot;);
    }</code></pre>
<h3>Writing the Camel route</h3>
<p>Replace the existing route with one that fetches messages from Amazon MQ over AMQP, and routes the content to different S3 buckets depending on the file name extension.</p>
<pre><code class="lang-java">import com.amazonaws.regions.Regions;
import com.amazonaws.services.s3.AmazonS3ClientBuilder;
…
public static void main(String... args) throws Exception {
        Main main = new Main();
        main.bind(&quot;s3Client&quot;, AmazonS3ClientBuilder.standard().withRegion(Regions.US_EAST_1).build());
        main.addRouteBuilder(new MyRouteBuilder());
        main.addRouteBuilder(new MessageProducerBuilder());
        main.run(args);
    }


public class MyRouteBuilder extends RouteBuilder {
    private String secretKey = System.getenv(&quot;AWS_SECRET_ACCESS_KEY&quot;);
    private String accessKey = System.getenv(&quot;AWS_ACCESS_KEY&quot;);
    
    public void configure() {
        from(&quot;amqp:filequeue&quot;)
        .process()
            .message(this::setExtensionHeader)
        .choice()
            .when(header(&quot;ext&quot;).isEqualTo(&quot;txt&quot;))
                .setHeader(&quot;CamelAwsS3Key&quot;).simple(&quot;text-files/${headers.CamelFileName}&quot;)
                .to(&quot;aws-s3://my-camel-example-bucket? amazonS3Client=#s3Client&quot;)
            .when(header(&quot;ext&quot;).isEqualTo(&quot;html&quot;))
                .setHeader(&quot;CamelAwsS3Key&quot;).simple(&quot;html-files/${headers.CamelFileName}&quot;)
                .to(&quot;aws-s3://my-camel-example-bucket? amazonS3Client=#s3Client&quot;)
            .otherwise()
                .setHeader(&quot;CamelAwsS3Key&quot;).simple(&quot;other-files/${headers.CamelFileName}&quot;)
                .to(&quot;aws-s3://my-camel-example-bucket? amazonS3Client=#s3Client&quot;);

    }

    private void setExtensionHeader(Message m) {
        String fileName = (String) m.getHeader(&quot;CamelFileName&quot;);
        String ext = fileName.substring(fileName.lastIndexOf(&quot;.&quot;)+1);
        m.setHeader(&quot;ext&quot;, ext);
    }

}</code></pre>
<p>The above code does the following:</p>
<ol>
<li>Reads messages from the AMQP queue named<strong> filequeue</strong>.</li>
<li>Processes the message and sets a new <strong>ext</strong>&nbsp;header using the setExtensionHeader method (see below).</li>
<li>Checks the value of the <strong>ext</strong>&nbsp;header and write the body of the message as an object in an S3 bucket using different key prefixes, retaining the original name of the file.</li>
</ol>
<p>The <a href="https://camel.apache.org/aws-s3.html">Amazon S3 component</a> is configured with the bucket name, and a reference to an S3 client (<code class="lang-java">amazonS3client=#s3Client</code>) that you added to the Camel registry in the Main method of the app. Adding the object to the Camel registry allows Camel to find the object at runtime. Even though you could pass the region, accessKey, and secretKey parameters directly in the component URI, this way is more secure. It can make use of EC2 instance roles, so that you never need to pass the secrets.</p>
<h3>Sending files to the AMQP queue</h3>
<p>To send the files to the AMQP queue for testing, add another Camel route. In a real scenario, the messages to the AMQP queue are generated by another client. You are going to create a new route builder, but you could also add this route inside the existing MyRouteBuilder.</p>
<pre><code class="lang-java">package com.angmas;

import org.apache.camel.builder.RouteBuilder;

/**
 * A Camel Java8 DSL Router
 */
public class MessageProducerBuilder extends RouteBuilder {
    /**
     * Configure the Camel routing rules using Java code...
     */
    public void configure() {
        from(&quot;file://input?delete=false&amp;noop=true&quot;)
        .log(&quot;Content ${body} ${headers.CamelFileName}&quot;)
        .to(&quot;amqp:filequeue&quot;);
    }
}</code></pre>
<p>The code reads files from the <strong>input&nbsp;</strong>folder in the <strong>work</strong> directory and publishes it to the queue. The route builder is added in the main class:</p>
<p><code class="lang-java">main.addRouteBuilder(new MessageProducerBuilder());</code></p>
<h3>Setting up AMQP</h3>
<p>By default, Camel tries to connect to a local AMQP broker. Configure it to connect to your Amazon&nbsp;MQ broker.</p>
<p>Create an&nbsp;<strong>AMQPConnectionDetails</strong> object that is configured to connect to Amazon&nbsp;MQ broker with SSL and pass the user name and password that you set on the broker. Adding the object to the Camel registry allows Camel to find the object at runtime and use it as the default connection to AMQP.</p>
<pre><code class="lang-java">public class MainApp {
    public static String BROKER_URL = System.getenv(&quot;BROKER_URL&quot;);
    public static String AMQP_URL = &quot;amqps://&quot;+BROKER_URL+&quot;:5671&quot;;
    public static String BROKER_USERNAME = System.getenv(&quot;BROKER_USERNAME&quot;);
    public static String BROKER_PASSWORD = System.getenv(&quot;BROKER_PASSWORD&quot;);
    /**
     * A main() so you can easily run these routing rules in your IDE
     */
    public static void main(String... args) throws Exception {
        Main main = new Main();
        main.bind(&quot;amqp&quot;, getAMQPconnection());
        main.bind(&quot;s3Client&quot;, AmazonS3ClientBuilder.standard().withRegion(Regions.US_EAST_1).build());
        main.addRouteBuilder(new MyRouteBuilder());
        main.addRouteBuilder(new MessageProducerBuilder());
        main.run(args);
    }

    public static AMQPConnectionDetails getAMQPconnection() {
        return new AMQPConnectionDetails(AMQP_URL, BROKER_USERNAME, BROKER_PASSWORD);
    }

}</code></pre>
<p>The AMQP_URL uses the amqps schema that indicates that you are using SSL. You then add the component to the registry. Camel finds it by matching the class type.<br /> <code class="lang-java">main.bind(&quot;amqp-ssl&quot;, getAMQPConnection());</code></p>
<h3>Testing the code</h3>
<p>Create an <strong>input</strong> folder in the project root, and create few files with different extensions, such as txt, html, and csv.</p>
<p>Set the different environment variables required by the code, either in the shell or in your IDE as execution configuration.</p>
<pre><code class="lang-bash">export BROKER_URL=&quot;xxx.mq.us-east-1.amazonaws.com&quot;
export BROKER_PASSWORD=&quot;***&quot;
export BROKER_USERNAME=&quot;admin&quot;</code></pre>
<p>If you are running the example from an EC2 instance, ensure that the EC2 instance role has read permission on the S3 bucket.</p>
<p>If you are running this on your laptop, ensure that you have configured the AWS credentials in the environment, for example, by using the <code class="lang-bash">aws configure</code> command.</p>
<p>From the command line, execute the code:</p>
<p><code class="lang-bash">mvn exec:java</code></p>
<p>If you are using an IDE, execute the main class. Camel outputs logging information and you should see messages listing the content and names of the files in the input folder.</p>
<p>Keep adding some more files to the input folder. You see that they are triaged in S3 a few seconds later. You can open the S3 console to check that they have been created.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/S3.png"><img loading="lazy" class="alignnone size-large wp-image-4140" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/S3-1024x379.png" alt="" width="1024" height="379" /></a></p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/S3-2.png"><img loading="lazy" class="alignnone size-large wp-image-4139" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/04/02/S3-2-1024x367.png" alt="" width="1024" height="367" /></a></p>
<p>To stop Camel, press&nbsp;<code class="lang-bash">CTRL+C</code> in the shell.</p>
<h2>Conclusion</h2>
<p>In this post, I showed you how to create a publicly accessible Amazon&nbsp;MQ broker, and how to use Apache Camel to easily integrate AWS services with the broker. In the example, you created a Camel route that reads messages containing files from the AMQP queue and triages them by file extension into an S3 bucket.</p>
<p>Camel supports several <a href="https://camel.apache.org/components.html">components</a>&nbsp;and provides blueprints for several <a href="https://camel.apache.org/enterprise-integration-patterns.html">enterprise integration patterns</a>. Used in combination with the Amazon&nbsp;MQ, it provides a powerful and flexible solution to extend traditional enterprise solutions to the AWS Cloud, and integrate them seamlessly with cloud-native services, such as Amazon S3, Amazon SNS, Amazon SQS, Amazon CloudWatch, and AWS Lambda.</p>
<p>To learn more, see the <a href="https://aws.amazon.com/amazon-mq/">Amazon MQ website</a>. You can try Amazon MQ for free with the AWS Free Tier, which includes up to 750 hours of a single-instance mq.t2.micro broker and up to 1 GB of storage per month for one year.</p>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/90/" rel="tag">90</a><a href="https://noise.getoto.net/tag/ace/" rel="tag">ACE</a><a href="https://noise.getoto.net/tag/actions/" rel="tag">actions</a><a href="https://noise.getoto.net/tag/activemq/" rel="tag">ActiveMQ</a><a href="https://noise.getoto.net/tag/ad/" rel="tag">AD</a><a href="https://noise.getoto.net/tag/adi/" rel="tag">ADI</a><a href="https://noise.getoto.net/tag/ads/" rel="tag">ads</a><a href="https://noise.getoto.net/tag/ai/" rel="tag">AI</a><a href="https://noise.getoto.net/tag/all/" rel="tag">All</a><a href="https://noise.getoto.net/tag/als/" rel="tag">als</a><a href="https://noise.getoto.net/tag/amazon/" rel="tag">amazon</a><a href="https://noise.getoto.net/tag/amazon-cloudwatch/" rel="tag">Amazon CloudWatch</a><a href="https://noise.getoto.net/tag/amazon-dynamodb/" rel="tag">Amazon DynamoDB</a><a href="https://noise.getoto.net/tag/amazon-kinesis/" rel="tag">Amazon Kinesis</a><a href="https://noise.getoto.net/tag/amazon-kinesis-streams/" rel="tag">Amazon Kinesis Streams</a><a href="https://noise.getoto.net/tag/amazon-mq/" rel="tag">Amazon MQ*</a><a href="https://noise.getoto.net/tag/amazon-s3/" rel="tag">Amazon S3</a><a href="https://noise.getoto.net/tag/amazon-sns/" rel="tag">Amazon SNS</a><a href="https://noise.getoto.net/tag/amazon-sqs/" rel="tag">Amazon SQS</a><a href="https://noise.getoto.net/tag/amazon-web-services/" rel="tag">Amazon Web Services</a><a href="https://noise.getoto.net/tag/apache/" rel="tag">Apache</a><a href="https://noise.getoto.net/tag/apis/" rel="tag">APIs</a><a href="https://noise.getoto.net/tag/app/" rel="tag">app</a><a href="https://noise.getoto.net/tag/application-integration/" rel="tag">Application Integration</a><a href="https://noise.getoto.net/tag/application-services/" rel="tag">Application Services*</a><a href="https://noise.getoto.net/tag/applications/" rel="tag">applications</a><a href="https://noise.getoto.net/tag/apt/" rel="tag">apt</a><a href="https://noise.getoto.net/tag/architecture/" rel="tag">Architecture</a><a href="https://noise.getoto.net/tag/aria/" rel="tag">ARIA</a><a href="https://noise.getoto.net/tag/arin/" rel="tag">arin</a><a href="https://noise.getoto.net/tag/art/" rel="tag">art</a><a href="https://noise.getoto.net/tag/artifact/" rel="tag">Artifact</a><a href="https://noise.getoto.net/tag/asia/" rel="tag">asia</a><a href="https://noise.getoto.net/tag/asia-pacific/" rel="tag">Asia Pacific</a><a href="https://noise.getoto.net/tag/ati/" rel="tag">ATI</a><a href="https://noise.getoto.net/tag/ats/" rel="tag">ATS</a><a href="https://noise.getoto.net/tag/auth/" rel="tag">auth</a><a href="https://noise.getoto.net/tag/availability/" rel="tag">Availability</a><a href="https://noise.getoto.net/tag/aws/" rel="tag">AWS</a><a href="https://noise.getoto.net/tag/aws-account/" rel="tag">AWS account</a><a href="https://noise.getoto.net/tag/aws-cloud/" rel="tag">AWS Cloud</a><a href="https://noise.getoto.net/tag/aws-config/" rel="tag">AWS Config</a><a href="https://noise.getoto.net/tag/aws-direct-connect/" rel="tag">AWS Direct Connect</a><a href="https://noise.getoto.net/tag/aws-elastic-beanstalk/" rel="tag">AWS Elastic Beanstalk</a><a href="https://noise.getoto.net/tag/aws-lambda/" rel="tag">AWS Lambda</a><a href="https://noise.getoto.net/tag/aws-solutions/" rel="tag">aws solutions</a><a href="https://noise.getoto.net/tag/bean/" rel="tag">Bean</a><a href="https://noise.getoto.net/tag/bec/" rel="tag">BEC</a><a href="https://noise.getoto.net/tag/ble/" rel="tag">ble</a><a href="https://noise.getoto.net/tag/book/" rel="tag">book</a><a href="https://noise.getoto.net/tag/bsi/" rel="tag">BSI</a><a href="https://noise.getoto.net/tag/c/" rel="tag">C</a><a href="https://noise.getoto.net/tag/cam/" rel="tag">cam</a><a href="https://noise.getoto.net/tag/car/" rel="tag">car</a><a href="https://noise.getoto.net/tag/cas/" rel="tag">CAS</a><a href="https://noise.getoto.net/tag/case/" rel="tag">Case</a><a href="https://noise.getoto.net/tag/cassandra/" rel="tag">cassandra</a><a href="https://noise.getoto.net/tag/cd/" rel="tag">cd</a><a href="https://noise.getoto.net/tag/choice/" rel="tag">Choice</a><a href="https://noise.getoto.net/tag/ci/" rel="tag">ci</a><a href="https://noise.getoto.net/tag/cia/" rel="tag">cia</a><a href="https://noise.getoto.net/tag/cli/" rel="tag">cli</a><a href="https://noise.getoto.net/tag/cloud/" rel="tag">cloud</a><a href="https://noise.getoto.net/tag/cloud-services/" rel="tag">cloud services</a><a href="https://noise.getoto.net/tag/cloudwatch/" rel="tag">CloudWatch</a><a href="https://noise.getoto.net/tag/code/" rel="tag">code</a><a href="https://noise.getoto.net/tag/commercial/" rel="tag">commercial</a><a href="https://noise.getoto.net/tag/communications/" rel="tag">communications</a><a href="https://noise.getoto.net/tag/console/" rel="tag">console</a><a href="https://noise.getoto.net/tag/container/" rel="tag">container</a><a href="https://noise.getoto.net/tag/context/" rel="tag">context</a><a href="https://noise.getoto.net/tag/control/" rel="tag">control</a><a href="https://noise.getoto.net/tag/conversion/" rel="tag">conversion</a><a href="https://noise.getoto.net/tag/core/" rel="tag">Core</a><a href="https://noise.getoto.net/tag/court/" rel="tag">court</a><a href="https://noise.getoto.net/tag/credentials/" rel="tag">credentials</a><a href="https://noise.getoto.net/tag/curity/" rel="tag">Curity</a><a href="https://noise.getoto.net/tag/data/" rel="tag">data</a><a href="https://noise.getoto.net/tag/dbc/" rel="tag">dbc</a><a href="https://noise.getoto.net/tag/ddr/" rel="tag">ddr</a><a href="https://noise.getoto.net/tag/dea/" rel="tag">dea</a><a href="https://noise.getoto.net/tag/dependencies/" rel="tag">Dependencies</a><a href="https://noise.getoto.net/tag/det/" rel="tag">det</a><a href="https://noise.getoto.net/tag/dp/" rel="tag">dp</a><a href="https://noise.getoto.net/tag/dress/" rel="tag">dress</a><a href="https://noise.getoto.net/tag/dyn/" rel="tag">Dyn</a><a href="https://noise.getoto.net/tag/dynamodb/" rel="tag">DynamoDB</a><a href="https://noise.getoto.net/tag/east/" rel="tag">EAST</a><a href="https://noise.getoto.net/tag/ebook/" rel="tag">ebook</a><a href="https://noise.getoto.net/tag/ebs/" rel="tag">ebs</a><a href="https://noise.getoto.net/tag/ebuild/" rel="tag">ebuild</a><a href="https://noise.getoto.net/tag/ec/" rel="tag">ec</a><a href="https://noise.getoto.net/tag/ec2/" rel="tag">EC2</a><a href="https://noise.getoto.net/tag/eclipse/" rel="tag">eclipse</a><a href="https://noise.getoto.net/tag/ecr/" rel="tag">ECR</a><a href="https://noise.getoto.net/tag/ed/" rel="tag">ed</a><a href="https://noise.getoto.net/tag/edge/" rel="tag">Edge</a><a href="https://noise.getoto.net/tag/elastic-beanstalk/" rel="tag">Elastic Beanstalk</a><a href="https://noise.getoto.net/tag/ens/" rel="tag">ENS</a><a href="https://noise.getoto.net/tag/enterprise/" rel="tag">Enterprise</a><a href="https://noise.getoto.net/tag/enterprise-strategy/" rel="tag">Enterprise Strategy*</a><a href="https://noise.getoto.net/tag/environment/" rel="tag">environment</a><a href="https://noise.getoto.net/tag/et/" rel="tag">et</a><a href="https://noise.getoto.net/tag/eu/" rel="tag">eu</a><a href="https://noise.getoto.net/tag/facebook/" rel="tag">Facebook</a><a href="https://noise.getoto.net/tag/fact/" rel="tag">fact</a><a href="https://noise.getoto.net/tag/fail/" rel="tag">fail</a><a href="https://noise.getoto.net/tag/failover/" rel="tag">Failover</a><a href="https://noise.getoto.net/tag/fine/" rel="tag">fine</a><a href="https://noise.getoto.net/tag/fir/" rel="tag">fir</a><a href="https://noise.getoto.net/tag/form/" rel="tag">form</a><a href="https://noise.getoto.net/tag/fun/" rel="tag">Fun</a><a href="https://noise.getoto.net/tag/gateway/" rel="tag">Gateway</a><a href="https://noise.getoto.net/tag/general/" rel="tag">General</a><a href="https://noise.getoto.net/tag/git/" rel="tag">Git</a><a href="https://noise.getoto.net/tag/github/" rel="tag">Github</a><a href="https://noise.getoto.net/tag/go/" rel="tag">Go</a><a href="https://noise.getoto.net/tag/got/" rel="tag">got</a><a href="https://noise.getoto.net/tag/guide/" rel="tag">guide</a><a href="https://noise.getoto.net/tag/hat/" rel="tag">HAT</a><a href="https://noise.getoto.net/tag/header/" rel="tag">header</a><a href="https://noise.getoto.net/tag/html/" rel="tag">html</a><a href="https://noise.getoto.net/tag/http/" rel="tag">http</a><a href="https://noise.getoto.net/tag/ice/" rel="tag">ICE</a><a href="https://noise.getoto.net/tag/ide/" rel="tag">IDE</a><a href="https://noise.getoto.net/tag/inside/" rel="tag">Inside</a><a href="https://noise.getoto.net/tag/install/" rel="tag">install</a><a href="https://noise.getoto.net/tag/intel/" rel="tag">intel</a><a href="https://noise.getoto.net/tag/internet/" rel="tag">internet</a><a href="https://noise.getoto.net/tag/ip/" rel="tag">IP</a><a href="https://noise.getoto.net/tag/ip-address/" rel="tag">ip address</a><a href="https://noise.getoto.net/tag/ips/" rel="tag">IPS</a><a href="https://noise.getoto.net/tag/ireland/" rel="tag">ireland</a><a href="https://noise.getoto.net/tag/irs/" rel="tag">irs</a><a href="https://noise.getoto.net/tag/iss/" rel="tag">iss</a><a href="https://noise.getoto.net/tag/iste/" rel="tag">ISTE</a><a href="https://noise.getoto.net/tag/java/" rel="tag">java</a><a href="https://noise.getoto.net/tag/java-sdk/" rel="tag">Java SDK</a><a href="https://noise.getoto.net/tag/kinesis/" rel="tag">kinesis</a><a href="https://noise.getoto.net/tag/lambda/" rel="tag">lambda</a><a href="https://noise.getoto.net/tag/laptop/" rel="tag">laptop</a><a href="https://noise.getoto.net/tag/launch/" rel="tag">launch</a><a href="https://noise.getoto.net/tag/law/" rel="tag">Law</a><a href="https://noise.getoto.net/tag/laws/" rel="tag">laws</a><a href="https://noise.getoto.net/tag/led/" rel="tag">LED</a><a href="https://noise.getoto.net/tag/lfi/" rel="tag">lfi</a><a href="https://noise.getoto.net/tag/logging/" rel="tag">logging</a><a href="https://noise.getoto.net/tag/lte/" rel="tag">LTE</a><a href="https://noise.getoto.net/tag/mac/" rel="tag">Mac</a><a href="https://noise.getoto.net/tag/make/" rel="tag">Make</a><a href="https://noise.getoto.net/tag/mali/" rel="tag">Mali</a><a href="https://noise.getoto.net/tag/mana/" rel="tag">mana</a><a href="https://noise.getoto.net/tag/maven/" rel="tag">maven</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/message-topics/" rel="tag">message topics</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a><a href="https://noise.getoto.net/tag/migration/" rel="tag">Migration</a><a href="https://noise.getoto.net/tag/monitor/" rel="tag">Monitor</a><a href="https://noise.getoto.net/tag/monitoring/" rel="tag">monitoring</a><a href="https://noise.getoto.net/tag/mqtt/" rel="tag">MQTT</a><a href="https://noise.getoto.net/tag/nab/" rel="tag">NAB</a><a href="https://noise.getoto.net/tag/ncr/" rel="tag">NCR</a><a href="https://noise.getoto.net/tag/nec/" rel="tag">NEC</a><a href="https://noise.getoto.net/tag/nes/" rel="tag">NES</a><a href="https://noise.getoto.net/tag/network/" rel="tag">Network</a><a href="https://noise.getoto.net/tag/nsa/" rel="tag">NSA</a><a href="https://noise.getoto.net/tag/on-premises/" rel="tag">on-premises</a><a href="https://noise.getoto.net/tag/oregon/" rel="tag">Oregon</a><a href="https://noise.getoto.net/tag/org/" rel="tag">ORG</a><a href="https://noise.getoto.net/tag/oss/" rel="tag">OSS</a><a href="https://noise.getoto.net/tag/other/" rel="tag">Other</a><a href="https://noise.getoto.net/tag/ous/" rel="tag">OUs</a><a href="https://noise.getoto.net/tag/pa/" rel="tag">PA</a><a href="https://noise.getoto.net/tag/password/" rel="tag">password</a><a href="https://noise.getoto.net/tag/pc/" rel="tag">pc</a><a href="https://noise.getoto.net/tag/plex/" rel="tag">Plex</a><a href="https://noise.getoto.net/tag/plugin/" rel="tag">plugin</a><a href="https://noise.getoto.net/tag/power/" rel="tag">power</a><a href="https://noise.getoto.net/tag/ppl/" rel="tag">PPL</a><a href="https://noise.getoto.net/tag/present/" rel="tag">Present</a><a href="https://noise.getoto.net/tag/project/" rel="tag">project</a><a href="https://noise.getoto.net/tag/protocols/" rel="tag">protocols</a><a href="https://noise.getoto.net/tag/ps/" rel="tag">ps</a><a href="https://noise.getoto.net/tag/pth/" rel="tag">pth</a><a href="https://noise.getoto.net/tag/qt/" rel="tag">Qt</a><a href="https://noise.getoto.net/tag/r/" rel="tag">R</a><a href="https://noise.getoto.net/tag/rat/" rel="tag">rat</a><a href="https://noise.getoto.net/tag/rate/" rel="tag">rate</a><a href="https://noise.getoto.net/tag/registry/" rel="tag">registry</a><a href="https://noise.getoto.net/tag/rest/" rel="tag">rest</a><a href="https://noise.getoto.net/tag/roles/" rel="tag">roles</a><a href="https://noise.getoto.net/tag/router/" rel="tag">router</a><a href="https://noise.getoto.net/tag/routing/" rel="tag">Routing</a><a href="https://noise.getoto.net/tag/rov/" rel="tag">ROV</a><a href="https://noise.getoto.net/tag/rti/" rel="tag">RTI</a><a href="https://noise.getoto.net/tag/running/" rel="tag">running</a><a href="https://noise.getoto.net/tag/s/" rel="tag">S.</a><a href="https://noise.getoto.net/tag/s3/" rel="tag">S3</a><a href="https://noise.getoto.net/tag/s3-bucket/" rel="tag">S3 bucket</a><a href="https://noise.getoto.net/tag/sam/" rel="tag">SAM</a><a href="https://noise.getoto.net/tag/schema/" rel="tag">schema</a><a href="https://noise.getoto.net/tag/sdk/" rel="tag">SDK</a><a href="https://noise.getoto.net/tag/secrets/" rel="tag">secrets</a><a href="https://noise.getoto.net/tag/security/" rel="tag">security</a><a href="https://noise.getoto.net/tag/security-group/" rel="tag">security group</a><a href="https://noise.getoto.net/tag/ses/" rel="tag">SES</a><a href="https://noise.getoto.net/tag/slack/" rel="tag">Slack</a><a href="https://noise.getoto.net/tag/sns/" rel="tag">SNS</a><a href="https://noise.getoto.net/tag/spark/" rel="tag">Spark</a><a href="https://noise.getoto.net/tag/spring/" rel="tag">spring</a><a href="https://noise.getoto.net/tag/sqs/" rel="tag">sqs</a><a href="https://noise.getoto.net/tag/sse/" rel="tag">SSE</a><a href="https://noise.getoto.net/tag/ssl/" rel="tag">SSL</a><a href="https://noise.getoto.net/tag/star/" rel="tag">Star</a><a href="https://noise.getoto.net/tag/storage/" rel="tag">storage</a><a href="https://noise.getoto.net/tag/support/" rel="tag">support</a><a href="https://noise.getoto.net/tag/tag/" rel="tag">TAG</a><a href="https://noise.getoto.net/tag/talk/" rel="tag">talk</a><a href="https://noise.getoto.net/tag/tech/" rel="tag">tech</a><a href="https://noise.getoto.net/tag/technology/" rel="tag">Technology</a><a href="https://noise.getoto.net/tag/ted/" rel="tag">ted</a><a href="https://noise.getoto.net/tag/terminal/" rel="tag">terminal</a><a href="https://noise.getoto.net/tag/test/" rel="tag">test</a><a href="https://noise.getoto.net/tag/testing/" rel="tag">testing</a><a href="https://noise.getoto.net/tag/the/" rel="tag">The</a><a href="https://noise.getoto.net/tag/tic/" rel="tag">TIC</a><a href="https://noise.getoto.net/tag/time/" rel="tag">time</a><a href="https://noise.getoto.net/tag/tor/" rel="tag">tor</a><a href="https://noise.getoto.net/tag/ui/" rel="tag">UI</a><a href="https://noise.getoto.net/tag/un/" rel="tag">un</a><a href="https://noise.getoto.net/tag/us/" rel="tag">US</a><a href="https://noise.getoto.net/tag/variables/" rel="tag">variables</a><a href="https://noise.getoto.net/tag/virgin/" rel="tag">virgin</a><a href="https://noise.getoto.net/tag/visual-studio/" rel="tag">Visual Studio</a><a href="https://noise.getoto.net/tag/vpc/" rel="tag">VPC</a><a href="https://noise.getoto.net/tag/vpn/" rel="tag">vpn</a><a href="https://noise.getoto.net/tag/war/" rel="tag">war</a><a href="https://noise.getoto.net/tag/watch/" rel="tag">watch</a><a href="https://noise.getoto.net/tag/web/" rel="tag">web</a><a href="https://noise.getoto.net/tag/web-services/" rel="tag">web services</a><a href="https://noise.getoto.net/tag/website/" rel="tag">website</a><a href="https://noise.getoto.net/tag/win/" rel="tag">win</a><a href="https://noise.getoto.net/tag/windows/" rel="tag">windows</a><a href="https://noise.getoto.net/tag/work/" rel="tag">Work</a><a href="https://noise.getoto.net/tag/writing/" rel="tag">writing</a><a href="https://noise.getoto.net/tag/xml/" rel="tag">xml</a></span></footer></article>
<article id="post-356529" class="post-356529 post type-post status-publish format-standard hentry tag-accessibility tag-ace tag-activemq tag-ad tag-ai tag-all tag-amazon tag-amazon-mq tag-apache tag-app tag-application-integration tag-applications tag-architecture tag-art tag-ati tag-availability tag-aws tag-aws-cloud tag-aws-direct-connect tag-aws-lambda tag-aws-solutions tag-ble tag-bsi tag-bt tag-business tag-c tag-cam tag-cas tag-case tag-cases tag-cern tag-ci tag-cli tag-cloud tag-cloud-messaging tag-column tag-console tag-court tag-curity tag-ddr tag-deployment tag-developer tag-development tag-down tag-dp tag-dress tag-dyn tag-ebs tag-ec tag-ed tag-edge tag-enterprise tag-enterprise-strategy tag-environment tag-et tag-eu tag-fir tag-form tag-getting-started tag-gre tag-guide tag-hat tag-ibm tag-ice tag-ide tag-install tag-internet tag-ios tag-ip tag-ip-address tag-irs tag-iste tag-java tag-lambda tag-launch tag-led tag-light tag-lte tag-mana tag-media tag-message-queues tag-messaging tag-migration tag-mqtt tag-nec tag-nes tag-network tag-nsa tag-on-premises tag-org tag-other tag-pa tag-pc tag-phi tag-plex tag-ppl tag-processing tag-protocols tag-ps tag-qt tag-r tag-rat tag-rate tag-remote tag-resource tag-resources tag-rest tag-routing tag-rov tag-rti tag-running tag-s tag-sam tag-scr tag-security tag-security-group tag-server tag-serverless tag-serverless-architecture tag-ses tag-setup tag-shed tag-sse tag-ssl tag-star tag-storage tag-sts tag-subnet tag-target tag-tech tag-ted tag-test tag-testing tag-the tag-things tag-tic tag-tor tag-ui tag-un tag-us tag-useful tag-vpc tag-vpn tag-war tag-web tag-website tag-win tag-work tag-xml">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2018/02/20/running-activemq-in-a-hybrid-cloud-environment-with-amazon-mq/" rel="bookmark">Running ActiveMQ in a Hybrid Cloud Environment with Amazon MQ</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2018/02/20/running-activemq-in-a-hybrid-cloud-environment-with-amazon-mq/" rel="bookmark"><time class="entry-date" datetime="2018-02-20T07:47:11+02:00">2018-02-20</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/tara-van-unen/" rel="author">Tara Van Unen</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Tara Van Unen">Tara Van Unen</a> original <a href="https://aws.amazon.com/blogs/compute/running-activemq-in-a-hybrid-cloud-environment-with-amazon-mq/">https://aws.amazon.com/blogs/compute/running-activemq-in-a-hybrid-cloud-environment-with-amazon-mq/</a></p>
<p>This post courtesy of Greg Share, AWS Solutions Architect</p>
<p>Many organizations, particularly enterprises, rely on message brokers to connect and coordinate different systems. Message brokers enable distributed applications to communicate with one another, serving as the technological backbone for their IT environment, and ultimately their business services. Applications depend on messaging to work.</p>
<p>In many cases, those organizations have started to build new or “lift and shift” applications to AWS. In some cases, there are applications, such as mainframe systems, too costly to migrate. In these scenarios, those on-premises applications still need to interact with cloud-based components.</p>
<p><a href="https://aws.amazon.com/amazon-mq/">Amazon MQ</a> is a managed message broker service for ActiveMQ that enables organizations to send messages between applications in the cloud and on-premises to enable hybrid environments and application modernization. For example, you can <a href="https://aws.amazon.com/blogs/compute/invoking-aws-lambda-from-amazon-mq/">invoke AWS Lambda from queues and topics managed by Amazon MQ brokers</a> to integrate legacy systems with serverless architectures. ActiveMQ is an open-source message broker written in Java that is packaged with clients in multiple languages, Java Message Server (JMS) client being one example.</p>
<p>This post shows you can use Amazon MQ to integrate on-premises and cloud environments using the network of brokers feature of ActiveMQ. It provides configuration parameters for a one-way duplex connection for the flow of messages from an on-premises ActiveMQ message broker to Amazon MQ.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/integrating-on-premises-and-cloud-environments.jpg"><img loading="lazy" class="alignnone wp-image-3947 size-large" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/integrating-on-premises-and-cloud-environments-1024x396.jpg" alt="" width="1024" height="396" /></a></p>
<h2>ActiveMQ and the network of brokers</h2>
<p>First, look at queues within ActiveMQ and then at the network of brokers as a mechanism to distribute messages.</p>
<p>The network of brokers behaves differently from models such as physical networks. The key consideration is that the production (sending) of a message is disconnected from the consumption of that message. Think of the delivery of a parcel: The parcel is sent by the supplier (producer) to the end customer (consumer). The path it took to get there is of little concern to the customer, as long as it receives the package.</p>
<p>The same logic can be applied to the network of brokers. Here’s how you build the flow from a simple message to a queue and build toward a network of brokers. Before you look at setting up a hybrid connection, I discuss how a broker processes messages in a simple scenario.</p>
<p>When a message is sent from a producer to a queue on a broker, the following steps occur:</p>
<ol>
<li>A message is sent to a queue from the producer.</li>
<li>The broker persists this in its store or journal.</li>
<li>At this point, an acknowledgement (ACK) is sent to the producer from the broker.<br /> <a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/broker-sends-ack.jpg"><img loading="lazy" class="alignnone wp-image-3948 size-medium" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/broker-sends-ack-300x295.jpg" alt="" width="300" height="295" /></a></li>
</ol>
<p>When a consumer looks to consume the message from that same queue, the following steps occur:</p>
<ol>
<li>The message listener (consumer) calls the broker, which creates a subscription to the queue.</li>
<li>Messages are fetched from the message store and sent to the consumer.</li>
<li>The consumer acknowledges that the message has been received before processing it.</li>
<li>Upon receiving the ACK, the broker sets the message as having been consumed. By default, this deletes it from the queue.
<ul>
<li>You can set the consumer to ACK after processing by setting up <strong>transaction</strong> <strong>management</strong> or handle it manually using&nbsp;<strong>Session.CLIENT_ACKNOWLEDGE</strong>.</li>
</ul>
</li>
</ol>
<h2>Static propagation</h2>
<p>I now introduce the concept of static propagation with the network of brokers as the mechanism for message transfer from on-premises brokers to Amazon MQ. &nbsp;Static propagation refers to message propagation that occurs in the&nbsp;absence&nbsp;of subscription information. In this case, the objective is to transfer messages arriving at your selected on-premises broker to the Amazon MQ broker for consumption within the cloud environment.</p>
<p>After you configure static propagation with a network of brokers, the following occurs:</p>
<ol>
<li>The on-premises broker receives a message from a producer for a specific queue.</li>
<li>The on-premises broker sends (statically propagates) the message to the Amazon MQ broker.</li>
<li>The Amazon MQ broker sends an acknowledgement to the on-premises broker, which marks the message as having been consumed.<a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/broker-sends-ack2-sm.jpg"><img loading="lazy" class="alignnone size-full wp-image-3979" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/broker-sends-ack2-sm.jpg" alt="" width="476" height="396" /></a></li>
<li>Amazon MQ holds the message in its queue ready for consumption.</li>
<li>A consumer connects to Amazon MQ broker, subscribes to the queue in which the message resides, and receives the message.</li>
<li>Amazon MQ broker marks the message as having been consumed.</li>
</ol>
<h2>Getting started</h2>
<p>The first step is creating an Amazon MQ broker.</p>
<ol>
<li>Sign in to the <a href="https://console.aws.amazon.com/amazon-mq/">Amazon MQ console</a> and launch a new Amazon MQ broker.</li>
<li>Name your broker and choose <strong>Next step</strong>.</li>
<li>For <strong>Broker instance type</strong>, choose your instance size:<br /> – <strong>mq.t2.micro</strong><br /> – <strong>mq.m4.large</strong></li>
<li>For<strong> Deployment mode</strong>, enter one of the following:<br /> – <strong>Single-instance broker</strong> for development and test implementations (recommended)<br /> – <strong>Active/standby broker for high availability</strong> in production environments</li>
<li>Scroll down and enter your user name and password.</li>
<li>Expand <strong>Advanced Settings</strong>.</li>
<li>For <strong>VPC</strong>, <strong>Subnet</strong>, and <strong>Security Group</strong>, pick the values for the resources in which your broker will reside.</li>
<li>For <strong>Public Accessibility</strong>, choose <strong>Yes</strong>, as connectivity is internet-based. Another option would be to use private connectivity between your on-premises network and the VPC, an example being an AWS Direct Connect or VPN connection. In that case, you could set <strong>Public Accessibility</strong> to <strong>No</strong>.</li>
<li>For <strong>Maintenance</strong>, leave the default value, <strong>No preference</strong>.</li>
<li>Choose <strong>Create Broker</strong>. Wait several minutes for the broker to be created.<br /> <a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/broker-creation.jpg"><img loading="lazy" class="alignnone size-full wp-image-3952" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/broker-creation.jpg" alt="" width="1364" height="108" /></a></li>
</ol>
<p>After creation is complete, you see your broker listed.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/broker-listed.jpg"><img loading="lazy" class="alignnone size-full wp-image-3951" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/broker-listed.jpg" alt="" width="2292" height="394" /></a></p>
<p>For connectivity to work, you must configure the security group where Amazon MQ resides. For this post, I focus on the OpenWire protocol.</p>
<p>For Openwire connectivity, allow port 61617 access for Amazon MQ from your on-premises <strong>ActiveMQ</strong> broker source IP address. For alternate protocols, see the Amazon MQ broker configuration information for the ports required:</p>
<p>OpenWire – ssl://xxxxxxx.xxx.com:61617<br /> AMQP – amqp+ssl:// xxxxxxx.xxx.com:5671<br /> STOMP – stomp+ssl:// xxxxxxx.xxx.com:61614<br /> MQTT – mqtt+ssl:// xxxxxxx.xxx.com:8883<br /> WSS – wss:// xxxxxxx.xxx.com:61619</p>
<h2>Configuring the network of brokers</h2>
<p>Configuring the network of brokers with static propagation occurs on the on-premises broker by applying changes to the following file:<br /> &lt;activemq install directory&gt;/conf activemq.xml</p>
<h3>Network connector</h3>
<p>This is the first configuration item required to enable a network of brokers. It is only required on the on-premises broker, which initiates and creates the connection with Amazon MQ. This connection, after it’s established, enables the flow of messages in either direction between the on-premises broker and Amazon MQ. The focus of this post is the uni-directional flow of messages from the on-premises broker to Amazon MQ.</p>
<p>The default activemq.xml file does not include the network connector configuration. Add this with the <strong>networkConnector</strong> element. In this scenario, edit the on-premises broker activemq.xml file to include the following information between &lt;systemUsage&gt; and &lt;transportConnectors&gt;:</p>
<pre><code class="lang-xml">&lt;networkConnectors&gt;
             &lt;networkConnector 
                name=<strong>&quot;Q:source broker name-&gt;target broker name&quot;</strong>
                duplex=<strong>&quot;false&quot;</strong> 
                uri=<strong>&quot;</strong>static<strong>:(ssl:// aws mq endpoint:61617)&quot;</strong> 
                userName=<strong>&quot;username&quot;</strong>
                password=<strong>&quot;password&quot;</strong> 
                networkTTL=&quot;2&quot; 
                dynamicOnly=&quot;false&quot;&gt;
                &lt;staticallyIncludedDestinations&gt;
                    &lt;queue physicalName=<strong>&quot;queuename&quot;</strong>/&gt;
                &lt;/staticallyIncludedDestinations&gt; 
                &lt;excludedDestinations&gt;
                      &lt;queue physicalName=&quot;&gt;&quot; /&gt;
                &lt;/excludedDestinations&gt;
             &lt;/networkConnector&gt; 
     &lt;networkConnectors&gt;</code></pre>
<p>The highlighted components are the most important elements when configuring your on-premises broker.</p>
<ul>
<li><strong>name</strong> – Name of the network bridge. In this case, it specifies two things:
<ul>
<li>That this connection relates to an ActiveMQ queue (Q) as opposed to a topic (T), for reference purposes.</li>
<li>The source broker and target broker.</li>
</ul>
</li>
<li><strong>duplex</strong> –Setting this to <strong>false</strong> ensures that messages traverse uni-directionally from the on-premises broker to Amazon MQ.</li>
<li><strong>uri</strong> –Specifies the remote endpoint to which to connect for message transfer. In this case, it is an Openwire endpoint on your Amazon MQ broker. This information could be obtained from the Amazon MQ console or via the API.<a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/endpoints.jpg"><img loading="lazy" class="alignnone size-full wp-image-3956" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/endpoints.jpg" alt="" width="1360" height="278" /></a></li>
<li><strong>username and password</strong> – The same username and password configured when creating the Amazon MQ broker, and used to access the Amazon MQ ActiveMQ console.</li>
<li><strong>networkTTL</strong> – Number of brokers in the network through which messages and subscriptions can pass. Leave this setting at the current value, if it is already included in your broker connection.</li>
<li><strong>staticallyIncludedDestinations &gt; queue physicalName</strong> – The destination ActiveMQ queue for which messages are destined. This is the queue that is propagated from the on-premises broker to the Amazon MQ broker for message consumption.</li>
</ul>
<p>After the network connector is configured, you must restart the ActiveMQ service on the on-premises broker for the changes to be applied.</p>
<h2>Verify the configuration</h2>
<p>There are a number of places within the ActiveMQ console of your on-premises and Amazon MQ brokers to browse to verify that the configuration is correct and the connection has been established.</p>
<h3>On-premises broker</h3>
<p>Launch the ActiveMQ console of your on-premises broker and navigate to <strong>Network</strong>. You should see an active network bridge similar to the following:</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/network-bridge.jpg"><img loading="lazy" class="alignnone size-full wp-image-3957" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/network-bridge.jpg" alt="" width="940" height="62" /></a></p>
<p>This identifies that the connection between your on-premises broker and your Amazon MQ broker is up and running.</p>
<p>Now navigate to <strong>Connections</strong> and scroll to the bottom of the page. Under the <strong>Network Connectors</strong> subsection, you should see a connector labeled with the <strong>name</strong>: value that you provided within the ActiveMQ.xml configuration file. You should see an entry similar to:</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/connector.jpg"><img loading="lazy" class="alignnone size-full wp-image-3958" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/connector.jpg" alt="" width="938" height="57" /></a></p>
<h3>Amazon MQ broker</h3>
<p>Launch the ActiveMQ console of your Amazon MQ broker and navigate to<strong> Connections</strong>. Scroll to the <strong>Connections openwire</strong> subsection and you should see a connection specified that references the <strong>name: value</strong> that you provided within the ActiveMQ.xml configuration file. You should see an entry similar to:</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/name-value.jpg"><img loading="lazy" class="alignnone size-full wp-image-3959" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/name-value.jpg" alt="" width="940" height="69" /></a></p>
<p>If you configured the <strong>uri</strong>: for AMQP, STOMP, MQTT, or WSS as opposed to Openwire, you would see this connection under the corresponding section of the <strong>Connections</strong> page.</p>
<h2>Testing your message flow</h2>
<p>The setup described outlines a way for messages produced on premises to be propagated to the cloud for consumption in the cloud. This section provides steps on verifying the message flow.</p>
<h3>Verify that the queue has been created</h3>
<p>After you specify this queue name as <strong>staticallyIncludedDestinations &gt; queue physicalName</strong>: and your ActiveMQ service starts, you see the following on your on-premises ActiveMQ console <strong>Queues</strong> page.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/queues.jpg"><img loading="lazy" class="alignnone size-full wp-image-3960" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/queues.jpg" alt="" width="929" height="69" /></a></p>
<p>As you can see, no messages have been sent but you have one consumer listed. If you then choose Active Consumers under the Views column, you see Active Consumers for TestingQ.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/testing-Q.jpg"><img loading="lazy" class="alignnone size-full wp-image-3961" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/testing-Q.jpg" alt="" width="1009" height="69" /></a></p>
<p>This is telling you that your Amazon MQ broker is a consumer of your on-premises broker for the testing queue.</p>
<h3>Produce and send a message to the on-premises broker</h3>
<p>Now, produce a message on an on-premises producer and send it to your on-premises broker to a queue named <strong>TestingQ</strong>. If you navigate back to the <strong>queues</strong> page of your on-premises ActiveMQ console, you see that the <strong>messages enqueued</strong> and <strong>messages dequeued</strong> column count for your <strong>TestingQ</strong> queue have changed:</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/messages-enqueued.jpg"><img loading="lazy" class="alignnone size-full wp-image-3962" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/messages-enqueued.jpg" alt="" width="931" height="73" /></a></p>
<p>What this means is that the message originating from the on-premises producer has traversed the on-premises broker and propagated immediately to the Amazon MQ broker. At this point, the message is no longer available for consumption from the on-premises broker.</p>
<p>If you access the ActiveMQ console of your Amazon MQ broker and navigate to the <strong>Queues</strong> page, you see the following for the <strong>TestingQ</strong> queue:</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/testing-Q-2.jpg"><img loading="lazy" class="alignnone size-full wp-image-3963" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/testing-Q-2.jpg" alt="" width="933" height="70" /></a></p>
<p>This means that the message originally sent to your on-premises broker has traversed the network of brokers unidirectional network bridge, and is ready to be consumed from your Amazon MQ broker. The indicator is the <strong>Number of Pending Messages</strong> column.</p>
<h3>Consume the message from an Amazon MQ broker</h3>
<p>Connect to the Amazon MQ <strong>TestingQ</strong> queue from a consumer within the AWS Cloud environment for message consumption. Log on to the ActiveMQ console of your Amazon MQ broker and navigate to the <strong>Queue</strong> page:</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/queues-2.jpg"><img loading="lazy" class="alignnone size-full wp-image-3964" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/queues-2.jpg" alt="" width="935" height="67" /></a></p>
<p>As you can see, the <strong>Number of Pending Messages</strong> column figure has changed to 0 as that message has been consumed.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/message-lifecycle.jpg"><img loading="lazy" class="alignnone wp-image-3965 size-large" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/02/20/message-lifecycle-1024x518.jpg" alt="" width="1024" height="518" /></a></p>
<p>This diagram outlines the message lifecycle from the on-premises producer to the on-premises broker, traversing the hybrid connection between the on-premises broker and Amazon MQ, and finally consumption within the AWS Cloud.</p>
<h2>Conclusion</h2>
<p>This post focused on an ActiveMQ-specific scenario for transferring messages within an ActiveMQ queue from an on-premises broker to Amazon MQ.</p>
<p>For other on-premises brokers, such as IBM MQ, another approach would be to run ActiveMQ on-premises broker and use JMS bridging to IBM MQ, while using the approach in this post to forward to Amazon MQ. Yet another approach would be to use Apache Camel for more sophisticated routing.</p>
<p>I hope that you have found this example of hybrid messaging between an on-premises environment in the AWS Cloud to be useful. Many customers are already using on-premises ActiveMQ brokers, and this is a great use case to enable hybrid cloud scenarios.</p>
<p>To learn more, see the <a href="https://aws.amazon.com/amazon-mq/">Amazon MQ</a> website and <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/welcome.html">Developer Guide</a>. You can <a href="https://console.aws.amazon.com/amazon-mq/home">try Amazon MQ for free</a> with the AWS Free Tier, which includes up to 750 hours of a single-instance mq.t2.micro broker and up to 1 GB of storage per month for one year.</p>
<p>&nbsp;</p>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/accessibility/" rel="tag">accessibility</a><a href="https://noise.getoto.net/tag/ace/" rel="tag">ACE</a><a href="https://noise.getoto.net/tag/activemq/" rel="tag">ActiveMQ</a><a href="https://noise.getoto.net/tag/ad/" rel="tag">AD</a><a href="https://noise.getoto.net/tag/ai/" rel="tag">AI</a><a href="https://noise.getoto.net/tag/all/" rel="tag">All</a><a href="https://noise.getoto.net/tag/amazon/" rel="tag">amazon</a><a href="https://noise.getoto.net/tag/amazon-mq/" rel="tag">Amazon MQ*</a><a href="https://noise.getoto.net/tag/apache/" rel="tag">Apache</a><a href="https://noise.getoto.net/tag/app/" rel="tag">app</a><a href="https://noise.getoto.net/tag/application-integration/" rel="tag">Application Integration</a><a href="https://noise.getoto.net/tag/applications/" rel="tag">applications</a><a href="https://noise.getoto.net/tag/architecture/" rel="tag">Architecture</a><a href="https://noise.getoto.net/tag/art/" rel="tag">art</a><a href="https://noise.getoto.net/tag/ati/" rel="tag">ATI</a><a href="https://noise.getoto.net/tag/availability/" rel="tag">Availability</a><a href="https://noise.getoto.net/tag/aws/" rel="tag">AWS</a><a href="https://noise.getoto.net/tag/aws-cloud/" rel="tag">AWS Cloud</a><a href="https://noise.getoto.net/tag/aws-direct-connect/" rel="tag">AWS Direct Connect</a><a href="https://noise.getoto.net/tag/aws-lambda/" rel="tag">AWS Lambda</a><a href="https://noise.getoto.net/tag/aws-solutions/" rel="tag">aws solutions</a><a href="https://noise.getoto.net/tag/ble/" rel="tag">ble</a><a href="https://noise.getoto.net/tag/bsi/" rel="tag">BSI</a><a href="https://noise.getoto.net/tag/bt/" rel="tag">BT</a><a href="https://noise.getoto.net/tag/business/" rel="tag">Business</a><a href="https://noise.getoto.net/tag/c/" rel="tag">C</a><a href="https://noise.getoto.net/tag/cam/" rel="tag">cam</a><a href="https://noise.getoto.net/tag/cas/" rel="tag">CAS</a><a href="https://noise.getoto.net/tag/case/" rel="tag">Case</a><a href="https://noise.getoto.net/tag/cases/" rel="tag">cases</a><a href="https://noise.getoto.net/tag/cern/" rel="tag">CERN</a><a href="https://noise.getoto.net/tag/ci/" rel="tag">ci</a><a href="https://noise.getoto.net/tag/cli/" rel="tag">cli</a><a href="https://noise.getoto.net/tag/cloud/" rel="tag">cloud</a><a href="https://noise.getoto.net/tag/cloud-messaging/" rel="tag">cloud messaging</a><a href="https://noise.getoto.net/tag/column/" rel="tag">column</a><a href="https://noise.getoto.net/tag/console/" rel="tag">console</a><a href="https://noise.getoto.net/tag/court/" rel="tag">court</a><a href="https://noise.getoto.net/tag/curity/" rel="tag">Curity</a><a href="https://noise.getoto.net/tag/ddr/" rel="tag">ddr</a><a href="https://noise.getoto.net/tag/deployment/" rel="tag">deployment</a><a href="https://noise.getoto.net/tag/developer/" rel="tag">developer</a><a href="https://noise.getoto.net/tag/development/" rel="tag">development</a><a href="https://noise.getoto.net/tag/down/" rel="tag">down</a><a href="https://noise.getoto.net/tag/dp/" rel="tag">dp</a><a href="https://noise.getoto.net/tag/dress/" rel="tag">dress</a><a href="https://noise.getoto.net/tag/dyn/" rel="tag">Dyn</a><a href="https://noise.getoto.net/tag/ebs/" rel="tag">ebs</a><a href="https://noise.getoto.net/tag/ec/" rel="tag">ec</a><a href="https://noise.getoto.net/tag/ed/" rel="tag">ed</a><a href="https://noise.getoto.net/tag/edge/" rel="tag">Edge</a><a href="https://noise.getoto.net/tag/enterprise/" rel="tag">Enterprise</a><a href="https://noise.getoto.net/tag/enterprise-strategy/" rel="tag">Enterprise Strategy*</a><a href="https://noise.getoto.net/tag/environment/" rel="tag">environment</a><a href="https://noise.getoto.net/tag/et/" rel="tag">et</a><a href="https://noise.getoto.net/tag/eu/" rel="tag">eu</a><a href="https://noise.getoto.net/tag/fir/" rel="tag">fir</a><a href="https://noise.getoto.net/tag/form/" rel="tag">form</a><a href="https://noise.getoto.net/tag/getting-started/" rel="tag">getting started</a><a href="https://noise.getoto.net/tag/gre/" rel="tag">GRE</a><a href="https://noise.getoto.net/tag/guide/" rel="tag">guide</a><a href="https://noise.getoto.net/tag/hat/" rel="tag">HAT</a><a href="https://noise.getoto.net/tag/ibm/" rel="tag">ibm</a><a href="https://noise.getoto.net/tag/ice/" rel="tag">ICE</a><a href="https://noise.getoto.net/tag/ide/" rel="tag">IDE</a><a href="https://noise.getoto.net/tag/install/" rel="tag">install</a><a href="https://noise.getoto.net/tag/internet/" rel="tag">internet</a><a href="https://noise.getoto.net/tag/ios/" rel="tag">ios</a><a href="https://noise.getoto.net/tag/ip/" rel="tag">IP</a><a href="https://noise.getoto.net/tag/ip-address/" rel="tag">ip address</a><a href="https://noise.getoto.net/tag/irs/" rel="tag">irs</a><a href="https://noise.getoto.net/tag/iste/" rel="tag">ISTE</a><a href="https://noise.getoto.net/tag/java/" rel="tag">java</a><a href="https://noise.getoto.net/tag/lambda/" rel="tag">lambda</a><a href="https://noise.getoto.net/tag/launch/" rel="tag">launch</a><a href="https://noise.getoto.net/tag/led/" rel="tag">LED</a><a href="https://noise.getoto.net/tag/light/" rel="tag">light</a><a href="https://noise.getoto.net/tag/lte/" rel="tag">LTE</a><a href="https://noise.getoto.net/tag/mana/" rel="tag">mana</a><a href="https://noise.getoto.net/tag/media/" rel="tag">media</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a><a href="https://noise.getoto.net/tag/migration/" rel="tag">Migration</a><a href="https://noise.getoto.net/tag/mqtt/" rel="tag">MQTT</a><a href="https://noise.getoto.net/tag/nec/" rel="tag">NEC</a><a href="https://noise.getoto.net/tag/nes/" rel="tag">NES</a><a href="https://noise.getoto.net/tag/network/" rel="tag">Network</a><a href="https://noise.getoto.net/tag/nsa/" rel="tag">NSA</a><a href="https://noise.getoto.net/tag/on-premises/" rel="tag">on-premises</a><a href="https://noise.getoto.net/tag/org/" rel="tag">ORG</a><a href="https://noise.getoto.net/tag/other/" rel="tag">Other</a><a href="https://noise.getoto.net/tag/pa/" rel="tag">PA</a><a href="https://noise.getoto.net/tag/pc/" rel="tag">pc</a><a href="https://noise.getoto.net/tag/phi/" rel="tag">PHI</a><a href="https://noise.getoto.net/tag/plex/" rel="tag">Plex</a><a href="https://noise.getoto.net/tag/ppl/" rel="tag">PPL</a><a href="https://noise.getoto.net/tag/processing/" rel="tag">Processing</a><a href="https://noise.getoto.net/tag/protocols/" rel="tag">protocols</a><a href="https://noise.getoto.net/tag/ps/" rel="tag">ps</a><a href="https://noise.getoto.net/tag/qt/" rel="tag">Qt</a><a href="https://noise.getoto.net/tag/r/" rel="tag">R</a><a href="https://noise.getoto.net/tag/rat/" rel="tag">rat</a><a href="https://noise.getoto.net/tag/rate/" rel="tag">rate</a><a href="https://noise.getoto.net/tag/remote/" rel="tag">remote</a><a href="https://noise.getoto.net/tag/resource/" rel="tag">Resource</a><a href="https://noise.getoto.net/tag/resources/" rel="tag">resources</a><a href="https://noise.getoto.net/tag/rest/" rel="tag">rest</a><a href="https://noise.getoto.net/tag/routing/" rel="tag">Routing</a><a href="https://noise.getoto.net/tag/rov/" rel="tag">ROV</a><a href="https://noise.getoto.net/tag/rti/" rel="tag">RTI</a><a href="https://noise.getoto.net/tag/running/" rel="tag">running</a><a href="https://noise.getoto.net/tag/s/" rel="tag">S.</a><a href="https://noise.getoto.net/tag/sam/" rel="tag">SAM</a><a href="https://noise.getoto.net/tag/scr/" rel="tag">scr</a><a href="https://noise.getoto.net/tag/security/" rel="tag">security</a><a href="https://noise.getoto.net/tag/security-group/" rel="tag">security group</a><a href="https://noise.getoto.net/tag/server/" rel="tag">server</a><a href="https://noise.getoto.net/tag/serverless/" rel="tag">serverless</a><a href="https://noise.getoto.net/tag/serverless-architecture/" rel="tag">serverless architecture</a><a href="https://noise.getoto.net/tag/ses/" rel="tag">SES</a><a href="https://noise.getoto.net/tag/setup/" rel="tag">setup</a><a href="https://noise.getoto.net/tag/shed/" rel="tag">shed</a><a href="https://noise.getoto.net/tag/sse/" rel="tag">SSE</a><a href="https://noise.getoto.net/tag/ssl/" rel="tag">SSL</a><a href="https://noise.getoto.net/tag/star/" rel="tag">Star</a><a href="https://noise.getoto.net/tag/storage/" rel="tag">storage</a><a href="https://noise.getoto.net/tag/sts/" rel="tag">sts</a><a href="https://noise.getoto.net/tag/subnet/" rel="tag">Subnet</a><a href="https://noise.getoto.net/tag/target/" rel="tag">target</a><a href="https://noise.getoto.net/tag/tech/" rel="tag">tech</a><a href="https://noise.getoto.net/tag/ted/" rel="tag">ted</a><a href="https://noise.getoto.net/tag/test/" rel="tag">test</a><a href="https://noise.getoto.net/tag/testing/" rel="tag">testing</a><a href="https://noise.getoto.net/tag/the/" rel="tag">The</a><a href="https://noise.getoto.net/tag/things/" rel="tag">things</a><a href="https://noise.getoto.net/tag/tic/" rel="tag">TIC</a><a href="https://noise.getoto.net/tag/tor/" rel="tag">tor</a><a href="https://noise.getoto.net/tag/ui/" rel="tag">UI</a><a href="https://noise.getoto.net/tag/un/" rel="tag">un</a><a href="https://noise.getoto.net/tag/us/" rel="tag">US</a><a href="https://noise.getoto.net/tag/useful/" rel="tag">Useful</a><a href="https://noise.getoto.net/tag/vpc/" rel="tag">VPC</a><a href="https://noise.getoto.net/tag/vpn/" rel="tag">vpn</a><a href="https://noise.getoto.net/tag/war/" rel="tag">war</a><a href="https://noise.getoto.net/tag/web/" rel="tag">web</a><a href="https://noise.getoto.net/tag/website/" rel="tag">website</a><a href="https://noise.getoto.net/tag/win/" rel="tag">win</a><a href="https://noise.getoto.net/tag/work/" rel="tag">Work</a><a href="https://noise.getoto.net/tag/xml/" rel="tag">xml</a></span></footer></article>
<article id="post-351578" class="post-351578 post type-post status-publish format-standard hentry tag-activemq tag-ad tag-ads tag-ai tag-all tag-amazon tag-amazon-cloudwatch tag-amazon-cloudwatch-events tag-amazon-dynamodb tag-amazon-elastic-transcoder tag-amazon-mq tag-apache tag-api-gateway tag-apis tag-app tag-application-integration tag-application-services tag-apt tag-architecture tag-aria tag-art tag-aspect tag-ati tag-aws tag-aws-lambda tag-aws-solutions tag-ble tag-bsi tag-bug tag-c tag-cam tag-cap tag-cas tag-cli tag-cloud tag-cloud-messaging tag-cloudwatch tag-cloudwatch-events tag-cloudwatch-logs tag-code tag-console tag-credentials tag-curity tag-data tag-ddr tag-deployment tag-det tag-developer tag-developers tag-document tag-down tag-dress tag-dyn tag-dynamodb tag-dynamodb-table tag-east tag-ebs tag-ec tag-ed tag-ejs tag-enterprise tag-enterprise-strategy tag-environment tag-et tag-eu tag-event tag-event-driven-computing tag-events tag-fact tag-fir tag-form tag-fun tag-gateway tag-getting-started tag-gif tag-git tag-github tag-go tag-guide tag-hat tag-header tag-ice tag-ide tag-ip tag-ip-address tag-irs tag-json tag-lambda tag-lambda-function tag-launch tag-lte tag-make tag-mana tag-media tag-message-queues tag-message-topics tag-messaging tag-migration tag-mpa tag-nec tag-node-js tag-nodejs tag-on-premises tag-opera tag-other tag-pa tag-pc tag-ppl tag-processing tag-programming tag-r tag-rat tag-rate tag-ror tag-rov tag-rti tag-s tag-sam tag-scr tag-security tag-security-group tag-server tag-serverless tag-serverless-architecture tag-sse tag-star tag-status tag-storage tag-tea tag-ted tag-test tag-the tag-tic tag-time tag-tor tag-training tag-ui tag-un tag-us tag-useful tag-variables tag-video tag-videos tag-vpc tag-watch tag-web tag-website tag-win tag-work">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2018/01/30/invoking-aws-lambda-from-amazon-mq/" rel="bookmark">Invoking AWS Lambda from Amazon MQ</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2018/01/30/invoking-aws-lambda-from-amazon-mq/" rel="bookmark"><time class="entry-date" datetime="2018-01-30T05:36:27+02:00">2018-01-30</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/tara-van-unen/" rel="author">Tara Van Unen</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Tara Van Unen">Tara Van Unen</a> original <a href="https://aws.amazon.com/blogs/compute/invoking-aws-lambda-from-amazon-mq/">https://aws.amazon.com/blogs/compute/invoking-aws-lambda-from-amazon-mq/</a></p>
<h5><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/Josh_Kahn_Headshot2.png"><img loading="lazy" class="alignnone size-full wp-image-3802" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/Josh_Kahn_Headshot2.png" alt="" width="125" height="138" /></a></h5>
<h5>Contributed by Josh Kahn, AWS Solutions Architect</h5>
<p>Message brokers can be used to solve a number of needs in enterprise architectures, including managing workload queues and broadcasting messages to a number of subscribers. <a href="https://aws.amazon.com/amazon-mq/">Amazon MQ</a> is a managed message broker service for Apache ActiveMQ that makes it easy to set up and operate message brokers in the cloud.</p>
<p>In this post, I discuss one approach to invoking <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> from queues and topics managed by Amazon MQ brokers. This and other similar patterns can be useful in integrating legacy systems with serverless architectures. You could also integrate systems already migrated to the cloud that use common APIs such as JMS.</p>
<p>For example, imagine that you work for a company that produces training videos and which recently migrated its video management system to AWS. The on-premises system used to publish a message to an ActiveMQ broker when a video was ready for processing by an on-premises transcoder. However, on AWS, your company uses <a href="https://aws.amazon.com/elastictranscoder/">Amazon Elastic Transcoder</a>. Instead of modifying the management system, Lambda polls the broker for new messages and starts a new Elastic Transcoder job. This approach avoids changes to the existing application while refactoring the workload to leverage cloud-native components.</p>
<p>This solution uses <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html">Amazon CloudWatch Events</a> to trigger a Lambda function that polls the Amazon MQ broker for messages. Instead of starting an Elastic Transcoder job, the sample writes the received message to an <a href="https://aws.amazon.com/dynamodb/">Amazon DynamoDB</a> table with a time stamp indicating the time received.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/30/reference_diagram_resized.png"><img loading="lazy" class="aligncenter wp-image-3807 size-full" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/30/reference_diagram_resized.png" alt="" width="857" height="240" /></a></p>
<h2>Getting started</h2>
<p>To start, navigate to the <a href="https://console.aws.amazon.com/amazon-mq/home">Amazon MQ console</a>. Next, launch a new Amazon MQ instance, selecting <strong>Single-instance Broker</strong> and supplying a broker name, user name, and password. Be sure to document the user name and password for later.</p>
<p>For the purposes of this sample, choose the default options in the <strong>Advanced settings</strong> section. Your new broker is deployed to the default VPC in the selected AWS Region with the default security group. For this post, you update the security group to allow access for your sample Lambda function. In a production scenario, I recommend deploying both the Lambda function and your Amazon MQ broker in your own VPC.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/Picture1-1.png"><img loading="lazy" class="size-full wp-image-3791 aligncenter" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/Picture1-1.png" alt="" width="692" height="685" /></a></p>
<p>After several minutes, your instance changes status from “Creation Pending” to “Available.” You can then visit the Details page of your broker to retrieve connection information, including a link to the ActiveMQ web console where you can monitor the status of your broker, publish test messages, and so on. In this example, use the Stomp protocol to connect to your broker. Be sure to capture the broker host name, for example:</p>
<p>&lt;BROKER_ID&gt;.mq.us-east-1.amazonaws.com</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/Picture2-1.png"><img loading="lazy" class="size-full wp-image-3792 aligncenter" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/Picture2-1.png" alt="" width="863" height="739" /></a></p>
<p>You should also modify the Security Group for the broker by clicking on its Security Group ID. Click the<strong> Edit</strong> button and then click <strong>Add Rule</strong> to allow inbound traffic on port 8162 for your IP address.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/Picture3-1.png"><img loading="lazy" class="aligncenter wp-image-3793" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/Picture3-1.png" alt="" width="600" height="208" /></a></p>
<h2>Deploying and scheduling the Lambda function</h2>
<p>To simplify the deployment of this example, I’ve provided an <a href="https://github.com/awslabs/serverless-application-model">AWS Serverless Application Model (SAM)</a> template that deploys the sample function and DynamoDB table, and schedules the function to be invoked every five minutes. Detailed instructions can be found with sample code on GitHub in the <a href="https://github.com/aws-samples/amazonmq-invoke-aws-lambda">amazonmq-invoke-aws-lambda repository</a>, with sample code. I discuss a few key aspects in this post.</p>
<p>First, SAM makes it easy to deploy and schedule invocation of our function:</p>
<pre><code class="lang-yaml"></code></pre>
<pre><code class="lang-yaml">SubscriberFunction:
	Type: AWS::Serverless::Function
	Properties:
		CodeUri: subscriber/
		Handler: index.handler
		Runtime: nodejs6.10
		Role: !GetAtt SubscriberFunctionRole.Arn
		Timeout: 15
		Environment:
			Variables:
				HOST: !Ref AmazonMQHost
				LOGIN: !Ref AmazonMQLogin
				PASSWORD: !Ref AmazonMQPassword
				QUEUE_NAME: !Ref AmazonMQQueueName
				WORKER_FUNCTIOn: !Ref WorkerFunction
		Events:
			Timer:
				Type: Schedule
				Properties:
					Schedule: rate(5 minutes)

WorkerFunction:
Type: AWS::Serverless::Function
	Properties:
		CodeUri: worker/
		Handler: index.handler
		Runtime: nodejs6.10
Role: !GetAtt WorkerFunctionRole.Arn
		Environment:
			Variables:
				TABLE_NAME: !Ref MessagesTable</code></pre>
<p>In the code, you include the URI, user name, and password for your newly created Amazon MQ broker. These allow the function to poll the broker for new messages on the sample queue.</p>
<p>The sample Lambda function is written in Node.js, but <a href="http://activemq.apache.org/cross-language-clients.html">clients exist for a number of programming languages</a>.</p>
<pre><code class="lang-js">stomp.connect(options, (error, client) =&gt; {
	if (error) { /* do something */ }

	let headers = {
		destination: ‘/queue/SAMPLE_QUEUE’,
		ack: ‘auto’
	}

	client.subscribe(headers, (error, message) =&gt; {
		if (error) { /* do something */ }

		message.readString(‘utf-8’, (error, body) =&gt; {
			if (error) { /* do something */ }

			let params = {
				FunctionName: MyWorkerFunction,
				Payload: JSON.stringify({
					message: body,
					timestamp: Date.now()
				})
			}

			let lambda = new AWS.Lambda()
			lambda.invoke(params, (error, data) =&gt; {
				if (error) { /* do something */ }
			})
		}
})
})</code></pre>
<pre><code class="lang- node.js"></code></pre>
<h2>Sending a sample message</h2>
<p>For the purpose of this example, use the Amazon MQ console to send a test message. Navigate to the details page for your broker.</p>
<p>About midway down the page, choose <strong>ActiveMQ Web Console</strong>. Next, choose <strong>Manage ActiveMQ Broker</strong> to launch the admin console. When you are prompted for a user name and password, use the credentials created earlier.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/Picture4-1.png"><img loading="lazy" class="aligncenter wp-image-3794" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/Picture4-1.png" alt="" width="700" height="302" /></a></p>
<p>At the top of the page, choose <strong>Send</strong>. From here, you can send a sample message from the broker to subscribers. For this example, this is how you generate traffic to test the end-to-end system. Be sure to set the <strong>Destination</strong> value to “SAMPLE_QUEUE.” The message body can contain any text. Choose <strong>Send</strong>.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/Picture5-1.png"><img loading="lazy" class="aligncenter wp-image-3795" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/Picture5-1.png" alt="" width="700" height="375" /></a></p>
<p>You now have a Lambda function polling for messages on the broker. To verify that your function is working, you can confirm in the <a href="https://console.aws.amazon.com/dynamodb/home">DynamoDB console</a> that the message was successfully received and processed by the sample Lambda function.</p>
<p>First, choose <strong>Tables</strong> on the left and select the table name “amazonmq-messages” in the middle section. With the table detail in view, choose <strong>Items</strong>. If the function was successful, you’ll find a new entry similar to the following:</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/DynamoDB_Table2.png"><img loading="lazy" class="aligncenter wp-image-3777" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2018/01/29/DynamoDB_Table2-1024x77.png" alt="" width="800" height="60" /></a></p>
<p>If there is no message in DynamoDB, check again in a few minutes or review the CloudWatch Logs group for Lambda functions that contain debug messages.</p>
<h2>Alternative approaches</h2>
<p>Beyond the approach described here, you may consider other approaches as well. For example, you could use an intermediary system such as Apache Flume to pass messages from the broker to Lambda or deploy <a href="https://camel.apache.org/http.html">Apache Camel to trigger Lambda via a POST to API Gateway</a>. There are trade-offs to each of these approaches. My goal in using CloudWatch Events was to introduce an easily repeatable pattern familiar to many Lambda developers.</p>
<h2>Summary</h2>
<p>I hope that you have found this example of how to integrate AWS Lambda with Amazon MQ useful. If you have expertise or legacy systems that leverage APIs such as JMS, you may find this useful as you incorporate serverless concepts in your enterprise architectures.</p>
<p>To learn more, see the <a href="https://aws.amazon.com/amazon-mq/">Amazon MQ</a> website and <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/welcome.html">Developer Guide</a>. You can try <a href="https://console.aws.amazon.com/amazon-mq/home">Amazon MQ for free</a> with the AWS Free Tier, which includes up to 750 hours of a single-instance mq.t2.micro broker and up to 1 GB of storage per month for one year.</p>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/activemq/" rel="tag">ActiveMQ</a><a href="https://noise.getoto.net/tag/ad/" rel="tag">AD</a><a href="https://noise.getoto.net/tag/ads/" rel="tag">ads</a><a href="https://noise.getoto.net/tag/ai/" rel="tag">AI</a><a href="https://noise.getoto.net/tag/all/" rel="tag">All</a><a href="https://noise.getoto.net/tag/amazon/" rel="tag">amazon</a><a href="https://noise.getoto.net/tag/amazon-cloudwatch/" rel="tag">Amazon CloudWatch</a><a href="https://noise.getoto.net/tag/amazon-cloudwatch-events/" rel="tag">Amazon CloudWatch Events</a><a href="https://noise.getoto.net/tag/amazon-dynamodb/" rel="tag">Amazon DynamoDB</a><a href="https://noise.getoto.net/tag/amazon-elastic-transcoder/" rel="tag">Amazon Elastic Transcoder</a><a href="https://noise.getoto.net/tag/amazon-mq/" rel="tag">Amazon MQ*</a><a href="https://noise.getoto.net/tag/apache/" rel="tag">Apache</a><a href="https://noise.getoto.net/tag/api-gateway/" rel="tag">api gateway</a><a href="https://noise.getoto.net/tag/apis/" rel="tag">APIs</a><a href="https://noise.getoto.net/tag/app/" rel="tag">app</a><a href="https://noise.getoto.net/tag/application-integration/" rel="tag">Application Integration</a><a href="https://noise.getoto.net/tag/application-services/" rel="tag">Application Services*</a><a href="https://noise.getoto.net/tag/apt/" rel="tag">apt</a><a href="https://noise.getoto.net/tag/architecture/" rel="tag">Architecture</a><a href="https://noise.getoto.net/tag/aria/" rel="tag">ARIA</a><a href="https://noise.getoto.net/tag/art/" rel="tag">art</a><a href="https://noise.getoto.net/tag/aspect/" rel="tag">Aspect</a><a href="https://noise.getoto.net/tag/ati/" rel="tag">ATI</a><a href="https://noise.getoto.net/tag/aws/" rel="tag">AWS</a><a href="https://noise.getoto.net/tag/aws-lambda/" rel="tag">AWS Lambda</a><a href="https://noise.getoto.net/tag/aws-solutions/" rel="tag">aws solutions</a><a href="https://noise.getoto.net/tag/ble/" rel="tag">ble</a><a href="https://noise.getoto.net/tag/bsi/" rel="tag">BSI</a><a href="https://noise.getoto.net/tag/bug/" rel="tag">bug</a><a href="https://noise.getoto.net/tag/c/" rel="tag">C</a><a href="https://noise.getoto.net/tag/cam/" rel="tag">cam</a><a href="https://noise.getoto.net/tag/cap/" rel="tag">cap</a><a href="https://noise.getoto.net/tag/cas/" rel="tag">CAS</a><a href="https://noise.getoto.net/tag/cli/" rel="tag">cli</a><a href="https://noise.getoto.net/tag/cloud/" rel="tag">cloud</a><a href="https://noise.getoto.net/tag/cloud-messaging/" rel="tag">cloud messaging</a><a href="https://noise.getoto.net/tag/cloudwatch/" rel="tag">CloudWatch</a><a href="https://noise.getoto.net/tag/cloudwatch-events/" rel="tag">CloudWatch Events</a><a href="https://noise.getoto.net/tag/cloudwatch-logs/" rel="tag">CloudWatch Logs</a><a href="https://noise.getoto.net/tag/code/" rel="tag">code</a><a href="https://noise.getoto.net/tag/console/" rel="tag">console</a><a href="https://noise.getoto.net/tag/credentials/" rel="tag">credentials</a><a href="https://noise.getoto.net/tag/curity/" rel="tag">Curity</a><a href="https://noise.getoto.net/tag/data/" rel="tag">data</a><a href="https://noise.getoto.net/tag/ddr/" rel="tag">ddr</a><a href="https://noise.getoto.net/tag/deployment/" rel="tag">deployment</a><a href="https://noise.getoto.net/tag/det/" rel="tag">det</a><a href="https://noise.getoto.net/tag/developer/" rel="tag">developer</a><a href="https://noise.getoto.net/tag/developers/" rel="tag">Developers</a><a href="https://noise.getoto.net/tag/document/" rel="tag">document</a><a href="https://noise.getoto.net/tag/down/" rel="tag">down</a><a href="https://noise.getoto.net/tag/dress/" rel="tag">dress</a><a href="https://noise.getoto.net/tag/dyn/" rel="tag">Dyn</a><a href="https://noise.getoto.net/tag/dynamodb/" rel="tag">DynamoDB</a><a href="https://noise.getoto.net/tag/dynamodb-table/" rel="tag">DynamoDB table</a><a href="https://noise.getoto.net/tag/east/" rel="tag">EAST</a><a href="https://noise.getoto.net/tag/ebs/" rel="tag">ebs</a><a href="https://noise.getoto.net/tag/ec/" rel="tag">ec</a><a href="https://noise.getoto.net/tag/ed/" rel="tag">ed</a><a href="https://noise.getoto.net/tag/ejs/" rel="tag">ejs</a><a href="https://noise.getoto.net/tag/enterprise/" rel="tag">Enterprise</a><a href="https://noise.getoto.net/tag/enterprise-strategy/" rel="tag">Enterprise Strategy*</a><a href="https://noise.getoto.net/tag/environment/" rel="tag">environment</a><a href="https://noise.getoto.net/tag/et/" rel="tag">et</a><a href="https://noise.getoto.net/tag/eu/" rel="tag">eu</a><a href="https://noise.getoto.net/tag/event/" rel="tag">event</a><a href="https://noise.getoto.net/tag/event-driven-computing/" rel="tag">event-driven computing</a><a href="https://noise.getoto.net/tag/events/" rel="tag">Events</a><a href="https://noise.getoto.net/tag/fact/" rel="tag">fact</a><a href="https://noise.getoto.net/tag/fir/" rel="tag">fir</a><a href="https://noise.getoto.net/tag/form/" rel="tag">form</a><a href="https://noise.getoto.net/tag/fun/" rel="tag">Fun</a><a href="https://noise.getoto.net/tag/gateway/" rel="tag">Gateway</a><a href="https://noise.getoto.net/tag/getting-started/" rel="tag">getting started</a><a href="https://noise.getoto.net/tag/gif/" rel="tag">gif</a><a href="https://noise.getoto.net/tag/git/" rel="tag">Git</a><a href="https://noise.getoto.net/tag/github/" rel="tag">Github</a><a href="https://noise.getoto.net/tag/go/" rel="tag">Go</a><a href="https://noise.getoto.net/tag/guide/" rel="tag">guide</a><a href="https://noise.getoto.net/tag/hat/" rel="tag">HAT</a><a href="https://noise.getoto.net/tag/header/" rel="tag">header</a><a href="https://noise.getoto.net/tag/ice/" rel="tag">ICE</a><a href="https://noise.getoto.net/tag/ide/" rel="tag">IDE</a><a href="https://noise.getoto.net/tag/ip/" rel="tag">IP</a><a href="https://noise.getoto.net/tag/ip-address/" rel="tag">ip address</a><a href="https://noise.getoto.net/tag/irs/" rel="tag">irs</a><a href="https://noise.getoto.net/tag/json/" rel="tag">json</a><a href="https://noise.getoto.net/tag/lambda/" rel="tag">lambda</a><a href="https://noise.getoto.net/tag/lambda-function/" rel="tag">Lambda function</a><a href="https://noise.getoto.net/tag/launch/" rel="tag">launch</a><a href="https://noise.getoto.net/tag/lte/" rel="tag">LTE</a><a href="https://noise.getoto.net/tag/make/" rel="tag">Make</a><a href="https://noise.getoto.net/tag/mana/" rel="tag">mana</a><a href="https://noise.getoto.net/tag/media/" rel="tag">media</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/message-topics/" rel="tag">message topics</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a><a href="https://noise.getoto.net/tag/migration/" rel="tag">Migration</a><a href="https://noise.getoto.net/tag/mpa/" rel="tag">MPA</a><a href="https://noise.getoto.net/tag/nec/" rel="tag">NEC</a><a href="https://noise.getoto.net/tag/node-js/" rel="tag">node.js</a><a href="https://noise.getoto.net/tag/nodejs/" rel="tag">nodejs</a><a href="https://noise.getoto.net/tag/on-premises/" rel="tag">on-premises</a><a href="https://noise.getoto.net/tag/opera/" rel="tag">opera</a><a href="https://noise.getoto.net/tag/other/" rel="tag">Other</a><a href="https://noise.getoto.net/tag/pa/" rel="tag">PA</a><a href="https://noise.getoto.net/tag/pc/" rel="tag">pc</a><a href="https://noise.getoto.net/tag/ppl/" rel="tag">PPL</a><a href="https://noise.getoto.net/tag/processing/" rel="tag">Processing</a><a href="https://noise.getoto.net/tag/programming/" rel="tag">programming</a><a href="https://noise.getoto.net/tag/r/" rel="tag">R</a><a href="https://noise.getoto.net/tag/rat/" rel="tag">rat</a><a href="https://noise.getoto.net/tag/rate/" rel="tag">rate</a><a href="https://noise.getoto.net/tag/ror/" rel="tag">ror</a><a href="https://noise.getoto.net/tag/rov/" rel="tag">ROV</a><a href="https://noise.getoto.net/tag/rti/" rel="tag">RTI</a><a href="https://noise.getoto.net/tag/s/" rel="tag">S.</a><a href="https://noise.getoto.net/tag/sam/" rel="tag">SAM</a><a href="https://noise.getoto.net/tag/scr/" rel="tag">scr</a><a href="https://noise.getoto.net/tag/security/" rel="tag">security</a><a href="https://noise.getoto.net/tag/security-group/" rel="tag">security group</a><a href="https://noise.getoto.net/tag/server/" rel="tag">server</a><a href="https://noise.getoto.net/tag/serverless/" rel="tag">serverless</a><a href="https://noise.getoto.net/tag/serverless-architecture/" rel="tag">serverless architecture</a><a href="https://noise.getoto.net/tag/sse/" rel="tag">SSE</a><a href="https://noise.getoto.net/tag/star/" rel="tag">Star</a><a href="https://noise.getoto.net/tag/status/" rel="tag">status</a><a href="https://noise.getoto.net/tag/storage/" rel="tag">storage</a><a href="https://noise.getoto.net/tag/tea/" rel="tag">tea</a><a href="https://noise.getoto.net/tag/ted/" rel="tag">ted</a><a href="https://noise.getoto.net/tag/test/" rel="tag">test</a><a href="https://noise.getoto.net/tag/the/" rel="tag">The</a><a href="https://noise.getoto.net/tag/tic/" rel="tag">TIC</a><a href="https://noise.getoto.net/tag/time/" rel="tag">time</a><a href="https://noise.getoto.net/tag/tor/" rel="tag">tor</a><a href="https://noise.getoto.net/tag/training/" rel="tag">training</a><a href="https://noise.getoto.net/tag/ui/" rel="tag">UI</a><a href="https://noise.getoto.net/tag/un/" rel="tag">un</a><a href="https://noise.getoto.net/tag/us/" rel="tag">US</a><a href="https://noise.getoto.net/tag/useful/" rel="tag">Useful</a><a href="https://noise.getoto.net/tag/variables/" rel="tag">variables</a><a href="https://noise.getoto.net/tag/video/" rel="tag">video</a><a href="https://noise.getoto.net/tag/videos/" rel="tag">videos</a><a href="https://noise.getoto.net/tag/vpc/" rel="tag">VPC</a><a href="https://noise.getoto.net/tag/watch/" rel="tag">watch</a><a href="https://noise.getoto.net/tag/web/" rel="tag">web</a><a href="https://noise.getoto.net/tag/website/" rel="tag">website</a><a href="https://noise.getoto.net/tag/win/" rel="tag">win</a><a href="https://noise.getoto.net/tag/work/" rel="tag">Work</a></span></footer></article>
<article id="post-339239" class="post-339239 post type-post status-publish format-standard hentry tag-ad tag-ai tag-ala tag-all tag-amazon tag-amazon-simple-notification-service tag-amazon-simple-notification-service-sns tag-amazon-simple-queue-service-sqs tag-amazon-sns tag-amazon-sqs tag-analytics tag-app tag-architecture tag-arin tag-art tag-ati tag-aws tag-aws-accounts tag-aws-lambda tag-aws-management-console tag-ble tag-blog tag-business tag-c tag-car tag-cas tag-case tag-cases tag-ci tag-console tag-credentials tag-curity tag-data tag-dea tag-design tag-det tag-development tag-down tag-dp tag-east tag-ec tag-ed tag-eff tag-environment tag-et tag-eu tag-event tag-fact tag-fan tag-fir tag-form tag-getting-started tag-go tag-gre tag-hat tag-http tag-ice tag-ide tag-ios tag-ip tag-irs tag-iss tag-lambda tag-least-privilege tag-light tag-limit tag-make tag-making tag-mana tag-message-queues tag-messaging tag-metric tag-metrics tag-micros tag-microservices tag-mit tag-mpa tag-nes tag-nist tag-notifications tag-opera tag-oss tag-other tag-pa tag-permissions tag-pip tag-play tag-plex tag-policy tag-ppl tag-processing tag-project tag-r tag-rat tag-rate tag-request tag-resource tag-resources tag-rest tag-rov tag-running tag-s tag-sam tag-scale tag-scr tag-security tag-server tag-shed tag-sns tag-software tag-sqs tag-sse tag-star tag-sts tag-tea tag-team tag-ted tag-test tag-tic tag-tor tag-tutorial tag-ui tag-un tag-us tag-war tag-web tag-web-server tag-win tag-work">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2017/11/14/cross-account-integration-with-amazon-sns/" rel="bookmark">Cross-Account Integration with Amazon SNS</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2017/11/14/cross-account-integration-with-amazon-sns/" rel="bookmark"><time class="entry-date" datetime="2017-11-14T22:51:03+02:00">2017-11-14</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/christie-gifrin/" rel="author">Christie Gifrin</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Christie Gifrin">Christie Gifrin</a> original <a href="https://aws.amazon.com/blogs/compute/cross-account-integration-with-amazon-sns/">https://aws.amazon.com/blogs/compute/cross-account-integration-with-amazon-sns/</a></p>
<h4>Contributed by Zak Islam, Senior Manager, Software Development, AWS Messaging</h4>
<p>&nbsp;</p>
<p><a href="https://aws.amazon.com/sns/">Amazon Simple Notification Service</a>&nbsp;(Amazon SNS)&nbsp;is a fully managed AWS service that makes it easy to decouple your application components and fan-out messages. SNS provides topics (similar to topics in message brokers such as RabbitMQ or ActiveMQ) that you can use to create 1:1, 1:N, or N:N producer/consumer design patterns. For more information about how to send messages from SNS to Amazon SQS, AWS Lambda, or HTTP(S) endpoints in the same account, see <a href="https://docs.aws.amazon.com/sns/latest/dg/SendMessageToSQS.html">Sending Amazon SNS Messages to Amazon SQS Queues</a>.</p>
<p>SNS can be used to send messages within a single account or to resources in different accounts to create administrative isolation. This enables administrators to grant only the minimum level of permissions required to process a workload (for example, limiting the scope of your application account to only send messages and to deny deletes). This approach is commonly known as the “principle of least privilege.” If you are interested, read more about AWS’s <a href="https://aws.amazon.com/answers/account-management/aws-multi-account-security-strategy/">multi-account security strategy</a>.</p>
<p>This is great from a security perspective, but why would you want to share messages between accounts? It may sound scary, but it’s a common practice to isolate application components (such as producer and consumer) to operate using different AWS accounts to lock down privileges in case credentials are exposed. In this post, I go slightly deeper and explore how to set up your SNS topic so that it can route messages to SQS queues that are owned by a separate AWS account.</p>
<h1>Potential use cases</h1>
<p style="text-align: left">First, look at a common order processing design pattern:<a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/11/03/cross_acct_integration_sns_image_1.png"><img loading="lazy" class="aligncenter wp-image-3138 size-full" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/11/03/cross_acct_integration_sns_image_1.png" alt="" width="1200" height="500" /></a></p>
<p><span id="more-2726"></span>This is a simple architecture. A web server submits an order directly to an SNS topic, which then fans out messages to two SQS queues. One SQS queue is used to track all incoming orders for audits (such as anti-entropy, comparing the data of all replicas and updating each replica to the newest version). The other is used to pass the request to the order processing systems.</p>
<p>Imagine now that a few years have passed, and your downstream processes no longer scale, so you are kicking around the idea of a re-architecture project. To thoroughly test your system, you need a way to replay your production messages in your development system. Sure, you can build a system to replicate and replay orders from your production environment in your development environment. Wouldn’t it be easier to subscribe your development queues to the production SNS topic so you can test your new system in real time? That’s exactly what you can do here.</p>
<p>Here’s another use case. As your business grows, you recognize the need for more metrics from your order processing pipeline. The analytics team at your company has built a metrics aggregation service and ingests data via a central SQS queue. Their architecture is as follows:<a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/11/03/cross_acct_integration_sns_image_2.png"><img loading="lazy" class="size-full wp-image-3139 aligncenter" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/11/03/cross_acct_integration_sns_image_2.png" alt="" width="1200" height="400" /></a></p>
<p>Again, it’s a fairly simple architecture. All data is ingested via SQS queues (master_ingest_queue, in this case). You subscribe the master_ingest_queue, running under the analytics team’s AWS account, to the topic that is in the order management team’s account.</p>
<h1>Making it work</h1>
<p>Now that you’ve seen a few scenarios, let’s dig into the details. There are a couple of ways to link an SQS queue to an SNS topic (subscribe a queue to a topic):</p>
<ol>
<li>The queue owner can create a subscription to the topic.</li>
<li>The topic owner can subscribe a queue in another account to the topic.</li>
</ol>
<h2>Queue owner subscription</h2>
<p>What happens when the queue owner subscribes to a topic? In this case, assume that the topic owner has given permission to the subscriber’s account to call the Subscribe API action using the topic ARN (Amazon Resource Name). For the examples below, also assume the following:</p>
<ul>
<li>&nbsp;<em>Topic_Owner</em> is the identifier for the account that owns the topic <em>MainTopic</em></li>
<li><em>Queue_Owner</em> is the identifier for the account that owns the queue subscribed to the main topic</li>
</ul>
<p>To enable the subscriber to subscribe to a topic, the topic owner must add the sns:Subscribe and topic ARN to the topic policy via the AWS Management Console, as follows:</p>
<pre><code class="lang-json">{
  &quot;Version&quot;:&quot;2012-10-17&quot;,
  &quot;Id&quot;:&quot;MyTopicSubscribePolicy&quot;,
  &quot;Statement&quot;:[{
      &quot;Sid&quot;:&quot;Allow-other-account-to-subscribe-to-topic&quot;,
      &quot;Effect&quot;:&quot;Allow&quot;,
      &quot;Principal&quot;:{
        &quot;AWS&quot;:&quot;Topic_Owner&quot;
      },
      &quot;Action&quot;:&quot;sns:Subscribe&quot;,
      &quot;Resource&quot;:&quot;arn:aws:sns:us-east-1:Queue_Owner:MainTopic&quot;
    }
  ]
}</code></pre>
<p>After this has been set up, the subscriber (using account <em>Queue_Owner</em>) can call Subscribe to link the queue to the topic. After the queue has been successfully subscribed, SNS starts to publish notifications. In this case, neither the topic owner nor the subscriber have had to process any kind of confirmation message.</p>
<h2>Topic owner subscription</h2>
<p>The second way to subscribe an SQS queue to an SNS topic is to have the <em>Topic_Owner</em> account initiate the subscription for the queue from account <em>Queue_Owner</em>. In this case, SNS first sends a confirmation message to the queue. To confirm the subscription, a user who can read messages from the queue must visit the URL specified in the&nbsp;SubscribeURL&nbsp;value in the message. Until the subscription is confirmed, no notifications published to the topic are sent to the queue. To confirm a subscription, you can use the SQS console or the&nbsp;ReceiveMessage&nbsp;API action.</p>
<h1>What’s next?</h1>
<p>In this post, I covered a few simple use cases but the principles can be extended to complex systems as well. As you architect new systems and refactor existing ones, think about where you can leverage queues (SQS) and topics (SNS) to build a loosely coupled system that can be quickly and easily extended to meet your business need.</p>
<p>For step by step instructions, see&nbsp;<a href="https://docs.aws.amazon.com/sns/latest/dg/SendMessageToSQS.cross.account.html">Sending Amazon SNS messages to an Amazon SQS queue in a different account</a>. You can also visit the following resources to get started working with message queues and topics:</p>
<ul>
<li><span style="color: #000000">10-minute Tutorial: <a href="https://aws.amazon.com/getting-started/tutorials/send-messages-distributed-applications/">Send Messages Between Distributed Applications with Amazon SQS</a></span></li>
<li><span style="color: #000000">10-minute Tutorial: <a href="https://aws.amazon.com/getting-started/tutorials/send-fanout-event-notifications/">Send&nbsp;Fanout Event Notifications with Amazon SNS and Amazon SQS</a></span></li>
<li>Blog:&nbsp;<a href="https://aws.amazon.com/blogs/compute/building-loosely-coupled-scalable-c-applications-with-amazon-sqs-and-amazon-sns/">Building Loosely Coupled, Scalable, C# Applications with Amazon SQS and Amazon SNS</a></li>
<li>Blog:&nbsp;<a href="https://aws.amazon.com/blogs/compute/building-scalable-applications-and-microservices-adding-messaging-to-your-toolbox/">Building Scalable Applications and Microservices: Adding Messaging to Your Toolbox</a></li>
<li>Other resources:&nbsp;<a href="https://aws.amazon.com/sns/getting-started/">Getting started with Amazon SNS</a></li>
<li>Other resources:&nbsp;<a href="https://aws.amazon.com/sqs/getting-started/">Getting started with Amazon SQS</a></li>
</ul>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/ad/" rel="tag">AD</a><a href="https://noise.getoto.net/tag/ai/" rel="tag">AI</a><a href="https://noise.getoto.net/tag/ala/" rel="tag">ALA</a><a href="https://noise.getoto.net/tag/all/" rel="tag">All</a><a href="https://noise.getoto.net/tag/amazon/" rel="tag">amazon</a><a href="https://noise.getoto.net/tag/amazon-simple-notification-service/" rel="tag">Amazon Simple Notification Service</a><a href="https://noise.getoto.net/tag/amazon-simple-notification-service-sns/" rel="tag">Amazon Simple Notification Service (SNS)</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service-sqs/" rel="tag">Amazon Simple Queue Service (SQS)</a><a href="https://noise.getoto.net/tag/amazon-sns/" rel="tag">Amazon SNS</a><a href="https://noise.getoto.net/tag/amazon-sqs/" rel="tag">Amazon SQS</a><a href="https://noise.getoto.net/tag/analytics/" rel="tag">Analytics</a><a href="https://noise.getoto.net/tag/app/" rel="tag">app</a><a href="https://noise.getoto.net/tag/architecture/" rel="tag">Architecture</a><a href="https://noise.getoto.net/tag/arin/" rel="tag">arin</a><a href="https://noise.getoto.net/tag/art/" rel="tag">art</a><a href="https://noise.getoto.net/tag/ati/" rel="tag">ATI</a><a href="https://noise.getoto.net/tag/aws/" rel="tag">AWS</a><a href="https://noise.getoto.net/tag/aws-accounts/" rel="tag">AWS Accounts</a><a href="https://noise.getoto.net/tag/aws-lambda/" rel="tag">AWS Lambda</a><a href="https://noise.getoto.net/tag/aws-management-console/" rel="tag">AWS Management Console</a><a href="https://noise.getoto.net/tag/ble/" rel="tag">ble</a><a href="https://noise.getoto.net/tag/blog/" rel="tag">blog</a><a href="https://noise.getoto.net/tag/business/" rel="tag">Business</a><a href="https://noise.getoto.net/tag/c/" rel="tag">C</a><a href="https://noise.getoto.net/tag/car/" rel="tag">car</a><a href="https://noise.getoto.net/tag/cas/" rel="tag">CAS</a><a href="https://noise.getoto.net/tag/case/" rel="tag">Case</a><a href="https://noise.getoto.net/tag/cases/" rel="tag">cases</a><a href="https://noise.getoto.net/tag/ci/" rel="tag">ci</a><a href="https://noise.getoto.net/tag/console/" rel="tag">console</a><a href="https://noise.getoto.net/tag/credentials/" rel="tag">credentials</a><a href="https://noise.getoto.net/tag/curity/" rel="tag">Curity</a><a href="https://noise.getoto.net/tag/data/" rel="tag">data</a><a href="https://noise.getoto.net/tag/dea/" rel="tag">dea</a><a href="https://noise.getoto.net/tag/design/" rel="tag">design</a><a href="https://noise.getoto.net/tag/det/" rel="tag">det</a><a href="https://noise.getoto.net/tag/development/" rel="tag">development</a><a href="https://noise.getoto.net/tag/down/" rel="tag">down</a><a href="https://noise.getoto.net/tag/dp/" rel="tag">dp</a><a href="https://noise.getoto.net/tag/east/" rel="tag">EAST</a><a href="https://noise.getoto.net/tag/ec/" rel="tag">ec</a><a href="https://noise.getoto.net/tag/ed/" rel="tag">ed</a><a href="https://noise.getoto.net/tag/eff/" rel="tag">eff</a><a href="https://noise.getoto.net/tag/environment/" rel="tag">environment</a><a href="https://noise.getoto.net/tag/et/" rel="tag">et</a><a href="https://noise.getoto.net/tag/eu/" rel="tag">eu</a><a href="https://noise.getoto.net/tag/event/" rel="tag">event</a><a href="https://noise.getoto.net/tag/fact/" rel="tag">fact</a><a href="https://noise.getoto.net/tag/fan/" rel="tag">fan</a><a href="https://noise.getoto.net/tag/fir/" rel="tag">fir</a><a href="https://noise.getoto.net/tag/form/" rel="tag">form</a><a href="https://noise.getoto.net/tag/getting-started/" rel="tag">getting started</a><a href="https://noise.getoto.net/tag/go/" rel="tag">Go</a><a href="https://noise.getoto.net/tag/gre/" rel="tag">GRE</a><a href="https://noise.getoto.net/tag/hat/" rel="tag">HAT</a><a href="https://noise.getoto.net/tag/http/" rel="tag">http</a><a href="https://noise.getoto.net/tag/ice/" rel="tag">ICE</a><a href="https://noise.getoto.net/tag/ide/" rel="tag">IDE</a><a href="https://noise.getoto.net/tag/ios/" rel="tag">ios</a><a href="https://noise.getoto.net/tag/ip/" rel="tag">IP</a><a href="https://noise.getoto.net/tag/irs/" rel="tag">irs</a><a href="https://noise.getoto.net/tag/iss/" rel="tag">iss</a><a href="https://noise.getoto.net/tag/lambda/" rel="tag">lambda</a><a href="https://noise.getoto.net/tag/least-privilege/" rel="tag">least privilege</a><a href="https://noise.getoto.net/tag/light/" rel="tag">light</a><a href="https://noise.getoto.net/tag/limit/" rel="tag">limit</a><a href="https://noise.getoto.net/tag/make/" rel="tag">Make</a><a href="https://noise.getoto.net/tag/making/" rel="tag">making</a><a href="https://noise.getoto.net/tag/mana/" rel="tag">mana</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a><a href="https://noise.getoto.net/tag/metric/" rel="tag">metric</a><a href="https://noise.getoto.net/tag/metrics/" rel="tag">metrics</a><a href="https://noise.getoto.net/tag/micros/" rel="tag">MICROS</a><a href="https://noise.getoto.net/tag/microservices/" rel="tag">microservices</a><a href="https://noise.getoto.net/tag/mit/" rel="tag">mit</a><a href="https://noise.getoto.net/tag/mpa/" rel="tag">MPA</a><a href="https://noise.getoto.net/tag/nes/" rel="tag">NES</a><a href="https://noise.getoto.net/tag/nist/" rel="tag">nist</a><a href="https://noise.getoto.net/tag/notifications/" rel="tag">notifications</a><a href="https://noise.getoto.net/tag/opera/" rel="tag">opera</a><a href="https://noise.getoto.net/tag/oss/" rel="tag">OSS</a><a href="https://noise.getoto.net/tag/other/" rel="tag">Other</a><a href="https://noise.getoto.net/tag/pa/" rel="tag">PA</a><a href="https://noise.getoto.net/tag/permissions/" rel="tag">Permissions</a><a href="https://noise.getoto.net/tag/pip/" rel="tag">pip</a><a href="https://noise.getoto.net/tag/play/" rel="tag">Play</a><a href="https://noise.getoto.net/tag/plex/" rel="tag">Plex</a><a href="https://noise.getoto.net/tag/policy/" rel="tag">policy</a><a href="https://noise.getoto.net/tag/ppl/" rel="tag">PPL</a><a href="https://noise.getoto.net/tag/processing/" rel="tag">Processing</a><a href="https://noise.getoto.net/tag/project/" rel="tag">project</a><a href="https://noise.getoto.net/tag/r/" rel="tag">R</a><a href="https://noise.getoto.net/tag/rat/" rel="tag">rat</a><a href="https://noise.getoto.net/tag/rate/" rel="tag">rate</a><a href="https://noise.getoto.net/tag/request/" rel="tag">request</a><a href="https://noise.getoto.net/tag/resource/" rel="tag">Resource</a><a href="https://noise.getoto.net/tag/resources/" rel="tag">resources</a><a href="https://noise.getoto.net/tag/rest/" rel="tag">rest</a><a href="https://noise.getoto.net/tag/rov/" rel="tag">ROV</a><a href="https://noise.getoto.net/tag/running/" rel="tag">running</a><a href="https://noise.getoto.net/tag/s/" rel="tag">S.</a><a href="https://noise.getoto.net/tag/sam/" rel="tag">SAM</a><a href="https://noise.getoto.net/tag/scale/" rel="tag">Scale</a><a href="https://noise.getoto.net/tag/scr/" rel="tag">scr</a><a href="https://noise.getoto.net/tag/security/" rel="tag">security</a><a href="https://noise.getoto.net/tag/server/" rel="tag">server</a><a href="https://noise.getoto.net/tag/shed/" rel="tag">shed</a><a href="https://noise.getoto.net/tag/sns/" rel="tag">SNS</a><a href="https://noise.getoto.net/tag/software/" rel="tag">software</a><a href="https://noise.getoto.net/tag/sqs/" rel="tag">sqs</a><a href="https://noise.getoto.net/tag/sse/" rel="tag">SSE</a><a href="https://noise.getoto.net/tag/star/" rel="tag">Star</a><a href="https://noise.getoto.net/tag/sts/" rel="tag">sts</a><a href="https://noise.getoto.net/tag/tea/" rel="tag">tea</a><a href="https://noise.getoto.net/tag/team/" rel="tag">team</a><a href="https://noise.getoto.net/tag/ted/" rel="tag">ted</a><a href="https://noise.getoto.net/tag/test/" rel="tag">test</a><a href="https://noise.getoto.net/tag/tic/" rel="tag">TIC</a><a href="https://noise.getoto.net/tag/tor/" rel="tag">tor</a><a href="https://noise.getoto.net/tag/tutorial/" rel="tag">Tutorial</a><a href="https://noise.getoto.net/tag/ui/" rel="tag">UI</a><a href="https://noise.getoto.net/tag/un/" rel="tag">un</a><a href="https://noise.getoto.net/tag/us/" rel="tag">US</a><a href="https://noise.getoto.net/tag/war/" rel="tag">war</a><a href="https://noise.getoto.net/tag/web/" rel="tag">web</a><a href="https://noise.getoto.net/tag/web-server/" rel="tag">web server</a><a href="https://noise.getoto.net/tag/win/" rel="tag">win</a><a href="https://noise.getoto.net/tag/work/" rel="tag">Work</a></span></footer></article>
<article id="post-335454" class="post-335454 post type-post status-publish format-standard hentry tag-ad tag-adi tag-ai tag-ala tag-all tag-amazon tag-amazon-dynamodb tag-amazon-simple-queue-service tag-amazon-simple-queue-service-sqs tag-amazon-sns tag-amazon-sqs tag-app tag-architecture tag-art tag-ati tag-aws tag-aws-cost-explorer tag-aws-lambda tag-aws-reinvent tag-aws-resources tag-bbc tag-ble tag-blog tag-c tag-ci tag-dyn tag-dynamodb tag-ebs tag-ec tag-ed tag-eff tag-eu tag-hat tag-ice tag-ip tag-iplayer tag-lambda tag-launch tag-location tag-mana tag-media tag-message-queues tag-micros tag-microservices tag-pa tag-play tag-ppl tag-project tag-ps tag-r tag-record tag-resource tag-resources tag-rest tag-rov tag-s tag-scale tag-search tag-snapshots tag-sns tag-sqs tag-stage tag-star tag-sts tag-support tag-tag tag-tagging tag-tags tag-talk tag-tea tag-tic tag-today tag-tor tag-ui tag-un tag-us tag-watch tag-web">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2017/10/20/introducing-cost-allocation-tags-for-amazon-sqs/" rel="bookmark">Introducing Cost Allocation Tags for Amazon SQS</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2017/10/20/introducing-cost-allocation-tags-for-amazon-sqs/" rel="bookmark"><time class="entry-date" datetime="2017-10-20T01:22:32+03:00">2017-10-20</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/jeff-barr/" rel="author">Jeff Barr</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Jeff Barr">Jeff Barr</a> original <a href="https://aws.amazon.com/blogs/aws/introducing-cost-allocation-tags-for-amazon-sqs/">https://aws.amazon.com/blogs/aws/introducing-cost-allocation-tags-for-amazon-sqs/</a></p>
<p>You have long had the ability to tag your AWS resources and to see cost breakouts on a per-tag basis. Cost allocation was launched in 2012 (see <a href="https://aws.amazon.com/blogs/aws/aws-cost-allocation/">AWS Cost Allocation for Customer Bills</a>) and we have steadily added support for additional services, most recently DynamoDB (<a href="https://aws.amazon.com/blogs/database/announcing-tagging-for-amazon-dynamodb/">Introducing Cost Allocation Tags for Amazon DynamoDB</a>), Lambda (<a href="https://aws.amazon.com/about-aws/whats-new/2017/04/aws-lambda-supports-tagging-and-cost-allocations/">AWS Lambda Supports Tagging and Cost Allocations</a>), and EBS (<a href="https://aws.amazon.com/blogs/aws/new-cost-allocation-for-ebs-snapshots/">New – Cost Allocation for AWS Snapshots</a>).</p>
<p>Today, we are launching tag-based cost allocation for <a href="https://aws.amazon.com/sqs/" title="">Amazon Simple Queue Service (SQS)</a>. You can now assign tags to your queues and use them to manage your costs at any desired level: application, application stage (for a loosely coupled application that communicates via queues), project, department, or developer. After you have tagged your queues, you can use the AWS Tag Editor to search queues that have tags of interest.</p>
<p>Here’s how I would add three tags (<strong>app</strong>, <strong>stage</strong>, and <strong>department</strong>) to one of my queues:</p>
<p><img loading="lazy" class="aligncenter size-medium" src="https://media.amazonwebservices.com/blog/2017/sqs_tag_queue_1.png" width="860" height="521" /></p>
<p>This feature is available now in all AWS Regions and you can start using in today! To learn more about tagging, read <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-queue-tags.html">Tagging Your Amazon SQS Queues</a>. To learn more about cost allocation via tags, read <a href="https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/cost-alloc-tags.html">Using Cost Allocation Tags</a>. To learn more about how to use message queues to build loosely coupled microservices for modern applications, read our blog post (<a href="https://aws.amazon.com/blogs/compute/building-loosely-coupled-scalable-c-applications-with-amazon-sqs-and-amazon-sns/">Building Loosely Coupled, Scalable, C# Applications with Amazon SQS and Amazon SNS</a>) and watch the recording of our recent webinar, <a href="https://www.youtube.com/watch?v=UesxWuZMZqI">Decouple and Scale Applications Using Amazon SQS and Amazon SNS</a>.</p>
<p>If you are coming to <a href="https://reinvent.awsevents.com/" title="">AWS re:Invent</a>, plan to attend session <a href="https://www.portal.reinvent.awsevents.com/connect/sessionDetail.ww?SESSION_ID=17553">ARC 330: How the BBC Built a Massive Media Pipeline Using Microservices</a>. In the talk you will find out how they used SNS and SQS to improve the elasticity and reliability of the <a href="https://www.bbc.co.uk/iplayer">BBC iPlayer</a> architecture.</p>
<p>— <a href="https://twitter.com/jeffbarr">Jeff</a>;</p>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/ad/" rel="tag">AD</a><a href="https://noise.getoto.net/tag/adi/" rel="tag">ADI</a><a href="https://noise.getoto.net/tag/ai/" rel="tag">AI</a><a href="https://noise.getoto.net/tag/ala/" rel="tag">ALA</a><a href="https://noise.getoto.net/tag/all/" rel="tag">All</a><a href="https://noise.getoto.net/tag/amazon/" rel="tag">amazon</a><a href="https://noise.getoto.net/tag/amazon-dynamodb/" rel="tag">Amazon DynamoDB</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service/" rel="tag">Amazon Simple Queue Service</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service-sqs/" rel="tag">Amazon Simple Queue Service (SQS)</a><a href="https://noise.getoto.net/tag/amazon-sns/" rel="tag">Amazon SNS</a><a href="https://noise.getoto.net/tag/amazon-sqs/" rel="tag">Amazon SQS</a><a href="https://noise.getoto.net/tag/app/" rel="tag">app</a><a href="https://noise.getoto.net/tag/architecture/" rel="tag">Architecture</a><a href="https://noise.getoto.net/tag/art/" rel="tag">art</a><a href="https://noise.getoto.net/tag/ati/" rel="tag">ATI</a><a href="https://noise.getoto.net/tag/aws/" rel="tag">AWS</a><a href="https://noise.getoto.net/tag/aws-cost-explorer/" rel="tag">AWS Cost Explorer</a><a href="https://noise.getoto.net/tag/aws-lambda/" rel="tag">AWS Lambda</a><a href="https://noise.getoto.net/tag/aws-reinvent/" rel="tag">AWS re:Invent</a><a href="https://noise.getoto.net/tag/aws-resources/" rel="tag">AWS resources</a><a href="https://noise.getoto.net/tag/bbc/" rel="tag">BBC</a><a href="https://noise.getoto.net/tag/ble/" rel="tag">ble</a><a href="https://noise.getoto.net/tag/blog/" rel="tag">blog</a><a href="https://noise.getoto.net/tag/c/" rel="tag">C</a><a href="https://noise.getoto.net/tag/ci/" rel="tag">ci</a><a href="https://noise.getoto.net/tag/dyn/" rel="tag">Dyn</a><a href="https://noise.getoto.net/tag/dynamodb/" rel="tag">DynamoDB</a><a href="https://noise.getoto.net/tag/ebs/" rel="tag">ebs</a><a href="https://noise.getoto.net/tag/ec/" rel="tag">ec</a><a href="https://noise.getoto.net/tag/ed/" rel="tag">ed</a><a href="https://noise.getoto.net/tag/eff/" rel="tag">eff</a><a href="https://noise.getoto.net/tag/eu/" rel="tag">eu</a><a href="https://noise.getoto.net/tag/hat/" rel="tag">HAT</a><a href="https://noise.getoto.net/tag/ice/" rel="tag">ICE</a><a href="https://noise.getoto.net/tag/ip/" rel="tag">IP</a><a href="https://noise.getoto.net/tag/iplayer/" rel="tag">iplayer</a><a href="https://noise.getoto.net/tag/lambda/" rel="tag">lambda</a><a href="https://noise.getoto.net/tag/launch/" rel="tag">launch</a><a href="https://noise.getoto.net/tag/location/" rel="tag">location</a><a href="https://noise.getoto.net/tag/mana/" rel="tag">mana</a><a href="https://noise.getoto.net/tag/media/" rel="tag">media</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/micros/" rel="tag">MICROS</a><a href="https://noise.getoto.net/tag/microservices/" rel="tag">microservices</a><a href="https://noise.getoto.net/tag/pa/" rel="tag">PA</a><a href="https://noise.getoto.net/tag/play/" rel="tag">Play</a><a href="https://noise.getoto.net/tag/ppl/" rel="tag">PPL</a><a href="https://noise.getoto.net/tag/project/" rel="tag">project</a><a href="https://noise.getoto.net/tag/ps/" rel="tag">ps</a><a href="https://noise.getoto.net/tag/r/" rel="tag">R</a><a href="https://noise.getoto.net/tag/record/" rel="tag">record</a><a href="https://noise.getoto.net/tag/resource/" rel="tag">Resource</a><a href="https://noise.getoto.net/tag/resources/" rel="tag">resources</a><a href="https://noise.getoto.net/tag/rest/" rel="tag">rest</a><a href="https://noise.getoto.net/tag/rov/" rel="tag">ROV</a><a href="https://noise.getoto.net/tag/s/" rel="tag">S.</a><a href="https://noise.getoto.net/tag/scale/" rel="tag">Scale</a><a href="https://noise.getoto.net/tag/search/" rel="tag">Search</a><a href="https://noise.getoto.net/tag/snapshots/" rel="tag">snapshots</a><a href="https://noise.getoto.net/tag/sns/" rel="tag">SNS</a><a href="https://noise.getoto.net/tag/sqs/" rel="tag">sqs</a><a href="https://noise.getoto.net/tag/stage/" rel="tag">stage</a><a href="https://noise.getoto.net/tag/star/" rel="tag">Star</a><a href="https://noise.getoto.net/tag/sts/" rel="tag">sts</a><a href="https://noise.getoto.net/tag/support/" rel="tag">support</a><a href="https://noise.getoto.net/tag/tag/" rel="tag">TAG</a><a href="https://noise.getoto.net/tag/tagging/" rel="tag">Tagging</a><a href="https://noise.getoto.net/tag/tags/" rel="tag">Tags</a><a href="https://noise.getoto.net/tag/talk/" rel="tag">talk</a><a href="https://noise.getoto.net/tag/tea/" rel="tag">tea</a><a href="https://noise.getoto.net/tag/tic/" rel="tag">TIC</a><a href="https://noise.getoto.net/tag/today/" rel="tag">Today</a><a href="https://noise.getoto.net/tag/tor/" rel="tag">tor</a><a href="https://noise.getoto.net/tag/ui/" rel="tag">UI</a><a href="https://noise.getoto.net/tag/un/" rel="tag">un</a><a href="https://noise.getoto.net/tag/us/" rel="tag">US</a><a href="https://noise.getoto.net/tag/watch/" rel="tag">watch</a><a href="https://noise.getoto.net/tag/web/" rel="tag">web</a></span></footer></article>
<article id="post-333590" class="post-333590 post type-post status-publish format-standard hentry tag-5763 tag-4k tag-7821 tag-acs tag-ad tag-adi tag-ads tag-ai tag-all tag-android tag-app tag-apt tag-art tag-ati tag-basic tag-bec tag-behavior tag-bett tag-bits tag-ble tag-blog tag-bt tag-c tag-cam tag-car tag-cas tag-case tag-cases tag-choice tag-ci tag-cia tag-cli tag-containers tag-context tag-core tag-creative tag-curity tag-data tag-database tag-databases tag-dea tag-design tag-det tag-directories tag-disa tag-down tag-dyn tag-east tag-ec tag-ecs tag-ed tag-eff tag-environment tag-eset tag-et tag-eu tag-event tag-exploit tag-fact tag-fail tag-fashion tag-fedora tag-fir tag-fly tag-form tag-fun tag-general tag-glibc tag-go tag-got tag-gre tag-groups tag-guide tag-guides tag-hash tag-hat tag-ice tag-identity tag-improvements tag-inside tag-install tag-ip tag-irs tag-isp tag-iss tag-issue tag-iste tag-kernel tag-law tag-lies tag-light tag-limit tag-linux tag-location tag-lte tag-mac tag-mail tag-make tag-making tag-mana tag-map tag-message-queues tag-mit tag-mou tag-mov tag-move tag-mpa tag-ncr tag-nec tag-nes tag-nmap tag-npr tag-nse tag-objects tag-opera tag-operating-systems tag-oss tag-other tag-ous tag-pa tag-pc tag-people tag-perl tag-power tag-ppl tag-present tag-problem tag-processing tag-ps tag-r tag-rat tag-rate tag-raw tag-rds tag-read-only tag-release tag-resource tag-resources tag-rest tag-roi tag-rov tag-rti tag-running tag-rust tag-s tag-sam tag-security tag-server tag-shed tag-space tag-sse tag-star tag-status tag-sts tag-support tag-suse tag-tag tag-tea tag-tech tag-technical tag-ted tag-test tag-things tag-tic tag-today tag-tor tag-touch tag-trust tag-ui tag-un tag-upgrade tag-us tag-useful tag-ustr tag-ux tag-validation tag-watch tag-wd tag-work tag-writing">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2017/10/06/dynamic-users-with-systemd/" rel="bookmark">Dynamic Users with systemd</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2017/10/06/dynamic-users-with-systemd/" rel="bookmark"><time class="entry-date" datetime="2017-10-06T01:00:00+03:00">2017-10-06</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/lennart-poettering/" rel="author">Lennart Poettering</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Lennart Poettering">Lennart Poettering</a> original <a href="http://0pointer.net/blog/dynamic-users-with-systemd.html">http://0pointer.net/blog/dynamic-users-with-systemd.html</a></p>
<p><em>TL;DR: you may now configure systemd to dynamically allocate a UNIX<br />
user ID for service processes when it starts them and release it when<br />
it stops them. It&#8217;s pretty secure, mixes well with transient services,<br />
socket activated services and service templating.</em></p>
<p>Today we released <a href="https://lists.freedesktop.org/archives/systemd-devel/2017-October/039589.html">systemd<br />
235</a>. Among<br />
other improvements this greatly extends the dynamic user logic of<br />
systemd. Dynamic users are a powerful but little known concept,<br />
supported in its basic form since systemd 232. With this blog story I<br />
hope to make it a bit better known.</p>
<p>The UNIX <em>user</em> concept is the most basic and well-understood security<br />
concept in POSIX operating systems. It is UNIX/POSIX&#8217; primary security<br />
concept, the one everybody can agree on, and most security concepts<br />
that came after it (such as process capabilities, SELinux and other<br />
MACs, user name-spaces, …) in some form or another build on it, extend<br />
it or at least interface with it. If you build a Linux kernel with all<br />
security features turned off, the user concept is pretty much the one<br />
you&#8217;ll still retain.</p>
<p>Originally, the user concept was introduced to make multi-user systems<br />
a reality, i.e. systems enabling multiple <em>human</em> users to share the<br />
same system at the same time, cleanly separating their resources and<br />
protecting them from each other. The majority of today&#8217;s UNIX systems<br />
don&#8217;t really use the user concept like that anymore though. Most of<br />
today&#8217;s systems probably have only one actual human user (or even<br />
less!), but their user databases (<code>/etc/passwd</code>) list a good number<br />
more entries than that. Today, the majority of UNIX users in most<br />
environments are <em>system users</em>, i.e. users that are not the technical<br />
representation of a human sitting in front of a PC anymore, but the<br />
security identity a system service — an executable program — runs<br />
as. Event though traditional, simultaneous multi-user systems slowly<br />
became less relevant, their ground-breaking basic concept became the<br />
cornerstone of UNIX security. The OS is nowadays partitioned into<br />
isolated services — and each service runs as its own system user, and<br />
thus within its own, minimal security context.</p>
<p>The people behind the Android OS realized the relevance of the UNIX<br />
user concept as the primary security concept on UNIX, and took its use<br />
even further: on Android not only system services take benefit of the<br />
UNIX user concept, but each UI app gets its own, individual user<br />
identity too — thus neatly separating app resources from each other,<br />
and protecting app processes from each other, too.</p>
<p>Back in the more traditional Linux world things are a bit less<br />
advanced in this area. Even though users are the quintessential UNIX<br />
security concept, allocation and management of system users is still a<br />
pretty limited, raw and static affair. In most cases, RPM or DEB<br />
package installation scripts allocate a fixed number of (usually one)<br />
system users when you install the package of a service that wants to<br />
take benefit of the user concept, and from that point on the system<br />
user remains allocated on the system and is never deallocated again,<br />
even if the package is later removed again. Most Linux distributions<br />
limit the number of system users to 1000 (which isn&#8217;t particularly a<br />
lot). Allocating a system user is hence expensive: the number of<br />
available users is limited, and there&#8217;s no defined way to dispose of<br />
them after use. If you make use of system users too liberally, you are<br />
very likely to run out of them sooner rather than later.</p>
<p>You may wonder why system users are generally not deallocated when the<br />
package that registered them is uninstalled from a system (at least on<br />
most distributions). The reason for that is one relevant property of<br />
the user concept (you might even want to call this a <em>design flaw</em>):<br />
user IDs are <em>sticky</em> to files (and other objects such as IPC<br />
objects). If a service running as a specific system user creates a<br />
file at some location, and is then terminated and its package and user<br />
removed, then the created file still belongs to the numeric ID (&#8220;UID&#8221;)<br />
the system user originally got assigned. When the next system user is<br />
allocated and — due to ID recycling — happens to get assigned the same<br />
numeric ID, then it will also gain access to the file, and that&#8217;s<br />
generally considered a problem, given that the file belonged to a<br />
potentially very different service once upon a time, and likely should<br />
not be readable or changeable by anything coming after<br />
it. Distributions hence tend to avoid UID recycling which means system<br />
users remain registered forever on a system after they have been<br />
allocated once.</p>
<p>The above is a description of the status quo ante. Let&#8217;s now focus on<br />
what systemd&#8217;s dynamic user concept brings to the table, to improve<br />
the situation.</p>
<h1>Introducing Dynamic Users</h1>
<p>With systemd dynamic users we hope to make make it easier and cheaper<br />
to allocate system users on-the-fly, thus substantially increasing the<br />
possible uses of this core UNIX security concept.</p>
<p>If you write a systemd service unit file, you may enable the dynamic<br />
user logic for it by setting the<br />
<a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#DynamicUser="><code>DynamicUser=</code></a><br />
option in its <code>[Service]</code> section to <code>yes</code>. If you do a system user is<br />
dynamically allocated the instant the service binary is invoked, and<br />
released again when the service terminates. The user is automatically<br />
allocated from the UID range 61184–65519, by looking for a so far<br />
unused UID.</p>
<p>Now you may wonder, how does this concept deal with the sticky user<br />
issue discussed above? In order to counter the problem, two strategies<br />
easily come to mind:</p>
<ol>
<li>
<p>Prohibit the service from creating any files/directories or IPC objects</p>
</li>
<li>
<p>Automatically removing the files/directories or IPC objects the<br />
service created when it shuts down.</p>
</li>
</ol>
<p>In systemd we implemented both strategies, but for different parts of<br />
the execution environment. Specifically:</p>
<ol>
<li>
<p>Setting <code>DynamicUser=yes</code> implies<br />
<a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#ProtectSystem="><code>ProtectSystem=strict</code></a><br />
and<br />
<a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#ProtectHome="><code>ProtectHome=read-only</code></a>. These<br />
sand-boxing options turn off write access to pretty much the whole OS<br />
directory tree, with a few relevant exceptions, such as the API file<br />
systems <code>/proc</code>, <code>/sys</code> and so on, as well as <code>/tmp</code> and<br />
<code>/var/tmp</code>. (BTW: setting these two options on your regular services<br />
that do not use <code>DynamicUser=</code> is a good idea too, as it drastically<br />
reduces the exposure of the system to exploited services.)</p>
</li>
<li>
<p>Setting <code>DynamicUser=yes</code> implies<br />
<a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#PrivateTmp="><code>PrivateTmp=yes</code></a>. This<br />
option sets up <code>/tmp</code> and <code>/var/tmp</code> for the service in a way that it<br />
gets its own, disconnected version of these directories, that are not<br />
shared by other services, and whose life-cycle is bound to the<br />
service&#8217;s own life-cycle. Thus if the service goes down, the user is<br />
removed and all its temporary files and directories with it. (BTW: as<br />
above, consider setting this option for your regular services that do<br />
not use <code>DynamicUser=</code> too, it&#8217;s a great way to lock things down<br />
security-wise.)</p>
</li>
<li>
<p>Setting <code>DynamicUser=yes</code> implies<br />
<a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#RemoveIPC="><code>RemoveIPC=yes</code></a>. This<br />
option ensures that when the service goes down all SysV and POSIX IPC<br />
objects (shared memory, message queues, semaphores) owned by the<br />
service&#8217;s user are removed. Thus, the life-cycle of the IPC objects is<br />
bound to the life-cycle of the dynamic user and service, too. (BTW:<br />
yes, here too, consider using this in your regular services, too!)</p>
</li>
</ol>
<p>With these four settings in effect, services with dynamic users are<br />
nicely sand-boxed. They cannot create files or directories, except in<br />
<code>/tmp</code> and <code>/var/tmp</code>, where they will be removed automatically when<br />
the service shuts down, as will any IPC objects created. Sticky<br />
ownership of files/directories and IPC objects is hence dealt with<br />
effectively.</p>
<p>The<br />
<a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#RuntimeDirectory="><code>RuntimeDirectory=</code></a><br />
option may be used to open up a bit the sandbox to external<br />
programs. If you set it to a directory name of your choice, it will be<br />
created below <code>/run</code> when the service is started, and removed in its<br />
entirety when it is terminated. The ownership of the directory is<br />
assigned to the service&#8217;s dynamic user. This way, a dynamic user<br />
service can expose API interfaces (AF_UNIX sockets, …) to other<br />
services at a well-defined place and again bind the life-cycle of it to<br />
the service&#8217;s own run-time. Example: set <code>RuntimeDirectory=foobar</code> in<br />
your service, and watch how a directory <code>/run/foobar</code> appears at the<br />
moment you start the service, and disappears the moment you stop<br />
it again. (BTW: Much like the other settings discussed above,<br />
<code>RuntimeDirectory=</code> may be used outside of the <code>DynamicUser=</code> context<br />
too, and is a nice way to run any service with a properly owned,<br />
life-cycle-managed run-time directory.)</p>
<h1>Persistent Data</h1>
<p>Of course, a service running in such an environment (although already<br />
very useful for many cases!), has a major limitation: it cannot leave<br />
persistent data around it can reuse on a later run. As pretty much the<br />
whole OS directory tree is read-only to it, there&#8217;s simply no place it<br />
could put the data that survives from one service invocation to the<br />
next.</p>
<p>With systemd 235 this limitation is removed: there are now three new<br />
settings:<br />
<a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#RuntimeDirectory="><code>StateDirectory=</code></a>,<br />
<code>LogsDirectory=</code> and <code>CacheDirectory=</code>. In many ways they operate like<br />
<code>RuntimeDirectory=</code>, but create sub-directories below <code>/var/lib</code>,<br />
<code>/var/log</code> and <code>/var/cache</code>, respectively. There&#8217;s one major<br />
difference beyond that however: directories created that way are<br />
<em>persistent</em>, they will survive the run-time cycle of a service, and<br />
thus may be used to store data that is supposed to stay around between<br />
invocations of the service.</p>
<p>Of course, the obvious question to ask now is: how do these three<br />
settings deal with the <em>sticky file ownership problem</em>?</p>
<p>For that we lifted a concept from container managers. Container<br />
managers have a very similar problem: each container and the host<br />
typically end up using a very similar set of numeric UIDs, and unless<br />
user name-spacing is deployed this means that host users might be able<br />
to access the data of specific containers that also have a user by the<br />
same numeric UID assigned, even though it actually refers to a very<br />
different identity in a different context. (Actually, it&#8217;s even worse<br />
than just getting access, due to the existence of <code>setuid</code> file bits,<br />
access might translate to privilege elevation.) The way container<br />
managers protect the container images from the host (and from each<br />
other to some level) is by placing the container trees below a<br />
<em>boundary</em> directory, with very restrictive access modes and ownership<br />
(0700 and <code>root:root</code> or so). A host user hence cannot take advantage<br />
of the files/directories of a container user of the same UID inside of<br />
a local container tree, simply because the boundary directory makes it<br />
impossible to even reference files in it. After all on UNIX, in order<br />
to get access to a specific path you need access to every single<br />
component of it.</p>
<p>How is that applied to dynamic user services? Let&#8217;s say<br />
<code>StateDirectory=foobar</code> is set for a service that has <code>DynamicUser=</code><br />
turned off. The instant the service is started, <code>/var/lib/foobar</code> is<br />
created as state directory, owned by the service&#8217;s user and remains in<br />
existence when the service is stopped. If the same service now is run<br />
with <code>DynamicUser=</code> turned on, the implementation is slightly<br />
altered. Instead of a directory <code>/var/lib/foobar</code> a symbolic link by<br />
the same path is created (owned by root), pointing to<br />
<code>/var/lib/private/foobar</code> (the latter being owned by the service&#8217;s<br />
dynamic user). The <code>/var/lib/private</code> directory is created as boundary<br />
directory: it&#8217;s owned by <code>root:root</code>, and has a restrictive access<br />
mode of 0700. Both the symlink and the service&#8217;s state directory will<br />
survive the service&#8217;s life-cycle, but the state directory will remain,<br />
and continues to be owned by the now disposed dynamic UID — however it<br />
is protected from other host users (and other services which might get<br />
the same dynamic UID assigned due to UID recycling) by the boundary<br />
directory.</p>
<p>The obvious question to ask now is: but if the boundary directory<br />
prohibits access to the directory from unprivileged processes, how can<br />
the service itself which runs under its own dynamic UID access it<br />
anyway? This is achieved by invoking the service process in a slightly<br />
modified mount name-space: it will see most of the file hierarchy the<br />
same way as everything else on the system (modulo <code>/tmp</code> and<br />
<code>/var/tmp</code> as mentioned above), except for <code>/var/lib/private</code>, which<br />
is over-mounted with a read-only <code>tmpfs</code> file system instance, with a<br />
slightly more liberal access mode permitting the service read<br />
access. Inside of this <code>tmpfs</code> file system instance another mount is<br />
placed: a bind mount to the host&#8217;s real <code>/var/lib/private/foobar</code><br />
directory, onto the same name. Putting this together these means that<br />
superficially everything looks the same and is available at the same<br />
place on the host and from inside the service, but two important<br />
changes have been made: the <code>/var/lib/private</code> boundary directory lost<br />
its restrictive character inside the service, and has been emptied of<br />
the state directories of any other service, thus making the protection<br />
complete. Note that the symlink <code>/var/lib/foobar</code> hides the fact that<br />
the boundary directory is used (making it little more than an<br />
implementation detail), as the directory is available this way under<br />
the same name as it would be if <code>DynamicUser=</code> was not used. Long<br />
story short: for the daemon and from the view from the host the<br />
indirection through <code>/var/lib/private</code> is mostly transparent.</p>
<p>This logic of course raises another question: what happens to the<br />
state directory if a dynamic user service is started with a state<br />
directory configured, gets UID X assigned on this first invocation,<br />
then terminates and is restarted and now gets UID Y assigned on the<br />
second invocation, with X ≠ Y? On the second invocation the directory<br />
— and all the files and directories below it — will still be owned by<br />
the original UID X so how could the second instance running as Y<br />
access it? Our way out is simple: systemd will recursively change the<br />
ownership of the directory and everything contained within it to UID Y<br />
before invoking the service&#8217;s executable.</p>
<p>Of course, such recursive ownership changing (<code>chown()</code>ing) of whole<br />
directory trees can become expensive (though according to my<br />
experiences, IRL and for most services it&#8217;s much cheaper than you<br />
might think), hence in order to optimize behavior in this regard, the<br />
allocation of dynamic UIDs has been tweaked in two ways to avoid the<br />
necessity to do this expensive operation in most cases: firstly, when<br />
a dynamic UID is allocated for a service an allocation loop is<br />
employed that starts out with a UID hashed from the service&#8217;s<br />
name. This means a service by the same name is likely to always use<br />
the same numeric UID. That means that a stable service name translates<br />
into a stable dynamic UID, and that means recursive file ownership<br />
adjustments can be skipped (of course, after validation). Secondly, if<br />
the configured state directory already exists, and is owned by a<br />
suitable currently unused dynamic UID, it&#8217;s preferably used above<br />
everything else, thus maximizing the chance we can avoid the<br />
<code>chown()</code>ing. (That all said, ultimately we have to face it, the<br />
currently available UID space of 4K+ is very small still, and<br />
conflicts are pretty likely sooner or later, thus a chown()ing has to<br />
be expected every now and then when this feature is used extensively).</p>
<p>Note that <code>CacheDirectory=</code> and <code>LogsDirectory=</code> work very similar to<br />
<code>StateDirectory=</code>. The only difference is that they manage directories<br />
below the <code>/var/cache</code> and <code>/var/logs</code> directories, and their boundary<br />
directory hence is <code>/var/cache/private</code> and <code>/var/log/private</code>,<br />
respectively.</p>
<h1>Examples</h1>
<p>So, after all this introduction, let&#8217;s have a look how this all can be<br />
put together. Here&#8217;s a trivial example:</p>
<div class="highlight">
<pre><span></span><span class="c1"># cat &gt; /etc/systemd/system/dynamic-user-test.service &lt;&lt;EOF</span>
<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/sleep <span class="m">4711</span>
<span class="nv">DynamicUser</span><span class="o">=</span>yes
EOF
<span class="c1"># systemctl daemon-reload</span>
<span class="c1"># systemctl start dynamic-user-test</span>
<span class="c1"># systemctl status dynamic-user-test</span>
● dynamic-user-test.service
   Loaded: loaded <span class="o">(</span>/etc/systemd/system/dynamic-user-test.service<span class="p">;</span> static<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
   Active: active <span class="o">(</span>running<span class="o">)</span> since Fri <span class="m">2017</span>-10-06 <span class="m">13</span>:12:25 CEST<span class="p">;</span> 3s ago
 Main PID: <span class="m">2967</span> <span class="o">(</span>sleep<span class="o">)</span>
    Tasks: <span class="m">1</span> <span class="o">(</span>limit: <span class="m">4915</span><span class="o">)</span>
   CGroup: /system.slice/dynamic-user-test.service
           └─2967 /usr/bin/sleep <span class="m">4711</span>

Okt <span class="m">06</span> <span class="m">13</span>:12:25 sigma systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>: Started dynamic-user-test.service.
<span class="c1"># ps -e -o pid,comm,user | grep 2967</span>
 <span class="m">2967</span> sleep           dynamic-user-test
<span class="c1"># id dynamic-user-test</span>
<span class="nv">uid</span><span class="o">=</span><span class="m">64642</span><span class="o">(</span>dynamic-user-test<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span><span class="m">64642</span><span class="o">(</span>dynamic-user-test<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span><span class="m">64642</span><span class="o">(</span>dynamic-user-test<span class="o">)</span>
<span class="c1"># systemctl stop dynamic-user-test</span>
<span class="c1"># id dynamic-user-test</span>
id: ‘dynamic-user-test’: no such user
</pre>
</div>
<p>In this example, we create a unit file with <code>DynamicUser=</code> turned on,<br />
start it, check if it&#8217;s running correctly, have a look at the service<br />
process&#8217; user (which is named like the service; systemd does this<br />
automatically if the service name is suitable as user name, and you<br />
didn&#8217;t configure any user name to use explicitly), stop the service<br />
and verify that the user ceased to exist too.</p>
<p>That&#8217;s already pretty cool. Let&#8217;s step it up a notch, by doing the<br />
same in an interactive <em>transient</em> service (for those who don&#8217;t know<br />
systemd well: a transient service is a service that is defined and<br />
started dynamically at run-time, for example via the <code>systemd-run</code><br />
command from the shell. Think: run a service without having to write a<br />
unit file first):</p>
<div class="highlight">
<pre><span></span><span class="c1"># systemd-run --pty --property=DynamicUser=yes --property=StateDirectory=wuff /bin/sh</span>
Running as unit: run-u15750.service
Press ^<span class="o">]</span> three <span class="nb">times</span> within 1s to disconnect TTY.
sh-4.4$ id
<span class="nv">uid</span><span class="o">=</span><span class="m">63122</span><span class="o">(</span>run-u15750<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span><span class="m">63122</span><span class="o">(</span>run-u15750<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span><span class="m">63122</span><span class="o">(</span>run-u15750<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:initrc_t:s0
sh-4.4$ ls -al /var/lib/private/
total <span class="m">0</span>
drwxr-xr-x. <span class="m">3</span> root       root        <span class="m">60</span>  <span class="m">6</span>. Okt <span class="m">13</span>:21 .
drwxr-xr-x. <span class="m">1</span> root       root       <span class="m">852</span>  <span class="m">6</span>. Okt <span class="m">13</span>:21 ..
drwxr-xr-x. <span class="m">1</span> run-u15750 run-u15750   <span class="m">8</span>  <span class="m">6</span>. Okt <span class="m">13</span>:22 wuff
sh-4.4$ ls -ld /var/lib/wuff
lrwxrwxrwx. <span class="m">1</span> root root <span class="m">12</span>  <span class="m">6</span>. Okt <span class="m">13</span>:21 /var/lib/wuff -&gt; private/wuff
sh-4.4$ ls -ld /var/lib/wuff/
drwxr-xr-x. <span class="m">1</span> run-u15750 run-u15750 <span class="m">0</span>  <span class="m">6</span>. Okt <span class="m">13</span>:21 /var/lib/wuff/
sh-4.4$ <span class="nb">echo</span> hello &gt; /var/lib/wuff/test
sh-4.4$ <span class="nb">exit</span>
<span class="nb">exit</span>
<span class="c1"># id run-u15750</span>
id: ‘run-u15750’: no such user
<span class="c1"># ls -al /var/lib/private</span>
total <span class="m">0</span>
drwx------. <span class="m">1</span> root  root   <span class="m">66</span>  <span class="m">6</span>. Okt <span class="m">13</span>:21 .
drwxr-xr-x. <span class="m">1</span> root  root  <span class="m">852</span>  <span class="m">6</span>. Okt <span class="m">13</span>:21 ..
drwxr-xr-x. <span class="m">1</span> <span class="m">63122</span> <span class="m">63122</span>   <span class="m">8</span>  <span class="m">6</span>. Okt <span class="m">13</span>:22 wuff
<span class="c1"># ls -ld /var/lib/wuff</span>
lrwxrwxrwx. <span class="m">1</span> root root <span class="m">12</span>  <span class="m">6</span>. Okt <span class="m">13</span>:21 /var/lib/wuff -&gt; private/wuff
<span class="c1"># ls -ld /var/lib/wuff/</span>
drwxr-xr-x. <span class="m">1</span> <span class="m">63122</span> <span class="m">63122</span> <span class="m">8</span>  <span class="m">6</span>. Okt <span class="m">13</span>:22 /var/lib/wuff/
<span class="c1"># cat /var/lib/wuff/test</span>
hello
</pre>
</div>
<p>The above invokes an interactive shell as transient service<br />
<code>run-u15750.service</code> (<code>systemd-run</code> picked that name automatically,<br />
since we didn&#8217;t specify anything explicitly) with a dynamic user whose<br />
name is derived automatically from the service name. Because<br />
<code>StateDirectory=wuff</code> is used, a persistent state directory for the<br />
service is made available as <code>/var/lib/wuff</code>. In the interactive shell<br />
running inside the service, the <code>ls</code> commands show the<br />
<code>/var/lib/private</code> boundary directory and its contents, as well as the<br />
symlink that is placed for the service. Finally, before exiting the<br />
shell, a file is created in the state directory. Back in the original<br />
command shell we check if the user is still allocated: it is not, of<br />
course, since the service ceased to exist when we exited the shell and<br />
with it the dynamic user associated with it. From the host we check<br />
the state directory of the service, with similar commands as we did<br />
from inside of it. We see that things are set up pretty much the same<br />
way in both cases, except for two things: first of all the user/group<br />
of the files is now shown as raw numeric UIDs instead of the<br />
user/group names derived from the unit name. That&#8217;s because the user<br />
ceased to exist at this point, and &#8220;ls&#8221; shows the raw UID for files<br />
owned by users that don&#8217;t exist. Secondly, the access mode of the<br />
boundary directory is different: when we look at it from outside of<br />
the service it is not readable by anyone but root, when we looked from<br />
inside we saw it it being world readable.</p>
<p>Now, let&#8217;s see how things look if we start another transient service,<br />
reusing the state directory from the first invocation:</p>
<div class="highlight">
<pre><span></span><span class="c1"># systemd-run --pty --property=DynamicUser=yes --property=StateDirectory=wuff /bin/sh</span>
Running as unit: run-u16087.service
Press ^<span class="o">]</span> three <span class="nb">times</span> within 1s to disconnect TTY.
sh-4.4$ cat /var/lib/wuff/test
hello
sh-4.4$ ls -al /var/lib/wuff/
total <span class="m">4</span>
drwxr-xr-x. <span class="m">1</span> run-u16087 run-u16087  <span class="m">8</span>  <span class="m">6</span>. Okt <span class="m">13</span>:22 .
drwxr-xr-x. <span class="m">3</span> root       root       <span class="m">60</span>  <span class="m">6</span>. Okt <span class="m">15</span>:42 ..
-rw-r--r--. <span class="m">1</span> run-u16087 run-u16087  <span class="m">6</span>  <span class="m">6</span>. Okt <span class="m">13</span>:22 <span class="nb">test</span>
sh-4.4$ id
<span class="nv">uid</span><span class="o">=</span><span class="m">63122</span><span class="o">(</span>run-u16087<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span><span class="m">63122</span><span class="o">(</span>run-u16087<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span><span class="m">63122</span><span class="o">(</span>run-u16087<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:initrc_t:s0
sh-4.4$ <span class="nb">exit</span>
<span class="nb">exit</span>
</pre>
</div>
<p>Here, <code>systemd-run</code> picked a different auto-generated unit name, but<br />
the used dynamic UID is still the same, as it was read from the<br />
pre-existing state directory, and was otherwise unused. As we can see<br />
the test file we generated earlier is accessible and still contains<br />
the data we left in there. Do note that the user name is different<br />
this time (as it is derived from the unit name, which is different),<br />
but the UID it is assigned to is the same one as on the first<br />
invocation. We can thus see that the mentioned optimization of the UID<br />
allocation logic (i.e. that we start the allocation loop from the UID<br />
owner of any existing state directory) took effect, so that no<br />
recursive <code>chown()</code>ing was required.</p>
<p>And that&#8217;s the end of our example, which hopefully illustrated a bit<br />
how this concept and implementation works.</p>
<h1>Use-cases</h1>
<p>Now that we had a look at how to enable this logic for a unit and how<br />
it is implemented, let&#8217;s discuss where this actually could be useful<br />
in real life.</p>
<ul>
<li>
<p>One major benefit of dynamic user IDs is that running a<br />
privilege-separated service leaves no artifacts in the system. A<br />
system user is allocated and made use of, but it is discarded<br />
automatically in a safe and secure way after use, in a fashion that is<br />
safe for later recycling. Thus, quickly invoking a short-lived service<br />
for processing some job can be protected properly through a user ID<br />
without having to pre-allocate it and without this draining the<br />
available UID pool any longer than necessary.</p>
</li>
<li>
<p>In many cases, starting a service no longer requires<br />
package-specific preparation. Or in other words, quite often<br />
<code>useradd</code>/<code>mkdir</code>/<code>chown</code>/<code>chmod</code> invocations in &#8220;<code>post-inst</code>&#8221; package<br />
scripts, as well as<br />
<a href="https://www.freedesktop.org/software/systemd/man/sysusers.d.html"><code>sysusers.d</code></a><br />
and<br />
<a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html"><code>tmpfiles.d</code></a><br />
drop-ins become unnecessary, as the <code>DynamicUser=</code> and<br />
<code>StateDirectory=</code>/<code>CacheDirectory=</code>/<code>LogsDirectory=</code> logic can do the<br />
necessary work automatically, on-demand and with a well-defined<br />
life-cycle.</p>
</li>
<li>
<p>By combining dynamic user IDs with the transient unit concept, new<br />
creative ways of sand-boxing are made available. For example, let&#8217;s say<br />
you don&#8217;t trust the correct implementation of the <code>sort</code> command. You<br />
can now lock it into a simple, robust, dynamic UID sandbox with a<br />
simple <code>systemd-run</code> and still integrate it into a shell pipeline like<br />
any other command. Here&#8217;s an example, showcasing a shell pipeline<br />
whose middle element runs as a dynamically on-the-fly allocated UID,<br />
that is released when the pipelines ends.</p>
<div class="highlight">
<pre><span></span># cat some-file.txt | systemd-run ---pipe --property=DynamicUser=1 sort -u | grep -i foobar &gt; some-other-file.txt
</pre>
</div>
</li>
<li>
<p>By combining dynamic user IDs with the systemd templating logic it<br />
is now possible to do much more fine-grained and fully automatic UID<br />
management. For example, let&#8217;s say you have a template unit file<br />
<code>/etc/systemd/system/<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="41272e2e23203325016f32243337282224">[email&#160;protected]</a></code>:</p>
<div class="highlight">
<pre><span></span><span class="k">[Service]</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/myfoobarserviced</span>
<span class="na">DynamicUser</span><span class="o">=</span><span class="s">1</span>
<span class="na">StateDirectory</span><span class="o">=</span><span class="s">foobar/%i</span>
</pre>
</div>
<p>Now, let&#8217;s say you want to start one instance of this service for<br />
each of your customers. All you need to do now for that is:</p>
<div class="highlight">
<pre><span></span># systemctl enable <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4c2a23232e2d3e280c2f393f382321293e343536623f293e3a252f29">[email&#160;protected]</a> --now
</pre>
</div>
<p>And you are done. (Invoke this as many times as you like, each time<br />
replacing <code>customerxyz</code> by some customer identifier, you get the<br />
idea.)</p>
</li>
<li>
<p>By combining dynamic user IDs with socket activation you may easily<br />
implement a system where each incoming connection is served by a<br />
process instance running as a different, fresh, newly allocated UID<br />
within its own sandbox. Here&#8217;s an example <code>waldo.socket</code>:</p>
<div class="highlight">
<pre><span></span><span class="k">[Socket]</span>
<span class="na">ListenStream</span><span class="o">=</span><span class="s">2048</span>
<span class="na">Accept</span><span class="o">=</span><span class="s">yes</span>
</pre>
</div>
<p>With a matching <code><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="14637578707b543a677166627d7771">[email&#160;protected]</a></code>:</p>
<div class="highlight">
<pre><span></span><span class="k">[Service]</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">-/usr/bin/myservicebinary</span>
<span class="na">DynamicUser</span><span class="o">=</span><span class="s">yes</span>
</pre>
</div>
<p>With the two unit files above, systemd will listen on TCP/IP port<br />
2048, and for each incoming connection invoke a fresh instance of<br />
<code><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="94e3f5f8f0fbd4bae7f1e6e2fdf7f1">[email&#160;protected]</a></code>, each time utilizing a different, new,<br />
dynamically allocated UID, neatly isolated from any other<br />
instance.</p>
</li>
<li>
<p>Dynamic user IDs combine very well with state-less systems,<br />
i.e. systems that come up with an unpopulated <code>/etc</code> and <code>/var</code>. A<br />
service using dynamic user IDs and the <code>StateDirectory=</code>,<br />
<code>CacheDirectory=</code>, <code>LogsDirectory=</code> and <code>RuntimeDirectory=</code> concepts<br />
will implicitly allocate the users and directories it needs for<br />
running, right at the moment where it needs it.</p>
</li>
</ul>
<p>Dynamic users are a very generic concept, hence a multitude of other<br />
uses are thinkable; the list above is just supposed to trigger your<br />
imagination.</p>
<h1>What does this mean for you as a packager?</h1>
<p>I am pretty sure that a large number of services shipped with today&#8217;s<br />
distributions could benefit from using <code>DynamicUser=</code> and<br />
<code>StateDirectory=</code> (and related settings). It often allows removal of<br />
<code>post-inst</code> packaging scripts altogether, as well as any <code>sysusers.d</code><br />
and <code>tmpfiles.d</code> drop-ins by unifying the needed declarations in the<br />
unit file itself. Hence, as a packager please consider switching your<br />
unit files over. That said, there are a number of conditions where<br />
<code>DynamicUser=</code> and <code>StateDirectory=</code> (and friends) cannot or should<br />
not be used. To name a few:</p>
<ol>
<li>
<p>Service that need to write to files outside of <code>/run/&lt;package&gt;</code>,<br />
<code>/var/lib/&lt;package&gt;</code>, <code>/var/cache/&lt;package&gt;</code>, <code>/var/log/&lt;package&gt;</code>,<br />
<code>/var/tmp</code>, <code>/tmp</code>, <code>/dev/shm</code> are generally incompatible with this<br />
scheme. This rules out daemons that upgrade the system as one example,<br />
as that involves writing to <code>/usr</code>.</p>
</li>
<li>
<p>Services that maintain a herd of processes with different user<br />
IDs. Some SMTP services are like this. If your service has such a<br />
<em>super-server</em> design, UID management needs to be done by the<br />
super-server itself, which rules out systemd doing its dynamic UID<br />
magic for it.</p>
</li>
<li>
<p>Services which run as root (obviously…) or are otherwise<br />
privileged.</p>
</li>
<li>
<p>Services that need to live in the same mount name-space as the host<br />
system (for example, because they want to establish mount points<br />
visible system-wide). As mentioned <code>DynamicUser=</code> implies<br />
<code>ProtectSystem=</code>, <code>PrivateTmp=</code> and related options, which all require<br />
the service to run in its own mount name-space.</p>
</li>
<li>
<p>Your focus is older distributions, i.e. distributions that do not<br />
have systemd 232 (for <code>DynamicUser=</code>) or systemd 235 (for<br />
<code>StateDirectory=</code> and friends) yet.</p>
</li>
<li>
<p>If your distribution&#8217;s packaging guides don&#8217;t allow it. Consult<br />
your packaging guides, and possibly start a discussion on your<br />
distribution&#8217;s mailing list about this.</p>
</li>
</ol>
<h1>Notes</h1>
<p>A couple of additional, random notes about the implementation and use<br />
of these features:</p>
<ol>
<li>
<p>Do note that allocating or deallocating a dynamic user leaves<br />
<code>/etc/passwd</code> untouched. A dynamic user is added into the user<br />
database through the glibc NSS module<br />
<a href="https://www.freedesktop.org/software/systemd/man/nss-systemd.html"><code>nss-systemd</code></a>,<br />
and this information never hits the disk.</p>
</li>
<li>
<p>On traditional UNIX systems it was the job of the daemon process<br />
itself to drop privileges, while the <code>DynamicUser=</code> concept is<br />
designed around the service manager (i.e. systemd) being responsible<br />
for that. That said, since v235 there&#8217;s a way to marry <code>DynamicUser=</code><br />
and such services which want to drop privileges on their own. For<br />
that, turn on <code>DynamicUser=</code> and set<br />
<a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#User="><code>User=</code></a><br />
to the user name the service wants to <code>setuid()</code> to. This has the<br />
effect that systemd will allocate the dynamic user under the specified<br />
name when the service is started. Then, prefix the command line you<br />
specify in<br />
<a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html#ExecStart="><code>ExecStart=</code></a><br />
with a single <code>!</code> character. If you do, the user is allocated for the<br />
service, but the daemon binary is is invoked as <code>root</code> instead of the<br />
allocated user, under the assumption that the daemon changes its UID<br />
on its own the right way. Not that after registration the user will<br />
show up instantly in the user database, and is hence resolvable like<br />
any other by the daemon process. Example:<br />
<code>ExecStart=!/usr/bin/mydaemond</code></p>
</li>
<li>
<p>You may wonder why systemd uses the UID range 61184–65519 for its<br />
dynamic user allocations (side note: in hexadecimal this reads as<br />
0xEF00–0xFFEF). That&#8217;s because distributions (specifically Fedora)<br />
tend to allocate regular users from below the 60000 range, and we<br />
don&#8217;t want to step into that. We also want to stay away from 65535 and<br />
a bit around it, as some of these UIDs have special meanings (65535 is<br />
often used as special value for &#8220;invalid&#8221; or &#8220;no&#8221; UID, as it is<br />
identical to the 16bit value -1; 65534 is generally mapped to the<br />
&#8220;nobody&#8221; user, and is where some kernel subsystems map unmappable<br />
UIDs). Finally, we want to stay within the 16bit range. In a user<br />
name-spacing world each container tends to have much less than the full<br />
32bit UID range available that Linux kernels theoretically<br />
provide. Everybody apparently can agree that a container should at<br />
least cover the 16bit range though — already to include a <code>nobody</code><br />
user. (And quite frankly, I am pretty sure assigning 64K UIDs per<br />
container is nicely systematic, as the the higher 16bit of the 32bit<br />
UID values this way become a container ID, while the lower 16bit<br />
become the logical UID within each container, if you still follow what<br />
I am babbling here…). And before you ask: no this range cannot be<br />
changed right now, it&#8217;s compiled in. We might change that eventually<br />
however.</p>
</li>
<li>
<p>You might wonder what happens if you already used UIDs from the<br />
61184–65519 range on your system for other purposes. systemd should<br />
handle that mostly fine, as long as that usage is properly registered<br />
in the user database: when allocating a dynamic user we pick a UID,<br />
see if it is currently used somehow, and if yes pick a different one,<br />
until we find a free one. Whether a UID is used right now or not is<br />
checked through NSS calls. Moreover the IPC object lists are checked to<br />
see if there are any objects owned by the UID we are about to<br />
pick. This means systemd will avoid using UIDs you have assigned<br />
otherwise. Note however that this of course makes the pool of<br />
available UIDs smaller, and in the worst cases this means that<br />
allocating a dynamic user might fail because there simply are no<br />
unused UIDs in the range.</p>
</li>
<li>
<p>If not specified otherwise the name for a dynamically allocated<br />
user is derived from the service name. Not everything that&#8217;s valid in<br />
a service name is valid in a user-name however, and in some cases a<br />
randomized name is used instead to deal with this. Often it makes<br />
sense to pick the user names to register explicitly. For that use<br />
<code>User=</code> and choose whatever you like.</p>
</li>
<li>
<p>If you pick a user name with <code>User=</code> and combine it with<br />
<code>DynamicUser=</code> and the user already exists statically it will be used<br />
for the service and the dynamic user logic is automatically<br />
disabled. This permits automatic up- and downgrades between static and<br />
dynamic UIDs. For example, it provides a nice way to move a system<br />
from static to dynamic UIDs in a compatible way: as long as you select<br />
the same <code>User=</code> value before and after switching <code>DynamicUser=</code> on,<br />
the service will continue to use the statically allocated user if it<br />
exists, and only operates in the dynamic mode if it does not. This is<br />
useful for other cases as well, for example to adapt a service that<br />
normally would use a dynamic user to concepts that require statically<br />
assigned UIDs, for example to marry classic UID-based file system<br />
quota with such services.</p>
</li>
<li>
<p>systemd always allocates a pair of dynamic UID and GID at the same<br />
time, with the same numeric ID.</p>
</li>
<li>
<p>If the Linux kernel had a &#8220;shiftfs&#8221; or similar functionality,<br />
i.e. a way to mount an existing directory to a second place, but map<br />
the exposed UIDs/GIDs in some way configurable at mount time, this<br />
would be excellent for the implementation of <code>StateDirectory=</code> in<br />
conjunction with <code>DynamicUser=</code>. It would make the recursive<br />
<code>chown()</code>ing step unnecessary, as the host version of the state<br />
directory could simply be mounted into a the service&#8217;s mount<br />
name-space, with a shift applied that maps the directory&#8217;s owner to the<br />
services&#8217; UID/GID. But I don&#8217;t have high hopes in this regard, as all<br />
work being done in this area appears to be bound to user name-spacing<br />
— which is a concept not used here (and I guess one could say user<br />
name-spacing is probably more a source of problems than a solution to<br />
one, but you are welcome to disagree on that).</p>
</li>
</ol>
<p>And that&#8217;s all for now. Enjoy your dynamic users!</p>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/2017/" rel="tag">2017</a><a href="https://noise.getoto.net/tag/4k/" rel="tag">4K</a><a href="https://noise.getoto.net/tag/52/" rel="tag">52</a><a href="https://noise.getoto.net/tag/acs/" rel="tag">acs</a><a href="https://noise.getoto.net/tag/ad/" rel="tag">AD</a><a href="https://noise.getoto.net/tag/adi/" rel="tag">ADI</a><a href="https://noise.getoto.net/tag/ads/" rel="tag">ads</a><a href="https://noise.getoto.net/tag/ai/" rel="tag">AI</a><a href="https://noise.getoto.net/tag/all/" rel="tag">All</a><a href="https://noise.getoto.net/tag/android/" rel="tag">Android</a><a href="https://noise.getoto.net/tag/app/" rel="tag">app</a><a href="https://noise.getoto.net/tag/apt/" rel="tag">apt</a><a href="https://noise.getoto.net/tag/art/" rel="tag">art</a><a href="https://noise.getoto.net/tag/ati/" rel="tag">ATI</a><a href="https://noise.getoto.net/tag/basic/" rel="tag">BASIC</a><a href="https://noise.getoto.net/tag/bec/" rel="tag">BEC</a><a href="https://noise.getoto.net/tag/behavior/" rel="tag">Behavior</a><a href="https://noise.getoto.net/tag/bett/" rel="tag">BETT</a><a href="https://noise.getoto.net/tag/bits/" rel="tag">Bits</a><a href="https://noise.getoto.net/tag/ble/" rel="tag">ble</a><a href="https://noise.getoto.net/tag/blog/" rel="tag">blog</a><a href="https://noise.getoto.net/tag/bt/" rel="tag">BT</a><a href="https://noise.getoto.net/tag/c/" rel="tag">C</a><a href="https://noise.getoto.net/tag/cam/" rel="tag">cam</a><a href="https://noise.getoto.net/tag/car/" rel="tag">car</a><a href="https://noise.getoto.net/tag/cas/" rel="tag">CAS</a><a href="https://noise.getoto.net/tag/case/" rel="tag">Case</a><a href="https://noise.getoto.net/tag/cases/" rel="tag">cases</a><a href="https://noise.getoto.net/tag/choice/" rel="tag">Choice</a><a href="https://noise.getoto.net/tag/ci/" rel="tag">ci</a><a href="https://noise.getoto.net/tag/cia/" rel="tag">cia</a><a href="https://noise.getoto.net/tag/cli/" rel="tag">cli</a><a href="https://noise.getoto.net/tag/containers/" rel="tag">Containers</a><a href="https://noise.getoto.net/tag/context/" rel="tag">context</a><a href="https://noise.getoto.net/tag/core/" rel="tag">Core</a><a href="https://noise.getoto.net/tag/creative/" rel="tag">creative</a><a href="https://noise.getoto.net/tag/curity/" rel="tag">Curity</a><a href="https://noise.getoto.net/tag/data/" rel="tag">data</a><a href="https://noise.getoto.net/tag/database/" rel="tag">database</a><a href="https://noise.getoto.net/tag/databases/" rel="tag">databases</a><a href="https://noise.getoto.net/tag/dea/" rel="tag">dea</a><a href="https://noise.getoto.net/tag/design/" rel="tag">design</a><a href="https://noise.getoto.net/tag/det/" rel="tag">det</a><a href="https://noise.getoto.net/tag/directories/" rel="tag">directories</a><a href="https://noise.getoto.net/tag/disa/" rel="tag">DISA</a><a href="https://noise.getoto.net/tag/down/" rel="tag">down</a><a href="https://noise.getoto.net/tag/dyn/" rel="tag">Dyn</a><a href="https://noise.getoto.net/tag/east/" rel="tag">EAST</a><a href="https://noise.getoto.net/tag/ec/" rel="tag">ec</a><a href="https://noise.getoto.net/tag/ecs/" rel="tag">ECS</a><a href="https://noise.getoto.net/tag/ed/" rel="tag">ed</a><a href="https://noise.getoto.net/tag/eff/" rel="tag">eff</a><a href="https://noise.getoto.net/tag/environment/" rel="tag">environment</a><a href="https://noise.getoto.net/tag/eset/" rel="tag">eset</a><a href="https://noise.getoto.net/tag/et/" rel="tag">et</a><a href="https://noise.getoto.net/tag/eu/" rel="tag">eu</a><a href="https://noise.getoto.net/tag/event/" rel="tag">event</a><a href="https://noise.getoto.net/tag/exploit/" rel="tag">exploit</a><a href="https://noise.getoto.net/tag/fact/" rel="tag">fact</a><a href="https://noise.getoto.net/tag/fail/" rel="tag">fail</a><a href="https://noise.getoto.net/tag/fashion/" rel="tag">fashion</a><a href="https://noise.getoto.net/tag/fedora/" rel="tag">fedora</a><a href="https://noise.getoto.net/tag/fir/" rel="tag">fir</a><a href="https://noise.getoto.net/tag/fly/" rel="tag">Fly</a><a href="https://noise.getoto.net/tag/form/" rel="tag">form</a><a href="https://noise.getoto.net/tag/fun/" rel="tag">Fun</a><a href="https://noise.getoto.net/tag/general/" rel="tag">General</a><a href="https://noise.getoto.net/tag/glibc/" rel="tag">glibc</a><a href="https://noise.getoto.net/tag/go/" rel="tag">Go</a><a href="https://noise.getoto.net/tag/got/" rel="tag">got</a><a href="https://noise.getoto.net/tag/gre/" rel="tag">GRE</a><a href="https://noise.getoto.net/tag/groups/" rel="tag">groups</a><a href="https://noise.getoto.net/tag/guide/" rel="tag">guide</a><a href="https://noise.getoto.net/tag/guides/" rel="tag">Guides</a><a href="https://noise.getoto.net/tag/hash/" rel="tag">hash</a><a href="https://noise.getoto.net/tag/hat/" rel="tag">HAT</a><a href="https://noise.getoto.net/tag/ice/" rel="tag">ICE</a><a href="https://noise.getoto.net/tag/identity/" rel="tag">Identity</a><a href="https://noise.getoto.net/tag/improvements/" rel="tag">improvements</a><a href="https://noise.getoto.net/tag/inside/" rel="tag">Inside</a><a href="https://noise.getoto.net/tag/install/" rel="tag">install</a><a href="https://noise.getoto.net/tag/ip/" rel="tag">IP</a><a href="https://noise.getoto.net/tag/irs/" rel="tag">irs</a><a href="https://noise.getoto.net/tag/isp/" rel="tag">ISP</a><a href="https://noise.getoto.net/tag/iss/" rel="tag">iss</a><a href="https://noise.getoto.net/tag/issue/" rel="tag">issue</a><a href="https://noise.getoto.net/tag/iste/" rel="tag">ISTE</a><a href="https://noise.getoto.net/tag/kernel/" rel="tag">kernel</a><a href="https://noise.getoto.net/tag/law/" rel="tag">Law</a><a href="https://noise.getoto.net/tag/lies/" rel="tag">lies</a><a href="https://noise.getoto.net/tag/light/" rel="tag">light</a><a href="https://noise.getoto.net/tag/limit/" rel="tag">limit</a><a href="https://noise.getoto.net/tag/linux/" rel="tag">linux</a><a href="https://noise.getoto.net/tag/location/" rel="tag">location</a><a href="https://noise.getoto.net/tag/lte/" rel="tag">LTE</a><a href="https://noise.getoto.net/tag/mac/" rel="tag">Mac</a><a href="https://noise.getoto.net/tag/mail/" rel="tag">mail</a><a href="https://noise.getoto.net/tag/make/" rel="tag">Make</a><a href="https://noise.getoto.net/tag/making/" rel="tag">making</a><a href="https://noise.getoto.net/tag/mana/" rel="tag">mana</a><a href="https://noise.getoto.net/tag/map/" rel="tag">map</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/mit/" rel="tag">mit</a><a href="https://noise.getoto.net/tag/mou/" rel="tag">MoU</a><a href="https://noise.getoto.net/tag/mov/" rel="tag">mov</a><a href="https://noise.getoto.net/tag/move/" rel="tag">move</a><a href="https://noise.getoto.net/tag/mpa/" rel="tag">MPA</a><a href="https://noise.getoto.net/tag/ncr/" rel="tag">NCR</a><a href="https://noise.getoto.net/tag/nec/" rel="tag">NEC</a><a href="https://noise.getoto.net/tag/nes/" rel="tag">NES</a><a href="https://noise.getoto.net/tag/nmap/" rel="tag">nmap</a><a href="https://noise.getoto.net/tag/npr/" rel="tag">NPR</a><a href="https://noise.getoto.net/tag/nse/" rel="tag">nse</a><a href="https://noise.getoto.net/tag/objects/" rel="tag">objects</a><a href="https://noise.getoto.net/tag/opera/" rel="tag">opera</a><a href="https://noise.getoto.net/tag/operating-systems/" rel="tag">Operating Systems</a><a href="https://noise.getoto.net/tag/oss/" rel="tag">OSS</a><a href="https://noise.getoto.net/tag/other/" rel="tag">Other</a><a href="https://noise.getoto.net/tag/ous/" rel="tag">OUs</a><a href="https://noise.getoto.net/tag/pa/" rel="tag">PA</a><a href="https://noise.getoto.net/tag/pc/" rel="tag">pc</a><a href="https://noise.getoto.net/tag/people/" rel="tag">people</a><a href="https://noise.getoto.net/tag/perl/" rel="tag">perl</a><a href="https://noise.getoto.net/tag/power/" rel="tag">power</a><a href="https://noise.getoto.net/tag/ppl/" rel="tag">PPL</a><a href="https://noise.getoto.net/tag/present/" rel="tag">Present</a><a href="https://noise.getoto.net/tag/problem/" rel="tag">problem</a><a href="https://noise.getoto.net/tag/processing/" rel="tag">Processing</a><a href="https://noise.getoto.net/tag/ps/" rel="tag">ps</a><a href="https://noise.getoto.net/tag/r/" rel="tag">R</a><a href="https://noise.getoto.net/tag/rat/" rel="tag">rat</a><a href="https://noise.getoto.net/tag/rate/" rel="tag">rate</a><a href="https://noise.getoto.net/tag/raw/" rel="tag">raw</a><a href="https://noise.getoto.net/tag/rds/" rel="tag">RDS</a><a href="https://noise.getoto.net/tag/read-only/" rel="tag">read-only</a><a href="https://noise.getoto.net/tag/release/" rel="tag">Release</a><a href="https://noise.getoto.net/tag/resource/" rel="tag">Resource</a><a href="https://noise.getoto.net/tag/resources/" rel="tag">resources</a><a href="https://noise.getoto.net/tag/rest/" rel="tag">rest</a><a href="https://noise.getoto.net/tag/roi/" rel="tag">ROI</a><a href="https://noise.getoto.net/tag/rov/" rel="tag">ROV</a><a href="https://noise.getoto.net/tag/rti/" rel="tag">RTI</a><a href="https://noise.getoto.net/tag/running/" rel="tag">running</a><a href="https://noise.getoto.net/tag/rust/" rel="tag">Rust</a><a href="https://noise.getoto.net/tag/s/" rel="tag">S.</a><a href="https://noise.getoto.net/tag/sam/" rel="tag">SAM</a><a href="https://noise.getoto.net/tag/security/" rel="tag">security</a><a href="https://noise.getoto.net/tag/server/" rel="tag">server</a><a href="https://noise.getoto.net/tag/shed/" rel="tag">shed</a><a href="https://noise.getoto.net/tag/space/" rel="tag">space</a><a href="https://noise.getoto.net/tag/sse/" rel="tag">SSE</a><a href="https://noise.getoto.net/tag/star/" rel="tag">Star</a><a href="https://noise.getoto.net/tag/status/" rel="tag">status</a><a href="https://noise.getoto.net/tag/sts/" rel="tag">sts</a><a href="https://noise.getoto.net/tag/support/" rel="tag">support</a><a href="https://noise.getoto.net/tag/suse/" rel="tag">SUSE</a><a href="https://noise.getoto.net/tag/tag/" rel="tag">TAG</a><a href="https://noise.getoto.net/tag/tea/" rel="tag">tea</a><a href="https://noise.getoto.net/tag/tech/" rel="tag">tech</a><a href="https://noise.getoto.net/tag/technical/" rel="tag">Technical</a><a href="https://noise.getoto.net/tag/ted/" rel="tag">ted</a><a href="https://noise.getoto.net/tag/test/" rel="tag">test</a><a href="https://noise.getoto.net/tag/things/" rel="tag">things</a><a href="https://noise.getoto.net/tag/tic/" rel="tag">TIC</a><a href="https://noise.getoto.net/tag/today/" rel="tag">Today</a><a href="https://noise.getoto.net/tag/tor/" rel="tag">tor</a><a href="https://noise.getoto.net/tag/touch/" rel="tag">touch</a><a href="https://noise.getoto.net/tag/trust/" rel="tag">trust</a><a href="https://noise.getoto.net/tag/ui/" rel="tag">UI</a><a href="https://noise.getoto.net/tag/un/" rel="tag">un</a><a href="https://noise.getoto.net/tag/upgrade/" rel="tag">Upgrade</a><a href="https://noise.getoto.net/tag/us/" rel="tag">US</a><a href="https://noise.getoto.net/tag/useful/" rel="tag">Useful</a><a href="https://noise.getoto.net/tag/ustr/" rel="tag">USTR</a><a href="https://noise.getoto.net/tag/ux/" rel="tag">UX</a><a href="https://noise.getoto.net/tag/validation/" rel="tag">Validation</a><a href="https://noise.getoto.net/tag/watch/" rel="tag">watch</a><a href="https://noise.getoto.net/tag/wd/" rel="tag">wd</a><a href="https://noise.getoto.net/tag/work/" rel="tag">Work</a><a href="https://noise.getoto.net/tag/writing/" rel="tag">writing</a></span></footer></article>
<article id="post-317038" class="post-317038 post type-post status-publish format-standard hentry tag-ad tag-adi tag-ads tag-ai tag-ala tag-alarms tag-all tag-amazon tag-amazon-dynamodb tag-amazon-ec2 tag-amazon-rds tag-amazon-redshift tag-amazon-simple-notification-service tag-amazon-simple-queue-service tag-amazon-sns tag-amazon-sqs tag-analysis tag-app tag-apt tag-architecture tag-aria tag-arm tag-art tag-ati tag-auto-scaling tag-availability tag-aws tag-aws-lambda tag-bec tag-behavior tag-best-practices tag-ble tag-blocking tag-business tag-c tag-cali tag-cas tag-case tag-cases tag-challenge tag-choice tag-ci tag-cia tag-cloud tag-cloud-messaging tag-cloudwatch tag-code tag-console tag-data tag-database tag-dea tag-decoupling tag-dependencies tag-design tag-developers tag-development tag-dimension tag-down tag-dp tag-dress tag-dyn tag-dynamodb tag-ec tag-ec2 tag-ec2-instances tag-ecr tag-ed tag-email tag-enterprise tag-environment tag-et tag-eu tag-event tag-facets tag-fail tag-fan tag-fm tag-form tag-fun tag-getting-started tag-go tag-gre tag-guide tag-hash tag-hat tag-hp tag-http tag-https tag-ice tag-increase tag-infrastructure tag-instances tag-ios tag-ip tag-iq tag-irs tag-isp tag-iss tag-issue tag-json tag-lambda tag-limit tag-load-balancing tag-logging tag-lte tag-lua tag-mail tag-make tag-making tag-mana tag-marketing tag-math tag-media tag-message-queues tag-message-topics tag-messaging tag-metrics tag-micros tag-microservices tag-mit tag-mobile tag-mov tag-move tag-mpa tag-nature tag-ncr tag-nec tag-nes tag-network tag-notifications tag-npr tag-nsa tag-nse tag-opera tag-oss tag-other tag-ous tag-paris tag-pin tag-policy tag-position tag-power tag-ppl tag-processing tag-project tag-protocols tag-proxima tag-ps tag-pth tag-pubsub tag-r tag-rat tag-rate tag-rds tag-record tag-resource tag-rest tag-ror tag-rov tag-rti tag-running tag-s tag-sam tag-scalability tag-scale tag-sdk tag-server tag-serverless tag-servers tag-shed tag-sms tag-software tag-space tag-sqs tag-sse tag-stage tag-star tag-storage tag-sts tag-support tag-sync tag-tag tag-target tag-tea tag-team tag-tech tag-ted tag-tor tag-tutorial tag-tutorials tag-ui tag-un tag-uncategorized tag-us tag-ustr tag-war tag-watch tag-web tag-web-app tag-win tag-windows tag-wol tag-work tag-workflow">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2017/06/20/building-loosely-coupled-scalable-c-applications-with-amazon-sqs-and-amazon-sns/" rel="bookmark">Building Loosely Coupled, Scalable, C# Applications with Amazon SQS and Amazon SNS</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2017/06/20/building-loosely-coupled-scalable-c-applications-with-amazon-sqs-and-amazon-sns/" rel="bookmark"><time class="entry-date" datetime="2017-06-20T22:56:00+03:00">2017-06-20</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/tara-van-unen/" rel="author">Tara Van Unen</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Tara Van Unen">Tara Van Unen</a> original <a href="https://aws.amazon.com/blogs/compute/building-loosely-coupled-scalable-c-applications-with-amazon-sqs-and-amazon-sns/">https://aws.amazon.com/blogs/compute/building-loosely-coupled-scalable-c-applications-with-amazon-sqs-and-amazon-sns/</a></p>
<h5>&nbsp;<a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/06/19/Stephen_Liedig.png"><img loading="lazy" class="alignnone size-full wp-image-2371" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/06/19/Stephen_Liedig.png" alt="" width="203" height="160" /></a><br /> Stephen Liedig, Solutions Architect</h5>
<p>&nbsp;</p>
<p>One of the many challenges professional software architects and developers face is how to make cloud-native applications scalable, fault-tolerant, and highly available.</p>
<p>Fundamental to your project success is understanding the importance of making systems highly cohesive and loosely coupled. That means considering the multi-dimensional facets of system coupling to support the distributed nature of the applications that you are building for the cloud.</p>
<p>By that, I mean addressing not only the application-level coupling (managing incoming and outgoing dependencies), but also considering the impacts of of platform, spatial, and temporal coupling of your systems. Platform coupling relates to the interoperability, or lack thereof, of heterogeneous systems components. Spatial coupling deals with managing components at a network topology level or protocol level. Temporal, or runtime coupling, refers to the ability of a component within your system to do any kind of meaningful work while it is performing a synchronous, blocking operation.</p>
<p>The AWS messaging services, <a href="https://aws.amazon.com/sqs/">Amazon SQS</a> and <a href="https://aws.amazon.com/sns/">Amazon SNS</a>, help you deal with these forms of coupling by providing mechanisms for:</p>
<ul>
<li>Reliable, durable, and fault-tolerant delivery of messages between application components</li>
<li>Logical decomposition of systems and increased autonomy of components</li>
<li>Creating unidirectional, non-blocking operations, temporarily decoupling system components at runtime</li>
<li>Decreasing the dependencies that components have on each other through standard communication and network channels</li>
</ul>
<p>Following on the recent topic, <a href="https://aws.amazon.com/blogs/compute/building-scalable-applications-and-microservices-adding-messaging-to-your-toolbox/">Building Scalable Applications and Microservices: Adding Messaging to Your Toolbox</a>, in this post, I look at some of the ways you can introduce SQS and SNS into your architectures to decouple your components, and show how you can implement them using C#.</p>
<h3>Walkthrough</h3>
<p>To illustrate some of these concepts, consider a web application that processes customer orders. As good architects and developers, you have followed best practices and made your application scalable and highly available. Your solution included implementing load balancing, dynamic scaling across multiple Availability Zones, and persisting orders in a Multi-AZ Amazon RDS database instance, as in the following diagram.</p>
<p><img loading="lazy" class="aligncenter wp-image-2373 size-large" title="Order_Processing_Application" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/06/19/WebApplicationDiagram1-1024x552.png" alt="" width="640" height="345" /><br /> In this example, the application is responsible for handling and persisting the order data, as well as dealing with increases in traffic for popular items.</p>
<p>One potential point of vulnerability in the order processing workflow is in saving the order in the database. The business expects that every order has been persisted into the database. However, any potential deadlock, race condition, or network issue could cause the persistence of the order to fail. Then, the order is lost with no recourse to restore the order.</p>
<p>With good logging capability, you may be able to identify when an error occurred and which customer’s order failed. This wouldn’t allow you to “restore” the transaction, and by that stage, your customer is no longer your customer.</p>
<p>As illustrated in the following diagram, introducing an SQS queue helps improve your ordering application. Using the queue isolates the processing logic into its own component and runs it in a separate process from the web application. This, in turn, allows the system to be more resilient to spikes in traffic, while allowing work to be performed only as fast as necessary in order to manage costs.</p>
<p><img loading="lazy" class="aligncenter wp-image-2379 size-large" title="Order_Processing_SQS" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/06/19/CustomOrderQueue-1024x632.png" alt="" width="640" height="395" /><br /> In addition, you now have a mechanism for persisting orders as messages (with the queue acting as a temporary database), and have moved the scope of your transaction with your database further down the stack. In the event of an application exception or transaction failure, this ensures that the order processing can be retired or redirected to the Amazon SQS Dead Letter Queue (DLQ), for re-processing at a later stage. (See the recent post, <a href="https://aws.amazon.com/blogs/compute/using-amazon-sqs-dead-letter-queues-to-control-message-failure/">Using Amazon SQS Dead-Letter Queues to Control Message Failure,</a> for more information on dead-letter queues.)</p>
<h3>Scaling the order processing nodes</h3>
<p>This change allows you now to scale the web application frontend independently from the processing nodes. The frontend application can continue to scale based on metrics such as CPU usage, or the number of requests hitting the load balancer. Processing nodes can scale based on the number of orders in the queue. Here is an example of scale-in and scale-out alarms that you would associate with the scaling policy.</p>
<p><strong class="lang-bash">Scale-out Alarm</strong></p>
<div class="hide-language">
<pre><code class="lang-powershell">aws cloudwatch put-metric-alarm --alarm-name AddCapacityToCustomerOrderQueue --metric-name ApproximateNumberOfMessagesVisible --namespace &quot;AWS/SQS&quot; 
--statistic Average --period 300 --threshold 3 --comparison-operator GreaterThanOrEqualToThreshold --dimensions Name=QueueName,Value=customer-orders
--evaluation-periods 2 --alarm-actions &lt;arn of the scale-out autoscaling policy&gt;
</code></pre>
<p><strong>Scale-in Alarm</strong></p>
</div>
<div class="hide-language">
<div class="hide-language">
<pre><code class="lang-powershell">aws cloudwatch put-metric-alarm --alarm-name RemoveCapacityFromCustomerOrderQueue --metric-name ApproximateNumberOfMessagesVisible --namespace &quot;AWS/SQS&quot; 
 --statistic Average --period 300 --threshold 1 --comparison-operator LessThanOrEqualToThreshold --dimensions Name=QueueName,Value=customer-orders
 --evaluation-periods 2 --alarm-actions &lt;arn of the scale-in autoscaling policy&gt;
</code></pre>
</p></div>
<p>In the above example, use the A<em>pproximateNumberOfMessagesVisible</em> metric to discover the queue length and drive the scaling policy of the Auto Scaling group. Another useful metric is <em>ApproximateAgeOfOldestMessage</em>, when applications have time-sensitive messages and developers need to ensure that messages are processed within a specific time period.</p>
</div>
<h3>Scaling the order processing implementation</h3>
<p>On top of scaling at an infrastructure level using Auto Scaling, make sure to take advantage of the processing power of your <a href="https://aws.amazon.com/ec2">Amazon EC2</a> instances by using as many of the available threads as possible. There are several ways to implement this. In this post, we build a Windows service that uses the <strong>BackgroundWorker</strong> class to process the messages from the queue.</p>
<p>Here’s a closer look at the implementation. In the first section of the consuming application, use a loop to continually poll the queue for new messages, and construct a <strong>ReceiveMessageRequest</strong> variable.</p>
<pre><code class="lang-csharp">public static void PollQueue()
{
    while (_running)
    {
        Task&lt;ReceiveMessageResponse&gt; receiveMessageResponse;

        // Pull messages off the queue
        using (var sqs = new AmazonSQSClient())
        {
            const int maxMessages = 10;  // 1-10

            //Receiving a message
            var receiveMessageRequest = new ReceiveMessageRequest
            {
                // Get URL from Configuration
                QueueUrl = _queueUrl, 
                // The maximum number of messages to return. 
                // Fewer messages might be returned. 
                MaxNumberOfMessages = maxMessages, 
                // A list of attributes that need to be returned with message.
                AttributeNames = new List&lt;string&gt; { &quot;All&quot; },
                // Enable long polling. 
                // Time to wait for message to arrive on queue.
                WaitTimeSeconds = 5 
            };

            receiveMessageResponse = sqs.ReceiveMessageAsync(receiveMessageRequest);
        }
</code></pre>
<p>The<strong> WaitTimeSeconds</strong> property of the <strong>ReceiveMessageRequest</strong> specifies the duration (in seconds) that the call waits for a message to arrive in the queue before returning a response to the calling application. There are a few benefits to using long polling:</p>
<ul>
<li>It reduces the number of empty responses by allowing SQS to wait until a message is available in the queue before sending a response.</li>
<li>It eliminates false empty responses by querying all (rather than a limited number) of the servers.</li>
<li>It returns messages as soon any message becomes available.</li>
</ul>
<p>For more information, see <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-long-polling.html">Amazon SQS Long Polling</a>.</p>
<p>After you have returned messages from the queue, you can start to process them by looping through each message in the response and invoking a new <strong>BackgroundWorker</strong> thread.</p>
<pre><code class="lang-csharp">// Process messages
if (receiveMessageResponse.Result.Messages != null)
{
    foreach (var message in receiveMessageResponse.Result.Messages)
    {
        Console.WriteLine(&quot;Received SQS message, starting worker thread&quot;);

        // Create background worker to process message
        BackgroundWorker worker = new BackgroundWorker();
        worker.DoWork += (obj, e) =&gt; ProcessMessage(message);
        worker.RunWorkerAsync();
    }
}
else
{
    Console.WriteLine(&quot;No messages on queue&quot;);
}
</code></pre>
<p>The event handler, <strong>ProcessMessage</strong>, is where you implement business logic for processing orders. It is important to have a good understanding of how long a typical transaction takes so you can set a message <strong>VisibilityTimeout</strong> that is long enough to complete your operation. If order processing takes longer than the specified timeout period, the message becomes visible on the queue. Other nodes may pick it and process the same order twice, leading to unintended consequences.</p>
<h3>Handling Duplicate Messages</h3>
<p>In order to manage duplicate messages, seek to make your processing application idempotent. In mathematics, idempotent describes a function that produces the same result if it is applied to itself:</p>
<p style="text-align: center">f(x) = f(f(x))</p>
<p>No matter how many times you process the same message, the end result is the same (definition from Enterprise Integration Patterns: Designing, Building, and Deploying Messaging Solutions, Hohpe and Wolf, 2004).</p>
<p>There are several strategies you could apply to achieve this:</p>
<ul>
<li>Create messages that have inherent idempotent characteristics. That is, they are non-transactional in nature and are unique at a specified point in time. Rather than saying “place new order for Customer A,” which adds a duplicate order to the customer, use “place order &lt;orderid&gt; on &lt;timestamp&gt; for Customer A,” which creates a single order no matter how often it is persisted.</li>
<li>Deliver your messages via an <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/FIFO-queues.html">Amazon SQS FIFO queue</a>, which provides the benefits of message sequencing, but also mechanisms for content-based deduplication. You can deduplicate using the <strong>MessageDeduplicationId</strong> property on the <strong>SendMessage</strong> request or by enabling content-based deduplication on the queue, which generates a hash for <strong>MessageDeduplicationId</strong>, based on the content of the message, not the attributes.</li>
</ul>
<pre><code class="lang-csharp">var sendMessageRequest = new SendMessageRequest
{
    QueueUrl = _queueUrl,
    MessageBody = JsonConvert.SerializeObject(order),
    MessageGroupId = Guid.NewGuid().ToString(&quot;N&quot;),
    MessageDeduplicationId = Guid.NewGuid().ToString(&quot;N&quot;)
};
</code></pre>
<ul>
<li>If using SQS FIFO queues is not an option, keep a message log of all messages attributes processed for a specified period of time, as an alternative to message deduplication on the receiving end. Verifying the existence of the message in the log before processing the message adds additional computational overhead to your processing. This can be minimized through low latency persistence solutions such as Amazon DynamoDB. Bear in mind that this solution is dependent on the successful, distributed transaction of the message and the message log.</li>
</ul>
<h3>Handling exceptions</h3>
<p>Because of the distributed nature of SQS queues, it does not automatically delete the message. Therefore, you must explicitly delete the message from the queue after processing it, using the message <strong>ReceiptHandle</strong> property (see the following code example).</p>
<p>However, if at any stage you have an exception, avoid handling it as you normally would. The intention is to make sure that the message ends back on the queue, so that you can gracefully deal with intermittent failures. Instead, log the exception to capture diagnostic information, and swallow it.</p>
<p>By not explicitly deleting the message from the queue, you can take advantage of the <strong>VisibilityTimeout</strong> behavior described earlier. Gracefully handle the message processing failure and make the unprocessed message available to other nodes to process.</p>
<p><img loading="lazy" class="aligncenter wp-image-2378 size-large" title="SQS_queue_settings" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/06/19/ConfigureCustomerOrders-1024x732.png" alt="" width="640" height="458" /></p>
<p>In the event that subsequent retries fail, SQS automatically moves the message to the configured DLQ after the configured number of receives has been reached. You can further investigate why the order process failed. Most importantly, the order has not been lost, and your customer is still your customer.</p>
<pre><code class="lang-csharp">private static void ProcessMessage(Message message)
{
    using (var sqs = new AmazonSQSClient())
    {
        try
        {
            Console.WriteLine(&quot;Processing message id: {0}&quot;, message.MessageId);

            // Implement messaging processing here
            // Ensure no downstream resource contention (parallel processing)
            // &lt;your order processing logic in here…&gt;
            Console.WriteLine(&quot;{0} Thread {1}: {2}&quot;, DateTime.Now.ToString(&quot;s&quot;), Thread.CurrentThread.ManagedThreadId, message.MessageId);
            
            // Delete the message off the queue. 
            // Receipt handle is the identifier you must provide 
            // when deleting the message.
            var deleteRequest = new DeleteMessageRequest(_queueName, message.ReceiptHandle);
            sqs.DeleteMessageAsync(deleteRequest);
            Console.WriteLine(&quot;Processed message id: {0}&quot;, message.MessageId);

        }
        catch (Exception ex)
        {
            // Do nothing.
            // Swallow exception, message will return to the queue when 
            // visibility timeout has been exceeded.
            Console.WriteLine(&quot;Could not process message due to error. Exception: {0}&quot;, ex.Message);
        }
    }
}
</code></pre>
<h3>Using SQS to adapt to changing business requirements</h3>
<p>One of the benefits of introducing a message queue is that you can accommodate new business requirements without dramatically affecting your application.</p>
<p>If, for example, the business decided that all orders placed over $5000 are to be handled as a priority, you could introduce a new “priority order” queue. The way the orders are processed does not change. The only significant change to the processing application is to ensure that messages from the “priority order” queue are processed before the “standard order” queue.</p>
<p>The following diagram shows how this logic could be isolated in an “order dispatcher,” whose only purpose is to route order messages to the appropriate queue based on whether the order exceeds $5000. Nothing on the web application or the processing nodes changes other than the target queue to which the order is sent. The rates at which orders are processed can be achieved by modifying the poll rates and scalability settings that I have already discussed.</p>
<p><img loading="lazy" class="aligncenter wp-image-2377 size-large" title="Order_Dispatcher" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/06/19/OrderDispatcher-1024x534.png" alt="" width="640" height="334" /></p>
<h3>Extending the design pattern with Amazon SNS</h3>
<p>Amazon SNS supports reliable publish-subscribe (pub-sub) scenarios and push notifications to known endpoints across a wide variety of protocols. It eliminates the need to periodically check or poll for new information and updates. SNS supports:</p>
<ul>
<li>Reliable storage of messages for immediate or delayed processing</li>
<li>Publish / subscribe – direct, broadcast, targeted “push” messaging</li>
<li>Multiple subscriber protocols</li>
<li>Amazon SQS, HTTP, HTTPS, email, SMS, mobile push, AWS Lambda</li>
</ul>
<p>With these capabilities, you can provide parallel asynchronous processing of orders in the system and extend it to support any number of different business use cases without affecting the production environment. This is commonly referred to as a “fanout” scenario.</p>
<p>Rather than your web application pushing orders to a queue for processing, send a notification via SNS. The SNS messages are sent to a topic and then replicated and pushed to multiple SQS queues and Lambda functions for processing.</p>
<p><img loading="lazy" class="aligncenter wp-image-2376 size-large" title="Order_Dispatcher_Fanout" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/06/19/OrderDispatcher2-1024x718.png" alt="" width="640" height="449" /></p>
<p>As the diagram above shows, you have the development team consuming “live” data as they work on the next version of the processing application, or potentially using the messages to troubleshoot issues in production.</p>
<p>Marketing is consuming all order information, via a Lambda function that has subscribed to the SNS topic, inserting the records into an Amazon Redshift warehouse for analysis.</p>
<p>All of this, of course, is happening without affecting your order processing application.</p>
<h3>Summary</h3>
<p>While I haven’t dived deep into the specifics of each service, I have discussed how these services can be applied at an architectural level to build loosely coupled systems that facilitate multiple business use cases. I’ve also shown you how to use infrastructure and application-level scaling techniques, so you can get the most out of your EC2 instances.</p>
<p>One of the many benefits of using these managed services is how quickly and easily you can implement powerful messaging capabilities in your systems, and lower the capital and operational costs of managing your own messaging middleware.</p>
<p>Using Amazon SQS and Amazon SNS together can provide you with a powerful mechanism for decoupling application components. This should be part of design considerations as you architect for the cloud.</p>
<p>For more information, see the <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/Welcome.html">Amazon SQS Developer Guide</a> and <a href="https://docs.aws.amazon.com/sns/latest/dg/welcome.html">Amazon SNS Developer Guide</a>. You’ll find tutorials on all the concepts covered in this post, and more. To can get started using the AWS console or SDK of your choice visit:</p>
<ul>
<li><a href="https://aws.amazon.com/sqs/getting-started/">Getting Started with Amazon SQS</a></li>
<li><a href="https://aws.amazon.com/sns/getting-started/">Getting Started with Amazon SNS</a></li>
</ul>
<p>Happy messaging!</p>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/ad/" rel="tag">AD</a><a href="https://noise.getoto.net/tag/adi/" rel="tag">ADI</a><a href="https://noise.getoto.net/tag/ads/" rel="tag">ads</a><a href="https://noise.getoto.net/tag/ai/" rel="tag">AI</a><a href="https://noise.getoto.net/tag/ala/" rel="tag">ALA</a><a href="https://noise.getoto.net/tag/alarms/" rel="tag">alarms</a><a href="https://noise.getoto.net/tag/all/" rel="tag">All</a><a href="https://noise.getoto.net/tag/amazon/" rel="tag">amazon</a><a href="https://noise.getoto.net/tag/amazon-dynamodb/" rel="tag">Amazon DynamoDB</a><a href="https://noise.getoto.net/tag/amazon-ec2/" rel="tag">Amazon EC2</a><a href="https://noise.getoto.net/tag/amazon-rds/" rel="tag">Amazon RDS</a><a href="https://noise.getoto.net/tag/amazon-redshift/" rel="tag">Amazon Redshift</a><a href="https://noise.getoto.net/tag/amazon-simple-notification-service/" rel="tag">Amazon Simple Notification Service</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service/" rel="tag">Amazon Simple Queue Service</a><a href="https://noise.getoto.net/tag/amazon-sns/" rel="tag">Amazon SNS</a><a href="https://noise.getoto.net/tag/amazon-sqs/" rel="tag">Amazon SQS</a><a href="https://noise.getoto.net/tag/analysis/" rel="tag">analysis</a><a href="https://noise.getoto.net/tag/app/" rel="tag">app</a><a href="https://noise.getoto.net/tag/apt/" rel="tag">apt</a><a href="https://noise.getoto.net/tag/architecture/" rel="tag">Architecture</a><a href="https://noise.getoto.net/tag/aria/" rel="tag">ARIA</a><a href="https://noise.getoto.net/tag/arm/" rel="tag">ARM</a><a href="https://noise.getoto.net/tag/art/" rel="tag">art</a><a href="https://noise.getoto.net/tag/ati/" rel="tag">ATI</a><a href="https://noise.getoto.net/tag/auto-scaling/" rel="tag">Auto Scaling</a><a href="https://noise.getoto.net/tag/availability/" rel="tag">Availability</a><a href="https://noise.getoto.net/tag/aws/" rel="tag">AWS</a><a href="https://noise.getoto.net/tag/aws-lambda/" rel="tag">AWS Lambda</a><a href="https://noise.getoto.net/tag/bec/" rel="tag">BEC</a><a href="https://noise.getoto.net/tag/behavior/" rel="tag">Behavior</a><a href="https://noise.getoto.net/tag/best-practices/" rel="tag">Best practices</a><a href="https://noise.getoto.net/tag/ble/" rel="tag">ble</a><a href="https://noise.getoto.net/tag/blocking/" rel="tag">blocking</a><a href="https://noise.getoto.net/tag/business/" rel="tag">Business</a><a href="https://noise.getoto.net/tag/c/" rel="tag">C</a><a href="https://noise.getoto.net/tag/cali/" rel="tag">Cali</a><a href="https://noise.getoto.net/tag/cas/" rel="tag">CAS</a><a href="https://noise.getoto.net/tag/case/" rel="tag">Case</a><a href="https://noise.getoto.net/tag/cases/" rel="tag">cases</a><a href="https://noise.getoto.net/tag/challenge/" rel="tag">Challenge</a><a href="https://noise.getoto.net/tag/choice/" rel="tag">Choice</a><a href="https://noise.getoto.net/tag/ci/" rel="tag">ci</a><a href="https://noise.getoto.net/tag/cia/" rel="tag">cia</a><a href="https://noise.getoto.net/tag/cloud/" rel="tag">cloud</a><a href="https://noise.getoto.net/tag/cloud-messaging/" rel="tag">cloud messaging</a><a href="https://noise.getoto.net/tag/cloudwatch/" rel="tag">CloudWatch</a><a href="https://noise.getoto.net/tag/code/" rel="tag">code</a><a href="https://noise.getoto.net/tag/console/" rel="tag">console</a><a href="https://noise.getoto.net/tag/data/" rel="tag">data</a><a href="https://noise.getoto.net/tag/database/" rel="tag">database</a><a href="https://noise.getoto.net/tag/dea/" rel="tag">dea</a><a href="https://noise.getoto.net/tag/decoupling/" rel="tag">decoupling</a><a href="https://noise.getoto.net/tag/dependencies/" rel="tag">Dependencies</a><a href="https://noise.getoto.net/tag/design/" rel="tag">design</a><a href="https://noise.getoto.net/tag/developers/" rel="tag">Developers</a><a href="https://noise.getoto.net/tag/development/" rel="tag">development</a><a href="https://noise.getoto.net/tag/dimension/" rel="tag">dimension</a><a href="https://noise.getoto.net/tag/down/" rel="tag">down</a><a href="https://noise.getoto.net/tag/dp/" rel="tag">dp</a><a href="https://noise.getoto.net/tag/dress/" rel="tag">dress</a><a href="https://noise.getoto.net/tag/dyn/" rel="tag">Dyn</a><a href="https://noise.getoto.net/tag/dynamodb/" rel="tag">DynamoDB</a><a href="https://noise.getoto.net/tag/ec/" rel="tag">ec</a><a href="https://noise.getoto.net/tag/ec2/" rel="tag">EC2</a><a href="https://noise.getoto.net/tag/ec2-instances/" rel="tag">EC2 instances</a><a href="https://noise.getoto.net/tag/ecr/" rel="tag">ECR</a><a href="https://noise.getoto.net/tag/ed/" rel="tag">ed</a><a href="https://noise.getoto.net/tag/email/" rel="tag">email</a><a href="https://noise.getoto.net/tag/enterprise/" rel="tag">Enterprise</a><a href="https://noise.getoto.net/tag/environment/" rel="tag">environment</a><a href="https://noise.getoto.net/tag/et/" rel="tag">et</a><a href="https://noise.getoto.net/tag/eu/" rel="tag">eu</a><a href="https://noise.getoto.net/tag/event/" rel="tag">event</a><a href="https://noise.getoto.net/tag/facets/" rel="tag">facets</a><a href="https://noise.getoto.net/tag/fail/" rel="tag">fail</a><a href="https://noise.getoto.net/tag/fan/" rel="tag">fan</a><a href="https://noise.getoto.net/tag/fm/" rel="tag">fm</a><a href="https://noise.getoto.net/tag/form/" rel="tag">form</a><a href="https://noise.getoto.net/tag/fun/" rel="tag">Fun</a><a href="https://noise.getoto.net/tag/getting-started/" rel="tag">getting started</a><a href="https://noise.getoto.net/tag/go/" rel="tag">Go</a><a href="https://noise.getoto.net/tag/gre/" rel="tag">GRE</a><a href="https://noise.getoto.net/tag/guide/" rel="tag">guide</a><a href="https://noise.getoto.net/tag/hash/" rel="tag">hash</a><a href="https://noise.getoto.net/tag/hat/" rel="tag">HAT</a><a href="https://noise.getoto.net/tag/hp/" rel="tag">hp</a><a href="https://noise.getoto.net/tag/http/" rel="tag">http</a><a href="https://noise.getoto.net/tag/https/" rel="tag">https</a><a href="https://noise.getoto.net/tag/ice/" rel="tag">ICE</a><a href="https://noise.getoto.net/tag/increase/" rel="tag">increase</a><a href="https://noise.getoto.net/tag/infrastructure/" rel="tag">infrastructure</a><a href="https://noise.getoto.net/tag/instances/" rel="tag">instances</a><a href="https://noise.getoto.net/tag/ios/" rel="tag">ios</a><a href="https://noise.getoto.net/tag/ip/" rel="tag">IP</a><a href="https://noise.getoto.net/tag/iq/" rel="tag">iq</a><a href="https://noise.getoto.net/tag/irs/" rel="tag">irs</a><a href="https://noise.getoto.net/tag/isp/" rel="tag">ISP</a><a href="https://noise.getoto.net/tag/iss/" rel="tag">iss</a><a href="https://noise.getoto.net/tag/issue/" rel="tag">issue</a><a href="https://noise.getoto.net/tag/json/" rel="tag">json</a><a href="https://noise.getoto.net/tag/lambda/" rel="tag">lambda</a><a href="https://noise.getoto.net/tag/limit/" rel="tag">limit</a><a href="https://noise.getoto.net/tag/load-balancing/" rel="tag">load balancing</a><a href="https://noise.getoto.net/tag/logging/" rel="tag">logging</a><a href="https://noise.getoto.net/tag/lte/" rel="tag">LTE</a><a href="https://noise.getoto.net/tag/lua/" rel="tag">lua</a><a href="https://noise.getoto.net/tag/mail/" rel="tag">mail</a><a href="https://noise.getoto.net/tag/make/" rel="tag">Make</a><a href="https://noise.getoto.net/tag/making/" rel="tag">making</a><a href="https://noise.getoto.net/tag/mana/" rel="tag">mana</a><a href="https://noise.getoto.net/tag/marketing/" rel="tag">marketing</a><a href="https://noise.getoto.net/tag/math/" rel="tag">math</a><a href="https://noise.getoto.net/tag/media/" rel="tag">media</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/message-topics/" rel="tag">message topics</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a><a href="https://noise.getoto.net/tag/metrics/" rel="tag">metrics</a><a href="https://noise.getoto.net/tag/micros/" rel="tag">MICROS</a><a href="https://noise.getoto.net/tag/microservices/" rel="tag">microservices</a><a href="https://noise.getoto.net/tag/mit/" rel="tag">mit</a><a href="https://noise.getoto.net/tag/mobile/" rel="tag">mobile</a><a href="https://noise.getoto.net/tag/mov/" rel="tag">mov</a><a href="https://noise.getoto.net/tag/move/" rel="tag">move</a><a href="https://noise.getoto.net/tag/mpa/" rel="tag">MPA</a><a href="https://noise.getoto.net/tag/nature/" rel="tag">nature</a><a href="https://noise.getoto.net/tag/ncr/" rel="tag">NCR</a><a href="https://noise.getoto.net/tag/nec/" rel="tag">NEC</a><a href="https://noise.getoto.net/tag/nes/" rel="tag">NES</a><a href="https://noise.getoto.net/tag/network/" rel="tag">Network</a><a href="https://noise.getoto.net/tag/notifications/" rel="tag">notifications</a><a href="https://noise.getoto.net/tag/npr/" rel="tag">NPR</a><a href="https://noise.getoto.net/tag/nsa/" rel="tag">NSA</a><a href="https://noise.getoto.net/tag/nse/" rel="tag">nse</a><a href="https://noise.getoto.net/tag/opera/" rel="tag">opera</a><a href="https://noise.getoto.net/tag/oss/" rel="tag">OSS</a><a href="https://noise.getoto.net/tag/other/" rel="tag">Other</a><a href="https://noise.getoto.net/tag/ous/" rel="tag">OUs</a><a href="https://noise.getoto.net/tag/paris/" rel="tag">paris</a><a href="https://noise.getoto.net/tag/pin/" rel="tag">PIN</a><a href="https://noise.getoto.net/tag/policy/" rel="tag">policy</a><a href="https://noise.getoto.net/tag/position/" rel="tag">Position</a><a href="https://noise.getoto.net/tag/power/" rel="tag">power</a><a href="https://noise.getoto.net/tag/ppl/" rel="tag">PPL</a><a href="https://noise.getoto.net/tag/processing/" rel="tag">Processing</a><a href="https://noise.getoto.net/tag/project/" rel="tag">project</a><a href="https://noise.getoto.net/tag/protocols/" rel="tag">protocols</a><a href="https://noise.getoto.net/tag/proxima/" rel="tag">Proxima</a><a href="https://noise.getoto.net/tag/ps/" rel="tag">ps</a><a href="https://noise.getoto.net/tag/pth/" rel="tag">pth</a><a href="https://noise.getoto.net/tag/pubsub/" rel="tag">pub/sub</a><a href="https://noise.getoto.net/tag/r/" rel="tag">R</a><a href="https://noise.getoto.net/tag/rat/" rel="tag">rat</a><a href="https://noise.getoto.net/tag/rate/" rel="tag">rate</a><a href="https://noise.getoto.net/tag/rds/" rel="tag">RDS</a><a href="https://noise.getoto.net/tag/record/" rel="tag">record</a><a href="https://noise.getoto.net/tag/resource/" rel="tag">Resource</a><a href="https://noise.getoto.net/tag/rest/" rel="tag">rest</a><a href="https://noise.getoto.net/tag/ror/" rel="tag">ror</a><a href="https://noise.getoto.net/tag/rov/" rel="tag">ROV</a><a href="https://noise.getoto.net/tag/rti/" rel="tag">RTI</a><a href="https://noise.getoto.net/tag/running/" rel="tag">running</a><a href="https://noise.getoto.net/tag/s/" rel="tag">S.</a><a href="https://noise.getoto.net/tag/sam/" rel="tag">SAM</a><a href="https://noise.getoto.net/tag/scalability/" rel="tag">scalability</a><a href="https://noise.getoto.net/tag/scale/" rel="tag">Scale</a><a href="https://noise.getoto.net/tag/sdk/" rel="tag">SDK</a><a href="https://noise.getoto.net/tag/server/" rel="tag">server</a><a href="https://noise.getoto.net/tag/serverless/" rel="tag">serverless</a><a href="https://noise.getoto.net/tag/servers/" rel="tag">servers</a><a href="https://noise.getoto.net/tag/shed/" rel="tag">shed</a><a href="https://noise.getoto.net/tag/sms/" rel="tag">sms</a><a href="https://noise.getoto.net/tag/software/" rel="tag">software</a><a href="https://noise.getoto.net/tag/space/" rel="tag">space</a><a href="https://noise.getoto.net/tag/sqs/" rel="tag">sqs</a><a href="https://noise.getoto.net/tag/sse/" rel="tag">SSE</a><a href="https://noise.getoto.net/tag/stage/" rel="tag">stage</a><a href="https://noise.getoto.net/tag/star/" rel="tag">Star</a><a href="https://noise.getoto.net/tag/storage/" rel="tag">storage</a><a href="https://noise.getoto.net/tag/sts/" rel="tag">sts</a><a href="https://noise.getoto.net/tag/support/" rel="tag">support</a><a href="https://noise.getoto.net/tag/sync/" rel="tag">Sync</a><a href="https://noise.getoto.net/tag/tag/" rel="tag">TAG</a><a href="https://noise.getoto.net/tag/target/" rel="tag">target</a><a href="https://noise.getoto.net/tag/tea/" rel="tag">tea</a><a href="https://noise.getoto.net/tag/team/" rel="tag">team</a><a href="https://noise.getoto.net/tag/tech/" rel="tag">tech</a><a href="https://noise.getoto.net/tag/ted/" rel="tag">ted</a><a href="https://noise.getoto.net/tag/tor/" rel="tag">tor</a><a href="https://noise.getoto.net/tag/tutorial/" rel="tag">Tutorial</a><a href="https://noise.getoto.net/tag/tutorials/" rel="tag">Tutorials</a><a href="https://noise.getoto.net/tag/ui/" rel="tag">UI</a><a href="https://noise.getoto.net/tag/un/" rel="tag">un</a><a href="https://noise.getoto.net/tag/uncategorized/" rel="tag">Uncategorized</a><a href="https://noise.getoto.net/tag/us/" rel="tag">US</a><a href="https://noise.getoto.net/tag/ustr/" rel="tag">USTR</a><a href="https://noise.getoto.net/tag/war/" rel="tag">war</a><a href="https://noise.getoto.net/tag/watch/" rel="tag">watch</a><a href="https://noise.getoto.net/tag/web/" rel="tag">web</a><a href="https://noise.getoto.net/tag/web-app/" rel="tag">Web app</a><a href="https://noise.getoto.net/tag/win/" rel="tag">win</a><a href="https://noise.getoto.net/tag/windows/" rel="tag">windows</a><a href="https://noise.getoto.net/tag/wol/" rel="tag">wol</a><a href="https://noise.getoto.net/tag/work/" rel="tag">Work</a><a href="https://noise.getoto.net/tag/workflow/" rel="tag">workflow</a></span></footer></article>
<article id="post-315417" class="post-315417 post type-post status-publish format-standard hentry tag-ad tag-ai tag-ala tag-all tag-amazon tag-amazon-ec2 tag-amazon-simple-queue-service tag-amazon-simple-queue-service-sqs tag-amazon-sqs tag-app tag-architecture tag-arm tag-art tag-aspect tag-ati tag-aws tag-aws-lambda tag-aws-management-console tag-bec tag-bett tag-ble tag-blocking tag-c tag-cas tag-ci tag-cis tag-cloud tag-cloud-messaging tag-cloudwatch tag-console tag-context tag-data tag-dea tag-decoupling tag-design tag-det tag-down tag-ec tag-ecr tag-ed tag-edge tag-eff tag-et tag-eu tag-fail tag-guide tag-hardware tag-hat tag-hp tag-ice tag-increase tag-ip tag-irs tag-iss tag-issue tag-java tag-lambda tag-light tag-mana tag-message-queues tag-messaging tag-micros tag-microservices tag-monitoring tag-mov tag-move tag-ncr tag-opera tag-oss tag-other tag-ous tag-pir tag-ppl tag-processing tag-ps tag-r tag-rat tag-rate tag-resource tag-resources tag-ror tag-s tag-server tag-serverless tag-sky tag-software tag-sqs tag-sse tag-star tag-storage tag-sts tag-support tag-tag tag-tea tag-ted tag-tor tag-transmission tag-ui tag-un tag-us tag-video tag-war tag-watch tag-win tag-work">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2017/06/07/using-amazon-sqs-dead-letter-queues-to-control-message-failure/" rel="bookmark">Using Amazon SQS Dead-Letter Queues to Control Message Failure</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2017/06/07/using-amazon-sqs-dead-letter-queues-to-control-message-failure/" rel="bookmark"><time class="entry-date" datetime="2017-06-07T23:18:10+03:00">2017-06-07</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/tara-van-unen/" rel="author">Tara Van Unen</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Tara Van Unen">Tara Van Unen</a> original <a href="https://aws.amazon.com/blogs/compute/using-amazon-sqs-dead-letter-queues-to-control-message-failure/">https://aws.amazon.com/blogs/compute/using-amazon-sqs-dead-letter-queues-to-control-message-failure/</a></p>
<h5><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/06/07/headshot.jpg"><img loading="lazy" class="alignnone wp-image-2218 size-thumbnail" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/06/07/headshot-150x150.jpg" alt="" width="150" height="150" /></a><strong><br /> Michael G. Khmelnitsky, Senior Programmer Writer</strong></h5>
<p>&nbsp;</p>
<p>Sometimes, messages can’t be processed because of a variety of possible issues, such as erroneous conditions within the producer or consumer application. For example, if a user places an order within a certain number of minutes of creating an account, the producer might pass a message with an empty string instead of a customer identifier. Occasionally, producers and consumers might fail to interpret aspects of the protocol that they use to communicate, causing message corruption or loss. Also, the consumer’s hardware errors might corrupt message payload. For these reasons, messages that can’t be processed in a timely manner are delivered to a <em>dead-letter queue</em>.</p>
<p>The recent post <a href="https://aws.amazon.com/blogs/compute/building-scalable-applications-and-microservices-adding-messaging-to-your-toolbox/">Building Scalable Applications and Microservices: Adding Messaging to Your Toolbox</a> gives an overview of messaging in the microservice architecture of modern applications. This post explains how and when you should use dead-letter queues to gain better control over message handling in your applications. It also offers some resources for configuring a dead-letter queue in <a href="https://aws.amazon.com/sqs/">Amazon Simple Queue Service (SQS)</a>.</p>
<h3>What are the benefits of dead-letter queues?</h3>
<p>The main task of a dead-letter queue is handling message failure. A dead-letter queue lets you set aside and isolate messages that can’t be processed correctly to determine why their processing didn’t succeed. Setting up a dead-letter queue allows you to do the following:</p>
<ul>
<li>Configure an alarm for any messages delivered to a dead-letter queue.</li>
<li>Examine logs for exceptions that might have caused messages to be delivered to a dead-letter queue.</li>
<li>Analyze the contents of messages delivered to a dead-letter queue to diagnose software or the producer’s or consumer’s hardware issues.</li>
<li>Determine whether you have given your consumer sufficient time to process messages.</li>
</ul>
<h3>How do high-throughput, unordered queues handle message failure?</h3>
<p>High-throughput, unordered queues (sometimes called <em>standard</em> or <em>storage queues</em>) keep processing messages until the expiration of the retention period. This helps ensure continuous processing of messages, which minimizes the chances of your queue being blocked by messages that can’t be processed. It also ensures fast recovery for your queue.</p>
<p>In a system that processes thousands of messages, having a large number of messages that the consumer repeatedly fails to acknowledge and delete might increase costs and place extra load on the hardware. Instead of trying to process failing messages until they expire, it is better to move them to a dead-letter queue after a few processing attempts.</p>
<p><strong>Note:</strong> This queue type often allows a high number of in-flight messages. If the majority of your messages can’t be consumed and aren’t sent to a dead-letter queue, your rate of processing valid messages can slow down. Thus, to maintain the efficiency of your queue, you must ensure that your application handles message processing correctly.</p>
<h3>How do FIFO queues handle message failure?</h3>
<p>FIFO (first-in-first-out) queues (sometimes called <em>service bus queues</em>) help ensure exactly-once processing by consuming messages in sequence from a <em>message group</em>. Thus, although the consumer can continue to retrieve ordered messages from another message group, the first message group remains unavailable until the message blocking the queue is processed successfully.</p>
<p><strong>Note:</strong> This queue type often allows a lower number of in-flight messages. Thus, to help ensure that your FIFO queue doesn’t get blocked by a message, you must ensure that your application handles message processing correctly.</p>
<h3>When should I use a dead-letter queue?</h3>
<ul>
<li><strong>Do</strong> use dead-letter queues with high-throughput, unordered queues. You should always take advantage of dead-letter queues when your applications don’t depend on ordering. Dead-letter queues can help you troubleshoot incorrect message transmission operations. <strong>Note:</strong> Even when you use dead-letter queues, you should continue to monitor your queues and retry sending messages that fail for transient reasons.</li>
<li><strong>Do</strong> use dead-letter queues to decrease the number of messages and to reduce the possibility of exposing your system to <em>poison-pill messages</em> (messages that can be received but can’t be processed).</li>
<li><strong>Don’t</strong> use a dead-letter queue with high-throughput, unordered queues when you want to be able to keep retrying the transmission of a message indefinitely. For example, don’t use a dead-letter queue if your program must wait for a dependent process to become active or available.</li>
<li><strong>Don’t</strong> use a dead-letter queue with a FIFO queue if you don’t want to break the exact order of messages or operations. For example, don’t use a dead-letter queue with instructions in an Edit Decision List (EDL) for a video editing suite, where changing the order of edits changes the context of subsequent edits.</li>
</ul>
<h3>How do I get started with dead-letter queues in Amazon SQS?</h3>
<p>Amazon SQS is a fully managed service that offers reliable, highly scalable hosted queues for exchanging messages between applications or microservices. Amazon SQS moves data between distributed application components and helps you decouple these components. It supports both <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/standard-queues.html">standard queues</a> and <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/FIFO-queues.html">FIFO queues</a>. To configure a queue as a dead-letter queue, you can use the <a href="http://console.aws.amazon.com/sqs/home">AWS Management Console</a> or the Amazon SQS <code class="lang-setqueueattributes">SetQueueAttributes</code> API action.</p>
<p>To get started with dead-letter queues in Amazon SQS, see the following topics in the <em>Amazon SQS Developer Guide</em>:</p>
<ul>
<li><a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/Welcome.html">What is Amazon SQS?</a></li>
<li><a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-dead-letter-queues.html">Using Amazon SQS Dead-Letter Queues</a></li>
<li><a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/MonitorSQSwithCloudWatch.html">Monitoring Amazon SQS Using CloudWatch</a></li>
</ul>
<p>To start working with dead-letter queues programmatically, see the following resources:</p>
<ul>
<li>Java: <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-configure-dead-letter-queue.html#configure-dead-letter-queue-java">Configure a Dead-Letter Queue with the Amazon SQS API</a></li>
<li>Java: <a href="https://aws.amazon.com/blogs/developer/using-amazon-sqs-dead-letter-queues-2/">Using Amazon SQS Dead-Letter Queues</a></li>
<li>C#: <a href="https://aws.amazon.com/blogs/developer/using-amazon-sqs-dead-letter-queues/">Using Amazon SQS Dead-Letter Queues</a></li>
<li>Lambda: <a href="https://aws.amazon.com/blogs/compute/robust-serverless-application-design-with-aws-lambda-dlq/">Robust Serverless Application Design with AWS Lambda Dead-Letter Queues</a></li>
</ul>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/ad/" rel="tag">AD</a><a href="https://noise.getoto.net/tag/ai/" rel="tag">AI</a><a href="https://noise.getoto.net/tag/ala/" rel="tag">ALA</a><a href="https://noise.getoto.net/tag/all/" rel="tag">All</a><a href="https://noise.getoto.net/tag/amazon/" rel="tag">amazon</a><a href="https://noise.getoto.net/tag/amazon-ec2/" rel="tag">Amazon EC2</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service/" rel="tag">Amazon Simple Queue Service</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service-sqs/" rel="tag">Amazon Simple Queue Service (SQS)</a><a href="https://noise.getoto.net/tag/amazon-sqs/" rel="tag">Amazon SQS</a><a href="https://noise.getoto.net/tag/app/" rel="tag">app</a><a href="https://noise.getoto.net/tag/architecture/" rel="tag">Architecture</a><a href="https://noise.getoto.net/tag/arm/" rel="tag">ARM</a><a href="https://noise.getoto.net/tag/art/" rel="tag">art</a><a href="https://noise.getoto.net/tag/aspect/" rel="tag">Aspect</a><a href="https://noise.getoto.net/tag/ati/" rel="tag">ATI</a><a href="https://noise.getoto.net/tag/aws/" rel="tag">AWS</a><a href="https://noise.getoto.net/tag/aws-lambda/" rel="tag">AWS Lambda</a><a href="https://noise.getoto.net/tag/aws-management-console/" rel="tag">AWS Management Console</a><a href="https://noise.getoto.net/tag/bec/" rel="tag">BEC</a><a href="https://noise.getoto.net/tag/bett/" rel="tag">BETT</a><a href="https://noise.getoto.net/tag/ble/" rel="tag">ble</a><a href="https://noise.getoto.net/tag/blocking/" rel="tag">blocking</a><a href="https://noise.getoto.net/tag/c/" rel="tag">C</a><a href="https://noise.getoto.net/tag/cas/" rel="tag">CAS</a><a href="https://noise.getoto.net/tag/ci/" rel="tag">ci</a><a href="https://noise.getoto.net/tag/cis/" rel="tag">CIS</a><a href="https://noise.getoto.net/tag/cloud/" rel="tag">cloud</a><a href="https://noise.getoto.net/tag/cloud-messaging/" rel="tag">cloud messaging</a><a href="https://noise.getoto.net/tag/cloudwatch/" rel="tag">CloudWatch</a><a href="https://noise.getoto.net/tag/console/" rel="tag">console</a><a href="https://noise.getoto.net/tag/context/" rel="tag">context</a><a href="https://noise.getoto.net/tag/data/" rel="tag">data</a><a href="https://noise.getoto.net/tag/dea/" rel="tag">dea</a><a href="https://noise.getoto.net/tag/decoupling/" rel="tag">decoupling</a><a href="https://noise.getoto.net/tag/design/" rel="tag">design</a><a href="https://noise.getoto.net/tag/det/" rel="tag">det</a><a href="https://noise.getoto.net/tag/down/" rel="tag">down</a><a href="https://noise.getoto.net/tag/ec/" rel="tag">ec</a><a href="https://noise.getoto.net/tag/ecr/" rel="tag">ECR</a><a href="https://noise.getoto.net/tag/ed/" rel="tag">ed</a><a href="https://noise.getoto.net/tag/edge/" rel="tag">Edge</a><a href="https://noise.getoto.net/tag/eff/" rel="tag">eff</a><a href="https://noise.getoto.net/tag/et/" rel="tag">et</a><a href="https://noise.getoto.net/tag/eu/" rel="tag">eu</a><a href="https://noise.getoto.net/tag/fail/" rel="tag">fail</a><a href="https://noise.getoto.net/tag/guide/" rel="tag">guide</a><a href="https://noise.getoto.net/tag/hardware/" rel="tag">hardware</a><a href="https://noise.getoto.net/tag/hat/" rel="tag">HAT</a><a href="https://noise.getoto.net/tag/hp/" rel="tag">hp</a><a href="https://noise.getoto.net/tag/ice/" rel="tag">ICE</a><a href="https://noise.getoto.net/tag/increase/" rel="tag">increase</a><a href="https://noise.getoto.net/tag/ip/" rel="tag">IP</a><a href="https://noise.getoto.net/tag/irs/" rel="tag">irs</a><a href="https://noise.getoto.net/tag/iss/" rel="tag">iss</a><a href="https://noise.getoto.net/tag/issue/" rel="tag">issue</a><a href="https://noise.getoto.net/tag/java/" rel="tag">java</a><a href="https://noise.getoto.net/tag/lambda/" rel="tag">lambda</a><a href="https://noise.getoto.net/tag/light/" rel="tag">light</a><a href="https://noise.getoto.net/tag/mana/" rel="tag">mana</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a><a href="https://noise.getoto.net/tag/micros/" rel="tag">MICROS</a><a href="https://noise.getoto.net/tag/microservices/" rel="tag">microservices</a><a href="https://noise.getoto.net/tag/monitoring/" rel="tag">monitoring</a><a href="https://noise.getoto.net/tag/mov/" rel="tag">mov</a><a href="https://noise.getoto.net/tag/move/" rel="tag">move</a><a href="https://noise.getoto.net/tag/ncr/" rel="tag">NCR</a><a href="https://noise.getoto.net/tag/opera/" rel="tag">opera</a><a href="https://noise.getoto.net/tag/oss/" rel="tag">OSS</a><a href="https://noise.getoto.net/tag/other/" rel="tag">Other</a><a href="https://noise.getoto.net/tag/ous/" rel="tag">OUs</a><a href="https://noise.getoto.net/tag/pir/" rel="tag">PIR</a><a href="https://noise.getoto.net/tag/ppl/" rel="tag">PPL</a><a href="https://noise.getoto.net/tag/processing/" rel="tag">Processing</a><a href="https://noise.getoto.net/tag/ps/" rel="tag">ps</a><a href="https://noise.getoto.net/tag/r/" rel="tag">R</a><a href="https://noise.getoto.net/tag/rat/" rel="tag">rat</a><a href="https://noise.getoto.net/tag/rate/" rel="tag">rate</a><a href="https://noise.getoto.net/tag/resource/" rel="tag">Resource</a><a href="https://noise.getoto.net/tag/resources/" rel="tag">resources</a><a href="https://noise.getoto.net/tag/ror/" rel="tag">ror</a><a href="https://noise.getoto.net/tag/s/" rel="tag">S.</a><a href="https://noise.getoto.net/tag/server/" rel="tag">server</a><a href="https://noise.getoto.net/tag/serverless/" rel="tag">serverless</a><a href="https://noise.getoto.net/tag/sky/" rel="tag">sky</a><a href="https://noise.getoto.net/tag/software/" rel="tag">software</a><a href="https://noise.getoto.net/tag/sqs/" rel="tag">sqs</a><a href="https://noise.getoto.net/tag/sse/" rel="tag">SSE</a><a href="https://noise.getoto.net/tag/star/" rel="tag">Star</a><a href="https://noise.getoto.net/tag/storage/" rel="tag">storage</a><a href="https://noise.getoto.net/tag/sts/" rel="tag">sts</a><a href="https://noise.getoto.net/tag/support/" rel="tag">support</a><a href="https://noise.getoto.net/tag/tag/" rel="tag">TAG</a><a href="https://noise.getoto.net/tag/tea/" rel="tag">tea</a><a href="https://noise.getoto.net/tag/ted/" rel="tag">ted</a><a href="https://noise.getoto.net/tag/tor/" rel="tag">tor</a><a href="https://noise.getoto.net/tag/transmission/" rel="tag">Transmission</a><a href="https://noise.getoto.net/tag/ui/" rel="tag">UI</a><a href="https://noise.getoto.net/tag/un/" rel="tag">un</a><a href="https://noise.getoto.net/tag/us/" rel="tag">US</a><a href="https://noise.getoto.net/tag/video/" rel="tag">video</a><a href="https://noise.getoto.net/tag/war/" rel="tag">war</a><a href="https://noise.getoto.net/tag/watch/" rel="tag">watch</a><a href="https://noise.getoto.net/tag/win/" rel="tag">win</a><a href="https://noise.getoto.net/tag/work/" rel="tag">Work</a></span></footer></article>
<article id="post-314366" class="post-314366 post type-post status-publish format-standard hentry tag-ad tag-adi tag-ads tag-ai tag-ala tag-all tag-amazon tag-amazon-ec2 tag-amazon-ecs tag-amazon-s3 tag-amazon-simple-notification-service tag-amazon-simple-queue-service tag-amazon-simple-queue-service-sqs tag-amazon-sns tag-amazon-sqs tag-app tag-art tag-ati tag-aws-lambda tag-bec tag-bett tag-ble tag-blocking tag-book tag-bp tag-c tag-car tag-cas tag-case tag-cases tag-choice tag-ci tag-cia tag-cloud-messaging tag-code tag-data tag-database tag-databases tag-dea tag-design tag-det tag-developers tag-development tag-down tag-downloads tag-dp tag-dress tag-ebs tag-ec tag-ed tag-edge tag-eff tag-election tag-email tag-enterprise tag-erts tag-et tag-eu tag-fail tag-filtering tag-form tag-fun tag-getting-started tag-gre tag-hat tag-hoc tag-hp tag-http tag-ice tag-ip tag-isp tag-json tag-law tag-limit tag-lte tag-lua tag-mail tag-make tag-mana tag-message-queues tag-message-topics tag-messaging tag-metadata tag-micros tag-microservices tag-mit tag-nec tag-nes tag-notifications tag-nsa tag-nse tag-other tag-ous tag-people tag-ppl tag-problem tag-processing tag-programming tag-protocols tag-pubsub tag-r tag-rat tag-rate tag-rds tag-resources tag-rest tag-rov tag-rti tag-s tag-s3 tag-sam tag-server tag-serverless tag-servers tag-shed tag-software tag-sql tag-sqs tag-sse tag-star tag-storage tag-sts tag-support tag-sync tag-tea tag-tech tag-technology tag-ted tag-today tag-tools tag-tor tag-tracking tag-udp tag-ui tag-un tag-us tag-ustr tag-war tag-web tag-website tag-win tag-work tag-xml">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2017/05/31/building-scalable-applications-and-microservices-adding-messaging-to-your-toolbox/" rel="bookmark">Building Scalable Applications and Microservices: Adding Messaging to Your Toolbox</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2017/05/31/building-scalable-applications-and-microservices-adding-messaging-to-your-toolbox/" rel="bookmark"><time class="entry-date" datetime="2017-05-31T21:13:18+03:00">2017-05-31</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/tara-van-unen/" rel="author">Tara Van Unen</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Tara Van Unen">Tara Van Unen</a> original <a href="https://aws.amazon.com/blogs/compute/building-scalable-applications-and-microservices-adding-messaging-to-your-toolbox/">https://aws.amazon.com/blogs/compute/building-scalable-applications-and-microservices-adding-messaging-to-your-toolbox/</a></p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/05/24/Jakub.jpeg"><img loading="lazy" class="alignnone size-full wp-image-2082" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/05/24/Jakub.jpeg" alt="" width="119" height="160" /></a></p>
<p><strong>Jakub Wojciak, Senior Software Development Engineer</strong></p>
<p>Throughout our careers, we developers keep adding new tools to our development toolboxes. These range from the programming languages we learn, use, and become experts in, to architectural components such as HTTP servers, load balancers, and databases (both relational and NoSQL).</p>
<p>I’d like to kick off a series of posts to introduce you to the architectural components of messaging solutions. Expand your toolbox with this indispensable tool for building modern, scalable services and applications. In the coming months, I will update this post with links that dive deeper into each topic and illustrate messaging use cases using <a href="https://aws.amazon.com/sqs/">Amazon Simple Queue Service (SQS)</a> and<a href="https://aws.amazon.com/sns/"> Amazon Simple Notification Service (SNS)</a>.</p>
<p><strong>What is messaging?</strong><br /> Messaging involves passing messages around, but it’s different from email or text messages, because it is intended for communication between software components, not between people. Enterprise messaging happens at a higher level than that of UDP packets or direct TCP connections (although it does frequently use these protocols).</p>
<p>A message typically contains the payload — whatever information your application sends: XML, JSON, binary data, and so on. You can also add optional attributes and metadata to a message.</p>
<p>A SQL or NoSQL database often has a server that stores data. Similarly, a messaging server or service allows a place for your messages to be stored temporarily and transmitted.</p>
<p><strong>The queue and the topic</strong><br /> For a database service, the main resource is a table. In a messaging service, the two main resources are the queue and the topic.</p>
<p>A queue is like a buffer. You can put messages into a queue, and you can retrieve messages from a queue. The software that puts messages into a queue is called a message producer and the software that retrieves messages is called a message consumer.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/05/24/MessageQueueDiagramFINAL.png"><img loading="lazy" class="size-full wp-image-2080 aligncenter" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/05/24/MessageQueueDiagramFINAL.png" alt="" width="950" height="396" /></a></p>
<p>A topic is like a broadcasting station. You can publish messages to a topic, and anyone interested in these messages can subscribe to the topic. Then, the interested parties are notified about the published messages. The software that broadcasts topics is called a topic publisher and the software that subscribes to broadcasts is called a topic subscriber.</p>
<p><a href="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/05/24/MessageTopicDiagramFINAL.png"><img loading="lazy" class="size-full wp-image-2079 aligncenter" src="https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/05/24/MessageTopicDiagramFINAL.png" alt="" width="694" height="390" /></a><strong>When should you use messaging?</strong><br /> There are some common use cases that might instantly make you think “I should use messaging for that!” Here are some of these use cases (to be discussed in greater detail in future posts).</p>
<ul>
<li><strong>Service-to-service communication</strong><br /> You have two services or systems that need to communicate with each other. Let’s say a website (the frontend) has to update customer’s delivery address in a customer relationship management (CRM) system (the backend). Alternatively, you can set up a load balancer in front of the backend CRM service and call its API actions directly from the frontend website. You can also set up a queue and have the frontend website code send messages to the queue and have the backend CRM service to consume them.</li>
<li><strong>Asynchronous work item backlogs</strong><br /> You have a service that has to track a backlog of actions to be executed. Let’s say a hotel booking system needs to cancel a booking and this process takes a long time (from a few seconds to a minute). You can execute the cancellation synchronously, but then you risk annoying the customer who has to wait for the webpage to load. You can also track all pending cancellations in your database and keep polling and executing cancellations. Alternatively, you can put a message into a queue and have the same hotel booking system consume messages from that queue and perform asynchronous cancellations.</li>
<li><strong>State change notifications</strong><br /> You have a service that manages some resource and other services that receive updates about changes to those resources. Let’s say an inventory tracking system tracks products stocked in a warehouse. Whenever the stock is sold out, the website must stop offering that product. Whenever the stock is close to being depleted, the purchasing system must place an order for more items. Those systems can keep querying the inventory system to learn about these changes (or even directly examine the database—yuck!). Alternatively, the inventory system can publish notifications about stock changes to a topic and any interested program can subscribe to learn about those changes.</li>
</ul>
<p><strong>When should you not use messaging?</strong><br /> According to the law of the instrument, <a href="https://en.wikipedia.org/wiki/Law_of_the_instrument">“If all you have is a hammer, everything looks like a nail.”</a> In other words, it’s important to know when a particular technology won’t fit well with your use case. For example, you have a relational database that you can store large binary files in… but you probably shouldn’t.</p>
<p>Messaging has its own set of commonly encountered anti-patterns (also to be discussed in greater detail in future posts).</p>
<ul>
<li><strong>Message selection</strong><br /> It’s tempting to have the ability to receive messages selectively from a queue —that match a particular set of attributes, or even match an ad-hoc logical query. For example, a service requests a message with a particular attribute because it contains a response to another message that the service sent out. This can lead to a scenario where there are messages in the queue that no one is polling for and are never consumed. (Note: This problem doesn’t exist for message routing or filtering, which are evaluated when messages are&nbsp;sent&nbsp;to a destination queue or topic.)</li>
<li><strong>Very large messages or files</strong><br /> Most messaging protocols and implementations work best with reasonably sized messages (in the tens or hundreds of KBs). As message sizes grow, it’s best to use a dedicated file (or blob) storage system, such as Amazon S3, and pass a reference to an object in that store in the message itself. A dedicated file (or blob) store typically has much better support for uploading data in chunks with the ability to retry or resume downloads from a particular fragment.</li>
</ul>
<p><strong>Key features of messaging systems</strong><br /> Messaging servers and services offer much more than just produce/consume or publish/subscribe functionality. Thus, although it might seem easy to create your own message passing implementation on top of your own data store, consider all the extra features that a full-fledged messaging service provides. Here’s a list of a few but not—by any means—all messaging features:</p>
<ul>
<li><strong>Push or pull delivery</strong><br /> Most messaging services provide both options for consuming messages. Pull means continuously querying whether the messaging service has any new messages. Push means that the messaging service notifies you when a message is available. The notification about the new message might be a special packet sent over the messaging protocol. It might also be an HTTP call that the messaging service makes to your API endpoint. You can also use long-polling, which combines both push and pull functionality.</li>
<li><strong>Dead letter queues</strong><br /> What can your application do if a queue contains a message that you can’t process? Most messaging services allow you to configure a dead-letter queue for messages that you fail to process a certain number of times. This makes it easy to set them aside for further inspection without blocking the queue processing or spending CPU cycles on a message that can never be consumed successfully.</li>
<li><strong>Delay queues and scheduled messages</strong><br /> What if you want to postpone the processing of a particular message until a specific time? Many messaging services support setting a specific delivery time for a message. If you need to have a common delay for all messages, you can set up a delay queue.</li>
<li><strong>Ordering, priorities, duplicates</strong><br /> Messaging services provide you with a variety of options that affect the delivery of messages:
</p>
<ul>
<li>A choice between ordered delivery with limited maximum throughput or unordered delivery with virtually unlimited throughput</li>
<li>Message priorities, where a higher priority message can skip over other messages in the queue</li>
<li>Transactionality or best-effort acknowledgments of messages</li>
</ul>
</li>
</ul>
<p>When designing your system with messaging in mind, ask yourself the following questions:</p>
<ul>
<li>Do you need to process messages exactly in the order in which they were sent?</li>
<li>Could your application parallelize the workload and process messages out of order?</li>
<li>Do you want your application to consume certain messages at a higher priority than other messages?</li>
<li>What happens if your application fails to process a message midway? Can you handle processing the same message again?</li>
</ul>
<p><strong>How can you get started?</strong></p>
<p>If you have to configure and start a messaging server, it might take an extra effort to start using messaging. Instead, you can start to use message queues and topics today, using Amazon SQS and Amazon SNS. For more information, visit the following resources, and get started creating message queues and topics with just a few API actions:</p>
<ul>
<li><a href="https://aws.amazon.com/sqs/getting-started/">Getting started with Amazon SQS</a></li>
<li><a href="https://aws.amazon.com/sns/getting-started/">Getting started with Amazon SNS</a></li>
</ul>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/ad/" rel="tag">AD</a><a href="https://noise.getoto.net/tag/adi/" rel="tag">ADI</a><a href="https://noise.getoto.net/tag/ads/" rel="tag">ads</a><a href="https://noise.getoto.net/tag/ai/" rel="tag">AI</a><a href="https://noise.getoto.net/tag/ala/" rel="tag">ALA</a><a href="https://noise.getoto.net/tag/all/" rel="tag">All</a><a href="https://noise.getoto.net/tag/amazon/" rel="tag">amazon</a><a href="https://noise.getoto.net/tag/amazon-ec2/" rel="tag">Amazon EC2</a><a href="https://noise.getoto.net/tag/amazon-ecs/" rel="tag">Amazon ECS</a><a href="https://noise.getoto.net/tag/amazon-s3/" rel="tag">Amazon S3</a><a href="https://noise.getoto.net/tag/amazon-simple-notification-service/" rel="tag">Amazon Simple Notification Service</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service/" rel="tag">Amazon Simple Queue Service</a><a href="https://noise.getoto.net/tag/amazon-simple-queue-service-sqs/" rel="tag">Amazon Simple Queue Service (SQS)</a><a href="https://noise.getoto.net/tag/amazon-sns/" rel="tag">Amazon SNS</a><a href="https://noise.getoto.net/tag/amazon-sqs/" rel="tag">Amazon SQS</a><a href="https://noise.getoto.net/tag/app/" rel="tag">app</a><a href="https://noise.getoto.net/tag/art/" rel="tag">art</a><a href="https://noise.getoto.net/tag/ati/" rel="tag">ATI</a><a href="https://noise.getoto.net/tag/aws-lambda/" rel="tag">AWS Lambda</a><a href="https://noise.getoto.net/tag/bec/" rel="tag">BEC</a><a href="https://noise.getoto.net/tag/bett/" rel="tag">BETT</a><a href="https://noise.getoto.net/tag/ble/" rel="tag">ble</a><a href="https://noise.getoto.net/tag/blocking/" rel="tag">blocking</a><a href="https://noise.getoto.net/tag/book/" rel="tag">book</a><a href="https://noise.getoto.net/tag/bp/" rel="tag">BP</a><a href="https://noise.getoto.net/tag/c/" rel="tag">C</a><a href="https://noise.getoto.net/tag/car/" rel="tag">car</a><a href="https://noise.getoto.net/tag/cas/" rel="tag">CAS</a><a href="https://noise.getoto.net/tag/case/" rel="tag">Case</a><a href="https://noise.getoto.net/tag/cases/" rel="tag">cases</a><a href="https://noise.getoto.net/tag/choice/" rel="tag">Choice</a><a href="https://noise.getoto.net/tag/ci/" rel="tag">ci</a><a href="https://noise.getoto.net/tag/cia/" rel="tag">cia</a><a href="https://noise.getoto.net/tag/cloud-messaging/" rel="tag">cloud messaging</a><a href="https://noise.getoto.net/tag/code/" rel="tag">code</a><a href="https://noise.getoto.net/tag/data/" rel="tag">data</a><a href="https://noise.getoto.net/tag/database/" rel="tag">database</a><a href="https://noise.getoto.net/tag/databases/" rel="tag">databases</a><a href="https://noise.getoto.net/tag/dea/" rel="tag">dea</a><a href="https://noise.getoto.net/tag/design/" rel="tag">design</a><a href="https://noise.getoto.net/tag/det/" rel="tag">det</a><a href="https://noise.getoto.net/tag/developers/" rel="tag">Developers</a><a href="https://noise.getoto.net/tag/development/" rel="tag">development</a><a href="https://noise.getoto.net/tag/down/" rel="tag">down</a><a href="https://noise.getoto.net/tag/downloads/" rel="tag">downloads</a><a href="https://noise.getoto.net/tag/dp/" rel="tag">dp</a><a href="https://noise.getoto.net/tag/dress/" rel="tag">dress</a><a href="https://noise.getoto.net/tag/ebs/" rel="tag">ebs</a><a href="https://noise.getoto.net/tag/ec/" rel="tag">ec</a><a href="https://noise.getoto.net/tag/ed/" rel="tag">ed</a><a href="https://noise.getoto.net/tag/edge/" rel="tag">Edge</a><a href="https://noise.getoto.net/tag/eff/" rel="tag">eff</a><a href="https://noise.getoto.net/tag/election/" rel="tag">election</a><a href="https://noise.getoto.net/tag/email/" rel="tag">email</a><a href="https://noise.getoto.net/tag/enterprise/" rel="tag">Enterprise</a><a href="https://noise.getoto.net/tag/erts/" rel="tag">erts</a><a href="https://noise.getoto.net/tag/et/" rel="tag">et</a><a href="https://noise.getoto.net/tag/eu/" rel="tag">eu</a><a href="https://noise.getoto.net/tag/fail/" rel="tag">fail</a><a href="https://noise.getoto.net/tag/filtering/" rel="tag">filtering</a><a href="https://noise.getoto.net/tag/form/" rel="tag">form</a><a href="https://noise.getoto.net/tag/fun/" rel="tag">Fun</a><a href="https://noise.getoto.net/tag/getting-started/" rel="tag">getting started</a><a href="https://noise.getoto.net/tag/gre/" rel="tag">GRE</a><a href="https://noise.getoto.net/tag/hat/" rel="tag">HAT</a><a href="https://noise.getoto.net/tag/hoc/" rel="tag">HoC</a><a href="https://noise.getoto.net/tag/hp/" rel="tag">hp</a><a href="https://noise.getoto.net/tag/http/" rel="tag">http</a><a href="https://noise.getoto.net/tag/ice/" rel="tag">ICE</a><a href="https://noise.getoto.net/tag/ip/" rel="tag">IP</a><a href="https://noise.getoto.net/tag/isp/" rel="tag">ISP</a><a href="https://noise.getoto.net/tag/json/" rel="tag">json</a><a href="https://noise.getoto.net/tag/law/" rel="tag">Law</a><a href="https://noise.getoto.net/tag/limit/" rel="tag">limit</a><a href="https://noise.getoto.net/tag/lte/" rel="tag">LTE</a><a href="https://noise.getoto.net/tag/lua/" rel="tag">lua</a><a href="https://noise.getoto.net/tag/mail/" rel="tag">mail</a><a href="https://noise.getoto.net/tag/make/" rel="tag">Make</a><a href="https://noise.getoto.net/tag/mana/" rel="tag">mana</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/message-topics/" rel="tag">message topics</a><a href="https://noise.getoto.net/tag/messaging/" rel="tag">messaging</a><a href="https://noise.getoto.net/tag/metadata/" rel="tag">metadata</a><a href="https://noise.getoto.net/tag/micros/" rel="tag">MICROS</a><a href="https://noise.getoto.net/tag/microservices/" rel="tag">microservices</a><a href="https://noise.getoto.net/tag/mit/" rel="tag">mit</a><a href="https://noise.getoto.net/tag/nec/" rel="tag">NEC</a><a href="https://noise.getoto.net/tag/nes/" rel="tag">NES</a><a href="https://noise.getoto.net/tag/notifications/" rel="tag">notifications</a><a href="https://noise.getoto.net/tag/nsa/" rel="tag">NSA</a><a href="https://noise.getoto.net/tag/nse/" rel="tag">nse</a><a href="https://noise.getoto.net/tag/other/" rel="tag">Other</a><a href="https://noise.getoto.net/tag/ous/" rel="tag">OUs</a><a href="https://noise.getoto.net/tag/people/" rel="tag">people</a><a href="https://noise.getoto.net/tag/ppl/" rel="tag">PPL</a><a href="https://noise.getoto.net/tag/problem/" rel="tag">problem</a><a href="https://noise.getoto.net/tag/processing/" rel="tag">Processing</a><a href="https://noise.getoto.net/tag/programming/" rel="tag">programming</a><a href="https://noise.getoto.net/tag/protocols/" rel="tag">protocols</a><a href="https://noise.getoto.net/tag/pubsub/" rel="tag">pub/sub</a><a href="https://noise.getoto.net/tag/r/" rel="tag">R</a><a href="https://noise.getoto.net/tag/rat/" rel="tag">rat</a><a href="https://noise.getoto.net/tag/rate/" rel="tag">rate</a><a href="https://noise.getoto.net/tag/rds/" rel="tag">RDS</a><a href="https://noise.getoto.net/tag/resources/" rel="tag">resources</a><a href="https://noise.getoto.net/tag/rest/" rel="tag">rest</a><a href="https://noise.getoto.net/tag/rov/" rel="tag">ROV</a><a href="https://noise.getoto.net/tag/rti/" rel="tag">RTI</a><a href="https://noise.getoto.net/tag/s/" rel="tag">S.</a><a href="https://noise.getoto.net/tag/s3/" rel="tag">S3</a><a href="https://noise.getoto.net/tag/sam/" rel="tag">SAM</a><a href="https://noise.getoto.net/tag/server/" rel="tag">server</a><a href="https://noise.getoto.net/tag/serverless/" rel="tag">serverless</a><a href="https://noise.getoto.net/tag/servers/" rel="tag">servers</a><a href="https://noise.getoto.net/tag/shed/" rel="tag">shed</a><a href="https://noise.getoto.net/tag/software/" rel="tag">software</a><a href="https://noise.getoto.net/tag/sql/" rel="tag">sql</a><a href="https://noise.getoto.net/tag/sqs/" rel="tag">sqs</a><a href="https://noise.getoto.net/tag/sse/" rel="tag">SSE</a><a href="https://noise.getoto.net/tag/star/" rel="tag">Star</a><a href="https://noise.getoto.net/tag/storage/" rel="tag">storage</a><a href="https://noise.getoto.net/tag/sts/" rel="tag">sts</a><a href="https://noise.getoto.net/tag/support/" rel="tag">support</a><a href="https://noise.getoto.net/tag/sync/" rel="tag">Sync</a><a href="https://noise.getoto.net/tag/tea/" rel="tag">tea</a><a href="https://noise.getoto.net/tag/tech/" rel="tag">tech</a><a href="https://noise.getoto.net/tag/technology/" rel="tag">Technology</a><a href="https://noise.getoto.net/tag/ted/" rel="tag">ted</a><a href="https://noise.getoto.net/tag/today/" rel="tag">Today</a><a href="https://noise.getoto.net/tag/tools/" rel="tag">Tools</a><a href="https://noise.getoto.net/tag/tor/" rel="tag">tor</a><a href="https://noise.getoto.net/tag/tracking/" rel="tag">tracking</a><a href="https://noise.getoto.net/tag/udp/" rel="tag">udp</a><a href="https://noise.getoto.net/tag/ui/" rel="tag">UI</a><a href="https://noise.getoto.net/tag/un/" rel="tag">un</a><a href="https://noise.getoto.net/tag/us/" rel="tag">US</a><a href="https://noise.getoto.net/tag/ustr/" rel="tag">USTR</a><a href="https://noise.getoto.net/tag/war/" rel="tag">war</a><a href="https://noise.getoto.net/tag/web/" rel="tag">web</a><a href="https://noise.getoto.net/tag/website/" rel="tag">website</a><a href="https://noise.getoto.net/tag/win/" rel="tag">win</a><a href="https://noise.getoto.net/tag/work/" rel="tag">Work</a><a href="https://noise.getoto.net/tag/xml/" rel="tag">xml</a></span></footer></article>
<article id="post-320975" class="post-320975 post type-post status-publish format-standard hentry tag-acls tag-ad tag-adi tag-ads tag-ai tag-ala tag-all tag-app tag-aria tag-art tag-ati tag-ats tag-availability tag-basic tag-bett tag-bing tag-ble tag-blog tag-bug tag-bugs tag-c tag-cas tag-case tag-cases tag-choice tag-ci tag-cia tag-cli tag-clock tag-code tag-console tag-containers tag-controller tag-curity tag-data tag-dependencies tag-desktop tag-det tag-directories tag-document tag-down tag-dyn tag-ec tag-ed tag-embedded tag-environment tag-eset tag-et tag-eu tag-fail tag-fedora tag-file-systems tag-fm tag-form tag-fun tag-general tag-git tag-go tag-got tag-gre tag-groups tag-hardware tag-hat tag-ice tag-inside tag-install tag-integrit tag-ip tag-irs tag-iss tag-iste tag-kernel tag-kit tag-kms tag-library tag-limit tag-linux tag-location tag-mac tag-make tag-making tag-mana tag-media tag-message-queues tag-mit tag-mou tag-mov tag-move tag-mpa tag-nec tag-nes tag-network tag-nist tag-nse tag-opera tag-operating-systems tag-other tag-ous tag-pc tag-people tag-pin tag-plugin tag-policies tag-policy tag-power tag-ppl tag-problem tag-project tag-ps tag-r tag-rat tag-rate tag-rds tag-remote tag-resource tag-rest tag-risks tag-rti tag-running tag-s tag-sam tag-security tag-server tag-servers tag-setup tag-shed tag-shell-script tag-software tag-space tag-sse tag-star tag-status tag-storage tag-sts tag-support tag-sync tag-talk tag-target tag-tdo tag-tea tag-tech tag-technology tag-ted tag-test tag-tested tag-testing tag-things tag-tools tag-tor tag-touch tag-ui tag-un tag-updated tag-us tag-ux tag-variables tag-war tag-watch tag-work">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2012/04/21/systemd-status-update-5/" rel="bookmark">systemd Status Update</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2012/04/21/systemd-status-update-5/" rel="bookmark"><time class="entry-date" datetime="2012-04-21T01:17:00+03:00">2012-04-21</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/lennart-poettering/" rel="author">Lennart Poettering</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Lennart Poettering">Lennart Poettering</a> original <a href="http://0pointer.net/blog/projects/systemd-update-3.html">http://0pointer.net/blog/projects/systemd-update-3.html</a></p>
<p><a href="http://0pointer.de/blog/projects/systemd-update-2.html">It<br />
has been way too long since my last status update on<br />
systemd</a>. Here&#8217;s another short, incomprehensive status update on<br />
what we worked on for <a href="https://freedesktop.org/wiki/Software/systemd">systemd</a> since<br />
then.</p>
<p>We have been working hard to turn systemd into the most viable set<br />
of components to build operating systems, appliances and devices from,<br />
and make it the best choice for servers, for desktops and for embedded<br />
environments alike. I think we have a really convincing set of<br />
features now, but we are actively working on making it even<br />
better.</p>
<p>Here&#8217;s a list of some more and some less interesting features, in<br />
no particular order:</p>
<ol>
<li>We added an automatic pager to <tt>systemctl</tt> (and related tools), similar<br />
to how <tt>git</tt> has it.</li>
<li><tt>systemctl</tt> learnt a new switch <tt>--failed</tt>, to show only<br />
failed services.</li>
<li>You may now start services immediately, overrding all dependency<br />
logic by passing <tt>--ignore-dependencies</tt> to<br />
<tt>systemctl</tt>. This is mostly a debugging tool and nothing people<br />
should use in real life.</li>
<li>Sending <tt>SIGKILL</tt> as final part of the implicit shutdown<br />
logic of services is now optional and may be configured with the<br />
<tt>SendSIGKILL=</tt> option individually for each service.</li>
<li>We split off the Vala/Gtk tools into its own project <tt>systemd-ui</tt>.</li>
<li><tt>systemd-tmpfiles</tt> learnt file globbing and creating FIFO<br />
special files as well as character and block device nodes, and<br />
symlinks. It also is capable of relabelling certain directories at<br />
boot now (in the SELinux sense).</li>
<li>Immediately before shuttding dow we will now invoke all binaries<br />
found in <tt>/lib/systemd/system-shutdown/</tt>, which is useful for<br />
debugging late shutdown.</li>
<li>You may now globally control where STDOUT/STDERR of services goes<br />
(unless individual service configuration overrides it).</li>
<li>There&#8217;s a new <tt>ConditionVirtualization=</tt> option, that makes<br />
systemd skip a specific service if a certain virtualization technology<br />
is found or not found. Similar, we now have a new option to detect<br />
whether a certain security technology (such as SELinux) is available,<br />
called <tt>ConditionSecurity=</tt>. There&#8217;s also<br />
<tt>ConditionCapability=</tt> to check whether a certain process<br />
capability is in the capability bounding set of the system. There&#8217;s<br />
also a new <tt>ConditionFileIsExecutable=</tt>,<br />
<tt>ConditionPathIsMountPoint=</tt>,<br />
<tt>ConditionPathIsReadWrite=</tt>,<br />
<tt>ConditionPathIsSymbolicLink=</tt>.</li>
<li>The file system condition directives now support globbing.</li>
<li>Service conditions may now be &#8220;triggering&#8221; and &#8220;mandatory&#8221;, meaning that<br />
they can be a necessary requirement to hold for a service to start, or<br />
simply one trigger among many.</li>
<li>At boot time we now print warnings if: <a href="https://freedesktop.org/wiki/Software/systemd/separate-usr-is-broken"><tt>/usr</tt><br />
is on a split-off partition but not already mounted by an initrd</a>;<br />
if <tt>/etc/mtab</tt> is not a symlink to <tt>/proc/mounts</tt>; <a href="http://0pointer.de/blog/projects/cgroups-vs-cgroups.html">CONFIG_CGROUPS<br />
is not enabled in the kernel</a>. We&#8217;ll also expose this as<br />
<i>tainted</i> flag on the bus.</li>
<li>You may now boot the same OS image on a bare metal machine and in<br />
Linux namespace containers and will get a clean boot in both<br />
cases. This is more complicated than it sounds since device management<br />
with udev or write access to <tt>/sys</tt>, <tt>/proc/sys</tt> or<br />
things like <tt>/dev/kmsg</tt> is not available in a container. This<br />
makes systemd a first-class choice for managing thin container<br />
setups. This is all tested with systemd&#8217;s own <tt>systemd-nspawn</tt><br />
tool but should work fine in LXC setups, too. Basically this means<br />
that you do not have to adjust your OS manually to make it work in a<br />
container environment, but will just work out of the box. It also<br />
makes it easier to convert real systems into containers.</li>
<li>We now automatically spawn gettys on HVC ttys when booting in VMs.</li>
<li>We introduced <tt>/etc/machine-id</tt> as a generalization of<br />
D-Bus machine ID logic. See <a href="http://0pointer.de/blog/projects/the-new-configuration-files.html">this<br />
blog story for more information</a>. On stateless/read-only systems<br />
the machine ID is initialized randomly at boot. In virtualized<br />
environments it may be passed in from the machine manager (with qemu&#8217;s<br />
<tt>-uuid</tt> switch, or via the <a href="https://www.freedesktop.org/wiki/Software/systemd/ContainerInterface">container<br />
interface</a>).</li>
<li>All of the systemd-specific <tt>/etc/fstab</tt> mount options are<br />
now in the <tt>x-systemd-<i>xyz</i></tt> format.</li>
<li>To make it easy to find non-converted services we will now<br />
implicitly prefix all LSB and SysV init script descriptions with the<br />
strings &#8220;<tt>LSB:</tt>&#8221; resp. &#8220;<tt>SYSV:</tt>&#8220;.</li>
<li>We introduced <tt>/run</tt> and made it a hard dependency of<br />
systemd. This directory is now widely accepted and implemented on all<br />
relevant Linux distributions.</li>
<li>systemctl can now execute all its operations remotely too (<tt>-H</tt> switch).</li>
<li>We now ship <a href="http://0pointer.de/blog/projects/changing-roots.html">systemd-nspawn</a>,<br />
a really powerful tool that can be used to start containers for<br />
debugging, building and testing, much like chroot(1). It is useful to<br />
just get a shell inside a build tree, but is good enough to boot up a<br />
full system in it, too.</li>
<li>If we query the user for a hard disk password at boot he may hit<br />
TAB to hide the asterisks we normally show for each key that is<br />
entered, for extra paranoia.</li>
<li>We don&#8217;t enable <tt>udev-settle.service</tt> anymore, which is<br />
only required for certain legacy software that still hasn&#8217;t been<br />
updated to follow devices coming and going cleanly.</li>
<li>We now include a tool that can plot boot speed graphs, similar to<br />
bootchartd, called <a href="http://0pointer.de/blog/projects/blame-game.html"><tt>systemd-analyze</tt></a>.</li>
<li>At boot, we now initialize the kernel&#8217;s <tt>binfmt_misc</tt> logic with the data from <tt>/etc/binfmt.d</tt>.</li>
<li><tt>systemctl</tt> now recognizes if it is run in a <tt>chroot()</tt><br />
environment and will work accordingly (i.e. apply changes to the tree<br />
it is run in, instead of talking to the actual PID 1 for this). It also has a new <tt>--root=</tt> switch to work on an OS tree from outside of it.</li>
<li>There&#8217;s a new unit dependency type <tt>OnFailureIsolate=</tt> that<br />
allows entering a different target whenever a certain unit fails. For<br />
example, this is interesting to enter emergency mode if file system<br />
checks of crucial file systems failed.</li>
<li>Socket units may now listen on Netlink sockets, special files<br />
from <tt>/proc</tt> and POSIX message queues, too.</li>
<li>There&#8217;s a new <tt>IgnoreOnIsolate=</tt> flag which may be used to<br />
ensure certain units are left untouched by isolation requests. There&#8217;s<br />
a new <tt>IgnoreOnSnapshot=</tt> flag which may be used to exclude<br />
certain units from snapshot units when they are created.</li>
<li>There&#8217;s now small mechanism services <a href="https://www.freedesktop.org/wiki/Software/systemd/hostnamed">for<br />
changing the local hostname and other host meta data</a>, <a href="https://www.freedesktop.org/wiki/Software/systemd/localed">changing<br />
the system locale and console settings</a> and the <a href="https://www.freedesktop.org/wiki/Software/systemd/timedated">system<br />
clock</a>.</li>
<li>We now limit the capability bounding set for a number of our<br />
internal services by default.</li>
<li>Plymouth may now be disabled globally with<br />
<tt>plymouth.enable=0</tt> on the kernel command line.</li>
<li>We now disallocate VTs when a getty finished running (and<br />
optionally other tools run on VTs). This adds extra security since it<br />
clears up the scrollback buffer so that subsequent users cannot get<br />
access to a user&#8217;s session output.</li>
<li>In socket units there are now options to control the<br />
<tt>IP_TRANSPARENT</tt>, <tt>SO_BROADCAST</tt>, <tt>SO_PASSCRED</tt>,<br />
<tt>SO_PASSSEC</tt> socket options.</li>
<li>The receive and send buffers of socket units may now be set larger<br />
than the default system settings if needed by using<br />
SO_{RCV,SND}BUFFORCE.</li>
<li>We now set the hardware timezone as one of the first things in PID<br />
1, in order to avoid time jumps during normal userspace operation, and<br />
to guarantee sensible times on all generated logs. We also no longer<br />
save the system clock to the RTC on shutdown, assuming that this is<br />
done by the clock control tool when the user modifies the time, or<br />
automatically by the kernel if NTP is enabled.</li>
<li>The SELinux directory got moved from <tt>/selinux</tt> to<br />
<tt>/sys/fs/selinux</tt>.</li>
<li>We added a small service <tt>systemd-logind</tt> that keeps tracks<br />
of logged in users and their sessions. It creates control groups for<br />
them, implements the <a href="https://standards.freedesktop.org/basedir-spec/basedir-spec-latest.html">XDG_RUNTIME_DIR<br />
specification</a> for them, maintains seats and device node ACLs and<br />
implements shutdown/idle inhibiting for clients. It auto-spawns gettys<br />
on all local VTs when the user switches to them (instead of starting<br />
six of them unconditionally), thus reducing the resource foot print by<br />
default. It has a D-Bus interface as well as <a href="https://www.freedesktop.org/software/systemd/man/sd-login.html">a<br />
simple synchronous library interface</a>. This mechanism obsoletes<br />
ConsoleKit which is now deprecated and should no longer be used.</li>
<li>There&#8217;s now full, automatic multi-seat support, and this is<br />
enabled in GNOME 3.4. Just by pluging in new seat hardware you get a<br />
new login screen on your seat&#8217;s screen.</li>
<li>There is now an option <tt>ControlGroupModify=</tt> to allow<br />
services to change the properties of their control groups dynamically,<br />
and one to make control groups persistent in the tree<br />
(<tt>ControlGroupPersistent=</tt>) so that they can be created and<br />
maintained by external tools.</li>
<li>We now jump back into the <tt>initrd</tt> in shutdown, so that it can<br />
detach the root file system and the storage devices backing it. This<br />
allows (for the first time!) to reliably undo complex storage setups<br />
on shutdown and leave them in a clean state.</li>
<li><tt>systemctl</tt> now supports <i>presets</i>, a way for distributions and<br />
administrators to define their own policies on whether services should<br />
be enabled or disabled by default on package installation.</li>
<li><tt>systemctl</tt> now has high-level verbs for masking/unmasking<br />
units. There&#8217;s also a new command (<tt>systemctl list-unit-files</tt>)<br />
for determining the list of all installed unit file files and whether<br />
they are enabled or not.</li>
<li>We now apply <tt>sysctl</tt> variables to each new network device, as it<br />
appears. This makes <tt>/etc/sysctl.d</tt> compatible with hot-plug<br />
network devices.</li>
<li>There&#8217;s limited profiling for SELinux start-up perfomance built<br />
into PID 1.</li>
<li>There&#8217;s a new switch <a href="http://0pointer.de/blog/projects/security.html"><tt>PrivateNetwork=</tt></a><br />
to turn of any network access for a specific service.</li>
<li>Service units may now include configuration for control group<br />
parameters. A few (such as <tt>MemoryLimit=</tt>) are exposed with<br />
high-level options, and all others are available via the generic<br />
<tt>ControlGroupAttribute=</tt> setting.</li>
<li>There&#8217;s now the option to mount certain cgroup controllers<br />
jointly at boot. We do this now for <tt>cpu</tt> and<br />
<tt>cpuacct</tt> by default.</li>
<li>We added <a href="https://docs.google.com/document/pub?id=1IC9yOXj7j6cdLLxWEBAGRL6wl97tFxgjLUEHIX3MSTs">the<br />
journal</a> and turned it on by default.</li>
<li>All service output is now written to the Journal by default,<br />
regardless whether it is sent via syslog or simply written to<br />
stdout/stderr. Both message streams end up in the same location and<br />
are interleaved the way they should. All log messages even from the<br />
kernel and from early boot end up in the journal. Now, no service<br />
output gets unnoticed and is saved and indexed at the same<br />
location.</li>
<li><tt>systemctl status</tt> will now show the last 10 log lines for<br />
each service, directly from the journal.</li>
<li>We now show the progress of <tt>fsck</tt> at boot on the console,<br />
again. We also show the much loved colorful <tt>[ OK ]</tt> status<br />
messages at boot again, as known from most SysV implementations.</li>
<li>We merged udev into systemd.</li>
<li>We implemented and documented interfaces to <a href="https://www.freedesktop.org/wiki/Software/systemd/ContainerInterface">container<br />
managers</a> and <a href="https://www.freedesktop.org/wiki/Software/systemd/InitrdInterface">initrds</a><br />
for passing execution data to systemd. We also implemented and<br />
documented <a href="https://www.freedesktop.org/wiki/Software/systemd/RootStorageDaemons">an<br />
interface for storage daemons that are required to back the root file<br />
system</a>.</li>
<li>There are two new options in service files to propagate reload requests between several units.</li>
<li><tt>systemd-cgls</tt> won&#8217;t show kernel threads by default anymore, or show empty control groups.</li>
<li>We added a new tool <tt>systemd-cgtop</tt> that shows resource<br />
usage of whole services in a top(1) like fasion.</li>
<li>systemd may now supervise services in watchdog style. If enabled<br />
for a service the daemon daemon has to ping PID 1 in regular intervals<br />
or is otherwise considered failed (which might then result in<br />
restarting it, or even rebooting the machine, as configured). Also,<br />
PID 1 is capable of pinging a hardware watchdog. Putting this<br />
together, the hardware watchdogs PID 1 and PID 1 then watchdogs<br />
specific services. This is highly useful for high-availability servers<br />
as well as embedded machines. Since watchdog hardware is noawadays<br />
built into all modern chipsets (including desktop chipsets), this<br />
should hopefully help to make this a more widely used<br />
functionality.</li>
<li>We added support for a new kernel command line option<br />
<tt>systemd.setenv=</tt> to set an environment variable<br />
system-wide.</li>
<li>By default services which are started by systemd will have SIGPIPE<br />
set to ignored. The Unix SIGPIPE logic is used to reliably implement<br />
shell pipelines and when left enabled in services is usually just a<br />
source of bugs and problems.</li>
<li>You may now configure the rate limiting that is applied to<br />
restarts of specific services. Previously the rate limiting parameters<br />
were hard-coded (similar to SysV).</li>
<li>There&#8217;s now support for loading the IMA integrity policy into the<br />
kernel early in PID 1, similar to how we already did it with the<br />
SELinux policy.</li>
<li>There&#8217;s now an official API to schedule and query scheduled shutdowns.</li>
<li>We changed the license from GPL2+ to LGPL2.1+.</li>
<li>We made <a href="https://www.freedesktop.org/software/systemd/man/systemd-detect-virt.html"><tt>systemd-detect-virt</tt></a><br />
an official tool in the tool set. Since we already had code to detect<br />
certain VM and container environments we now added an official tool<br />
for administrators to make use of in shell scripts and suchlike.</li>
<li>We documented <a href="https://www.freedesktop.org/wiki/Software/systemd/InterfacePortabilityAndStabilityChart">numerous<br />
interfaces</a> systemd introduced.</li>
</ol>
<p>Much of the stuff above is already available in Fedora 15 and 16,<br />
or will be made available in the upcoming Fedora 17.</p>
<p>And that&#8217;s it for now. There&#8217;s a lot of other stuff in the git commits, but<br />
most of it is smaller and I will it thus spare you.</p>
<p>I&#8217;d like to thank everybody who contributed to systemd over the past years.</p>
<p>Thanks for your interest!</p>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/acls/" rel="tag">ACLs</a><a href="https://noise.getoto.net/tag/ad/" rel="tag">AD</a><a href="https://noise.getoto.net/tag/adi/" rel="tag">ADI</a><a href="https://noise.getoto.net/tag/ads/" rel="tag">ads</a><a href="https://noise.getoto.net/tag/ai/" rel="tag">AI</a><a href="https://noise.getoto.net/tag/ala/" rel="tag">ALA</a><a href="https://noise.getoto.net/tag/all/" rel="tag">All</a><a href="https://noise.getoto.net/tag/app/" rel="tag">app</a><a href="https://noise.getoto.net/tag/aria/" rel="tag">ARIA</a><a href="https://noise.getoto.net/tag/art/" rel="tag">art</a><a href="https://noise.getoto.net/tag/ati/" rel="tag">ATI</a><a href="https://noise.getoto.net/tag/ats/" rel="tag">ATS</a><a href="https://noise.getoto.net/tag/availability/" rel="tag">Availability</a><a href="https://noise.getoto.net/tag/basic/" rel="tag">BASIC</a><a href="https://noise.getoto.net/tag/bett/" rel="tag">BETT</a><a href="https://noise.getoto.net/tag/bing/" rel="tag">bing</a><a href="https://noise.getoto.net/tag/ble/" rel="tag">ble</a><a href="https://noise.getoto.net/tag/blog/" rel="tag">blog</a><a href="https://noise.getoto.net/tag/bug/" rel="tag">bug</a><a href="https://noise.getoto.net/tag/bugs/" rel="tag">Bugs</a><a href="https://noise.getoto.net/tag/c/" rel="tag">C</a><a href="https://noise.getoto.net/tag/cas/" rel="tag">CAS</a><a href="https://noise.getoto.net/tag/case/" rel="tag">Case</a><a href="https://noise.getoto.net/tag/cases/" rel="tag">cases</a><a href="https://noise.getoto.net/tag/choice/" rel="tag">Choice</a><a href="https://noise.getoto.net/tag/ci/" rel="tag">ci</a><a href="https://noise.getoto.net/tag/cia/" rel="tag">cia</a><a href="https://noise.getoto.net/tag/cli/" rel="tag">cli</a><a href="https://noise.getoto.net/tag/clock/" rel="tag">clock</a><a href="https://noise.getoto.net/tag/code/" rel="tag">code</a><a href="https://noise.getoto.net/tag/console/" rel="tag">console</a><a href="https://noise.getoto.net/tag/containers/" rel="tag">Containers</a><a href="https://noise.getoto.net/tag/controller/" rel="tag">controller</a><a href="https://noise.getoto.net/tag/curity/" rel="tag">Curity</a><a href="https://noise.getoto.net/tag/data/" rel="tag">data</a><a href="https://noise.getoto.net/tag/dependencies/" rel="tag">Dependencies</a><a href="https://noise.getoto.net/tag/desktop/" rel="tag">desktop</a><a href="https://noise.getoto.net/tag/det/" rel="tag">det</a><a href="https://noise.getoto.net/tag/directories/" rel="tag">directories</a><a href="https://noise.getoto.net/tag/document/" rel="tag">document</a><a href="https://noise.getoto.net/tag/down/" rel="tag">down</a><a href="https://noise.getoto.net/tag/dyn/" rel="tag">Dyn</a><a href="https://noise.getoto.net/tag/ec/" rel="tag">ec</a><a href="https://noise.getoto.net/tag/ed/" rel="tag">ed</a><a href="https://noise.getoto.net/tag/embedded/" rel="tag">embedded</a><a href="https://noise.getoto.net/tag/environment/" rel="tag">environment</a><a href="https://noise.getoto.net/tag/eset/" rel="tag">eset</a><a href="https://noise.getoto.net/tag/et/" rel="tag">et</a><a href="https://noise.getoto.net/tag/eu/" rel="tag">eu</a><a href="https://noise.getoto.net/tag/fail/" rel="tag">fail</a><a href="https://noise.getoto.net/tag/fedora/" rel="tag">fedora</a><a href="https://noise.getoto.net/tag/file-systems/" rel="tag">File Systems</a><a href="https://noise.getoto.net/tag/fm/" rel="tag">fm</a><a href="https://noise.getoto.net/tag/form/" rel="tag">form</a><a href="https://noise.getoto.net/tag/fun/" rel="tag">Fun</a><a href="https://noise.getoto.net/tag/general/" rel="tag">General</a><a href="https://noise.getoto.net/tag/git/" rel="tag">Git</a><a href="https://noise.getoto.net/tag/go/" rel="tag">Go</a><a href="https://noise.getoto.net/tag/got/" rel="tag">got</a><a href="https://noise.getoto.net/tag/gre/" rel="tag">GRE</a><a href="https://noise.getoto.net/tag/groups/" rel="tag">groups</a><a href="https://noise.getoto.net/tag/hardware/" rel="tag">hardware</a><a href="https://noise.getoto.net/tag/hat/" rel="tag">HAT</a><a href="https://noise.getoto.net/tag/ice/" rel="tag">ICE</a><a href="https://noise.getoto.net/tag/inside/" rel="tag">Inside</a><a href="https://noise.getoto.net/tag/install/" rel="tag">install</a><a href="https://noise.getoto.net/tag/integrit/" rel="tag">integrit</a><a href="https://noise.getoto.net/tag/ip/" rel="tag">IP</a><a href="https://noise.getoto.net/tag/irs/" rel="tag">irs</a><a href="https://noise.getoto.net/tag/iss/" rel="tag">iss</a><a href="https://noise.getoto.net/tag/iste/" rel="tag">ISTE</a><a href="https://noise.getoto.net/tag/kernel/" rel="tag">kernel</a><a href="https://noise.getoto.net/tag/kit/" rel="tag">kit</a><a href="https://noise.getoto.net/tag/kms/" rel="tag">kms</a><a href="https://noise.getoto.net/tag/library/" rel="tag">Library</a><a href="https://noise.getoto.net/tag/limit/" rel="tag">limit</a><a href="https://noise.getoto.net/tag/linux/" rel="tag">linux</a><a href="https://noise.getoto.net/tag/location/" rel="tag">location</a><a href="https://noise.getoto.net/tag/mac/" rel="tag">Mac</a><a href="https://noise.getoto.net/tag/make/" rel="tag">Make</a><a href="https://noise.getoto.net/tag/making/" rel="tag">making</a><a href="https://noise.getoto.net/tag/mana/" rel="tag">mana</a><a href="https://noise.getoto.net/tag/media/" rel="tag">media</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/mit/" rel="tag">mit</a><a href="https://noise.getoto.net/tag/mou/" rel="tag">MoU</a><a href="https://noise.getoto.net/tag/mov/" rel="tag">mov</a><a href="https://noise.getoto.net/tag/move/" rel="tag">move</a><a href="https://noise.getoto.net/tag/mpa/" rel="tag">MPA</a><a href="https://noise.getoto.net/tag/nec/" rel="tag">NEC</a><a href="https://noise.getoto.net/tag/nes/" rel="tag">NES</a><a href="https://noise.getoto.net/tag/network/" rel="tag">Network</a><a href="https://noise.getoto.net/tag/nist/" rel="tag">nist</a><a href="https://noise.getoto.net/tag/nse/" rel="tag">nse</a><a href="https://noise.getoto.net/tag/opera/" rel="tag">opera</a><a href="https://noise.getoto.net/tag/operating-systems/" rel="tag">Operating Systems</a><a href="https://noise.getoto.net/tag/other/" rel="tag">Other</a><a href="https://noise.getoto.net/tag/ous/" rel="tag">OUs</a><a href="https://noise.getoto.net/tag/pc/" rel="tag">pc</a><a href="https://noise.getoto.net/tag/people/" rel="tag">people</a><a href="https://noise.getoto.net/tag/pin/" rel="tag">PIN</a><a href="https://noise.getoto.net/tag/plugin/" rel="tag">plugin</a><a href="https://noise.getoto.net/tag/policies/" rel="tag">policies</a><a href="https://noise.getoto.net/tag/policy/" rel="tag">policy</a><a href="https://noise.getoto.net/tag/power/" rel="tag">power</a><a href="https://noise.getoto.net/tag/ppl/" rel="tag">PPL</a><a href="https://noise.getoto.net/tag/problem/" rel="tag">problem</a><a href="https://noise.getoto.net/tag/project/" rel="tag">project</a><a href="https://noise.getoto.net/tag/ps/" rel="tag">ps</a><a href="https://noise.getoto.net/tag/r/" rel="tag">R</a><a href="https://noise.getoto.net/tag/rat/" rel="tag">rat</a><a href="https://noise.getoto.net/tag/rate/" rel="tag">rate</a><a href="https://noise.getoto.net/tag/rds/" rel="tag">RDS</a><a href="https://noise.getoto.net/tag/remote/" rel="tag">remote</a><a href="https://noise.getoto.net/tag/resource/" rel="tag">Resource</a><a href="https://noise.getoto.net/tag/rest/" rel="tag">rest</a><a href="https://noise.getoto.net/tag/risks/" rel="tag">risks</a><a href="https://noise.getoto.net/tag/rti/" rel="tag">RTI</a><a href="https://noise.getoto.net/tag/running/" rel="tag">running</a><a href="https://noise.getoto.net/tag/s/" rel="tag">S.</a><a href="https://noise.getoto.net/tag/sam/" rel="tag">SAM</a><a href="https://noise.getoto.net/tag/security/" rel="tag">security</a><a href="https://noise.getoto.net/tag/server/" rel="tag">server</a><a href="https://noise.getoto.net/tag/servers/" rel="tag">servers</a><a href="https://noise.getoto.net/tag/setup/" rel="tag">setup</a><a href="https://noise.getoto.net/tag/shed/" rel="tag">shed</a><a href="https://noise.getoto.net/tag/shell-script/" rel="tag">shell script</a><a href="https://noise.getoto.net/tag/software/" rel="tag">software</a><a href="https://noise.getoto.net/tag/space/" rel="tag">space</a><a href="https://noise.getoto.net/tag/sse/" rel="tag">SSE</a><a href="https://noise.getoto.net/tag/star/" rel="tag">Star</a><a href="https://noise.getoto.net/tag/status/" rel="tag">status</a><a href="https://noise.getoto.net/tag/storage/" rel="tag">storage</a><a href="https://noise.getoto.net/tag/sts/" rel="tag">sts</a><a href="https://noise.getoto.net/tag/support/" rel="tag">support</a><a href="https://noise.getoto.net/tag/sync/" rel="tag">Sync</a><a href="https://noise.getoto.net/tag/talk/" rel="tag">talk</a><a href="https://noise.getoto.net/tag/target/" rel="tag">target</a><a href="https://noise.getoto.net/tag/tdo/" rel="tag">TDO</a><a href="https://noise.getoto.net/tag/tea/" rel="tag">tea</a><a href="https://noise.getoto.net/tag/tech/" rel="tag">tech</a><a href="https://noise.getoto.net/tag/technology/" rel="tag">Technology</a><a href="https://noise.getoto.net/tag/ted/" rel="tag">ted</a><a href="https://noise.getoto.net/tag/test/" rel="tag">test</a><a href="https://noise.getoto.net/tag/tested/" rel="tag">Tested</a><a href="https://noise.getoto.net/tag/testing/" rel="tag">testing</a><a href="https://noise.getoto.net/tag/things/" rel="tag">things</a><a href="https://noise.getoto.net/tag/tools/" rel="tag">Tools</a><a href="https://noise.getoto.net/tag/tor/" rel="tag">tor</a><a href="https://noise.getoto.net/tag/touch/" rel="tag">touch</a><a href="https://noise.getoto.net/tag/ui/" rel="tag">UI</a><a href="https://noise.getoto.net/tag/un/" rel="tag">un</a><a href="https://noise.getoto.net/tag/updated/" rel="tag">updated</a><a href="https://noise.getoto.net/tag/us/" rel="tag">US</a><a href="https://noise.getoto.net/tag/ux/" rel="tag">UX</a><a href="https://noise.getoto.net/tag/variables/" rel="tag">variables</a><a href="https://noise.getoto.net/tag/war/" rel="tag">war</a><a href="https://noise.getoto.net/tag/watch/" rel="tag">watch</a><a href="https://noise.getoto.net/tag/work/" rel="tag">Work</a></span></footer></article>
<article id="post-321068" class="post-321068 post type-post status-publish format-standard hentry tag-ad tag-adi tag-ai tag-algorithms tag-all tag-alpha tag-apis tag-app tag-apple tag-apt tag-arin tag-art tag-ati tag-basic tag-bec tag-bing tag-ble tag-blog tag-bluetooth tag-c tag-cam tag-cas tag-case tag-ci tag-cia tag-cli tag-code tag-cpy tag-dbus tag-dea tag-dependencies tag-design tag-desktop tag-det tag-developers tag-development tag-dp tag-ec tag-ecs tag-ed tag-embedded tag-environment tag-et tag-eu tag-event tag-fact tag-fail tag-family tag-fedora tag-fun tag-go tag-got tag-gre tag-hab tag-hat tag-ice tag-improvements tag-increase tag-install tag-internet tag-ip tag-ipv4 tag-ipv6 tag-irs tag-isp tag-iste tag-kernel tag-kms tag-launch tag-library tag-light tag-linux tag-logging tag-mac tag-make tag-media tag-message-queues tag-mobile tag-mov tag-move tag-mpa tag-ncr tag-nec tag-nes tag-nist tag-nse tag-oss tag-other tag-ous tag-patching tag-pin tag-power tag-ppl tag-problem tag-project tag-projects tag-ps tag-r tag-rat tag-rate tag-rds tag-reputation tag-resource tag-resources tag-rest tag-rov tag-rti tag-running tag-s tag-sam tag-server tag-servers tag-shed tag-source-code tag-space tag-sse tag-ssh tag-star tag-sts tag-support tag-target tag-tea tag-tech tag-technology tag-ted tag-things tag-tor tag-udp tag-ui tag-un tag-updated tag-upgrade tag-us tag-ustr tag-ux tag-war tag-win tag-work">
<header class="entry-header">
<h1 class="entry-title"><a href="https://noise.getoto.net/2011/05/18/systemd-for-developers-i-3/" rel="bookmark">systemd for Developers I</a></h1>
<div class="entry-meta">
<span class="entry-date"><a href="https://noise.getoto.net/2011/05/18/systemd-for-developers-i-3/" rel="bookmark"><time class="entry-date" datetime="2011-05-18T23:00:00+03:00">2011-05-18</time></a></span> <span class="byline"><span class="author vcard"><a class="url fn n" href="https://noise.getoto.net/author/lennart-poettering/" rel="author">Lennart Poettering</a></span></span> </div>
</header>
<div class="entry-content">
<p class="syndicated-attribution">Post Syndicated from <a href="https://noise.getoto.net/author/0/" title="Read other posts by Lennart Poettering">Lennart Poettering</a> original <a href="http://0pointer.net/blog/projects/socket-activation.html">http://0pointer.net/blog/projects/socket-activation.html</a></p>
<p><a href="https://www.freedesktop.org/wiki/Software/systemd">systemd</a><br />
not only brings improvements for administrators and users, it also<br />
brings a (small) number of new APIs with it. In this blog story (which might<br />
become the first of a series) I hope to shed some light on one of the<br />
most important new APIs in systemd:</p>
<h4>Socket Activation</h4>
<p>In the <a href="http://0pointer.de/blog/projects/systemd.html">original blog<br />
story about systemd</a> I tried to explain why socket activation is a<br />
wonderful technology to spawn services. Let&#8217;s reiterate the background<br />
here a bit.</p>
<p>The basic idea of socket activation is not new. The inetd<br />
superserver was a standard component of most Linux and Unix systems<br />
since time began: instead of spawning all local Internet services<br />
already at boot, the superserver would listen on behalf of the<br />
services and whenever a connection would come in an instance of the<br />
respective service would be spawned. This allowed relatively weak<br />
machines with few resources to offer a big variety of services at the<br />
same time. However it quickly got a reputation for being somewhat<br />
slow: since daemons would be spawned for each incoming connection a<br />
lot of time was spent on forking and initialization of the services<br />
&#8212; once for each connection, instead of once for them all.</p>
<p>Spawning one instance per connection was how inetd was primarily<br />
used, even though inetd actually understood another mode: on the first<br />
incoming connection it would notice this via <tt>poll()</tt> (or<br />
<tt>select()</tt>) and spawn a single instance for all future<br />
connections. (This was controllable with the<br />
<tt>wait</tt>/<tt>nowait</tt> options.) That way the first connection<br />
would be slow to set up, but subsequent ones would be as fast as with<br />
a standalone service. In this mode inetd would work in a true<br />
on-demand mode: a service would be made available lazily when it was<br />
required.</p>
<p>inetd&#8217;s focus was clearly on AF_INET (i.e. Internet) sockets. As<br />
time progressed and Linux/Unix left the server niche and became<br />
increasingly relevant on desktops, mobile and embedded environments<br />
inetd was somehow lost in the troubles of time. Its reputation for<br />
being slow, and the fact that Linux&#8217; focus shifted away from only<br />
Internet servers made a Linux machine running inetd (or one of its newer<br />
implementations, like xinetd) the exception, not the rule.</p>
<p>When Apple engineers worked on optimizing the MacOS boot time they<br />
found a new way to make use of the idea of socket activation: they<br />
shifted the focus away from AF_INET sockets towards AF_UNIX<br />
sockets. And they noticed that on-demand socket activation was only<br />
part of the story: much more powerful is socket activation when used<br />
for <i>all</i> local services including those which need to be started<br />
anyway on boot. They implemented these ideas in <a href="http://launchd.macosforge.org/">launchd</a>, a central building<br />
block of modern MacOS X systems, and probably the main reason why<br />
MacOS is so fast booting up.</p>
<p>But, before we continue, let&#8217;s have a closer look what the benefits<br />
of socket activation for non-on-demand, non-Internet services in<br />
detail are. Consider the four services Syslog, D-Bus, Avahi and the<br />
Bluetooth daemon. D-Bus logs to Syslog, hence on traditional Linux<br />
systems it would get started after Syslog. Similarly, Avahi requires<br />
Syslog and D-Bus, hence would get started after both. Finally<br />
Bluetooth is similar to Avahi and also requires Syslog and D-Bus but<br />
does not interface at all with Avahi. Sinceoin a traditional<br />
SysV-based system only one service can be in the process of getting<br />
started at a time, the following serialization of startup would take<br />
place: Syslog &#x2192; D-Bus &#x2192; Avahi &#x2192; Bluetooth (Of course, Avahi and<br />
Bluetooth could be started in the opposite order too, but we have to<br />
pick one here, so let&#8217;s simply go alphabetically.). To illustrate<br />
this, here&#8217;s a plot showing the order of startup beginning with system<br />
startup (at the top).</p>
<p><a href="http://0pointer.de/public/parallelization.png"><img loading="lazy" src="http://0pointer.de/public/parallelization-small.png" width="400" height="257" alt="Parallelization plot" /></a></p>
<p>Certain distributions tried to improve this strictly serialized<br />
start-up: since Avahi and Bluetooth are independent from each other,<br />
they can be started simultaneously. The parallelization is increased,<br />
the overall startup time slightly smaller. (This is visualized in the<br />
middle part of the plot.)</p>
<p>Socket activation makes it possible to start all four services<br />
completely simultaneously, without any kind of ordering. Since the<br />
creation of the listening sockets is moved outside of the daemons<br />
themselves we can start them all at the same time, and they are able<br />
to connect to each other&#8217;s sockets right-away. I.e. in a single step<br />
the <tt>/dev/log</tt> and <tt>/run/dbus/system_bus_socket</tt> sockets<br />
are created, and in the next step all four services are spawned<br />
simultaneously. When D-Bus then wants to log to syslog, it just writes<br />
its messages to <tt>/dev/log</tt>. As long as the socket buffer does<br />
not run full it can go on immediately with what else it wants to do<br />
for initialization. As soon as the syslog service catches up it will<br />
process the queued messages. And if the socket buffer runs full then<br />
the client logging will temporarily block until the socket is writable<br />
again, and continue the moment it can write its log messages. That<br />
means the scheduling of our services is entirely done by the kernel:<br />
from the userspace perspective all services are run at the same time,<br />
and when one service cannot keep up the others needing it will<br />
temporarily block on their request but go on as soon as these<br />
requests are dispatched. All of this is completely automatic and<br />
invisible to userspace. Socket activation hence allows us to<br />
drastically parallelize start-up, enabling simultaneous start-up of<br />
services which previously were thought to strictly require<br />
serialization. Most Linux services use sockets as communication<br />
channel. Socket activation allows starting of clients and servers of<br />
these channels at the same time.</p>
<p>But it&#8217;s not just about parallelization. It offers a number of<br />
other benefits:</p>
<ul>
<li>We no longer need to configure dependencies explicitly. Since the<br />
sockets are initialized before all services they are simply available,<br />
and no userspace ordering of service start-up needs to take place<br />
anymore. Socket activation hence drastically simplifies configuration<br />
and development of services.</li>
<li>If a service dies its listening socket stays around, not losing a<br />
single message. After a restart of the crashed service it can continue<br />
right where it left off.</li>
<li>If a service is upgraded we can restart the service while keeping<br />
around its sockets, thus ensuring the service is continously<br />
responsive. Not a single connection is lost during the upgrade.</li>
<li>We can even replace a service during runtime in a way that is<br />
invisible to the client. For example, all systems running systemd<br />
start up with a tiny syslog daemon at boot which passes all log<br />
messages written to <tt>/dev/log</tt> on to the kernel message<br />
buffer. That way we provide reliable userspace logging starting from<br />
the first instant of boot-up. Then, when the actual rsyslog daemon is<br />
ready to start we terminate the mini daemon and replace it with the<br />
real daemon. And all that while keeping around the original logging<br />
socket and sharing it between the two daemons and not losing a single<br />
message. Since rsyslog flushes the kernel log buffer to disk after<br />
start-up all log messages from the kernel, from early-boot and from<br />
runtime end up on disk.</li>
</ul>
<p>For another explanation of this idea consult <a href="http://0pointer.de/blog/projects/systemd.html">the original blog<br />
story about systemd</a>.</p>
<p>Socket activation has been available in systemd since its<br />
inception. On Fedora 15 a number of services have been modified to<br />
implement socket activation, including Avahi, D-Bus and rsyslog (to continue with the example above).</p>
<p>systemd&#8217;s socket activation is quite comprehensive. Not only classic<br />
sockets are support but related technologies as well:</p>
<ul>
<li>AF_UNIX sockets, in the flavours SOCK_DGRAM, SOCK_STREAM and SOCK_SEQPACKET; both in the filesystem and in the abstract namespace</li>
<li>AF_INET sockets, i.e. TCP/IP and UDP/IP; both IPv4 and IPv6</li>
<li>Unix named pipes/FIFOs in the filesystem</li>
<li>AF_NETLINK sockets, to subscribe to certain kernel features. This<br />
is currently used by udev, but could be useful for other<br />
netlink-related services too, such as audit.</li>
<li>Certain special files like <tt>/proc/kmsg</tt> or device nodes like <tt>/dev/input/*</tt>.</li>
<li>POSIX Message Queues</li>
</ul>
<p>A service capable of socket activation must be able to receive its<br />
preinitialized sockets from systemd, instead of creating them<br />
internally. For most services this requires (minimal)<br />
patching. However, since systemd actually provides inetd compatibility<br />
a service working with inetd will also work with systemd &#8212; which is<br />
quite useful for services like sshd for example.</p>
<p>So much about the background of socket activation, let&#8217;s now have a<br />
look how to patch a service to make it socket activatable. Let&#8217;s start<br />
with a theoretic service <tt>foobard</tt>. (In a later blog post we&#8217;ll focus on<br />
real-life example.)</p>
<p>Our little (theoretic) service includes code like the following for<br />
creating sockets (most services include code like this in one way or<br />
another):</p>
<pre><b>/* Source Code Example #1: ORIGINAL, NOT SOCKET-ACTIVATABLE SERVICE */</b>
...
union {
        struct sockaddr sa;
        struct sockaddr_un un;
} sa;
int fd;

fd = socket(AF_UNIX, SOCK_STREAM, 0);
if (fd &lt; 0) {
        fprintf(stderr, "socket(): %m\n");
        exit(1);
}

memset(&amp;sa, 0, sizeof(sa));
sa.un.sun_family = AF_UNIX;
strncpy(sa.un.sun_path, "/run/foobar.sk", sizeof(sa.un.sun_path));

if (bind(fd, &amp;sa.sa, sizeof(sa)) &lt; 0) {
        fprintf(stderr, "bind(): %m\n");
        exit(1);
}

if (listen(fd, SOMAXCONN) &lt; 0) {
        fprintf(stderr, "listen(): %m\n");
        exit(1);
}
...
</pre>
<p>A socket activatable service may use the following code instead:</p>
<pre><b>/* Source Code Example #2: UPDATED, SOCKET-ACTIVATABLE SERVICE */</b>
...
#include "sd-daemon.h"
...
int fd;

if (sd_listen_fds(0) != 1) {
        fprintf(stderr, "No or too many file descriptors received.\n");
        exit(1);
}

fd = SD_LISTEN_FDS_START + 0;
...
</pre>
<p>systemd might pass you more than one socket (based on<br />
configuration, see below). In this example we are interested in one<br />
only. <a href="http://0pointer.de/public/systemd-man/sd_listen_fds.html">sd_listen_fds()</a><br />
returns how many file descriptors are passed. We simply compare that<br />
with 1, and fail if we got more or less. The file descriptors systemd<br />
passes to us are inherited one after the other beginning with fd<br />
#3. (SD_LISTEN_FDS_START is a macro defined to 3). Our code hence just<br />
takes possession of fd #3.</p>
<p>As you can see this code is actually much shorter than the<br />
original. This of course comes at the price that our little service<br />
with this change will no longer work in a non-socket-activation<br />
environment. With minimal changes we can adapt our example to work nicely<br />
both with and without socket activation:</p>
<pre><b>/* Source Code Example #3: UPDATED, SOCKET-ACTIVATABLE SERVICE WITH COMPATIBILITY */</b>
...
#include "sd-daemon.h"
...
int fd, n;

n = sd_listen_fds(0);
if (n > 1) {
        fprintf(stderr, "Too many file descriptors received.\n");
        exit(1);
} else if (n == 1)
        fd = SD_LISTEN_FDS_START + 0;
else {
        union {
                struct sockaddr sa;
                struct sockaddr_un un;
        } sa;

        fd = socket(AF_UNIX, SOCK_STREAM, 0);
        if (fd &lt; 0) {
                fprintf(stderr, "socket(): %m\n");
                exit(1);
        }

        memset(&amp;sa, 0, sizeof(sa));
        sa.un.sun_family = AF_UNIX;
        strncpy(sa.un.sun_path, "/run/foobar.sk", sizeof(sa.un.sun_path));

        if (bind(fd, &amp;sa.sa, sizeof(sa)) &lt; 0) {
                fprintf(stderr, "bind(): %m\n");
                exit(1);
        }

        if (listen(fd, SOMAXCONN) &lt; 0) {
                fprintf(stderr, "listen(): %m\n");
                exit(1);
        }
}
...
</pre>
<p>With this simple change our service can now make use of socket<br />
activation but still works unmodified in classic environments. Now,<br />
let&#8217;s see how we can enable this service in systemd. For this we have<br />
to write two systemd unit files: one describing the socket, the other<br />
describing the service. First, here&#8217;s <tt>foobar.socket</tt>:</p>
<pre>[Socket]
ListenStream=/run/foobar.sk

[Install]
WantedBy=sockets.target
</pre>
<p>And here&#8217;s the matching service file <tt>foobar.service</tt>:</p>
<pre>[Service]
ExecStart=/usr/bin/foobard
</pre>
<p>If we place these two files in <tt>/etc/systemd/system</tt> we can<br />
enable and start them:</p>
<pre># systemctl enable foobar.socket
# systemctl start foobar.socket</pre>
<p>Now our little socket is listening, but our service not running<br />
yet. If we now connect to <tt>/run/foobar.sk</tt> the service will be<br />
automatically spawned, for on-demand service start-up. With a<br />
modification of <tt>foobar.service</tt> we can start our service<br />
already at startup, thus using socket activation only for<br />
parallelization purposes, not for on-demand auto-spawning anymore:</p>
<pre>[Service]
ExecStart=/usr/bin/foobard

<b>[Install]
WantedBy=multi-user.target</b>
</pre>
<p>And now let&#8217;s enable this too:</p>
<pre># systemctl enable foobar.service
# systemctl start foobar.service</pre>
<p>Now our little daemon will be started at boot and on-demand,<br />
whatever comes first. It can be started fully in parallel with its<br />
clients, and when it dies it will be automatically restarted when it<br />
is used the next time.</p>
<p>A single .socket file can include multiple ListenXXX stanzas, which<br />
is useful for services that listen on more than one socket. In this<br />
case all configured sockets will be passed to the service in the exact<br />
order they are configured in the socket unit file. <a href="http://0pointer.de/public/systemd-man/systemd.socket.html">Also,<br />
you may configure various socket settings in the .socket<br />
files.</a></p>
<p>In real life it&#8217;s a good idea to include description strings in<br />
these unit files, to keep things simple we&#8217;ll leave this out of our<br />
example. Speaking of real-life: our next installment will cover an<br />
actual real-life example. We&#8217;ll add socket activation to the CUPS<br />
printing server.</p>
<p>The <tt>sd_listen_fds()</tt> function call is defined in <a href="https://cgit.freedesktop.org/systemd/plain/src/sd-daemon.h">sd-daemon.h</a><br />
and <a href="https://cgit.freedesktop.org/systemd/plain/src/sd-daemon.c">sd-daemon.c</a>. These<br />
two files are currently drop-in .c sources which projects should<br />
simply copy into their source tree. Eventually we plan to turn this<br />
into a proper shared library, however using the drop-in files allows<br />
you to compile your project in a way that is compatible with socket<br />
activation even without any compile time dependencies on<br />
systemd. <tt>sd-daemon.c</tt> is liberally licensed, should compile<br />
fine on the most exotic Unixes and the algorithms are trivial enough<br />
to be reimplemented with very little code if the license should<br />
nonetheless be a problem for your project. <tt>sd-daemon.c</tt><br />
contains a couple of other API functions besides<br />
<tt>sd_listen_fds()</tt> that are useful when implementing socket<br />
activation in a project. For example, there&#8217;s <tt><a href="http://0pointer.de/public/systemd-man/sd_is_fifo.html">sd_is_socket()</a></tt><br />
which can be used to distuingish and identify particular sockets when<br />
a service gets passed more than one.</p>
<p>Let me point out that the interfaces used here are in no way bound<br />
directly to systemd. They are generic enough to be implemented in<br />
other systems as well. We deliberately designed them as simple and<br />
minimal as possible to make it possible for others to adopt similar<br />
schemes.</p>
<p>Stay tuned for the next installment. As mentioned, it will cover a<br />
real-life example of turning an existing daemon into a<br />
socket-activatable one: the CUPS printing service. However, I hope<br />
this blog story might already be enough to get you started if you plan<br />
to convert an existing service into a socket activatable one. We<br />
invite everybody to convert upstream projects to this scheme. If you<br />
have any questions join us on <tt>#systemd</tt> on freenode.</p>
</div>
<footer class="entry-meta"><span class="tag-links"><a href="https://noise.getoto.net/tag/ad/" rel="tag">AD</a><a href="https://noise.getoto.net/tag/adi/" rel="tag">ADI</a><a href="https://noise.getoto.net/tag/ai/" rel="tag">AI</a><a href="https://noise.getoto.net/tag/algorithms/" rel="tag">algorithms</a><a href="https://noise.getoto.net/tag/all/" rel="tag">All</a><a href="https://noise.getoto.net/tag/alpha/" rel="tag">ALPHA</a><a href="https://noise.getoto.net/tag/apis/" rel="tag">APIs</a><a href="https://noise.getoto.net/tag/app/" rel="tag">app</a><a href="https://noise.getoto.net/tag/apple/" rel="tag">Apple</a><a href="https://noise.getoto.net/tag/apt/" rel="tag">apt</a><a href="https://noise.getoto.net/tag/arin/" rel="tag">arin</a><a href="https://noise.getoto.net/tag/art/" rel="tag">art</a><a href="https://noise.getoto.net/tag/ati/" rel="tag">ATI</a><a href="https://noise.getoto.net/tag/basic/" rel="tag">BASIC</a><a href="https://noise.getoto.net/tag/bec/" rel="tag">BEC</a><a href="https://noise.getoto.net/tag/bing/" rel="tag">bing</a><a href="https://noise.getoto.net/tag/ble/" rel="tag">ble</a><a href="https://noise.getoto.net/tag/blog/" rel="tag">blog</a><a href="https://noise.getoto.net/tag/bluetooth/" rel="tag">bluetooth</a><a href="https://noise.getoto.net/tag/c/" rel="tag">C</a><a href="https://noise.getoto.net/tag/cam/" rel="tag">cam</a><a href="https://noise.getoto.net/tag/cas/" rel="tag">CAS</a><a href="https://noise.getoto.net/tag/case/" rel="tag">Case</a><a href="https://noise.getoto.net/tag/ci/" rel="tag">ci</a><a href="https://noise.getoto.net/tag/cia/" rel="tag">cia</a><a href="https://noise.getoto.net/tag/cli/" rel="tag">cli</a><a href="https://noise.getoto.net/tag/code/" rel="tag">code</a><a href="https://noise.getoto.net/tag/cpy/" rel="tag">CPY</a><a href="https://noise.getoto.net/tag/dbus/" rel="tag">dbus</a><a href="https://noise.getoto.net/tag/dea/" rel="tag">dea</a><a href="https://noise.getoto.net/tag/dependencies/" rel="tag">Dependencies</a><a href="https://noise.getoto.net/tag/design/" rel="tag">design</a><a href="https://noise.getoto.net/tag/desktop/" rel="tag">desktop</a><a href="https://noise.getoto.net/tag/det/" rel="tag">det</a><a href="https://noise.getoto.net/tag/developers/" rel="tag">Developers</a><a href="https://noise.getoto.net/tag/development/" rel="tag">development</a><a href="https://noise.getoto.net/tag/dp/" rel="tag">dp</a><a href="https://noise.getoto.net/tag/ec/" rel="tag">ec</a><a href="https://noise.getoto.net/tag/ecs/" rel="tag">ECS</a><a href="https://noise.getoto.net/tag/ed/" rel="tag">ed</a><a href="https://noise.getoto.net/tag/embedded/" rel="tag">embedded</a><a href="https://noise.getoto.net/tag/environment/" rel="tag">environment</a><a href="https://noise.getoto.net/tag/et/" rel="tag">et</a><a href="https://noise.getoto.net/tag/eu/" rel="tag">eu</a><a href="https://noise.getoto.net/tag/event/" rel="tag">event</a><a href="https://noise.getoto.net/tag/fact/" rel="tag">fact</a><a href="https://noise.getoto.net/tag/fail/" rel="tag">fail</a><a href="https://noise.getoto.net/tag/family/" rel="tag">family</a><a href="https://noise.getoto.net/tag/fedora/" rel="tag">fedora</a><a href="https://noise.getoto.net/tag/fun/" rel="tag">Fun</a><a href="https://noise.getoto.net/tag/go/" rel="tag">Go</a><a href="https://noise.getoto.net/tag/got/" rel="tag">got</a><a href="https://noise.getoto.net/tag/gre/" rel="tag">GRE</a><a href="https://noise.getoto.net/tag/hab/" rel="tag">HAB</a><a href="https://noise.getoto.net/tag/hat/" rel="tag">HAT</a><a href="https://noise.getoto.net/tag/ice/" rel="tag">ICE</a><a href="https://noise.getoto.net/tag/improvements/" rel="tag">improvements</a><a href="https://noise.getoto.net/tag/increase/" rel="tag">increase</a><a href="https://noise.getoto.net/tag/install/" rel="tag">install</a><a href="https://noise.getoto.net/tag/internet/" rel="tag">internet</a><a href="https://noise.getoto.net/tag/ip/" rel="tag">IP</a><a href="https://noise.getoto.net/tag/ipv4/" rel="tag">ipv4</a><a href="https://noise.getoto.net/tag/ipv6/" rel="tag">ipv6</a><a href="https://noise.getoto.net/tag/irs/" rel="tag">irs</a><a href="https://noise.getoto.net/tag/isp/" rel="tag">ISP</a><a href="https://noise.getoto.net/tag/iste/" rel="tag">ISTE</a><a href="https://noise.getoto.net/tag/kernel/" rel="tag">kernel</a><a href="https://noise.getoto.net/tag/kms/" rel="tag">kms</a><a href="https://noise.getoto.net/tag/launch/" rel="tag">launch</a><a href="https://noise.getoto.net/tag/library/" rel="tag">Library</a><a href="https://noise.getoto.net/tag/light/" rel="tag">light</a><a href="https://noise.getoto.net/tag/linux/" rel="tag">linux</a><a href="https://noise.getoto.net/tag/logging/" rel="tag">logging</a><a href="https://noise.getoto.net/tag/mac/" rel="tag">Mac</a><a href="https://noise.getoto.net/tag/make/" rel="tag">Make</a><a href="https://noise.getoto.net/tag/media/" rel="tag">media</a><a href="https://noise.getoto.net/tag/message-queues/" rel="tag">message queues</a><a href="https://noise.getoto.net/tag/mobile/" rel="tag">mobile</a><a href="https://noise.getoto.net/tag/mov/" rel="tag">mov</a><a href="https://noise.getoto.net/tag/move/" rel="tag">move</a><a href="https://noise.getoto.net/tag/mpa/" rel="tag">MPA</a><a href="https://noise.getoto.net/tag/ncr/" rel="tag">NCR</a><a href="https://noise.getoto.net/tag/nec/" rel="tag">NEC</a><a href="https://noise.getoto.net/tag/nes/" rel="tag">NES</a><a href="https://noise.getoto.net/tag/nist/" rel="tag">nist</a><a href="https://noise.getoto.net/tag/nse/" rel="tag">nse</a><a href="https://noise.getoto.net/tag/oss/" rel="tag">OSS</a><a href="https://noise.getoto.net/tag/other/" rel="tag">Other</a><a href="https://noise.getoto.net/tag/ous/" rel="tag">OUs</a><a href="https://noise.getoto.net/tag/patching/" rel="tag">patching</a><a href="https://noise.getoto.net/tag/pin/" rel="tag">PIN</a><a href="https://noise.getoto.net/tag/power/" rel="tag">power</a><a href="https://noise.getoto.net/tag/ppl/" rel="tag">PPL</a><a href="https://noise.getoto.net/tag/problem/" rel="tag">problem</a><a href="https://noise.getoto.net/tag/project/" rel="tag">project</a><a href="https://noise.getoto.net/tag/projects/" rel="tag">Projects</a><a href="https://noise.getoto.net/tag/ps/" rel="tag">ps</a><a href="https://noise.getoto.net/tag/r/" rel="tag">R</a><a href="https://noise.getoto.net/tag/rat/" rel="tag">rat</a><a href="https://noise.getoto.net/tag/rate/" rel="tag">rate</a><a href="https://noise.getoto.net/tag/rds/" rel="tag">RDS</a><a href="https://noise.getoto.net/tag/reputation/" rel="tag">reputation</a><a href="https://noise.getoto.net/tag/resource/" rel="tag">Resource</a><a href="https://noise.getoto.net/tag/resources/" rel="tag">resources</a><a href="https://noise.getoto.net/tag/rest/" rel="tag">rest</a><a href="https://noise.getoto.net/tag/rov/" rel="tag">ROV</a><a href="https://noise.getoto.net/tag/rti/" rel="tag">RTI</a><a href="https://noise.getoto.net/tag/running/" rel="tag">running</a><a href="https://noise.getoto.net/tag/s/" rel="tag">S.</a><a href="https://noise.getoto.net/tag/sam/" rel="tag">SAM</a><a href="https://noise.getoto.net/tag/server/" rel="tag">server</a><a href="https://noise.getoto.net/tag/servers/" rel="tag">servers</a><a href="https://noise.getoto.net/tag/shed/" rel="tag">shed</a><a href="https://noise.getoto.net/tag/source-code/" rel="tag">source code</a><a href="https://noise.getoto.net/tag/space/" rel="tag">space</a><a href="https://noise.getoto.net/tag/sse/" rel="tag">SSE</a><a href="https://noise.getoto.net/tag/ssh/" rel="tag">ssh</a><a href="https://noise.getoto.net/tag/star/" rel="tag">Star</a><a href="https://noise.getoto.net/tag/sts/" rel="tag">sts</a><a href="https://noise.getoto.net/tag/support/" rel="tag">support</a><a href="https://noise.getoto.net/tag/target/" rel="tag">target</a><a href="https://noise.getoto.net/tag/tea/" rel="tag">tea</a><a href="https://noise.getoto.net/tag/tech/" rel="tag">tech</a><a href="https://noise.getoto.net/tag/technology/" rel="tag">Technology</a><a href="https://noise.getoto.net/tag/ted/" rel="tag">ted</a><a href="https://noise.getoto.net/tag/things/" rel="tag">things</a><a href="https://noise.getoto.net/tag/tor/" rel="tag">tor</a><a href="https://noise.getoto.net/tag/udp/" rel="tag">udp</a><a href="https://noise.getoto.net/tag/ui/" rel="tag">UI</a><a href="https://noise.getoto.net/tag/un/" rel="tag">un</a><a href="https://noise.getoto.net/tag/updated/" rel="tag">updated</a><a href="https://noise.getoto.net/tag/upgrade/" rel="tag">Upgrade</a><a href="https://noise.getoto.net/tag/us/" rel="tag">US</a><a href="https://noise.getoto.net/tag/ustr/" rel="tag">USTR</a><a href="https://noise.getoto.net/tag/ux/" rel="tag">UX</a><a href="https://noise.getoto.net/tag/war/" rel="tag">war</a><a href="https://noise.getoto.net/tag/win/" rel="tag">win</a><a href="https://noise.getoto.net/tag/work/" rel="tag">Work</a></span></footer></article>
</div>
</section>
<div id="secondary">
<h2 class="site-description">The collective thoughts of the interwebz</h2>
<div id="primary-sidebar" class="primary-sidebar widget-area" role="complementary">
<aside id="linkcat-1931" class="widget widget_links"><h1 class="widget-title">Contributors</h1>
<ul class='xoxo blogroll'>
<li><a href="http://www.devttys0.com" title="Embedded Device Hacking">/dev/ttyS0</a></li>
<li><a href="https://www.anchor.com.au" title="AWS automation, management and DevOps consulting services">Anchor | Cloud Engineering Services</a></li>
<li><a href="http://esr.ibiblio.org" title="Sex, software, politics, and firearms. Life&#8217;s simple pleasures&#8230;">Armed and Dangerous</a></li>
<li><a href="https://www.arp242.net/" title="Website of Martin Tournoij/arp242. I write about stuff, occasionally.">arp242.net</a></li>
<li><a href="https://aws.amazon.com/blogs/architecture/" title="Just another Amazon Web Services site">AWS Architecture Blog</a></li>
<li><a href="https://aws.amazon.com/blogs/big-data/" title="Official Big Data Blog of Amazon Web Services">AWS Big Data Blog</a></li>
<li><a href="https://aws.amazon.com/blogs/compute/">AWS Compute Blog</a></li>
<li><a href="https://aws.amazon.com/blogs/devops/" title="Just another AWS Brew Blogs  site">AWS DevOps Blog</a></li>
<li><a href="https://aws.amazon.com/blogs/messaging-and-targeting/" title="Just another AWS Brew Blogs  site">AWS Messaging &amp; Targeting Blog</a></li>
<li><a href="https://aws.amazon.com/blogs/aws/" title="Announcements, Updates, and Launches">AWS News Blog</a></li>
<li><a href="https://aws.amazon.com/blogs/security/" title="The latest AWS security, identity, and compliance launches, announcements, and how-to posts.">AWS Security Blog</a></li>
<li><a href="https://www.backblaze.com/blog" title="Cloud Storage &#038; Cloud Backup">Backblaze Blog | Cloud Storage &amp; Cloud Backup</a></li>
<li><a href="https://www.youtube.com/channel/UCuqokNoK8ZFNQdXxvlE129g">BeardedTinker</a></li>
<li><a href="https://bivol.bg" title="Съ рогата напрѣдъ!">Bivol.bg</a></li>
<li><a href="https://techblog.bozho.net" title="Tips and thoughts on developing software, by Bozhidar Bozhanov">Bozho&#039;s tech blog</a></li>
<li><a href="http://ebb.org/bkuhn/blog/" title="The personal blog of Bradley M. Kuhn (aka bkuhn ), in which he covers issues related to Free, Libre and Open Source Software, software freedom, licensing, GPL, copyleft and various other computer science topics.">Bradley M. Kuhn&#039;s Blog ( bkuhn )</a></li>
<li><a href="https://www.youtube.com/channel/UCVS6ejD9NLZvjsvhcbiDzjw">Crosstalk Solutions</a></li>
<li><a href="https://www.youtube.com/channel/UC726J5A0LLFRxQ0SZqr2mYQ">Curious Droid</a></li>
<li><a href="https://www.darknet.org.uk" title="Hacking Tools, Hacker News &#038; Cyber Security">Darknet</a></li>
<li><a href="https://deliantech.blogspot.com/" title="A little blog on IT topics, telecommunications and programming">Delian&#8217;s Tech blog</a></li>
<li><a href="https://devilsadvocatesecurity.blogspot.com/" title="&lt;center&gt;Devil&#8217;s Advocate Security is a blog dedicated to even handed discussion of security topics, security news, and  observations from the front lines of the daily business of IT security.&lt;/center&gt;">Devil&#8217;s Advocate Security</a></li>
<li><a href="https://www.youtube.com/channel/UC5ZdPKE2ckcBhljTc2R_qNA">digiblurDIY</a></li>
<li><a href="https://github.blog" title="Updates, ideas, and inspiration from GitHub to help developers build and design software.">Engineering – The GitHub Blog</a></li>
<li><a href="https://blog.erratasec.com/" title="Advanced persistent cybersecurity">Errata Security</a></li>
<li><a href="http://explosm.net" title="Flash Animations, Daily Comics and more!">Explosm.net</a></li>
<li><a href="https://eev.ee/">fuzzy notepad</a></li>
<li><a href="https://www.youtube.com/channel/UCHKRfxkMTqiiv4pF99qGKIw">Geographics</a></li>
<li><a href="https://engineering.grab.com/" title="Grab&#8217;s Engineering team solves critical transportation challenges and makes transport freedom a reality for 620 million people in Southeast Asia.
">Grab Tech</a></li>
<li><a href="http://www.gatchev.info/blog" title="Just another WordPress site">Grigor Gatchev – A Weblog</a></li>
<li><a href="https://www.youtube.com/channel/UCbX3YkedQunLt7EQAdVxh7w">Home Assistant</a></li>
<li><a href="https://ibms360.co.uk" title="Documenting the recovery and restoration of an IBM System 360 Model 20 and potentially an IBM System 370 Model 125">IBM 360 Model 20 Rescue and Restoration</a></li>
<li><a href="https://www.joelonsoftware.com">Joel on Software</a></li>
<li><a href="http://kendov.com" title="Новини">Kendov.com</a></li>
<li><a href="https://www.youtube.com/channel/UC3XTzVzaHQEd30rQbuvCtTQ">LastWeekTonight</a></li>
<li><a href="https://laur.ie/blog" title="Sometimes I make things or think things. Here they are.">laur.ie&#039;s blog</a></li>
<li><a href="https://lcamtuf.blogspot.com/">lcamtuf&#8217;s blog</a></li>
<li><a href="https://letsencrypt.org/" title="  Let&#8217;s Encrypt is a free, automated, and open certificate
  authority brought to you by the nonprofit &lt;a href=&quot;https://www.abetterinternet.org/&quot;&gt;Internet Security Research Group (ISRG)&lt;/a&gt;.
">Let&#039;s Encrypt</a></li>
<li><a href="https://www.youtube.com/channel/UCLx053rWZxCiYWsBETgdKrQ">LGR</a></li>
<li><a href="https://lwn.net" title="
 LWN.net is a comprehensive source of news and opinions from
        and about the Linux community.  This is the main LWN.net feed,
        listing all articles which are posted to the site front page.

    ">LWN.net</a></li>
<li><a href="https://www.youtube.com/channel/UCL5Hf6_JIzb3HpiJQGqs8cQ">Matt Granger</a></li>
<li><a href="https://mjg59.dreamwidth.org/" title="Matthew Garrett &#8211; Dreamwidth Studios">Matthew Garrett</a></li>
<li><a href="https://monty-says.blogspot.com/" title="Rambling thoughts about recent events in MariaDB / MySQL or Free software/Open source">Monty says</a></li>
<li><a href="https://netflixtechblog.com" title="Learn about Netflix’s world class engineering efforts, company culture, product developments and more. &#8211; Medium">Netflix TechBlog &#8211; Medium</a></li>
<li><a href="https://blog.ntpsec.org/" title="The blog for the NTPsec Project. NTPsec is a secure, hardened, and improved implementation of Network Time Protocol derived from NTP Classic, Dr. David Mills’s original. Our goal is to deliver code that can be used with confidence in deployments with the ">NTPsec Project Blog</a></li>
<li><a href="https://www.oglaf.com/latest/" title="Comics. Often dirty. Updates Sundays.">Oglaf! &#8212; Comics. Often dirty.</a></li>
<li><a href="https://0pointer.net/blog/">Pid Eins</a></li>
<li><a href="https://prometheus.io/">Prometheus Blog</a></li>
<li><a href="https://blog.rapid7.com/" title="Rapid7 transforms data into insight, empowering security professionals to progress and protect their organizations.">Rapid7 Blog</a></li>
<li><a href="https://www.raspberrypi.org" title="Teach, learn and make with Raspberry Pi">Raspberry Pi Foundation blog: news, announcements, stories, ideas</a></li>
<li><a href="https://www.schneier.com">Schneier on Security</a></li>
<li><a href="http://devopscafe.org/show/" title="Show Notes">Show Notes</a></li>
<li><a href="https://spritesmods.com" title="Sprites mods: website documenting various hardware and software mods and hacks.">Sprites mods</a></li>
<li><a href="https://www.youtube.com/channel/UCbmNph6atAoGfqLoCL_duAg">Talks at Google</a></li>
<li><a href="https://www.youtube.com/channel/UC5I2hjZYiW9gZPVkvzM8_Cw">Techmoan</a></li>
<li><a href="https://www.youtube.com/channel/UClRwC5Vc8HrB6vGx6Ti-lhA">Technology Connextras</a></li>
<li><a href="https://www.youtube.com/channel/UCK0z0_5uL7mb9IjntOKi5XQ">The Atlantic</a></li>
<li><a href="https://blog.cloudflare.com/" title="Get the latest news on how products at Cloudflare are built, technologies used, and join the teams helping to build a better Internet.">The Cloudflare Blog</a></li>
<li><a href="http://thecodelesscode.com" title="Kōans for the Software Engineer &#8212; An illustrated collection of (sometimes violent) fables, concerning the Art and Philosophy of software development.">The Codeless Code</a></li>
<li><a href="https://www.youtube.com/channel/UC4sEmXUuWIFlxRIFBRV6VXQ">The History Guy: History Deserves to Be Remembered</a></li>
<li><a href="https://www.youtube.com/channel/UC2gyzKcHbYfqoXA5xbyGXtQ">The Hook Up</a></li>
<li><a href="https://turnoff.us/" title="turnoff.us is a geek comic site. Comics about Programming Languages, Web, Cloud, Linux, etc.">turnoff.us &#8211; geek comic site</a></li>
<li><a href="https://xkcd.com/">xkcd.com</a></li>
<li><a href="https://yahooeng.tumblr.com/" title="A peek under the purple rug!">Yahoo Engineering</a></li>
<li><a href="https://blog.yate.ro">Yate – Software Defined Mobile Networks</a></li>
<li><a href="https://yovko.net/" title="Размисли, истории и идеи от Йовко Ламбрев">yovko in a nutshell</a></li>
<li><a href="https://blog.zabbix.com" title="The Future of Monitoring">Zabbix Blog</a></li>
<li><a href="https://blog.bozho.net" title="блог на Божидар Божанов">БЛОГодаря</a></li>
<li><a href="https://delian.blogspot.com/" title="Трябва много да ви е скучно, щом сте стигнали дотук&#8230;">Блогът на Делян Делчев</a></li>
<li><a href="https://yurukov.net/blog" title="Нещата които искам да споделя с другите">Блогът на Юруков</a></li>
<li><a href="http://georgi.unixsol.org/diary/" title="Мрън, мрън, всеки ден.">Дневникът на Георги</a></li>
<li><a href="http://dni.li">Дни</a></li>
<li><a href="http://kaka-cuuka.com">Како Сийке, не съм от тях!</a></li>
<li><a href="https://nookofselene.wordpress.com">Кътчето на Селин</a></li>
<li><a href="https://nellyo.wordpress.com" title=" [Media Law]   [Nelly Ognyanova]  ">Медийно право </a></li>
<li><a href="https://alex.stanev.org/blog" title="мисли, чувства, съмнения&#8230;">Неосъзнато</a></li>
<li><a href="https://vasil.ludost.net/blog" title="Имам теле в главата.">татко Крокодил</a></li>
<li><a href="https://toest.bg" title="Смисълът на новините">Тоест</a></li>
</ul>
</aside>
<aside id="tag_cloud-3" class="widget widget_tag_cloud"><h1 class="widget-title">Tags</h1><div class="tagcloud"><a href="https://noise.getoto.net/tag/ad/" class="tag-cloud-link tag-link-6101 tag-link-position-1" style="font-size: 11.92pt;" aria-label="AD (2,961 items)">AD</a>
<a href="https://noise.getoto.net/tag/ai/" class="tag-cloud-link tag-link-3287 tag-link-position-2" style="font-size: 16.4pt;" aria-label="AI (4,285 items)">AI</a>
<a href="https://noise.getoto.net/tag/all/" class="tag-cloud-link tag-link-63 tag-link-position-3" style="font-size: 16.96pt;" aria-label="All (4,425 items)">All</a>
<a href="https://noise.getoto.net/tag/app/" class="tag-cloud-link tag-link-111 tag-link-position-4" style="font-size: 16.4pt;" aria-label="app (4,284 items)">app</a>
<a href="https://noise.getoto.net/tag/art/" class="tag-cloud-link tag-link-119 tag-link-position-5" style="font-size: 17.24pt;" aria-label="art (4,527 items)">art</a>
<a href="https://noise.getoto.net/tag/ati/" class="tag-cloud-link tag-link-126 tag-link-position-6" style="font-size: 20.04pt;" aria-label="ATI (5,688 items)">ATI</a>
<a href="https://noise.getoto.net/tag/aws/" class="tag-cloud-link tag-link-141 tag-link-position-7" style="font-size: 8.28pt;" aria-label="AWS (2,162 items)">AWS</a>
<a href="https://noise.getoto.net/tag/bec/" class="tag-cloud-link tag-link-172 tag-link-position-8" style="font-size: 8.84pt;" aria-label="BEC (2,308 items)">BEC</a>
<a href="https://noise.getoto.net/tag/ble/" class="tag-cloud-link tag-link-6177 tag-link-position-9" style="font-size: 9.4pt;" aria-label="ble (2,417 items)">ble</a>
<a href="https://noise.getoto.net/tag/c/" class="tag-cloud-link tag-link-239 tag-link-position-10" style="font-size: 22pt;" aria-label="C (6,798 items)">C</a>
<a href="https://noise.getoto.net/tag/cas/" class="tag-cloud-link tag-link-257 tag-link-position-11" style="font-size: 8pt;" aria-label="CAS (2,152 items)">CAS</a>
<a href="https://noise.getoto.net/tag/ci/" class="tag-cloud-link tag-link-5674 tag-link-position-12" style="font-size: 10.52pt;" aria-label="ci (2,607 items)">ci</a>
<a href="https://noise.getoto.net/tag/code/" class="tag-cloud-link tag-link-301 tag-link-position-13" style="font-size: 9.12pt;" aria-label="code (2,358 items)">code</a>
<a href="https://noise.getoto.net/tag/curity/" class="tag-cloud-link tag-link-358 tag-link-position-14" style="font-size: 9.4pt;" aria-label="Curity (2,380 items)">Curity</a>
<a href="https://noise.getoto.net/tag/data/" class="tag-cloud-link tag-link-387 tag-link-position-15" style="font-size: 9.68pt;" aria-label="data (2,452 items)">data</a>
<a href="https://noise.getoto.net/tag/ec/" class="tag-cloud-link tag-link-6518 tag-link-position-16" style="font-size: 12.48pt;" aria-label="ec (3,117 items)">ec</a>
<a href="https://noise.getoto.net/tag/ed/" class="tag-cloud-link tag-link-492 tag-link-position-17" style="font-size: 20.88pt;" aria-label="ed (6,160 items)">ed</a>
<a href="https://noise.getoto.net/tag/et/" class="tag-cloud-link tag-link-5657 tag-link-position-18" style="font-size: 13.88pt;" aria-label="et (3,445 items)">et</a>
<a href="https://noise.getoto.net/tag/go/" class="tag-cloud-link tag-link-656 tag-link-position-19" style="font-size: 16.4pt;" aria-label="Go (4,305 items)">Go</a>
<a href="https://noise.getoto.net/tag/hat/" class="tag-cloud-link tag-link-6839 tag-link-position-20" style="font-size: 10.24pt;" aria-label="HAT (2,545 items)">HAT</a>
<a href="https://noise.getoto.net/tag/ice/" class="tag-cloud-link tag-link-2947 tag-link-position-21" style="font-size: 12.48pt;" aria-label="ICE (3,103 items)">ICE</a>
<a href="https://noise.getoto.net/tag/ip/" class="tag-cloud-link tag-link-790 tag-link-position-22" style="font-size: 18.08pt;" aria-label="IP (4,945 items)">IP</a>
<a href="https://noise.getoto.net/tag/irs/" class="tag-cloud-link tag-link-796 tag-link-position-23" style="font-size: 11.64pt;" aria-label="irs (2,867 items)">irs</a>
<a href="https://noise.getoto.net/tag/iss/" class="tag-cloud-link tag-link-802 tag-link-position-24" style="font-size: 10.52pt;" aria-label="iss (2,602 items)">iss</a>
<a href="https://noise.getoto.net/tag/make/" class="tag-cloud-link tag-link-961 tag-link-position-25" style="font-size: 12.76pt;" aria-label="Make (3,140 items)">Make</a>
<a href="https://noise.getoto.net/tag/mit/" class="tag-cloud-link tag-link-1017 tag-link-position-26" style="font-size: 8.84pt;" aria-label="mit (2,314 items)">mit</a>
<a href="https://noise.getoto.net/tag/nes/" class="tag-cloud-link tag-link-1075 tag-link-position-27" style="font-size: 11.92pt;" aria-label="NES (2,938 items)">NES</a>
<a href="https://noise.getoto.net/tag/oss/" class="tag-cloud-link tag-link-1145 tag-link-position-28" style="font-size: 9.4pt;" aria-label="OSS (2,398 items)">OSS</a>
<a href="https://noise.getoto.net/tag/other/" class="tag-cloud-link tag-link-1148 tag-link-position-29" style="font-size: 13.88pt;" aria-label="Other (3,505 items)">Other</a>
<a href="https://noise.getoto.net/tag/r/" class="tag-cloud-link tag-link-6394 tag-link-position-30" style="font-size: 16.12pt;" aria-label="R (4,213 items)">R</a>
<a href="https://noise.getoto.net/tag/rat/" class="tag-cloud-link tag-link-1294 tag-link-position-31" style="font-size: 16.4pt;" aria-label="rat (4,246 items)">rat</a>
<a href="https://noise.getoto.net/tag/rest/" class="tag-cloud-link tag-link-1311 tag-link-position-32" style="font-size: 8.84pt;" aria-label="rest (2,270 items)">rest</a>
<a href="https://noise.getoto.net/tag/rov/" class="tag-cloud-link tag-link-1334 tag-link-position-33" style="font-size: 12.2pt;" aria-label="ROV (2,994 items)">ROV</a>
<a href="https://noise.getoto.net/tag/rti/" class="tag-cloud-link tag-link-3768 tag-link-position-34" style="font-size: 8pt;" aria-label="RTI (2,146 items)">RTI</a>
<a href="https://noise.getoto.net/tag/s/" class="tag-cloud-link tag-link-1345 tag-link-position-35" style="font-size: 20.04pt;" aria-label="S. (5,743 items)">S.</a>
<a href="https://noise.getoto.net/tag/security/" class="tag-cloud-link tag-link-1381 tag-link-position-36" style="font-size: 11.08pt;" aria-label="security (2,729 items)">security</a>
<a href="https://noise.getoto.net/tag/sts/" class="tag-cloud-link tag-link-1476 tag-link-position-37" style="font-size: 8.56pt;" aria-label="sts (2,233 items)">sts</a>
<a href="https://noise.getoto.net/tag/support/" class="tag-cloud-link tag-link-1484 tag-link-position-38" style="font-size: 8.56pt;" aria-label="support (2,221 items)">support</a>
<a href="https://noise.getoto.net/tag/ted/" class="tag-cloud-link tag-link-5213 tag-link-position-39" style="font-size: 12.2pt;" aria-label="ted (3,006 items)">ted</a>
<a href="https://noise.getoto.net/tag/tor/" class="tag-cloud-link tag-link-1569 tag-link-position-40" style="font-size: 16.4pt;" aria-label="tor (4,219 items)">tor</a>
<a href="https://noise.getoto.net/tag/ui/" class="tag-cloud-link tag-link-1601 tag-link-position-41" style="font-size: 16.68pt;" aria-label="UI (4,316 items)">UI</a>
<a href="https://noise.getoto.net/tag/un/" class="tag-cloud-link tag-link-5663 tag-link-position-42" style="font-size: 14.44pt;" aria-label="un (3,611 items)">un</a>
<a href="https://noise.getoto.net/tag/us/" class="tag-cloud-link tag-link-1613 tag-link-position-43" style="font-size: 22pt;" aria-label="US (6,827 items)">US</a>
<a href="https://noise.getoto.net/tag/win/" class="tag-cloud-link tag-link-1708 tag-link-position-44" style="font-size: 10.52pt;" aria-label="win (2,642 items)">win</a>
<a href="https://noise.getoto.net/tag/work/" class="tag-cloud-link tag-link-2986 tag-link-position-45" style="font-size: 11.64pt;" aria-label="Work (2,898 items)">Work</a></div>
</aside> </div>
</div>
</div>
<footer id="colophon" class="site-footer" role="contentinfo">
<div class="site-info">
Proudly powered by Ants
</div>
</footer>
</div>
<link rel='stylesheet' id='basecss-css' href='https://noise.getoto.net/wp-content/plugins/eu-cookie-law/css/style.css?ver=5.8.4' type='text/css' media='all' />
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="5ced1ade86d8531617648efa-text/javascript" src='https://noise.getoto.net/wp-content/themes/z/js/functions.js?ver=20150315' id='twentyfourteen-script-js'></script>
<script type="5ced1ade86d8531617648efa-text/javascript" id='eucookielaw-scripts-js-extra'>
/* <![CDATA[ */
var eucookielaw_data = {"euCookieSet":"","autoBlock":"0","expireTimer":"360","scrollConsent":"0","networkShareURL":"","isCookiePage":"","isRefererWebsite":""};
/* ]]> */
</script>
<script type="5ced1ade86d8531617648efa-text/javascript" src='https://noise.getoto.net/wp-content/plugins/eu-cookie-law/js/scripts.js?ver=3.1.6' id='eucookielaw-scripts-js'></script>
<div class="pea_cook_wrapper pea_cook_bottomright" style="color:#FFFFFF;background:rgb(0,0,0);background: rgba(0,0,0,0.85);"><p>By continuing to use the site, you agree to the use of cookies. <a style="color:#FFFFFF;" href="#" id="fom">more information</a> <button id="pea_cook_btn" class="pea_cook_btn">Accept</button></p></div><div class="pea_cook_more_info_popover"><div class="pea_cook_more_info_popover_inner" style="color:#FFFFFF;background-color: rgba(0,0,0,0.9);"><p>The cookie settings on this website are set to "allow cookies" to give you the best browsing experience possible. If you continue to use this website without changing your cookie settings or you click "Accept" below then you are consenting to this.</p><p><a style="color:#FFFFFF;" href="#" id="pea_close">Close</a></p></div></div><script src="/cdn-cgi/scripts/7d0fa10a/cloudflare-static/rocket-loader.min.js" data-cf-settings="5ced1ade86d8531617648efa-|49" defer=""></script><script type="text/javascript">(function(){window['__CF$cv$params']={r:'71173bf3ed7138bf',m:'FL_lUVMpneOYrmwB3HDAwI4Gr6SlQuxN6pLAc4pTQS4-1653575694-0-AdJTejpL2rNaMOoJ6Ij1XdNoo7Mk8Eo6yi2eOqULOGchGf51cONdhIuJj77d7tISOqG6kpHcU4kHSfexbJ3q1I262+zdTWnLVEyLZ5JutiCNRjlKMkcMLm4F8I+FA7vXsXDwfD8ZQWQiRPT76wWBfT0=',s:[0xd94c522d80,0x0ff170b590],u:'/cdn-cgi/challenge-platform/h/b'}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/v652eace1692a40cfa3763df669d7439c1639079717194" integrity="sha512-Gi7xpJR8tSkrpF7aordPZQlW2DLtzUlZcumS8dMQjwDHEnw9I7ZLyiOj/6tZStRBGtGgN6ceN6cMH8z7etPGlw==" data-cf-beacon='{"rayId":"71173bf3ed7138bf","version":"2021.12.0","r":1,"token":"cecbc7705ec84a85ad1fb6c36eaeb0f3","si":100}' crossorigin="anonymous"></script>
</body>
</html>
